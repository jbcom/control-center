---
alwaysApply: true
description: MANDATORY AI code review engagement protocol - agents MUST engage QA before merge
globs: ["**/*"]
---

# AI Code Review (QA) Engagement

## ðŸš¨ CRITICAL: Mandatory Review Before Merge

**NEVER merge a PR without:**
1. Requesting AI review from at least ONE QA agent
2. Waiting for the review to complete
3. FULLY addressing ALL feedback (not just dismissing it)
4. Documenting your response to each piece of feedback

## How to Request Review

### âš ï¸ CRITICAL: Different Rules for Different Repos

**FlipsideCrypto (FSC) repos** - Use paid AI reviewers:
```
/gemini review       # Google Gemini Code Assist
/q review            # Amazon Q Developer
@copilot review      # GitHub Copilot
```

**jbcom repos (personal/OSS)** - Use FREE tooling ONLY:
```
@copilot review      # GitHub Copilot (FREE for public repos)
```
- âŒ Do NOT use `/gemini review` on jbcom repos
- âŒ Do NOT use `/q review` on jbcom repos
- âœ… CodeQL is automatic and FREE
- âœ… Copilot code review is FREE for public repos
- âœ… Dependabot is FREE

### Why the Difference?
- FSC = Enterprise org with paid AI tooling budget
- jbcom = Personal account, use FREE public repo benefits only

### Automatic Reviewers
- **Copilot** - Enable in Settings > Code security and analysis (FREE for public)
- **CodeQL** - Automatic security scanning (FREE for public)

### Focused Reviews

Request specific review types (syntax varies by tool):
```
/gemini review security           # Gemini: append focus area
/q review performance             # Amazon Q: append focus area
@copilot focus on test coverage   # Copilot: use natural language
@coderabbitai review security     # CodeRabbit: append focus area
```

## Scope: When This Protocol Applies

### ALWAYS Request Review For:
- New features
- Bug fixes (even "simple" ones)
- Refactors of any size
- Dependency updates that affect code
- Security-related changes
- API changes
- Infrastructure or configuration changes that affect runtime behavior

### Review NOT Required (explicit exceptions):
- **Pure documentation changes** (README, comments only) that don't affect code behavior
- **Whitespace/formatting-only** changes with no functional impact
- **Automated Dependabot bumps** with no code changes

**Note:** When in doubt, request review. It's better to over-review than under-review.

## Addressing Feedback

### MANDATORY Steps:

1. **Read ALL feedback** - Every comment from every AI reviewer
2. **Categorize by severity**:
   - ðŸ›‘ **Critical/High** - MUST be resolved before merge (fix the issue OR document why it's a false positive with evidence)
   - âš ï¸ **Medium** - Should be resolved or provide strong technical justification
   - ðŸ’¡ **Low/Info** - Consider, document if skipping
3. **Fix or respond** to EVERY item:
   - Fix the issue, OR
   - Reply explaining why you disagree with technical justification
4. **Re-request review** if you made significant changes
5. **Document** your decisions in the PR

### What "Fully Addressing" Means:

âŒ **NOT acceptable:**
- Ignoring feedback
- Merging without responding
- Dismissing without justification
- "I'll fix it later"

âœ… **Acceptable:**
- Fixing the issue
- "This is intentional because [technical reason]"
- "False positive - [explanation with evidence]"
- "Out of scope for this PR - created issue #X" (Note: NOT valid for critical/high severity items)

## Thread Resolution

A review thread is considered **resolved** when:
1. The PR author has implemented the suggested fix, OR
2. The PR author has responded with a clear technical justification for not implementing the suggestion

Threads do NOT need to be manually marked 'Resolved' in the GitHub UI - a documented response satisfies the requirement.

## PR Owner Responsibilities

As PR owner, you MUST:
- Request AI review before merge
- Wait for reviews to complete
- Address every piece of feedback
- Not merge until feedback is resolved
- Document your merge decision

## Cross-Agent Collaboration & Conflict Resolution

### When Taking Over Another Agent's PR:
1. Request fresh AI review
2. Don't dismiss previous agent's decisions without justification
3. Tag original agent if making significant changes
4. Maintain the feedback resolution record
5. If conflicts arise, escalate to team lead or create discussion issue

### Resolving AI-to-AI Conflicts:
When AI reviewers disagree with each other:
1. **Evaluate both positions** - Consider the technical merit of each
2. **Apply project conventions** - Use existing codebase patterns as tiebreaker
3. **Document your decision** - Explain which position you chose and why
4. **Prefer security/correctness** - When in doubt, choose the safer option
5. **Escalate if needed** - Tag human reviewer for genuinely ambiguous cases

## Merge Checklist

### For FSC Repos (FlipsideCrypto):
- [ ] CI is green (all checks pass)
- [ ] At least ONE AI review completed (`/gemini review`, `/q review`, or Copilot)
- [ ] ALL critical/high severity items resolved
- [ ] ALL medium severity items resolved or justified
- [ ] Responses posted to ALL feedback items

### For jbcom Repos (Personal/OSS):
- [ ] CI is green (all checks pass)
- [ ] CodeQL passes (no HIGH/CRITICAL security issues)
- [ ] Copilot review feedback addressed (if any)
- [ ] Dependabot PRs: auto-merge for minor/patch is OK

## Example Workflow

### FSC Repos (FlipsideCrypto) - Paid AI Review
```bash
# 1. Create PR
GH_TOKEN="$GITHUB_FSC_TOKEN" gh pr create --repo FlipsideCrypto/some-repo --title "fix: something"

# 2. Request AI reviews (post as PR comment)
# /gemini review
# /q review

# 3. Wait for reviews, address feedback, merge
```

### jbcom Repos (Personal/OSS) - FREE Tooling Only
```bash
# 1. Create PR
GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh pr create --repo jbcom/jbcom-oss-ecosystem --title "fix: something"

# 2. Wait for automatic checks:
#    - CodeQL (automatic, FREE)
#    - Copilot review (automatic if enabled, FREE for public)
#    - CI (tests, build, lint)

# 3. Address any Copilot feedback

# 4. Merge when green
GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh pr merge --squash --delete-branch

# NOTE: Do NOT use /gemini or /q on jbcom repos!
```

## Repository Settings for Automatic AI Review

### For jbcom Repos (FREE tooling):
1. **Copilot Code Review** - Settings > Code security and analysis > Enable
2. **CodeQL** - Automatic for public repos
3. **Dependabot** - Enable in Settings > Security

### For FSC Repos (Paid tooling):
1. All the above, PLUS:
2. **Gemini/Amazon Q** - Triggered via PR comments (`/gemini review`, `/q review`)
3. **Rulesets** - Can require AI reviewer checks as status gates

## Enforcement

This is a **MANDATORY** protocol enforced as follows:

1. **Pre-merge gate** - Do not use `--admin` to bypass without AI review completion
2. **Detection** - PRs without AI review comments are flagged in PR audit
3. **Audit trail** - All feedback and responses are recorded in PR history
4. **Revert policy** - PRs merged without proper review will be flagged for review by the team lead and may be reverted if they contain unaddressed critical issues
5. **Continuous improvement** - Report AI reviewer false positives by creating an issue with label `ai-review-feedback`

The goal is **quality**, not speed. A well-reviewed PR that takes longer is better than a rushed merge that causes production issues.
