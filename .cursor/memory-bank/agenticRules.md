# Agentic Rules - jbcom Ecosystem

## ğŸ§  Memory Bank Usage

### At Session Start
1. **ALWAYS read these files first:**
   - `memory-bank/activeContext.md` - Current work state
   - `memory-bank/progress.md` - Task tracking
   
2. **Check external repos if working on integrations:**
   - terraform-modules: `/workspace/external/terraform-modules/memory-bank/`

### During Session
1. **Update progress.md** after completing significant tasks
2. **Update activeContext.md** when focus changes
3. **Create GitHub issues** for multi-step work

### At Session End
1. **Update progress.md** with final status
2. **Note "Next Actions"** in activeContext.md
3. **Push any uncommitted changes** to branches

---

## ğŸ“‹ GitHub Issue Tracking

### When to Create Issues
- Multi-step integration work (3+ tasks)
- Cross-repository changes
- Features requiring multiple PRs
- Bug fixes requiring investigation

### Issue Template
```markdown
## Overview
[Brief description]

## Tasks
- [ ] Task 1
- [ ] Task 2
- [ ] Task 3

## Dependencies
[What this blocks or is blocked by]

## Related
- PR #X
- Issue #Y

cc @jbcom
```

### Link PRs to Issues
- Use "Fixes #NNN" in PR body for auto-closing
- Use "Part of #NNN" for progress tracking

---

## ğŸ”€ Long-Running PR Workflow

### For Multi-Merge Sessions
When work requires multiple sequential PRs and CI monitoring:

1. **Create Holding PR**
   ```bash
   git checkout -b agent/holding-<topic>-YYYYMMDD
   echo "# Agent Session: <topic>" >> .cursor/agents/session-notes.md
   git add -A && git commit -m "Agent holding PR for <topic>"
   git push -u origin HEAD
   GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh pr create \
     --title "[HOLDING] Agent session for <topic>" \
     --body "This PR holds the session context. Work happens in interim PRs."
   ```

2. **Create Interim PR for Each Fix**
   ```bash
   git checkout main && git pull
   git checkout -b fix/<specific-fix>
   # Make changes
   git add -A && git commit -m "Fix: <description>"
   git push -u origin HEAD
   GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh pr create \
     --title "Fix: <description>" \
     --body "Part of holding PR #N"
   ```

3. **Merge and Monitor**
   ```bash
   GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh pr merge --squash --delete-branch
   # Wait for CI
   GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh run watch
   ```

4. **Repeat Until Complete**

5. **Close Holding PR**
   ```bash
   GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh pr close <HOLDING_PR_NUM>
   ```

---

## ğŸ” Authentication Rules

### jbcom Repositories
```bash
# ALWAYS prefix with token
GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh <command>
```

### FlipsideCrypto Repositories
```bash
# Default token works
gh <command>
```

### Never Do
- âŒ Use bare `gh` for jbcom repos
- âŒ Commit tokens to files
- âŒ Use personal tokens in CI

---

## ğŸ“¦ Package Management Rules

### CalVer Versioning
- **Format:** `YYYY.MM.BUILD` (e.g., 202511.42)
- **Generated by:** pycalver at CI start
- **Single version:** For entire monorepo push
- **No tags:** PyPI is source of truth

### Dependency Order
Always respect the dependency chain:
```
extended-data-types (FOUNDATION)
â”œâ”€â”€ lifecyclelogging
â”œâ”€â”€ directed-inputs-class
â””â”€â”€ vendor-connectors
```

### Before Adding Dependencies
1. Check if extended-data-types provides it
2. Check if vendor-connectors provides it
3. Only add if truly unique to the package

---

## ğŸš¨ CI/CD Rules

### Never Suggest
- âŒ semantic-release
- âŒ git tags for versioning
- âŒ Manual version management
- âŒ GitHub releases automation
- âŒ Conditional release logic

### Always Use
- âœ… pycalver for versioning
- âœ… uv for package management
- âœ… Unified ci.yml workflow
- âœ… PyPI for version tracking

---

## ğŸ”§ Development Workflow

### Working in jbcom-control-center
1. All package code is in `packages/`
2. Edit files directly
3. Create PR via branches
4. Merge triggers sync to public repos

### Working on External Repos (terraform-modules, etc.)
1. Clone to `/workspace/external/<repo>/`
2. Create feature branch
3. Make changes
4. Create PR using appropriate token
5. Monitor CI

### Cross-Repo Changes
1. Start with jbcom packages (if needed)
2. Release to PyPI
3. Update external repos to use new version
4. Create PRs for external repos

---

## ğŸ“ Communication Rules

### In PRs
- Clear, concise titles
- Explain what and why
- Link to issues
- Include test plan

### In Commits
- Descriptive messages
- No conventional commit format required
- Explain the change

### In Issues
- Full context
- Task checkboxes
- Dependencies noted
- Assigned to @jbcom

---

## ğŸ¯ Autonomy Rules

### Autonomous Actions (No Approval Needed)
- âœ… Create branches
- âœ… Create PRs
- âœ… Create issues
- âœ… Push fixes to PR branches
- âœ… Run tests locally
- âœ… Update memory-bank

### Requires Explicit Approval
- âš ï¸ Merge to main
- âš ï¸ Delete branches with unmerged work
- âš ï¸ Force push
- âš ï¸ Change protected files

### User Override Signals
When user says: "merge it", "just do it", "stop asking"
- Switch to autonomous mode
- Execute without confirmation
- Still verify after major changes

---

## ğŸ§ª Testing Rules

### Before Creating PR
1. Run tests locally if possible
2. Check for lint errors
3. Verify imports work
4. Test affected functionality

### After Merge
1. Watch CI run
2. Fix failures immediately
3. Don't leave broken main

---

## ğŸ“Š Monitoring Commands

### Check jbcom CI
```bash
for repo in extended-data-types lifecyclelogging directed-inputs-class vendor-connectors; do
  echo "=== $repo ==="
  GH_TOKEN="$GITHUB_JBCOM_TOKEN" gh run list --repo jbcom/$repo --limit 3
done
```

### Check PyPI Versions
```bash
pip index versions extended-data-types
pip index versions vendor-connectors
```

### Check terraform-modules CI
```bash
gh run list --repo FlipsideCrypto/terraform-modules --limit 5
```

---

## ğŸ—‚ï¸ File Locations

### jbcom-control-center
```
/workspace/
â”œâ”€â”€ .cursor/memory-bank/        # Agent memory
â”œâ”€â”€ packages/                   # All Python packages
â”‚   â”œâ”€â”€ extended-data-types/
â”‚   â”œâ”€â”€ lifecyclelogging/
â”‚   â”œâ”€â”€ directed-inputs-class/
â”‚   â””â”€â”€ vendor-connectors/
â”œâ”€â”€ .github/workflows/          # CI/CD workflows
â””â”€â”€ .ruler/                     # Agent instructions source
```

### terraform-modules
```
/workspace/external/terraform-modules/
â”œâ”€â”€ memory-bank/                # Agent memory
â”œâ”€â”€ lib/terraform_modules/      # Main library
â”œâ”€â”€ terraform/                  # Terraform modules
â””â”€â”€ sam/                        # SAM Lambda functions
```

---

## ğŸ”„ Recovery Procedures

### If CI Fails
1. Read full error output
2. Identify root cause
3. Create fix PR
4. Wait for CI
5. If still failing, escalate

### If Stuck
1. Update memory-bank with current state
2. Document what was tried
3. Note blockers
4. Ask for guidance if needed

### If Session Interrupted
1. Push all changes to branches
2. Update memory-bank
3. Note where to resume
4. Close holding PR if work complete
