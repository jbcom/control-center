#!/bin/bash
# Wiki CLI - Manage GitHub Wiki content
# Usage: wiki-cli <command> [args]

set -e

REPO="jbcom/jbcom-control-center"
WIKI_URL="https://github.com/${REPO}.wiki.git"

# Use GITHUB_JBCOM_TOKEN if GH_TOKEN not set
: "${GH_TOKEN:=${GITHUB_JBCOM_TOKEN}}"

if [ -z "$GH_TOKEN" ]; then
    echo "Error: GH_TOKEN or GITHUB_JBCOM_TOKEN must be set"
    exit 1
fi

WIKI_DIR="/tmp/wiki-cache-$$"
trap "rm -rf $WIKI_DIR" EXIT

clone_wiki() {
    if [ ! -d "$WIKI_DIR" ]; then
        git clone "https://${GH_TOKEN}@github.com/${REPO}.wiki.git" "$WIKI_DIR" 2>/dev/null
        cd "$WIKI_DIR"
        git config user.email "agent@jbcom.dev"
        git config user.name "jbcom-agent"
    fi
}

case "$1" in
    read)
        clone_wiki
        PAGE="${2/\//-}"  # Replace / with -
        if [ -f "$WIKI_DIR/${PAGE}.md" ]; then
            cat "$WIKI_DIR/${PAGE}.md"
        else
            echo "Page not found: $2"
            exit 1
        fi
        ;;

    write)
        clone_wiki
        PAGE="${2/\//-}"
        echo "$3" > "$WIKI_DIR/${PAGE}.md"
        cd "$WIKI_DIR"
        git add "${PAGE}.md"
        git commit -m "Update ${PAGE}" 2>/dev/null || true
        git push origin master 2>/dev/null
        echo "Updated: $2"
        ;;

    append)
        clone_wiki
        PAGE="${2/\//-}"
        echo "" >> "$WIKI_DIR/${PAGE}.md"
        echo "$3" >> "$WIKI_DIR/${PAGE}.md"
        cd "$WIKI_DIR"
        git add "${PAGE}.md"
        git commit -m "Append to ${PAGE}" 2>/dev/null || true
        git push origin master 2>/dev/null
        echo "Appended to: $2"
        ;;

    list)
        clone_wiki
        ls "$WIKI_DIR"/*.md 2>/dev/null | xargs -I{} basename {} .md
        ;;

    *)
        echo "Usage: wiki-cli <command> [args]"
        echo ""
        echo "Commands:"
        echo "  read <page>           Read a wiki page"
        echo "  write <page> <text>   Write/replace a wiki page"
        echo "  append <page> <text>  Append to a wiki page"
        echo "  list                  List all pages"
        echo ""
        echo "Examples:"
        echo "  wiki-cli read Memory-Bank-Active-Context"
        echo "  wiki-cli append Memory-Bank-Progress '## Session update'"
        ;;
esac
