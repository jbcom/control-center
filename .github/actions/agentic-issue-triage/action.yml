---
name: 'Agentic Issue Triage'
description: 'Triage a GitHub issue using an AI agent.'
author: 'jbcom/agentic-control'
branding:
  icon: 'alert-circle'
  color: 'orange'
inputs:
  github_token:
    description: 'The GitHub token to use for authentication.'
    required: true
  issue_number:
    description: 'The number of the issue to triage.'
    required: true
  model:
    description: 'The Ollama model to use for the triage.'
    required: false
    default: 'llama3'
  api_key:
    description: 'The API key for the model.'
    required: false
  jules_api_key:
    description: 'Jules API key'
    required: false
  cursor_api_key:
    description: 'Cursor API key'
    required: false
  comment_body:
    description: 'Comment body'
    required: false
  repository:
    description: 'Repository'
    required: false
  default_branch:
    description: 'Default branch'
    required: false
outputs:
  triage_summary:
    description: 'A summary of the triage.'
  labels:
    description: 'The labels suggested by the agent.'
  assignee:
    description: 'The assignee suggested by the agent.'
runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    - name: Run issue triage
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        JULES_API_KEY: ${{ inputs.jules_api_key }}
        GOOGLE_JULES_API_KEY: ${{ inputs.jules_api_key }}
        CURSOR_API_KEY: ${{ inputs.cursor_api_key }}
        COMMENT_BODY: ${{ inputs.comment_body }}
        ISSUE_NUMBER: ${{ inputs.issue_number }}
        REPOSITORY: ${{ inputs.repository }}
        DEFAULT_BRANCH: ${{ inputs.default_branch }}
      run: |
        set -eo pipefail
        if [[ "$COMMENT_BODY" == *"/jules"* ]]; then
          echo "ü§ñ Received '/jules' command. Delegating to Google Jules..."
          if [[ -z "$GOOGLE_JULES_API_KEY" ]]; then
            MSG="‚ö†Ô∏è GOOGLE_JULES_API_KEY not configured. Cannot delegate to Jules."
            gh issue comment "$ISSUE_NUMBER" --body "$MSG"
            exit 1
          fi
          TASK=$(echo "$COMMENT_BODY" | sed 's/^\/jules\s*//' | xargs)
          if [ -z "$TASK" ]; then
            read -r -d '' BODY << EOM
        ü§ñ Received an empty '/jules' command. Please provide a task.
        **Usage:** \`/jules <your task description>\`
        **Example:** \`/jules implement the fizz-buzz algorithm\`
        EOM
            gh issue comment "$ISSUE_NUMBER" --body "$BODY"
            exit 0
          fi
          MSG="ü§ñ Received '/jules' command. Creating Jules session for task: \`$TASK\`"
          gh issue comment "$ISSUE_NUMBER" --body "$MSG"
          JSON_PAYLOAD=$(jq -n \
            --arg task "Fix issue #$ISSUE_NUMBER: $TASK" \
            --arg repo "$REPOSITORY" \
            --arg branch "$DEFAULT_BRANCH" \
            '{
              prompt: $task,
              sourceContext: {
                source: ("sources/github/" + $repo),
                githubRepoContext: { startingBranch: $branch }
              },
              automationMode: "AUTO_CREATE_PR"
            }')
          RESPONSE=$(curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -n "$SESSION_ID" ]; then
            SESSION_URL="https://console.google.com/jules/session/$SESSION_ID"
            read -r -d '' BODY << EOM
        ## ü§ñ Jules Session Created
        ‚û°Ô∏è **[Monitor Session]($SESSION_URL)**
        Jules will analyze the issue and create a PR.
        EOM
            gh issue comment "$ISSUE_NUMBER" --body "$BODY"
          else
            echo "Failed to create Jules session: $RESPONSE"
            gh issue comment "$ISSUE_NUMBER" --body "‚ùå Failed to create Jules session."
            exit 1
          fi
          exit 0
        fi
        if [[ "$COMMENT_BODY" == *"/cursor"* ]]; then
          echo "ü§ñ Received '/cursor' command. Delegating to Cursor Cloud Agent..."
          MSG="ü§ñ Received '/cursor' command. Cursor delegation is handled by the orchestrator."
          gh issue comment "$ISSUE_NUMBER" --body "$MSG"
          exit 0
        fi
        echo "Performing standard issue triage..."
        gh issue comment "$ISSUE_NUMBER" --body "ü§ñ Issue received and queued for triage."
