name: Ecosystem Delegator

# Handles delegation commands in issue comments:
# - /jules - delegate to Google Jules
# - /cursor - delegate to Cursor agent
# - @claude - delegate to Claude

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # ============================================
  # Jules/Cursor delegation (existing)
  # ============================================
  delegate-command:
    name: Delegate to Jules/Cursor
    if: |
      github.event.issue.pull_request == null &&
      (contains(github.event.comment.body, '/jules') || contains(github.event.comment.body, '/cursor'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Delegate Issue Command
        uses: ./.github/actions/agentic-issue-triage
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          cursor_api_key: ${{ secrets.CURSOR_API_KEY }}
          comment_body: ${{ github.event.comment.body }}
          issue_number: ${{ github.event.issue.number }}
          repository: ${{ github.repository }}
          default_branch: ${{ github.event.repository.default_branch }}

  # ============================================
  # Claude delegation (@claude in issues)
  # ============================================
  delegate-claude:
    name: Delegate to Claude
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude on Issue
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          prompt: |
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            
            ${{ github.event.issue.body }}
            
            ---
            Comment that triggered this:
            ${{ github.event.comment.body }}
            
            ---
            Analyze the issue and either:
            1. Answer the question if it's a question
            2. Implement a fix if it's a bug
            3. Implement the feature if it's a feature request
            
            Create a PR with your changes.
          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(node:*),Bash(npm:*)"
