name: Ecosystem Delegator

# Issue delegation to AI agents
# /jules - Delegate to Google Jules
# /cursor - Delegate to Cursor Cloud Agent
# /sage - Ask the Sage

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  delegate-jules:
    name: Delegate to Jules
    if: |
      github.event.issue.pull_request == null && 
      contains(github.event.comment.body, '/jules')
    runs-on: ubuntu-latest
    steps:
      - name: Check for API Key
        id: check
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          if [[ -z "$GOOGLE_JULES_API_KEY" ]]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge
        if: steps.check.outputs.available == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ü§ñ Received '/jules' command. Creating Jules session..."

      - name: Parse Task
        id: task
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          TASK=$(echo "$COMMENT_BODY" | sed 's|/jules[[:space:]]*||' | head -c 1000)
          echo "task=$TASK" >> $GITHUB_OUTPUT

      - name: Create Jules Session
        if: steps.check.outputs.available == 'true'
        id: jules
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "Fix issue #${{ github.event.issue.number }}: ${{ steps.task.outputs.task }}" \
              --arg repo "${{ github.repository }}" \
              --arg branch "${{ github.event.repository.default_branch }}" \
              '{
                prompt: $task,
                sourceContext: {
                  source: ("sources/github/" + ($repo | split("/")[0]) + "/" + ($repo | split("/")[1])),
                  githubRepoContext: { startingBranch: $branch }
                },
                automationMode: "AUTO_CREATE_PR"
              }')")
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          SESSION_URL="https://jules.google.com/session/$SESSION_ID"
          
          echo "session_url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

      - name: Post Session Link
        if: steps.check.outputs.available == 'true' && steps.jules.outputs.session_id != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ü§ñ Jules Session Created

          ‚û°Ô∏è **[Monitor Session](${{ steps.jules.outputs.session_url }})**
          
          Jules will analyze the issue and create a PR."

      - name: Post API Key Missing
        if: steps.check.outputs.available == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ö†Ô∏è GOOGLE_JULES_API_KEY not configured."

  delegate-cursor:
    name: Delegate to Cursor
    if: |
      github.event.issue.pull_request == null && 
      contains(github.event.comment.body, '/cursor')
    runs-on: ubuntu-latest
    steps:
      - name: Check for API Key
        id: check
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [[ -z "$CURSOR_API_KEY" ]]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge
        if: steps.check.outputs.available == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ö° Received '/cursor' command. Spawning Cursor agent..."

      - name: Parse Task
        id: task
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          TASK=$(echo "$COMMENT_BODY" | sed 's|/cursor[[:space:]]*||' | head -c 2000)
          echo "task=$TASK" >> $GITHUB_OUTPUT

      - name: Spawn Cursor Agent
        if: steps.check.outputs.available == 'true'
        id: cursor
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST "https://api.cursor.com/v0/agents" \
            -H "Authorization: Bearer $CURSOR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "Fix issue #${{ github.event.issue.number }}: ${{ steps.task.outputs.task }}" \
              --arg repo "https://github.com/${{ github.repository }}" \
              --arg branch "${{ github.event.repository.default_branch }}" \
              '{
                prompt: { text: $task },
                source: { repository: $repo, ref: $branch },
                target: { autoCreatePr: true, openAsCursorGithubApp: true }
              }')")
          
          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT

      - name: Post Agent Link
        if: steps.check.outputs.available == 'true' && steps.cursor.outputs.agent_id != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ‚ö° Cursor Agent Spawned

          üÜî **Agent ID:** \`${{ steps.cursor.outputs.agent_id }}\`
          üîó **Monitor:** [cursor.com/agents](https://cursor.com/agents)
          
          The agent will analyze the issue and create a PR."

      - name: Post API Key Missing
        if: steps.check.outputs.available == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ö†Ô∏è CURSOR_API_KEY not configured."

  invoke-sage:
    name: Invoke Sage
    if: |
      github.event.issue.pull_request == null && 
      contains(github.event.comment.body, '/sage')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Trigger Sage
        env:
          GH_TOKEN: ${{ github.token }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          QUERY=$(echo "$COMMENT_BODY" | sed 's|/sage[[:space:]]*||')
          gh workflow run ecosystem-sage.yml \
            -f query="$QUERY" \
            -f context_type="issue" \
            -f context_id="${{ github.event.issue.number }}"
          
          gh issue comment ${{ github.event.issue.number }} --body "üßô Sage workflow triggered. Response coming soon..."
