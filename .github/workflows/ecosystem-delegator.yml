name: Ecosystem Delegator

# Handles delegation commands in issue comments:
# - /jules - delegate to Google Jules
# - /cursor - delegate to Cursor agent
# - @claude - delegate to Claude

on:
  issue_comment:
    types: [created]
  
  # Enterprise Reusable Workflow
  workflow_call:
    inputs:
      comment_body:
        description: 'The comment that triggered delegation'
        required: true
        type: string
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      issue_title:
        description: 'Issue title'
        required: false
        type: string
      issue_body:
        description: 'Issue body/description'
        required: false
        type: string
      repository:
        description: 'Repository owner/name'
        required: true
        type: string
      default_branch:
        description: 'Default branch of the target repository'
        required: false
        default: 'main'
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      GOOGLE_JULES_API_KEY:
        required: false
      CURSOR_API_KEY:
        required: false
      ANTHROPIC_API_KEY:
        required: false

  # Manual/On-call trigger
  workflow_dispatch:
    inputs:
      comment_body:
        description: 'Command (e.g. /jules fix this)'
        required: true
        type: string
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      issue_title:
        description: 'Issue title'
        required: false
        type: string
      issue_body:
        description: 'Issue body/description'
        required: false
        type: string
      repository:
        description: 'Repository'
        required: true
        type: string
      default_branch:
        description: 'Default branch of the target repository'
        default: 'main'
        type: string

env:
  TARGET_REPO: ${{ inputs.repository || github.repository }}
  TARGET_ISSUE: ${{ inputs.issue_number || github.event.issue.number }}
  ISSUE_TITLE: ${{ inputs.issue_title || github.event.issue.title }}
  ISSUE_BODY: ${{ inputs.issue_body || github.event.issue.body }}
  COMMENT_BODY: ${{ inputs.comment_body || github.event.comment.body }}

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # ============================================
  # Jules/Cursor delegation
  # ============================================
  delegate-command:
    name: Delegate to Jules/Cursor
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request == null && (contains(github.event.comment.body, '/jules') || contains(github.event.comment.body, '/cursor'))) ||
      (github.event_name == 'workflow_call' && (contains(inputs.comment_body, '/jules') || contains(inputs.comment_body, '/cursor'))) ||
      (github.event_name == 'workflow_dispatch' && (contains(inputs.comment_body, '/jules') || contains(inputs.comment_body, '/cursor')))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          
      - name: Delegate Issue Command
        uses: jbcom/control-center/.github/actions/agentic-issue-triage@main
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          cursor_api_key: ${{ secrets.CURSOR_API_KEY }}
          comment_body: ${{ env.COMMENT_BODY }}
          issue_number: ${{ env.TARGET_ISSUE }}
          repository: ${{ env.TARGET_REPO }}
          default_branch: ${{ inputs.default_branch || github.event.repository.default_branch || 'main' }}

  # ============================================
  # Claude delegation (@claude in issues)
  # ============================================
  delegate-claude:
    name: Delegate to Claude
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request == null && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'workflow_call' && contains(inputs.comment_body, '@claude')) ||
      (github.event_name == 'workflow_dispatch' && contains(inputs.comment_body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ env.TARGET_REPO }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Run Claude on Issue
        uses: anthropics/claude-code-action@28f83620103c48a57093dcc2837eec89e036bb9f # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "*"
          allowed_tools: "Edit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(node:*),Bash(npm:*)"
          direct_prompt: |
            Issue in ${{ env.TARGET_REPO }}: #${{ env.TARGET_ISSUE }}
            
            Title: ${{ env.ISSUE_TITLE }}
            
            Description:
            ${{ env.ISSUE_BODY }}
            
            ---
            
            Triggering comment: ${{ env.COMMENT_BODY }}
            
            ---
            
            Analyze the issue and either:
            1. Answer the question if it's a question
            2. Implement a fix if it's a bug
            3. Implement the feature if it's a feature request
            
            Create a PR with your changes.
