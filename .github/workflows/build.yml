name: Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  # Workflow Linting
  lint-workflows:
    name: Lint Workflows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install actionlint
        run: |
          ACTIONLINT_VERSION="1.7.9"
          ACTIONLINT_CHECKSUM="233b280d05e100837f4af1433c7b40a5dcb306e3aa68fb4f17f8a7f45a7df7b4"
          curl -sL "https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_linux_amd64.tar.gz" -o actionlint.tar.gz
          echo "${ACTIONLINT_CHECKSUM}  actionlint.tar.gz" | sha256sum -c
          tar xz -C /tmp actionlint < actionlint.tar.gz
          sudo mv /tmp/actionlint /usr/local/bin/
          rm actionlint.tar.gz

      - name: Lint workflows
        run: actionlint -ignore 'SC2086' -ignore 'SC2129' -ignore 'SC2016' -ignore 'SC2001' -color

  # Validate Config
  validate-config:
    name: Validate Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate JSON configs
        run: |
          jq empty repo-config.json
          jq empty agentic.config.json
          echo "✅ All configs valid"

  # Go Lint
  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true
      
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.7.2
          args: --timeout=5m

  # Go Test with Coverage
  go-test:
    name: Go Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true
      
      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      
      - name: Coverage report
        run: |
          go tool cover -func=coverage.out | tee coverage.txt
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "## Test Coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "❌ Coverage below 70%: $COVERAGE%"
            exit 1
          fi
          echo "✅ Coverage: $COVERAGE%"
      
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.out
          fail_ci_if_error: false

  # Go Build
  go-build:
    name: Go Build
    runs-on: ubuntu-latest
    needs: [go-lint, go-test]
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true
      
      - name: Build binary
        run: go build -v ./cmd/control-center
      
      - name: Verify binary
        run: ./control-center version

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: control-center
          path: control-center

  # Docker Build (main branch only)
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [go-build]
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Summary
  summary:
    name: Build Summary
    needs: [lint-workflows, validate-config, go-lint, go-test, go-build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report
        run: |
          {
            echo "## Build & Test Results"
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
            echo "| Lint Workflows | ${{ needs.lint-workflows.result == 'success' && '✅' || '❌' }} |"
            echo "| Validate Config | ${{ needs.validate-config.result == 'success' && '✅' || '❌' }} |"
            echo "| Go Lint | ${{ needs.go-lint.result == 'success' && '✅' || '❌' }} |"
            echo "| Go Test | ${{ needs.go-test.result == 'success' && '✅' || '❌' }} |"
            echo "| Go Build | ${{ needs.go-build.result == 'success' && '✅' || '❌' }} |"
          } >> "$GITHUB_STEP_SUMMARY"
          
          if [ "${{ needs.lint-workflows.result }}" != "success" ] || \
             [ "${{ needs.validate-config.result }}" != "success" ] || \
             [ "${{ needs.go-lint.result }}" != "success" ] || \
             [ "${{ needs.go-test.result }}" != "success" ] || \
             [ "${{ needs.go-build.result }}" != "success" ]; then
            echo "❌ Build failed"
            exit 1
          fi
          echo "✅ All checks passed"
