name: Ecosystem Fixer

# CI Failure Resolution Pipeline
# 
# SECURITY: This workflow does NOT checkout untrusted code.
# Instead, it analyzes failures via API and delegates to AI agents
# that run in their own sandboxed environments.
#
# Pattern: Privileged workflow_run â†’ API analysis â†’ External agent delegation

on:
  workflow_run:
    workflows: ["CI", "Build", "Test", "Lint"]
    types: [completed]
    branches-ignore: [main]
  
  # Enterprise Reusable Workflow
  workflow_call:
    inputs:
      run_id:
        description: 'Workflow run ID that failed'
        required: true
        type: string
      repository:
        description: 'Repository owner/name'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      GOOGLE_JULES_API_KEY:
        required: false
      ANTHROPIC_API_KEY:
        required: false

  # Manual/On-call trigger
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID'
        required: true
        type: string
      repository:
        description: 'Repository'
        required: true
        type: string
      branch:
        description: 'Branch'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  actions: read
  issues: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ANALYZE: Extract failure context via API (no code checkout)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze:
    name: Analyze Failure
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      is_fork: ${{ steps.context.outputs.is_fork }}
      pr_number: ${{ steps.context.outputs.pr_number }}
      failure_summary: ${{ steps.context.outputs.failure_summary }}
      target_repo: ${{ steps.context.outputs.target_repo }}
      target_branch: ${{ steps.context.outputs.target_branch }}
      target_run_id: ${{ steps.context.outputs.target_run_id }}
    steps:
      - name: Extract failure context via API
        id: context
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          INPUT_REPO: ${{ inputs.repository }}
          INPUT_BRANCH: ${{ inputs.branch }}
          INPUT_RUN_ID: ${{ inputs.run_id }}
        run: |
          # Resolve target from inputs or event
          TARGET_REPO="${INPUT_REPO:-${{ github.repository }}}"
          TARGET_BRANCH="${INPUT_BRANCH:-${{ github.event.workflow_run.head_branch }}}"
          TARGET_RUN_ID="${INPUT_RUN_ID:-${{ github.event.workflow_run.id }}}"
          
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "target_run_id=$TARGET_RUN_ID" >> $GITHUB_OUTPUT
          
          # Security: Check if fork PR
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            HEAD_REPO="${{ github.event.workflow_run.head_repository.full_name }}"
            BASE_REPO="${{ github.event.workflow_run.repository.full_name }}"
            
            if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
              echo "âš ï¸ Fork PR detected: $HEAD_REPO â†’ $BASE_REPO"
              echo "is_fork=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "is_fork=false" >> $GITHUB_OUTPUT
          
          # Get PR number from branch
          PR_NUM=$(gh pr list --repo "$TARGET_REPO" --head "$TARGET_BRANCH" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          
          # Get failure logs via API (no checkout needed)
          echo "ğŸ“‹ Fetching failure logs for run $TARGET_RUN_ID..."
          LOGS=$(gh run view "$TARGET_RUN_ID" --repo "$TARGET_REPO" --log-failed 2>&1 | head -500 || echo "Could not fetch logs")
          
          # Create summary (escape for JSON)
          SUMMARY=$(echo "$LOGS" | jq -Rs '.')
          echo "failure_summary=$SUMMARY" >> $GITHUB_OUTPUT
          
          echo "âœ… Analysis complete"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DELEGATE: Send to AI agent via API (agent runs in own sandbox)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  delegate-jules:
    name: Delegate to Jules
    needs: analyze
    if: |
      needs.analyze.outputs.is_fork != 'true' &&
      needs.analyze.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Create Jules session via API
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          TARGET_REPO: ${{ needs.analyze.outputs.target_repo }}
          TARGET_BRANCH: ${{ needs.analyze.outputs.target_branch }}
          FAILURE_SUMMARY: ${{ needs.analyze.outputs.failure_summary }}
          PR_NUM: ${{ needs.analyze.outputs.pr_number }}
        run: |
          if [ -z "$GOOGLE_JULES_API_KEY" ]; then
            echo "â­ï¸ No Jules API key configured, skipping"
            exit 0
          fi
          
          # Extract repo name for Jules source context
          REPO_NAME="${TARGET_REPO##*/}"
          OWNER="${TARGET_REPO%%/*}"
          
          # Build prompt from failure context (using heredoc for safety)
          PROMPT=$(cat <<PROMPT_EOF
          Fix the CI failure in this repository.
          
          Branch: $TARGET_BRANCH
          PR: #$PR_NUM
          
          Failure logs:
          $(echo "$FAILURE_SUMMARY" | head -200)
          
          Instructions:
          1. Analyze the failure logs
          2. Identify the root cause
          3. Make the minimal fix needed
          4. Ensure tests pass
          PROMPT_EOF
          )

          # Create Jules session via API (Jules runs in its own sandbox)
          echo "ğŸ¤– Creating Jules session..."
          RESPONSE=$(curl -sf -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg source "sources/github/$OWNER/$REPO_NAME" \
              --arg branch "$TARGET_BRANCH" \
              '{
                prompt: $prompt,
                sourceContext: {
                  source: $source,
                  githubRepoContext: {
                    startingBranch: $branch
                  }
                },
                automationMode: "AUTO_CREATE_PR"
              }')" 2>&1) || {
            echo "âš ï¸ Jules API call failed: $RESPONSE"
            exit 0
          }
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.name // empty')
          if [ -n "$SESSION_ID" ]; then
            echo "âœ… Jules session created: $SESSION_ID"
          else
            echo "âš ï¸ Could not extract session ID"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FALLBACK: Claude via GitHub Action (uses action's sandbox)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  delegate-claude:
    name: Delegate to Claude
    needs: [analyze, delegate-jules]
    if: |
      always() &&
      needs.analyze.outputs.is_fork != 'true' &&
      needs.analyze.outputs.pr_number != '' &&
      (needs.delegate-jules.result == 'failure' || needs.delegate-jules.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Post Claude fix request
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TARGET_REPO: ${{ needs.analyze.outputs.target_repo }}
          TARGET_BRANCH: ${{ needs.analyze.outputs.target_branch }}
          FAILURE_SUMMARY: ${{ needs.analyze.outputs.failure_summary }}
          PR_NUM: ${{ needs.analyze.outputs.pr_number }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "â­ï¸ No Anthropic API key configured, skipping"
            exit 0
          fi
          
          # Post comment to PR requesting Claude fix
          # Claude Code Action monitors for @claude mentions
          COMMENT_BODY=$(cat <<COMMENT_EOF
          @claude Please fix the CI failure on this PR.
          
          **Branch:** \`$TARGET_BRANCH\`
          
          **Failure Summary:**
          \`\`\`
          $(echo "$FAILURE_SUMMARY" | jq -r '.' 2>/dev/null | head -100 || echo "$FAILURE_SUMMARY" | head -100)
          \`\`\`
          
          Please analyze the logs, identify the root cause, and push a fix.
          COMMENT_EOF
          )
          
          gh pr comment "$PR_NUM" --repo "$TARGET_REPO" --body "$COMMENT_BODY"
          echo "âœ… Posted Claude fix request to PR #$PR_NUM"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFY: Report status for fork PRs (cannot auto-fix)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-fork:
    name: Notify Fork PR
    needs: analyze
    if: needs.analyze.outputs.is_fork == 'true' && needs.analyze.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Post security notice
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TARGET_REPO: ${{ needs.analyze.outputs.target_repo }}
          PR_NUM: ${{ needs.analyze.outputs.pr_number }}
        run: |
          gh pr comment "$PR_NUM" --repo "$TARGET_REPO" --body "$(cat <<'NOTICE_EOF'
          âš ï¸ **Auto-fix unavailable for fork PRs**
          
          This PR originates from a fork. For security reasons, automatic CI fixes are disabled.
          
          Please fix the CI failure manually and push your changes.
          NOTICE_EOF
          )"
