name: Ecosystem Fixer

# CI failure auto-resolution

on:
  workflow_run:
    workflows: ["CI", "Build", "Test", "Lint"]
    types: [completed]
    branches-ignore: [main]

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  fix:
    name: Auto-resolve CI Failures
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Get Failure Logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          LOGS=$(gh run view "$RUN_ID" --log-failed 2>&1 | tail -100)
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for Jules Key
        id: check
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          if [[ -n "$GOOGLE_JULES_API_KEY" ]]; then
            echo "jules=true" >> $GITHUB_OUTPUT
          else
            echo "jules=false" >> $GITHUB_OUTPUT
          fi

      - name: Spawn Jules for Fix
        if: steps.check.outputs.jules == 'true'
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          FAILURE_LOGS: ${{ steps.logs.outputs.logs }}
          REPOSITORY: ${{ github.repository }}
        run: |
          set -eo pipefail
          JSON_PAYLOAD=$(jq -n \
            --arg branch "$HEAD_BRANCH" \
            --arg logs "$FAILURE_LOGS" \
            --arg repo "$REPOSITORY" \
            '
            {
              "prompt": ("CI workflow failed on branch " + $branch + ".\n\nError logs:\n" + $logs + "\n\nPlease analyze the errors and fix them. Common issues:\n- TypeScript type errors\n- ESLint/Biome linting failures\n- Missing dependencies\n- Test failures\n\nFix the issues and commit the changes."),
              "sourceContext": {
                "source": ("sources/github/" + ($repo | split("/")[0]) + "/" + ($repo | split("/")[1])),
                "githubRepoContext": {
                  "startingBranch": $branch
                }
              },
              "automationMode": "INTERACTIVE"
            }')

          curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

      - name: Report No Auto-fix
        if: steps.check.outputs.jules == 'false'
        run: |
          echo "::warning::GOOGLE_JULES_API_KEY not set - cannot auto-fix CI failures"
