name: Ecosystem Fixer

# CI Failure Resolution Pipeline:
# 1. Try agentic-ci-resolution action (Jules/Cursor)
# 2. Fallback to Claude if that fails

on:
  workflow_run:
    workflows: ["CI", "Build", "Test", "Lint"]
    types: [completed]
    branches-ignore: [main]
  
  # Enterprise Reusable Workflow
  workflow_call:
    inputs:
      run_id:
        description: 'Workflow run ID that failed'
        required: true
        type: string
      repository:
        description: 'Repository owner/name'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      GOOGLE_JULES_API_KEY:
        required: false
      ANTHROPIC_API_KEY:
        required: false

  # Manual/On-call trigger
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID'
        required: true
        type: string
      repository:
        description: 'Repository'
        required: true
        type: string
      branch:
        description: 'Branch'
        required: true
        type: string

env:
  TARGET_REPO: ${{ inputs.repository || github.repository }}
  TARGET_RUN_ID: ${{ inputs.run_id || github.event.workflow_run.id }}
  TARGET_BRANCH: ${{ inputs.branch || github.event.workflow_run.head_branch }}

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  fix:
    name: Auto-resolve CI Failures
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.agentic.outcome }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          
      - name: Agentic CI Resolution
        id: agentic
        continue-on-error: true
        uses: jbcom/control-center/.github/actions/agentic-ci-resolution@main
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          workflow_run_id: ${{ env.TARGET_RUN_ID }}
          branch: ${{ env.TARGET_BRANCH }}
          repository: ${{ env.TARGET_REPO }}

  claude-fallback:
    name: Claude CI Fix
    needs: fix
    # Only run if the fix job actually ran (not skipped) and didn't succeed
    if: always() && needs.fix.result != 'skipped' && needs.fix.outputs.result != 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Get failure logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          gh run view ${{ env.TARGET_RUN_ID }} --repo ${{ env.TARGET_REPO }} --log-failed > /tmp/ci_failure.log 2>&1 || true
          echo "log_file=/tmp/ci_failure.log" >> $GITHUB_OUTPUT

      - name: Claude Fix
        uses: anthropics/claude-code-action@28f83620103c48a57093dcc2837eec89e036bb9f # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "*"
          allowed_tools: "Edit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(node:*),Bash(npm:*),Bash(cat:*)"
          direct_prompt: |
            Fix the CI failure in ${{ env.TARGET_REPO }}. The failure log is at /tmp/ci_failure.log
            
            1. Read the failure log
            2. Identify the root cause
            3. Fix the code
            4. Commit and push
            
            Branch: ${{ env.TARGET_BRANCH }}
