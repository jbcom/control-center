name: Ecosystem Fixer

# CI failure auto-resolution

on:
  workflow_run:
    workflows: ["CI", "Build", "Test", "Lint"]
    types: [completed]
    branches-ignore: [main]

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  fix:
    name: Auto-resolve CI Failures
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Get Failure Logs
        id: logs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LOGS=$(gh run view ${{ github.event.workflow_run.id }} --log-failed 2>&1 | tail -100)
          echo "logs<<EOF" >> $GITHUB_OUTPUT
          echo "$LOGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for Jules Key
        id: check
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          if [[ -n "$GOOGLE_JULES_API_KEY" ]]; then
            echo "jules=true" >> $GITHUB_OUTPUT
          else
            echo "jules=false" >> $GITHUB_OUTPUT
          fi

      - name: Spawn Jules for Fix
        if: steps.check.outputs.jules == 'true'
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          TASK="CI workflow failed on branch ${{ github.event.workflow_run.head_branch }}.

          Error logs:
          ${{ steps.logs.outputs.logs }}

          Please analyze the errors and fix them. Common issues:
          - TypeScript type errors
          - ESLint/Biome linting failures
          - Missing dependencies
          - Test failures
          
          Fix the issues and commit the changes."
          
          curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "$TASK" \
              --arg repo "${{ github.repository }}" \
              --arg branch "${{ github.event.workflow_run.head_branch }}" \
              '{
                prompt: $task,
                sourceContext: {
                  source: ("sources/github/" + ($repo | split("/")[0]) + "/" + ($repo | split("/")[1])),
                  githubRepoContext: { startingBranch: $branch }
                },
                automationMode: "INTERACTIVE"
              }')"

      - name: Report No Auto-fix
        if: steps.check.outputs.jules == 'false'
        run: |
          echo "::warning::GOOGLE_JULES_API_KEY not set - cannot auto-fix CI failures"
