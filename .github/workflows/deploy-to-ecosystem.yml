# Deployment to Ecosystem Repositories
# This workflow deploys CI/CD changes from this hub to managed repos

name: Deploy to Ecosystem

on:
  push:
    branches: [main]
    paths:
      - 'templates/**'
      - 'configs/**'
      - 'tools/deploy/**'
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated list of repos to deploy to (empty = all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (create PRs but dont auto-merge)'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  prepare-deployment:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      target_repos: ${{ steps.get-repos.outputs.repos }}
      deployment_id: ${{ steps.create-deployment.outputs.deployment_id }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Get target repositories
        id: get-repos
        run: |
          if [ -n "${{ github.event.inputs.repos }}" ]; then
            echo "repos=${{ github.event.inputs.repos }}" >> $GITHUB_OUTPUT
          else
            # Get all repos from ecosystem state
            python3 <<EOF
          import json
          state = json.load(open('ecosystem/ECOSYSTEM_STATE.json'))
          repos = list(state['repositories'].keys())
          print(f"repos={','.join(repos)}")
          EOF
          fi
      
      - name: Create deployment record
        id: create-deployment
        run: |
          deployment_id="deploy-$(date +%Y%m%d-%H%M%S)"
          echo "deployment_id=$deployment_id" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deployment ID: $deployment_id"

  deploy-workflows:
    name: Deploy to ${{ matrix.repo }}
    needs: prepare-deployment
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(format('[{0}]', needs.prepare-deployment.outputs.target_repos)) }}
      fail-fast: false
      max-parallel: 3
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install PyGithub pyyaml
      
      - name: Deploy workflow to ${{ matrix.repo }}
        env:
          GITHUB_TOKEN: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
        run: |
          python3 tools/deploy/deploy_workflow.py \
            --repo "jbcom/${{ matrix.repo }}" \
            --deployment-id "${{ needs.prepare-deployment.outputs.deployment_id }}" \
            $( [ "$DRY_RUN" = "true" ] && echo "--dry-run" )
      
      - name: Verify deployment
        if: github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
        run: |
          python3 tools/deploy/verify_deployment.py \
            --repo "jbcom/${{ matrix.repo }}" \
            --deployment-id "${{ needs.prepare-deployment.outputs.deployment_id }}"

  report-deployment:
    name: Report Deployment Results
    needs: [prepare-deployment, deploy-workflows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v5
      
      - name: Generate deployment report
        run: |
          echo "# Deployment Report" > deployment-report.md
          echo "" >> deployment-report.md
          echo "**Deployment ID:** ${{ needs.prepare-deployment.outputs.deployment_id }}" >> deployment-report.md
          echo "**Date:** $(date)" >> deployment-report.md
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'true' }}" >> deployment-report.md
          echo "" >> deployment-report.md
          echo "## Results" >> deployment-report.md
          # TODO: Aggregate results from matrix jobs
      
      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ needs.prepare-deployment.outputs.deployment_id }}
          path: deployment-report.md
