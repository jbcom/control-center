name: Multi-AI PR Review & Collaboration

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  checks: read
  id-token: write

jobs:
  # ============================================================================
  # PHASE 1: Initial Claude Code Review (Anthropic)
  # ============================================================================
  claude-review:
    name: Claude Code Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Initial Review
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Perform a comprehensive code review of this PR:
            
            **Focus Areas:**
            1. Code quality and best practices
            2. Security vulnerabilities
            3. Performance implications
            4. Architecture consistency with project patterns
            5. Documentation completeness
            6. Test coverage
            
            **Repository Context:**
            - This is the jbcom-control-center managing Python ecosystem
            - Follow CalVer versioning (YYYY.MM.BUILD)
            - Auto-release on main branch push
            - See .ruler/AGENTS.md for coding standards
            
            **Output Format:**
            - Use GitHub review comments for line-specific issues
            - Create summary comment with severity levels
            - Tag issues as: ðŸ”´ Critical, ðŸŸ¡ Warning, ðŸ”µ Suggestion
            - Include code snippets for proposed fixes
          claude_args: |
            --model claude-opus-4-20250514
            --max-turns 15
            --allowedTools "Read,Grep,Glob,LS,Bash(git:*)"
            --system-prompt "You are an expert code reviewer for the jbcom Python ecosystem. Follow the guidelines in .ruler/AGENTS.md. Be thorough but constructive."
  
  # ============================================================================
  # PHASE 2: Amazon Q Developer Review
  # ============================================================================
  amazonq-review:
    name: Amazon Q Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: claude-review
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Amazon Q Review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_JBCOM_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "/q review

          Focus on AWS infrastructure patterns, security best practices, and cloud architecture."

  # ============================================================================
  # PHASE 3: OpenAI GPT-4 Review (Third Perspective)
  # ============================================================================
  openai-review:
    name: OpenAI GPT-4 Review
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    needs: claude-review
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: OpenAI Code Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Note: OpenAI review can be integrated via custom script or third-party action
            // For now, this is a placeholder for future OpenAI GPT-4 integration
            // Alternative: Use GitHub Copilot for code review
            console.log('OpenAI review placeholder - can integrate codex-action here');
            core.info('Consider GitHub Copilot or custom OpenAI integration');

  # ============================================================================
  # PHASE 4: Claude Collaboration & Synthesis
  # ============================================================================
  claude-synthesis:
    name: Claude Synthesis & Collaboration
    runs-on: ubuntu-latest
    needs: [claude-review, amazonq-review, openai-review]
    if: always() && !cancelled()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Claude Synthesize Reviews
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review all AI feedback on this PR and synthesize a comprehensive action plan:
            
            **Your Task:**
            1. Read all review comments from Claude, Amazon Q, and DiffGuard
            2. Identify common themes and critical issues
            3. Resolve conflicting suggestions
            4. Create prioritized action items
            5. Post a synthesis comment with:
               - Executive Summary
               - Critical Issues (must fix)
               - Recommended Improvements
               - Optional Enhancements
               - Consensus vs Disagreements
            
            PR: #${{ github.event.pull_request.number }}
            Repository: ${{ github.repository }}
          claude_args: |
            --model claude-opus-4-20250514
            --max-turns 10
            --allowedTools "Read,Grep,LS"

  # ============================================================================
  # PHASE 5: Auto-Healing (Fix Critical Issues)
  # ============================================================================
  auto-heal:
    name: Auto-Heal Critical Issues
    runs-on: ubuntu-latest
    needs: claude-synthesis
    if: |
      github.event_name == 'pull_request' &&
      !startsWith(github.head_ref, 'claude-auto-heal-')
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_JBCOM_TOKEN }}
      
      - name: Setup git identity
        run: |
          git config user.email "claude[bot]@users.noreply.github.com"
          git config user.name "claude[bot]"
      
      - name: Claude Auto-Heal
        id: heal
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Auto-heal critical issues found in reviews:
            
            **Your Task:**
            1. Review all ðŸ”´ Critical issues from the synthesis
            2. Fix ONLY critical issues that are:
               - Linting errors
               - Import errors
               - Type errors
               - Security vulnerabilities
               - Breaking changes
            3. DO NOT fix:
               - Architecture decisions
               - Feature implementations
               - Stylistic preferences
            4. Commit fixes with descriptive messages
            5. Comment on PR with what was fixed
            
            PR: #${{ github.event.pull_request.number }}
            Branch: ${{ github.head_ref }}
          claude_args: |
            --model claude-opus-4-20250514
            --max-turns 20
            --allowedTools "Read,Write,MultiEdit,StrReplace,Grep,Glob,LS,Bash(git:*),Bash(ruff:*),Bash(mypy:*),Bash(pytest:*)"
      
      - name: Push auto-heal fixes
        if: steps.heal.outputs.made_changes == 'true'
        run: |
          git push origin ${{ github.head_ref }}

  # ============================================================================
  # PHASE 6: Interactive Claude Responses
  # ============================================================================
  claude-interactive:
    name: Claude Interactive Responses
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Claude Respond
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --max-turns 15
            --allowedTools "Read,Write,StrReplace,Grep,Glob,LS,Bash(git:*),Bash(gh:*)"

  # ============================================================================
  # PHASE 7: Amazon Q Interactive Responses
  # ============================================================================
  amazonq-interactive:
    name: Amazon Q Interactive
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/q')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '/q'))
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Amazon Q will respond via GitHub App integration');
            // Amazon Q responds automatically via its GitHub App

  # ============================================================================
  # PHASE 8: CI Failure Auto-Fix
  # ============================================================================
  ci-failure-autofix:
    name: Auto-Fix CI Failures
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-auto-fix-ci-')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_JBCOM_TOKEN }}
      
      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            
            return {
              runUrl: run.data.html_url,
              failedJobs: jobs.data.jobs.filter(j => j.conclusion === 'failure').map(j => j.name)
            };
      
      - name: Claude Fix CI
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Fix CI failures:
            
            Failed Run: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            Failed Jobs: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}
            PR: #${{ github.event.workflow_run.pull_requests[0].number }}
            
            **Fix these CI failures and commit the fixes.**
          claude_args: |
            --model claude-opus-4-20250514
            --max-turns 15
            --allowedTools "Read,Write,MultiEdit,StrReplace,Grep,Bash(git:*),Bash(pytest:*),Bash(ruff:*),Bash(mypy:*)"
