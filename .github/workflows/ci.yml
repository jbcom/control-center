# Master CI/CD orchestration workflow
#
# Uses reusable workflows with stacked matrices:
# - Package x Python version for testing
# - Package x Target repo for sync/release/docs
#
# On PR:   Test + Lint
# On main: Test + Lint + Sync + Release + Docs + Enforce Standards

name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      enforce_standards:
        description: 'Run standards enforcement'
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # MATRIX DEFINITION
  # ============================================
  matrix:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set.outputs.packages }}
      test-matrix: ${{ steps.set.outputs.test-matrix }}
      deploy-matrix: ${{ steps.set.outputs.deploy-matrix }}
    steps:
      - id: set
        run: |
          # Package definitions - single line for GITHUB_OUTPUT compatibility
          PACKAGES='[{"name":"extended-data-types","pypi":"extended-data-types","repo":"jbcom/extended-data-types","deps":[]},{"name":"lifecyclelogging","pypi":"lifecyclelogging","repo":"jbcom/lifecyclelogging","deps":["extended-data-types"]},{"name":"directed-inputs-class","pypi":"directed-inputs-class","repo":"jbcom/directed-inputs-class","deps":["extended-data-types"]},{"name":"vendor-connectors","pypi":"cloud-connectors","repo":"jbcom/vendor-connectors","deps":["extended-data-types","lifecyclelogging"]}]'
          
          PYTHON_VERSIONS='["3.9","3.13"]'
          
          # Test matrix: package x python
          TEST_MATRIX=$(echo "$PACKAGES" | jq -c --argjson py "$PYTHON_VERSIONS" '{package: [.[].name], python: $py}')
          
          # Deploy matrix: packages with metadata
          DEPLOY_MATRIX=$(echo "$PACKAGES" | jq -c '{include: .}')
          
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "test-matrix=$TEST_MATRIX" >> $GITHUB_OUTPUT
          echo "deploy-matrix=$DEPLOY_MATRIX" >> $GITHUB_OUTPUT

  # ============================================
  # TEST (package x python matrix)
  # ============================================
  test:
    needs: matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.test-matrix) }}
    uses: ./.github/workflows/reusable-test.yml
    with:
      package: ${{ matrix.package }}
      python-version: ${{ matrix.python }}

  # ============================================
  # LINT (once)
  # ============================================
  lint:
    uses: ./.github/workflows/reusable-lint.yml

  # ============================================
  # SYNC TO PUBLIC REPOS (main only)
  # ============================================
  sync:
    needs: [matrix, test, lint, enforce]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      fail-fast: false
      max-parallel: 1  # Sync in order
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    uses: ./.github/workflows/reusable-sync.yml
    with:
      package: ${{ matrix.name }}
      target-repo: ${{ matrix.repo }}
    secrets:
      token: ${{ secrets.CI_GITHUB_TOKEN }}

  # ============================================
  # RELEASE TO PYPI (main only, after sync)
  # ============================================
  release:
    needs: [matrix, sync]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      fail-fast: false
      max-parallel: 1  # Release in dependency order
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    uses: ./.github/workflows/reusable-release.yml
    with:
      package: ${{ matrix.name }}
      pypi-name: ${{ matrix.pypi }}
    secrets:
      pypi-token: ${{ secrets.PYPI_TOKEN }}

  # ============================================
  # DEPLOY DOCS (main only, after release)
  # ============================================
  docs:
    needs: [matrix, release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    uses: ./.github/workflows/reusable-docs.yml
    with:
      package: ${{ matrix.name }}
      target-repo: ${{ matrix.repo }}
    secrets:
      token: ${{ secrets.CI_GITHUB_TOKEN }}

  # ============================================
  # ENFORCE STANDARDS (main or manual)
  # ============================================
  enforce:
    needs: [matrix]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && inputs.enforce_standards)
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    uses: ./.github/workflows/reusable-enforce-standards.yml
    with:
      repo: ${{ matrix.repo }}
    secrets:
      token: ${{ secrets.CI_GITHUB_TOKEN }}
