# Master CI/CD orchestration workflow
#
# Uses composite actions with matrices:
# - Package x Python version for testing
# - Package x Target repo for sync/release/docs
#
# On PR:   Test + Lint
# On main: Test + Lint + Version + Sync + Release + Docs + Enforce Standards
#
# VERSIONING: pycalver generates ONE version at start, ALL packages use it

name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      enforce_standards:
        description: 'Run standards enforcement'
        type: boolean
        default: false

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write
  pages: write
  attestations: write

jobs:
  # ============================================
  # MATRIX DEFINITION
  # ============================================
  matrix:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set.outputs.packages }}
      test-matrix: ${{ steps.set.outputs.test-matrix }}
      deploy-matrix: ${{ steps.set.outputs.deploy-matrix }}
    steps:
      - id: set
        run: |
          PACKAGES='[{"name":"extended-data-types","pypi":"extended-data-types","repo":"jbcom/extended-data-types","deps":[]},{"name":"lifecyclelogging","pypi":"lifecyclelogging","repo":"jbcom/lifecyclelogging","deps":["extended-data-types"]},{"name":"directed-inputs-class","pypi":"directed-inputs-class","repo":"jbcom/directed-inputs-class","deps":["extended-data-types"]},{"name":"vendor-connectors","pypi":"vendor-connectors","repo":"jbcom/vendor-connectors","deps":["extended-data-types","lifecyclelogging"]}]'
          
          PYTHON_VERSIONS='["3.9","3.13"]'
          
          TEST_MATRIX=$(echo "$PACKAGES" | jq -c --argjson py "$PYTHON_VERSIONS" '{package: [.[].name], python: $py}')
          DEPLOY_MATRIX=$(echo "$PACKAGES" | jq -c '{include: .}')
          
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "test-matrix=$TEST_MATRIX" >> $GITHUB_OUTPUT
          echo "deploy-matrix=$DEPLOY_MATRIX" >> $GITHUB_OUTPUT

  # ============================================
  # TEST (package x python matrix)
  # ============================================
  test:
    needs: matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.test-matrix) }}
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/test-package
        with:
          package: ${{ matrix.package }}
          python-version: ${{ matrix.python }}

  # ============================================
  # LINT (once)
  # ============================================
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/lint-python
        with:
          paths: packages/

  # ============================================
  # VERSION - Generate ONE version for ALL packages (main only)
  # ============================================
  version:
    needs: [test, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7

      - name: Bump version with pycalver
        id: bump
        run: |
          echo "Current version:"
          grep 'current_version' pyproject.toml | head -1
          
          uvx --with setuptools pycalver bump --release final
          
          NEW_VERSION=$(grep 'current_version' pyproject.toml | head -1 | sed 's/.*= *"\([^"]*\)".*/\1/')
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          echo "=== Updated files ==="
          git diff --name-only
          
          echo "=== Package versions ==="
          grep -r "__version__" packages/*/src/*/__init__.py || true

      - name: Upload versioned source
        uses: actions/upload-artifact@v5
        with:
          name: versioned-source
          path: |
            packages/
            pyproject.toml
          retention-days: 1

  # ============================================
  # SYNC TO PUBLIC REPOS (main only, after version)
  # ============================================
  sync:
    needs: [matrix, version]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    steps:
      - uses: actions/checkout@v6

      - name: Download versioned source
        uses: actions/download-artifact@v6
        with:
          name: versioned-source
          path: source

      - uses: ./.github/actions/sync-package
        with:
          package: ${{ matrix.name }}
          target-repo: ${{ matrix.repo }}
          version: ${{ needs.version.outputs.version }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          source-path: source

  # ============================================
  # RELEASE TO PYPI (main only, after sync)
  # ============================================
  release:
    needs: [matrix, version, sync]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    steps:
      - uses: actions/checkout@v6

      - name: Download versioned source
        uses: actions/download-artifact@v6
        with:
          name: versioned-source
          path: source

      - uses: ./.github/actions/release-package
        with:
          package: ${{ matrix.name }}
          pypi-name: ${{ matrix.pypi }}
          version: ${{ needs.version.outputs.version }}
          pypi-token: ${{ secrets.PYPI_TOKEN }}
          source-path: source

  # ============================================
  # DEPLOY DOCS (main only, after release)
  # ============================================
  docs:
    needs: [matrix, version, release]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    steps:
      - uses: actions/checkout@v6

      - name: Download versioned source
        uses: actions/download-artifact@v6
        with:
          name: versioned-source
          path: source

      - uses: ./.github/actions/deploy-docs
        with:
          package: ${{ matrix.name }}
          target-repo: ${{ matrix.repo }}
          version: ${{ needs.version.outputs.version }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          source-path: source

  # ============================================
  # ENFORCE STANDARDS (main or manual, non-blocking)
  # ============================================
  enforce:
    needs: [matrix, test, lint]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && inputs.enforce_standards)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.deploy-matrix) }}
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/enforce-standards
        with:
          repo: ${{ matrix.repo }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}
