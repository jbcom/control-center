name: Jules Completion Handler

# This workflow acts as a webhook handler for completed Jules sessions.
# It listens for a `repository_dispatch` event, which can be triggered
# by an external service (like a Google Cloud Function) when a Jules
# session finishes.

on:
  repository_dispatch:
    types: [jules-session-complete]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  handle-completion:
    name: Handle Jules Session Completion
    runs-on: ubuntu-latest
    steps:
      - name: Post Completion Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SESSION_ID: ${{ github.event.client_payload.session_id }}
          OUTCOME: ${{ github.event.client_payload.outcome }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          REPO: ${{ github.repository }}
        run: |
          set -eo pipefail

          COMMENT_TARGET_ARGS=""
          # If an issue number is present, that's always the source of the session.
          if [[ -n "${ISSUE_NUMBER}" ]]; then
            COMMENT_TARGET_ARGS="issue comment ${ISSUE_NUMBER}"
          # If no issue number, the source might have been a PR.
          elif [[ -n "${PR_NUMBER}" ]]; then
            COMMENT_TARGET_ARGS="pr comment ${PR_NUMBER}"
          else
            echo "Error: No source issue or PR number was provided in the payload."
            exit 1
          fi

          JULES_SESSION_URL="https://console.google.com/jules/session/${SESSION_ID}"
          COMMENT_BODY="### âœ… Jules Session Complete

          - **Session:** [${SESSION_ID}](${JULES_SESSION_URL})
          - **Outcome:** \`${OUTCOME}\`
          "

          # If the source was an issue and a PR number is present, the PR is the result.
          if [[ -n "${ISSUE_NUMBER}" && -n "${PR_NUMBER}" ]]; then
            PR_URL="https://github.com/${REPO}/pull/${PR_NUMBER}"
            COMMENT_BODY="${COMMENT_BODY}
          - **Result:** See the generated PR: **[#${PR_NUMBER}](${PR_URL})**"
          fi

          gh ${COMMENT_TARGET_ARGS} --repo "${REPO}" --body "$COMMENT_BODY"
