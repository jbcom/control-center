name: Jules Completion Handler

# This workflow acts as a webhook handler for completed Jules sessions.
# It listens for a `repository_dispatch` event, which can be triggered
# by an external service when a Jules session finishes.

on:
  repository_dispatch:
    types: [jules-session-complete]

# No workflow-level permissions - all permissions defined at job level
permissions: {}

jobs:
  handle-completion:
    name: Handle Jules Session Completion
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Post Completion Comment
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          SESSION_ID: ${{ github.event.client_payload.session_id }}
          OUTCOME: ${{ github.event.client_payload.outcome }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          AGENT_TYPE: ${{ github.event.client_payload.agent_type }}
          PR_URL: ${{ github.event.client_payload.pr_url }}
          SESSION_URL: ${{ github.event.client_payload.session_url }}
          REPO: ${{ github.repository }}
        run: |
          set -eo pipefail

          # Determine emoji based on agent type
          case "${AGENT_TYPE}" in
            "bolt") EMOJI="‚ö°"; AGENT_NAME="Bolt (Performance)" ;;
            "palette") EMOJI="üé®"; AGENT_NAME="Palette (UX)" ;;
            "scribe") EMOJI="üìö"; AGENT_NAME="Scribe (Docs)" ;;
            "sentinel") EMOJI="üõ°Ô∏è"; AGENT_NAME="Sentinel (Security)" ;;
            "bug-fixer") EMOJI="üêõ"; AGENT_NAME="Bug Fixer" ;;
            "cleanup") EMOJI="üßπ"; AGENT_NAME="Cleanup" ;;
            *) EMOJI="ü§ñ"; AGENT_NAME="General" ;;
          esac

          # Determine status icon and action
          case "${OUTCOME}" in
            "success")
              STATUS_ICON="‚úÖ"
              STATUS_TEXT="Completed successfully"
              ;;
            "failure")
              STATUS_ICON="‚ùå"
              STATUS_TEXT="Failed - manual review needed"
              ;;
            "no_changes")
              STATUS_ICON="‚ÑπÔ∏è"
              STATUS_TEXT="No changes needed"
              ;;
            "pr_created")
              STATUS_ICON="üéâ"
              STATUS_TEXT="Pull request created"
              ;;
            *)
              STATUS_ICON="‚ùì"
              STATUS_TEXT="Unknown outcome"
              ;;
          esac

          # Construct the session link. Use a fallback for robustness.
          SESSION_LINK="[${SESSION_ID}](${SESSION_URL:-https://console.cloud.google.com/jules/session/${SESSION_ID}})"

          # Use a heredoc to build the main part of the comment body
          # This is more robust for multiline content in YAML
          COMMENT_BODY=$(cat <<EOF
          ### ${EMOJI} Jules ${AGENT_NAME} Session Complete

          | Field | Value |
          |-------|-------|
          | **Session** | ${SESSION_LINK} |
          | **Agent** | ${AGENT_NAME} |
          | **Outcome** | ${STATUS_ICON} ${STATUS_TEXT} |
          EOF
          )

          # Add PR link if available, ensuring the table format is maintained
          if [[ -n "${PR_URL}" ]]; then
            COMMENT_BODY="${COMMENT_BODY}
          | **Pull Request** | [View PR](${PR_URL}) |"
          fi

          # Add the footer
          COMMENT_BODY="${COMMENT_BODY}

          ---
          > ü§ñ *Automated by Jules*
          >
          > This PR will be automatically reviewed and merged if approved.
          "

          # Post the comment to the appropriate location (PR or Issue)
          if [[ -n "${PR_NUMBER}" ]]; then
            gh pr comment "${PR_NUMBER}" --repo "${REPO}" --body "$COMMENT_BODY"
            gh pr edit "${PR_NUMBER}" --repo "${REPO}" --add-label "jules-pr,auto-triage" || true
            echo "Posted completion comment to PR #${PR_NUMBER}"
          elif [[ -n "${ISSUE_NUMBER}" ]]; then
            gh issue comment "${ISSUE_NUMBER}" --repo "${REPO}" --body "$COMMENT_BODY"
            echo "Posted completion comment to Issue #${ISSUE_NUMBER}"
          else
            echo "::notice::No PR or issue number provided - completion logged only"
            echo "Session completed: ${SESSION_ID} - ${OUTCOME}"
          fi
