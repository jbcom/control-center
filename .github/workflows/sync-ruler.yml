name: Sync AI Agent Instructions (Ruler)

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Target repository"
        required: true
        type: choice
        options:
          # Python packages
          - jbcom/agentic-crew
          - jbcom/ai_game_dev
          - jbcom/directed-inputs-class
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/python-terraform-bridge
          - jbcom/rivers-of-reckoning
          - jbcom/vendor-connectors
          # Node.js / TypeScript packages
          - jbcom/agentic-control
          - jbcom/otter-river-rush
          - jbcom/otterfall
          - jbcom/pixels-pygame-palace
          - jbcom/rivermarsh
          - jbcom/strata
          # Go packages
          - jbcom/port-api
          - jbcom/secretsync
          # Terraform modules
          - jbcom/terraform-github-markdown
          - jbcom/terraform-repository-automation
        default: jbcom/vendor-connectors
      model:
        description: "Ollama Cloud model to use"
        required: true
        type: choice
        options:
          # GLM-4.6:cloud - Current generation (from ollama.com)
          - glm-4.6:cloud       # Advanced reasoning and coding model
          - qwen3-coder:480b-cloud  # Specialized coding model
          - gpt-oss:120b-cloud  # Large general-purpose model
        default: glm-4.6:cloud
      base_branch:
        description: "Base branch to analyze"
        required: false
        type: string
        default: main
      dry_run:
        description: "Dry run (analyze only, don't create PR)"
        required: false
        type: boolean
        default: false
      force_regenerate:
        description: "Force regenerate even if .ruler/ exists"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write
  id-token: write

jobs:
  # ============================================
  # ANALYZE - Assess the codebase
  # ============================================
  analyze:
    name: Analyze Repository
    runs-on: ubuntu-latest
    outputs:
      repo_name: ${{ steps.setup.outputs.repo_name }}
      language: ${{ steps.detect.outputs.language }}
      has_ruler: ${{ steps.detect.outputs.has_ruler }}
      has_cursor: ${{ steps.detect.outputs.has_cursor }}
      has_kiro: ${{ steps.detect.outputs.has_kiro }}
      framework: ${{ steps.detect.outputs.framework }}
      needs_update: ${{ steps.detect.outputs.needs_update }}

    steps:
      - name: Extract repo name
        id: setup
        run: |
          REPO="${{ inputs.repository }}"
          REPO_NAME="${REPO#*/}"
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Repository: $REPO"
          echo "ðŸ“› Repo name: $REPO_NAME"

      # actions/checkout v6.0.1
      - name: Checkout target repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.base_branch }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          fetch-depth: 0
          path: target-repo

      - name: Detect repository characteristics
        id: detect
        working-directory: target-repo
        run: |
          # Detect primary language
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
            LANGUAGE="python"
          elif [ -f "package.json" ]; then
            if grep -q '"typescript"' package.json 2>/dev/null; then
              LANGUAGE="typescript"
            else
              LANGUAGE="javascript"
            fi
          elif [ -f "go.mod" ]; then
            LANGUAGE="go"
          elif find . -name "*.tf" -type f | head -1 | grep -q .; then
            LANGUAGE="terraform"
          else
            LANGUAGE="unknown"
          fi
          echo "language=$LANGUAGE" >> $GITHUB_OUTPUT
          echo "ðŸ”¤ Primary language: $LANGUAGE"
          
          # Detect framework
          FRAMEWORK="none"
          if [ "$LANGUAGE" = "python" ]; then
            if grep -q "crewai\|langchain\|langgraph" pyproject.toml 2>/dev/null; then
              FRAMEWORK="ai-agents"
            elif grep -q "fastapi\|flask\|django" pyproject.toml 2>/dev/null; then
              FRAMEWORK="web"
            fi
          elif [ "$LANGUAGE" = "typescript" ] || [ "$LANGUAGE" = "javascript" ]; then
            if grep -q "react\|next" package.json 2>/dev/null; then
              FRAMEWORK="react"
            elif grep -q "express\|fastify" package.json 2>/dev/null; then
              FRAMEWORK="node-api"
            fi
          fi
          echo "framework=$FRAMEWORK" >> $GITHUB_OUTPUT
          echo "ðŸ—ï¸ Framework: $FRAMEWORK"
          
          # Check for existing configurations
          HAS_RULER="false"
          HAS_CURSOR="false"
          HAS_KIRO="false"
          
          [ -d ".ruler" ] && HAS_RULER="true"
          [ -d ".cursor/rules" ] && HAS_CURSOR="true"
          [ -d ".kiro/steering" ] && HAS_KIRO="true"
          
          echo "has_ruler=$HAS_RULER" >> $GITHUB_OUTPUT
          echo "has_cursor=$HAS_CURSOR" >> $GITHUB_OUTPUT
          echo "has_kiro=$HAS_KIRO" >> $GITHUB_OUTPUT
          
          echo "ðŸ“ Has .ruler/: $HAS_RULER"
          echo "ðŸ“ Has .cursor/rules/: $HAS_CURSOR"
          echo "ðŸ“ Has .kiro/steering/: $HAS_KIRO"
          
          # Determine if update is needed
          NEEDS_UPDATE="true"
          if [ "$HAS_RULER" = "true" ] && [ "${{ inputs.force_regenerate }}" != "true" ]; then
            NEEDS_UPDATE="false"
            echo "â„¹ï¸ Repository already has .ruler/ - skipping (use force_regenerate to override)"
          fi
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT

      - name: Display analysis summary
        run: |
          echo "## ðŸ“Š Repository Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ inputs.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Language | ${{ steps.detect.outputs.language }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Framework | ${{ steps.detect.outputs.framework }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has .ruler/ | ${{ steps.detect.outputs.has_ruler }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has .cursor/ | ${{ steps.detect.outputs.has_cursor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has .kiro/ | ${{ steps.detect.outputs.has_kiro }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Needs Update | ${{ steps.detect.outputs.needs_update }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # GENERATE - Create ruler configuration
  # ============================================
  generate:
    name: Generate Ruler Configuration
    needs: analyze
    if: needs.analyze.outputs.needs_update == 'true' && inputs.dry_run != true
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch.outputs.name }}

    steps:
      # actions/checkout v6.0.1
      - name: Checkout target repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.base_branch }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          fetch-depth: 0

      # actions/setup-node v6.1.0
      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install Ruler
        run: npm install -g @intellectronica/ruler

      - name: Create branch
        id: branch
        run: |
          BRANCH_NAME="ruler/update-instructions-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # Install Ollama CLI
      - name: Install Ollama CLI
        run: curl -fsSL https://ollama.com/install.sh | sh

      # Configure for Cloud
      - name: Configure Ollama for Cloud
        run: |
          echo "OLLAMA_HOST=https://ollama.com" >> $GITHUB_ENV
          echo "OLLAMA_API_KEY=${{ secrets.OLLAMA_API_KEY }}" >> $GITHUB_ENV

      # Register cloud model
      - name: Register cloud model
        run: ollama pull ${{ inputs.model }}

      # Generate ruler configuration with Ollama
      - name: Generate ruler configuration with Ollama
        id: generate
        run: |
          # Build the prompt
          PROMPT="You are an expert at configuring AI coding assistant instructions using the Ruler framework.

          ## Repository Context
          - **Repository**: ${{ inputs.repository }}
          - **Primary Language**: ${{ needs.analyze.outputs.language }}
          - **Framework**: ${{ needs.analyze.outputs.framework }}
          - **Has existing .cursor/**: ${{ needs.analyze.outputs.has_cursor }}
          - **Has existing .kiro/**: ${{ needs.analyze.outputs.has_kiro }}

          ## Your Task
          Create a comprehensive \`.ruler/\` configuration that centralizes AI agent instructions for this codebase.

          ## Instructions

          ### 1. Initialize Ruler Structure
          Create the following structure:
          \`\`\`
          .ruler/
          â”œâ”€â”€ AGENTS.md           # Main instructions file
          â”œâ”€â”€ ruler.toml          # Configuration
          â””â”€â”€ <context>.md        # Additional context-specific files
          \`\`\`

          ### 2. Analyze the Codebase
          - Read key files: README.md, pyproject.toml/package.json/go.mod, any existing CLAUDE.md
          - Understand the project's purpose, architecture, and patterns
          - If .cursor/rules/ exists, read those rules to understand existing conventions
          - If .kiro/steering/ exists, incorporate those guidelines

          ### 3. Create .ruler/AGENTS.md
          Write comprehensive instructions covering:

          **For Python projects:**
          - Code style (PEP 8, type hints, docstrings)
          - Testing conventions (pytest, fixtures, coverage)
          - Package management (uv, pyproject.toml)
          - Common patterns in this codebase

          **For TypeScript/JavaScript projects:**
          - Code style (ESLint, Prettier)
          - Testing conventions (Jest, Vitest)
          - Package management (npm, bun)
          - Framework-specific patterns (React, Next.js, etc.)

          **For Go projects:**
          - Code style (gofmt, golint)
          - Testing conventions (go test)
          - Module structure

          **For Terraform projects:**
          - Module conventions
          - Variable naming
          - Resource organization

          **For all projects:**
          - Git workflow (conventional commits, PR process)
          - Memory bank usage if present
          - Agent handoff protocols
          - Security considerations

          ### 4. Create .ruler/ruler.toml
          Configure agents appropriately:
          \`\`\`toml
          default_agents = [\"copilot\", \"claude\", \"cursor\", \"kiro\", \"aider\"]
          nested = false

          [gitignore]
          enabled = true

          [agents.claude]
          enabled = true

          [agents.cursor]
          enabled = true

          [agents.kiro]
          enabled = true
          \`\`\`

          ### 5. Create Context-Specific Files (if needed)
          For complex projects, create additional .md files:
          - \`development.md\` - Development process and workflow
          - \`architecture.md\` - System architecture documentation
          - \`security.md\` - Security guidelines

          ### 6. Run Ruler Apply
          After creating the configuration, run:
          \`\`\`bash
          ruler apply --verbose
          \`\`\`
          This will distribute the rules to all supported agent formats.

          ### 7. Clean Up Legacy Files
          If migrating from direct .cursor/rules/ sync:
          - The ruler-generated files will be in .gitignore
          - Keep any custom rules that aren't covered by the new configuration

          ## Important Guidelines
          - Be specific to THIS repository, not generic
          - Reference actual files and patterns found in the codebase
          - Don't just copy templates - tailor to the project's needs
          - Include examples from the actual codebase where helpful
          - Keep instructions concise but comprehensive

          ## Output
          Create the files directly. After creating them, run \`ruler apply\` and verify the output."

          # Build JSON payload safely using jq to handle special characters
          JSON_PAYLOAD=$(jq -n \
            --arg model "${{ inputs.model }}" \
            --arg system_msg "You are an expert AI coding assistant configuration specialist." \
            --arg user_msg "$PROMPT" \
            '{
              model: $model,
              messages: [
                { role: "system", content: $system_msg },
                { role: "user", content: $user_msg }
              ],
              options: {
                temperature: 0.1,
                mirostat: 2,
                mirostat_tau: 5.0,
                mirostat_eta: 0.1,
                top_p: 0.95,
                repeat_penalty: 1.15,
                num_ctx: 196608,
                num_predict: 4096
              },
              stream: false
            }')

          # Send to Ollama API
          RESPONSE=$(curl -s https://ollama.com/api/chat \
            -H "Authorization: Bearer ${{ secrets.OLLAMA_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          # Extract the response content
          CONFIG_CODE=$(echo "$RESPONSE" | jq -r '.message.content // empty')

          if [ -z "$CONFIG_CODE" ] || [ "$CONFIG_CODE" = "null" ]; then
            echo "Error: Empty or invalid response from model"
            exit 1
          fi

          echo "Generated ruler configuration successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify ruler output
        run: |
          echo "ðŸ“ Checking ruler output..."
          
          # Verify .ruler/ was created
          if [ -d ".ruler" ]; then
            echo "âœ… .ruler/ directory created"
            ls -la .ruler/
          else
            echo "âŒ .ruler/ directory not created"
            exit 1
          fi
          
          # Check for generated agent files
          echo ""
          echo "ðŸ“„ Generated agent files:"
          for f in AGENTS.md CLAUDE.md .clinerules .cursor/mcp.json .kiro/steering/*.md; do
            [ -f "$f" ] && echo "  âœ… $f"
          done

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Add all ruler-related files
          git add .ruler/
          git add AGENTS.md CLAUDE.md .clinerules 2>/dev/null || true
          git add .cursor/ .kiro/ .vscode/ 2>/dev/null || true
          git add .gitignore 2>/dev/null || true
          
          # Commit
          git commit -m "chore: add ruler-managed AI agent instructions

          Generated by Claude (${{ inputs.model }}) via sync-ruler workflow.
          
          This centralizes AI coding assistant instructions using the Ruler framework.
          Run 'ruler apply' to regenerate agent-specific files after modifying .ruler/
          
          Language: ${{ needs.analyze.outputs.language }}
          Framework: ${{ needs.analyze.outputs.framework }}"
          
          git push origin HEAD

  # ============================================
  # CREATE PR - Submit for review
  # ============================================
  create-pr:
    name: Create Pull Request
    needs: [analyze, generate]
    if: needs.analyze.outputs.needs_update == 'true' && inputs.dry_run != true
    runs-on: ubuntu-latest
    outputs:
      pr_url: ${{ steps.pr.outputs.pull-request-url }}
      pr_number: ${{ steps.pr.outputs.pull-request-number }}

    steps:
      # actions/checkout v6.0.1
      - name: Checkout target repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ needs.generate.outputs.branch_name }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      # peter-evans/create-pull-request v8.0.0
      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          branch: ${{ needs.generate.outputs.branch_name }}
          base: ${{ inputs.base_branch }}
          delete-branch: true
          title: "ðŸ¤– Add Ruler-managed AI agent instructions"
          body: |
            ## ðŸŽ¯ AI Agent Instructions Update
            
            This PR adds centralized AI coding assistant instructions using the [Ruler](https://github.com/intellectronica/ruler) framework.
            
            ### ðŸ“Š Repository Analysis
            | Property | Value |
            |----------|-------|
            | Language | ${{ needs.analyze.outputs.language }} |
            | Framework | ${{ needs.analyze.outputs.framework }} |
            | Model Used | `${{ inputs.model }}` |
            
            ### ðŸ“ Changes
            
            **New files:**
            - `.ruler/AGENTS.md` - Main instructions file
            - `.ruler/ruler.toml` - Ruler configuration
            - Additional context-specific `.md` files (if needed)
            
            **Generated agent files:**
            - `AGENTS.md` - For GitHub Copilot, Jules, Amp, etc.
            - `CLAUDE.md` - For Claude Code
            - `.cursor/` - For Cursor IDE
            - `.kiro/steering/` - For Kiro
            - And more...
            
            ### ðŸ”„ How It Works
            
            1. All AI instructions live in `.ruler/`
            2. Run `ruler apply` to distribute to all agent formats
            3. Agent-specific files are auto-generated and gitignored
            
            ### âœ… Review Checklist
            - [ ] Instructions are appropriate for this codebase
            - [ ] Code style guidelines match project conventions
            - [ ] Testing conventions are accurate
            - [ ] No sensitive information exposed
            
            ---
            *Generated by [sync-ruler.yml](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            ai-instructions
            ruler
            automated

      - name: Output PR info
        run: |
          echo "## ðŸŽ‰ Pull Request Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: Workflow Summary
    needs: [analyze, generate, create-pr]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate final summary
        run: |
          echo "## ðŸŽ¯ Ruler Sync Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ inputs.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ inputs.model }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Force Regenerate | ${{ inputs.force_regenerate }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Analyze | ${{ needs.analyze.result == 'success' && 'âœ…' || needs.analyze.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.analyze.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generate | ${{ needs.generate.result == 'success' && 'âœ…' || needs.generate.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.generate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create PR | ${{ needs.create-pr.result == 'success' && 'âœ…' || needs.create-pr.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.create-pr.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.create-pr.outputs.pr_url }}" != "" ]; then
            echo "### ðŸ”— Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** ${{ needs.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
