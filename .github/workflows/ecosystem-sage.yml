---
name: Ecosystem Sage

on:
  # On-call triggers
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  
  # Enterprise Reusable Workflow
  workflow_call:
    inputs:
      query:
        description: 'The question or task to process'
        required: true
        type: string
      context_repo:
        description: 'Repository context (owner/repo)'
        required: false
        type: string
      context_issue:
        description: 'Issue/PR number for context'
        required: false
        type: number
    secrets:
      CI_GITHUB_TOKEN:
        required: true
        description: 'GitHub token for cross-repository operations'
      OLLAMA_API_KEY:
        required: false
      OLLAMA_API_URL:
        required: false
      GOOGLE_JULES_API_KEY:
        required: false
      CURSOR_SESSION_TOKEN:
        required: false
    outputs:
      response:
        description: 'The Sage response'
        value: ${{ jobs.sage.outputs.response }}
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      query:
        description: 'Question to answer'
        required: true
        type: string
      context_repo:
        description: 'Repository for context'
        required: false
        type: string
      context_issue:
        description: 'Issue/PR number'
        required: false
        type: number

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  sage:
    name: Sage Advisory
    runs-on: ubuntu-latest
    # Only run on specific triggers
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'workflow_call' ||
      (github.event_name == 'issue_comment' && (contains(github.event.comment.body, '@sage') || contains(github.event.comment.body, '/sage'))) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@sage'))
    outputs:
      response: ${{ steps.sage.outputs.response }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.context_repo || github.repository }}
          fetch-depth: 0  # Full history for context
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Run Sage
        id: sage
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          OLLAMA_HOST: ${{ vars.OLLAMA_API_URL || vars.OLLAMA_API_URL || vars.OLLAMA_HOST || 'https://ollama.com' }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || 'glm-4.6:cloud' }}
          CURSOR_SESSION_TOKEN: ${{ secrets.CURSOR_SESSION_TOKEN }}
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          # Event context
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ inputs.context_issue || github.event.issue.number || github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ inputs.context_repo || github.repository }}
          # Workflow inputs
          INPUT_QUERY: ${{ inputs.query }}
          INPUT_CONTEXT_REPO: ${{ inputs.context_repo }}
          INPUT_CONTEXT_ISSUE: ${{ inputs.context_issue }}
        run: node scripts/ecosystem-sage.mjs

      - name: Post Response
        if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          if [ -f sage-response.md ]; then
            RESPONSE=$(cat sage-response.md)
            ISSUE_NUM=${{ inputs.context_issue || github.event.issue.number || github.event.pull_request.number }}
            REPO=${{ inputs.context_repo || github.repository }}
            
            if [ "${{ github.event_name }}" == "issue_comment" ]; then
              gh issue comment $ISSUE_NUM --repo $REPO --body "$RESPONSE"
            else
              gh pr comment $ISSUE_NUM --repo $REPO --body "$RESPONSE"
            fi
          fi
