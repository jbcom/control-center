# Unified Claude Code workflow
#
# Handles:
# - @claude mentions in issues/PRs/comments
# - Automatic PR review
# - Issue triage
# - CI failure auto-fix
#
# DRY: Single workflow, multiple jobs with appropriate triggers

name: Claude Code

on:
  # For @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  
  # For issue triage
  issues:
    types: [opened, assigned, labeled]
  
  # For PR review
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    branches: [main]
  
  # For CI fix
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

env:
  CLAUDE_MODEL: claude-haiku-4-5-20251001
  ALLOWED_BOTS: "cursor[bot],github-actions[bot],dependabot[bot],amazon-q-developer[bot],gemini-code-assist[bot]"

jobs:
  # ============================================
  # @CLAUDE MENTIONS
  # ============================================
  mention:
    name: Handle @claude mention
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude') || 
        contains(github.event.issue.title, '@claude') ||
        (github.event.action == 'assigned' && github.event.assignee.login == 'claude[bot]') ||
        (github.event.action == 'labeled' && github.event.label.name == 'claude')
      ))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"
          assignee_trigger: "claude[bot]"
          label_trigger: "claude"
          branch_prefix: "claude/"
          allowed_bots: ${{ env.ALLOWED_BOTS }}
          track_progress: true
          claude_args: |
            --model ${{ env.CLAUDE_MODEL }}
            --max-turns 20
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(uv:*),Bash(python:*),Bash(pytest:*),Bash(ruff:*),Bash(mypy:*)"

  # ============================================
  # PR REVIEW (auto on new PRs)
  # ============================================
  pr-review:
    name: Review PR
    if: |
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.title, '[HOLDING]') &&
      !contains(github.event.pull_request.labels.*.name, 'no-review')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v5

      - name: Check for code changes
        id: check
        run: |
          CHANGED=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
          CODE_CHANGES=$(echo "$CHANGED" | grep -vE '^(wiki/|docs/|.*\.md$)' || true)
          echo "skip=$( [ -z "$CODE_CHANGES" ] && echo true || echo false )" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - uses: anthropics/claude-code-action@v1
        if: steps.check.outputs.skip != 'true'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          allowed_bots: ${{ env.ALLOWED_BOTS }}
          prompt: |
            Review PR #${{ github.event.pull_request.number }} for bugs, security, types, tests.
            Use gh pr comment for summary, inline comments for specific issues.
          claude_args: |
            --model ${{ env.CLAUDE_MODEL }}
            --max-turns 10
            --allowedTools "Read,Grep,Bash(gh pr:*)"

  # ============================================
  # ISSUE TRIAGE (new issues)
  # ============================================
  triage:
    name: Triage issue
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'opened' &&
      !contains(github.event.issue.labels.*.name, 'agent-task') &&
      !contains(github.event.issue.labels.*.name, 'claude')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v5

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_non_write_users: "*"
          prompt: |
            Triage issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}"
            
            1. Classify: bug/enhancement/documentation/question/ci-cd/security
            2. Priority: critical/high/medium/low
            3. Add labels: gh issue edit ${{ github.event.issue.number }} --add-label "type,priority"
            4. Comment with triage summary
          claude_args: |
            --model ${{ env.CLAUDE_MODEL }}
            --max-turns 10
            --allowedTools "Bash(gh issue:*),Read,Grep"

  # ============================================
  # CI FIX (on CI failures)
  # ============================================
  ci-fix:
    name: Fix CI failure
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] &&
      !startsWith(github.event.workflow_run.head_branch, 'claude/')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup git
        run: |
          git config --global user.email "claude[bot]@users.noreply.github.com"
          git config --global user.name "claude[bot]"

      - name: Create fix branch
        id: branch
        run: |
          BRANCH="claude/fix-ci-${{ github.run_id }}"
          git checkout -b "$BRANCH"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT

      - name: Get failure logs
        id: logs
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            const failed = jobs.data.jobs.filter(j => j.conclusion === 'failure');
            return { jobs: failed.map(j => j.name), count: failed.length };

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            CI failed for PR #${{ github.event.workflow_run.pull_requests[0].number }}
            Branch: ${{ steps.branch.outputs.name }}
            Failed jobs: ${{ fromJSON(steps.logs.outputs.result).jobs }}
            
            1. Analyze and fix the failures
            2. For lint: ruff check --fix && ruff format
            3. Commit: git add -A && git commit -m "fix: CI failures"
            4. Push: git push -u origin ${{ steps.branch.outputs.name }}
            5. Create PR to ${{ github.event.workflow_run.head_branch }}
          claude_args: |
            --model ${{ env.CLAUDE_MODEL }}
            --max-turns 30
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(uv:*),Bash(ruff:*),Bash(mypy:*),Bash(pytest:*)"
