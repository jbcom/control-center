# Claude Code Workflow - Escalation Layer
#
# Integrates Claude as next line of defense after Ollama:
# - @claude mentions for interactive assistance
# - Automatic PR review when Ollama can't handle complexity
# - Issue triage escalation
# - CI failure resolution
#
# Based on arcade-cabinet/otter-elite-force pattern

name: Claude Code

on:
  # Interactive: @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  
  # PR review escalation (when ecosystem-reviewer suggests >5 issues)
  pull_request:
    types: [opened, synchronize, ready_for_review]

  # Manual trigger
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        type: choice
        options:
          - pr-review
          - issue-triage
          - ci-fix
        default: "pr-review"
      target:
        description: "PR number or issue number"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # ============================================
  # INTERACTIVE MODE: @claude mentions
  # ============================================
  claude-interactive:
    name: Claude Interactive
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          additional_permissions: |
            actions: read
          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(node:*),Bash(npm:*),Bash(cat:*),Bash(ls:*),Bash(head:*),Bash(tail:*),Bash(grep:*),Bash(rg:*),Bash(find:*),Bash(jq:*)"

  # ============================================
  # PR REVIEW: Escalation from Ollama
  # ============================================
  claude-review:
    name: Claude PR Review
    if: |
      github.event_name == 'pull_request' && 
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Check if escalation needed
        id: check
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Check if Ollama review already happened and found many issues
          COMMENTS=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[].body' 2>/dev/null || echo "")
          
          # Skip if Claude already reviewed
          if echo "$COMMENTS" | grep -q "Claude Code Review"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for Ollama review with many suggestions
          if echo "$COMMENTS" | grep -qE "ðŸ”´|ðŸŸ .*ðŸŸ .*ðŸŸ |critical|high.*high"; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "reason=escalation" >> $GITHUB_OUTPUT
          else
            # Also run on large PRs
            CHANGES=$(gh pr view ${{ github.event.pull_request.number }} --json additions,deletions --jq '.additions + .deletions')
            if [ "$CHANGES" -gt 500 ]; then
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "reason=large-pr" >> $GITHUB_OUTPUT
            else
              echo "skip=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude PR Review
        if: steps.check.outputs.skip != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          track_progress: true
          prompt: |
            ## Control Center PR Review

            This is jbcom-control-center, the unified orchestration hub managing:
            - Multi-org GitHub operations (jbcom, strata-game-library, agentic-dev-library, extended-data-library, arcade-cabinet)
            - AI agent fleet (Jules, Cursor, Copilot, Ollama)
            - Ecosystem workflows and file sync

            ## Review Checklist

            ### Critical
            - [ ] No hardcoded tokens or secrets
            - [ ] Token usage follows CI_GITHUB_TOKEN pattern
            - [ ] Self-discovery pattern (no hardcoded org/repo lists)
            - [ ] Bot PR auto-merge logic correct

            ### Workflows
            - [ ] Uses CI_GITHUB_TOKEN for cross-org operations
            - [ ] Proper error handling
            - [ ] No infinite loops possible

            ### Scripts
            - [ ] Fallback logic for missing APIs
            - [ ] Rate limit handling
            - [ ] Dry-run mode works

            Post inline comments for specific issues.
            Approve if no critical issues found.

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(git diff:*),Bash(git log:*),Bash(gh:*)"

  # ============================================
  # CI FAILURE RESOLUTION
  # ============================================
  claude-fix-ci:
    name: Claude CI Fix
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'ci-fix'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Fix CI
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          prompt: |
            Fix the CI failure in PR #${{ github.event.inputs.target }}.

            1. Check the failed workflow run logs
            2. Identify the root cause
            3. Fix the issue
            4. Commit and push the fix

            Use `gh run view --log` to see failure details.

          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(node:*),Bash(npm:*)"
