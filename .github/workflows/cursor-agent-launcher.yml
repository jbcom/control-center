name: Cursor Agent Launcher

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  launch-cursor-agent:
    name: Launch Cursor Agent
    if: "contains(github.event.comment.body, '/cursor')"
    runs-on: ubuntu-latest
    steps:
      - name: Check for API Key
        id: check
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if [[ -z "$CURSOR_API_KEY" ]]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge
        if: steps.check.outputs.available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ü§ñ Received '/cursor' command. Launching Cursor Cloud Agent..."

      - name: Launch Cursor Agent
        if: steps.check.outputs.available == 'true'
        id: cursor
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REPOSITORY: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          TASK=$(echo "$COMMENT_BODY" | sed 's|/cursor[[:space:]]*||' | head -c 1000)
          [ -z "$TASK" ] && TASK="Fix issue #$ISSUE_NUMBER"

          RESPONSE=$(curl -s -X POST "https://api.cursor.com/agents/launch" \
            -u "$CURSOR_API_KEY:" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "$TASK" \
              --arg repo "$REPOSITORY" \
              --arg branch "$DEFAULT_BRANCH" \
              '{
                repository: $repo,
                task: $task,
                branch: $branch
              }')")

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.agentId // empty')
          echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT

      - name: Post Agent Link
        if: steps.check.outputs.available == 'true' && steps.cursor.outputs.agent_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ü§ñ Cursor Agent Launched

          Agent ID: `${{ steps.cursor.outputs.agent_id }}`

          The Cursor agent will now work on the task in the background."

      - name: Post Failure Comment
        if: steps.check.outputs.available == 'true' && steps.cursor.outputs.agent_id == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ùå Failed to launch Cursor agent. Please check logs."

      - name: Post API Key Missing
        if: steps.check.outputs.available == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ö†Ô∏è CURSOR_API_KEY not configured. Cannot launch Cursor agent."
