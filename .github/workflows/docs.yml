---
name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'packages/*/docs/**'
      - 'packages/*/src/**'
      - 'packages/*/README.md'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to build docs for (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - extended-data-types
          - lifecyclelogging
          - directed-inputs-class
          - python-terraform-bridge
          - vendor-connectors

permissions: {}

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: "1"

jobs:
  # ============================================
  # BUILD DOCS
  # ============================================
  build-docs:
    name: Build ${{ matrix.package }} docs
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - package: extended-data-types
            repo: jbcom/extended-data-types
          - package: lifecyclelogging
            repo: jbcom/lifecyclelogging
          - package: directed-inputs-class
            repo: jbcom/directed-inputs-class
          - package: python-terraform-bridge
            repo: jbcom/python-terraform-bridge
          - package: vendor-connectors
            repo: jbcom/vendor-connectors

    steps:
      - name: Skip if not target package
        if: github.event_name == 'workflow_dispatch' && inputs.package != 'all' && inputs.package != matrix.package
        run: |
          echo "Skipping ${{ matrix.package }} - not selected"
          exit 0

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - uses: hynek/setup-cached-uv@v2

      - name: Get package version
        id: version
        run: |
          VERSION=$(grep '^version = ' packages/${{ matrix.package }}/pyproject.toml | head -1 | sed 's/version = "\([^"]*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install package with docs dependencies
        working-directory: packages/${{ matrix.package }}
        run: |
          uv venv
          uv pip install -e ".[docs]" 2>/dev/null || uv pip install -e .
          uv pip install sphinx sphinx-rtd-theme sphinxawesome-theme sphinx-autodoc2 myst-parser docutils

      - name: Build Sphinx documentation
        working-directory: packages/${{ matrix.package }}
        run: |
          mkdir -p docs/_build/html

          if [ -f "docs/conf.py" ]; then
            echo "Building Sphinx docs..."
            .venv/bin/sphinx-build -n -T -W -b html \
              -d docs/_build/doctrees \
              docs docs/_build/html || {
                echo "::warning::Sphinx build had warnings/errors, continuing..."
                .venv/bin/sphinx-build -b html docs docs/_build/html || true
              }
          else
            echo "No docs/conf.py found, generating placeholder..."
            cat > docs/_build/html/index.html << 'HEREDOC'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>${{ matrix.package }} Documentation</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
              h1 { color: #333; }
              a { color: #0066cc; }
              code { background: #f4f4f4; padding: 0.2em 0.4em; border-radius: 3px; }
            </style>
          </head>
          <body>
            <h1>${{ matrix.package }}</h1>
            <p><strong>Version:</strong> ${{ steps.version.outputs.version }}</p>
            <p>Full documentation is in progress. Please see the <a href="https://github.com/${{ matrix.repo }}">GitHub repository</a> for details.</p>
            <h2>Installation</h2>
            <pre><code>pip install ${{ matrix.package }}</code></pre>
            <h2>Links</h2>
            <ul>
              <li><a href="https://github.com/${{ matrix.repo }}">GitHub Repository</a></li>
              <li><a href="https://pypi.org/project/${{ matrix.package }}/">PyPI Package</a></li>
            </ul>
          </body>
          </html>
          HEREDOC
          fi

      - name: Run doctests
        if: hashFiles(format('packages/{0}/docs/conf.py', matrix.package)) != ''
        working-directory: packages/${{ matrix.package }}
        continue-on-error: true
        run: |
          .venv/bin/sphinx-build -n -T -W -b doctest \
            -d docs/_build/doctrees \
            docs docs/_build/doctest || true

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-${{ matrix.package }}
          path: packages/${{ matrix.package }}/docs/_build/html
          if-no-files-found: error

  # ============================================
  # DEPLOY DOCS TO GH-PAGES
  # ============================================
  deploy-docs:
    name: Deploy ${{ matrix.package }} docs
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - package: extended-data-types
            repo: jbcom/extended-data-types
          - package: lifecyclelogging
            repo: jbcom/lifecyclelogging
          - package: directed-inputs-class
            repo: jbcom/directed-inputs-class
          - package: python-terraform-bridge
            repo: jbcom/python-terraform-bridge
          - package: vendor-connectors
            repo: jbcom/vendor-connectors

    steps:
      - name: Skip if not target package
        if: github.event_name == 'workflow_dispatch' && inputs.package != 'all' && inputs.package != matrix.package
        run: |
          echo "Skipping ${{ matrix.package }} - not selected"
          exit 0

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-${{ matrix.package }}
          path: html

      - name: Deploy to gh-pages
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Clone or init gh-pages branch
          git clone --branch gh-pages --depth 1 \
            "https://x-access-token:${GH_TOKEN}@github.com/${{ matrix.repo }}.git" \
            gh-pages 2>/dev/null || {
              mkdir gh-pages && cd gh-pages
              git init -b gh-pages
              git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ matrix.repo }}.git"
              cd ..
            }

          # Clear old docs and copy new
          find gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cp -r html/. gh-pages/
          touch gh-pages/.nojekyll

          # Commit and push
          cd gh-pages
          git config user.name "jbcom-bot"
          git config user.email "jbcom-bot@users.noreply.github.com"
          git add -A

          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“š Update documentation"
            git push -uf origin gh-pages
            echo "âœ… Deployed docs for ${{ matrix.package }}"
          else
            echo "â­ï¸  No changes to deploy for ${{ matrix.package }}"
          fi

  # ============================================
  # BUILD COMBINED DOCS SITE
  # ============================================
  combined-docs:
    name: Build combined docs site
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download all docs artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: docs-*
          path: all-docs

      - name: Create combined docs site
        run: |
          mkdir -p combined-site

          # Create index page
          cat > combined-site/index.html << 'HEREDOC'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>jbcom Python Ecosystem</title>
            <style>
              :root { --bg: #0d1117; --text: #c9d1d9; --accent: #58a6ff; --card-bg: #161b22; }
              * { box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 2rem; line-height: 1.6; }
              .container { max-width: 1000px; margin: 0 auto; }
              h1 { color: #fff; font-size: 2.5rem; margin-bottom: 0.5rem; }
              .subtitle { color: #8b949e; margin-bottom: 2rem; }
              .packages { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
              .package { background: var(--card-bg); border-radius: 8px; padding: 1.5rem; border: 1px solid #30363d; }
              .package h2 { margin: 0 0 0.5rem 0; font-size: 1.2rem; }
              .package h2 a { color: var(--accent); text-decoration: none; }
              .package h2 a:hover { text-decoration: underline; }
              .package p { color: #8b949e; margin: 0 0 1rem 0; font-size: 0.9rem; }
              .package .links a { color: var(--accent); text-decoration: none; margin-right: 1rem; font-size: 0.85rem; }
              .footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #30363d; color: #8b949e; font-size: 0.85rem; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>jbcom Python Ecosystem</h1>
              <p class="subtitle">A collection of Python packages for data processing, logging, and cloud integrations.</p>

              <div class="packages">
                <div class="package">
                  <h2><a href="extended-data-types/">extended-data-types</a></h2>
                  <p>Extended functionality for Python data types with utilities for JSON, YAML, HCL2, and more.</p>
                  <div class="links">
                    <a href="https://pypi.org/project/extended-data-types/">PyPI</a>
                    <a href="https://github.com/jbcom/extended-data-types">GitHub</a>
                  </div>
                </div>

                <div class="package">
                  <h2><a href="lifecyclelogging/">lifecyclelogging</a></h2>
                  <p>Structured lifecycle logging with automatic data sanitization.</p>
                  <div class="links">
                    <a href="https://pypi.org/project/lifecyclelogging/">PyPI</a>
                    <a href="https://github.com/jbcom/lifecyclelogging">GitHub</a>
                  </div>
                </div>

                <div class="package">
                  <h2><a href="directed-inputs-class/">directed-inputs-class</a></h2>
                  <p>Declarative input validation and processing with decorator support.</p>
                  <div class="links">
                    <a href="https://pypi.org/project/directed-inputs-class/">PyPI</a>
                    <a href="https://github.com/jbcom/directed-inputs-class">GitHub</a>
                  </div>
                </div>

                <div class="package">
                  <h2><a href="python-terraform-bridge/">python-terraform-bridge</a></h2>
                  <p>Bridge between Python and Terraform for infrastructure automation.</p>
                  <div class="links">
                    <a href="https://pypi.org/project/python-terraform-bridge/">PyPI</a>
                    <a href="https://github.com/jbcom/python-terraform-bridge">GitHub</a>
                  </div>
                </div>

                <div class="package">
                  <h2><a href="vendor-connectors/">vendor-connectors</a></h2>
                  <p>Universal vendor connectors for AWS, GCP, GitHub, Slack, Vault, and Zoom.</p>
                  <div class="links">
                    <a href="https://pypi.org/project/vendor-connectors/">PyPI</a>
                    <a href="https://github.com/jbcom/vendor-connectors">GitHub</a>
                  </div>
                </div>
              </div>

              <div class="footer">
                <p>Maintained by <a href="https://github.com/jbcom" style="color: var(--accent);">jbcom</a></p>
              </div>
            </div>
          </body>
          </html>
          HEREDOC

          # Copy each package's docs to subdirectory
          for pkg_dir in all-docs/docs-*/; do
            pkg_name=$(basename "$pkg_dir" | sed 's/docs-//')
            mkdir -p "combined-site/$pkg_name"
            cp -r "$pkg_dir/." "combined-site/$pkg_name/"
          done

          touch combined-site/.nojekyll

      - name: Upload combined site
        uses: actions/upload-artifact@v4
        with:
          name: combined-docs-site
          path: combined-site
