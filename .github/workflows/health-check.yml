# Daily Ecosystem Health Check
# Monitors health of all managed repositories

name: Ecosystem Health Check

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  health-check:
    name: Check Ecosystem Health
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install PyGithub requests pyyaml
      
      - name: Run health checks
        env:
          GITHUB_TOKEN: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
        run: |
          python3 tools/monitor/health_check.py \
            --output ecosystem/HEALTH_METRICS.json
      
      - name: Generate dependency graph
        env:
          GITHUB_TOKEN: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
        run: |
          python3 tools/monitor/dependency_graph.py \
            --output ecosystem/DEPENDENCY_GRAPH.json
      
      - name: Check for critical issues
        id: check-critical
        run: |
          # Check if there are critical issues
          critical_count=$(python3 -c "
          import json
          metrics = json.load(open('ecosystem/HEALTH_METRICS.json'))
          print(sum(1 for r in metrics.get('repositories', {}).values() if r.get('status') == 'critical'))
          ")
          echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
          
          if [ "$critical_count" -gt 0 ]; then
            echo "âš ï¸  Found $critical_count repositories with critical issues"
            exit 0  # Don't fail the job, just report
          fi
      
      - name: Commit updated metrics
        run: |
          git config user.name "jbcom-bot"
          git config user.email "bot@jbcom.dev"
          git add ecosystem/HEALTH_METRICS.json ecosystem/DEPENDENCY_GRAPH.json
          git diff --staged --quiet || git commit -m "ðŸ“Š Update ecosystem health metrics [skip ci]"
          git push
      
      - name: Create issue for critical problems
        if: steps.check-critical.outputs.critical_count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸš¨ Critical Issues in Ecosystem (${{ steps.check-critical.outputs.critical_count }} repos)" \
            --body "$(python3 tools/monitor/generate_health_report.py)" \
            --label "critical,automated"
