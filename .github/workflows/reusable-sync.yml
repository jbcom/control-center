# Reusable sync workflow - pushes versioned package to public repo
name: Sync Package

on:
  workflow_call:
    inputs:
      package:
        required: true
        type: string
      target-repo:
        required: true
        type: string
      version:
        required: true
        type: string
        description: "Version from python-semantic-release"
    secrets:
      token:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout control-center
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest with version commits from PSR
          path: source

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target-repo }}
          token: ${{ secrets.token }}
          path: target

      - name: Sync files
        run: |
          echo "=== Syncing ${{ inputs.package }} v${{ inputs.version }} to ${{ inputs.target-repo }} ==="
          
          # Clear target (except .git)
          cd target
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          cd ..
          
          # Copy package contents (versioned by PSR)
          cp -r source/packages/${{ inputs.package }}/* target/
          
          # Verify version in synced files
          echo "=== Version check ==="
          grep -r "__version__" target/src/*/__init__.py 2>/dev/null || echo "No __version__ found"
          grep '^version = ' target/pyproject.toml || echo "No version in pyproject.toml"
          
          # Commit and push
          cd target
          git config user.name "jbcom-bot"
          git config user.email "jbcom-bot@users.noreply.github.com"
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to sync"
          else
            git commit -m "ðŸš€ Release v${{ inputs.version }} from control-center"
            git push
            echo "âœ… Synced ${{ inputs.package }} v${{ inputs.version }}"
          fi
