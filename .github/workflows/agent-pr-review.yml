name: Agent PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  spawn-review-agent:
    name: Spawn Background Agent for PR Review
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.title, '[HOLDING]') &&
      !contains(github.event.pull_request.labels.*.name, 'no-agent-review')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install cursor-background-agent-mcp-server
        run: npm install -g cursor-background-agent-mcp-server
      
      - name: Generate Review Task
        id: task
        run: |
          cat > /tmp/review_task.md << 'EOF'
          # PR Review Task
          
          **PR**: #${{ github.event.pull_request.number }}
          **Title**: ${{ github.event.pull_request.title }}
          **Author**: ${{ github.event.pull_request.user.login }}
          **Branch**: ${{ github.event.pull_request.head.ref }}
          
          ## Your Mission
          
          Review this PR comprehensively:
          
          1. **Code Quality**
             - Check for bugs, logic errors
             - Verify type safety
             - Review error handling
          
          2. **Security**
             - Check for credential leaks
             - Verify input validation
             - Review permissions
          
          3. **Tests**
             - Verify test coverage
             - Check test quality
          
          4. **Documentation**
             - Verify docstrings
             - Check README updates if needed
          
          ## Actions
          
          After review:
          - Comment on PR with findings
          - Approve if no issues
          - Request changes if issues found
          
          ## Files Changed
          
          ```bash
          gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path'
          ```
          
          ---
          
          **Repository**: ${{ github.repository }}
          **Ref**: ${{ github.event.pull_request.head.sha }}
          EOF
          
          echo "task=$(cat /tmp/review_task.md | base64 -w0)" >> $GITHUB_OUTPUT
      
      - name: Spawn Review Agent
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create agent via MCP server
          TASK=$(echo "${{ steps.task.outputs.task }}" | base64 -d)
          
          echo "ðŸ“‹ Spawning review agent for PR #${{ github.event.pull_request.number }}"
          
          # For now, create a comment indicating agent was requested
          # Full MCP integration requires running server
          gh pr comment ${{ github.event.pull_request.number }} --body "$(cat << 'COMMENT'
          ðŸ¤– **Background Agent Review Requested**
          
          A Cursor background agent has been dispatched to review this PR.
          
          **Task**: Code quality, security, tests, documentation review
          **Status**: Pending agent pickup
          
          The agent will comment with findings once complete.
          
          ---
          *Automated by agent-pr-review workflow*
          COMMENT
          )"
      
      - name: Create Agent Task Issue (Fallback)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ¤– Agent Task: Review PR #${{ github.event.pull_request.number }}" \
            --body "$(cat << EOF
          ## Background Agent Task
          
          **PR**: #${{ github.event.pull_request.number }}
          **Title**: ${{ github.event.pull_request.title }}
          **Priority**: HIGH
          
          Review this PR and comment with findings.
          
          ---
          *Auto-created by agent-pr-review workflow (fallback)*
          EOF
          )" \
            --label "agent-task"
