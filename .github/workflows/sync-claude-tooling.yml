name: Sync Claude Tooling to Repos

on:
  push:
    branches: [main]
    paths:
      - 'templates/claude/**'
      - '.github/workflows/sync-claude-tooling.yml'
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repos to sync (empty = all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (no PRs created)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

env:
  # All managed repos that should have Claude tooling
  MANAGED_REPOS: |
    jbcom/extended-data-types
    jbcom/lifecyclelogging
    jbcom/directed-inputs-class
    jbcom/vendor-connectors

jobs:
  sync:
    name: Sync to ${{ matrix.repo }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.prepare.outputs.repos) }}
    needs: prepare
    
    steps:
      - name: Checkout control-center
        uses: actions/checkout@v5
        with:
          path: control-center
      
      - name: Checkout target repo
        uses: actions/checkout@v5
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.JBCOM_TOKEN }}
          path: target-repo
      
      - name: Sync Claude tooling
        id: sync
        run: |
          cd target-repo
          
          # Create directories
          mkdir -p .claude/commands
          mkdir -p .github/workflows
          
          # Get package name from repo
          PACKAGE_NAME=$(basename "${{ matrix.repo }}")
          
          # Copy and customize CLAUDE.md
          cp ../control-center/templates/claude/CLAUDE.md.template ./CLAUDE.md
          sed -i "s/\${PACKAGE_NAME}/$PACKAGE_NAME/g" ./CLAUDE.md
          sed -i "s/\${REPO}/${{ matrix.repo }}/g" ./CLAUDE.md
          
          # Copy commands
          cp ../control-center/templates/claude/commands/*.md ./.claude/commands/
          
          # Copy workflows
          cp ../control-center/templates/claude/workflows/*.yml ./.github/workflows/
          
          # Check for changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to sync for ${{ matrix.repo }}"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected for ${{ matrix.repo }}"
            git diff --stat
          fi
      
      - name: Create sync PR
        if: steps.sync.outputs.changed == 'true' && inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          cd target-repo
          
          BRANCH="sync/claude-tooling-$(date +%Y%m%d)"
          
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "chore: Sync Claude Code tooling from control-center
          
          Updates:
          - CLAUDE.md project context
          - .claude/commands/ slash commands
          - .github/workflows/claude-*.yml workflows
          
          Synced from: jbcom/jbcom-control-center
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push -u origin "$BRANCH"
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
          else
            gh pr create \
              --title "chore: Sync Claude Code tooling" \
              --body "## Summary
          
          Automated sync of Claude Code tooling from [jbcom-control-center](https://github.com/jbcom/jbcom-control-center).
          
          ## Changes
          - Updated CLAUDE.md with project context
          - Updated .claude/commands/ with latest slash commands
          - Updated Claude workflows
          
          ## Review
          These are standardized tooling updates. Review for any repo-specific customizations that might conflict.
          
          ---
          *Automated by sync-claude-tooling workflow*"
          fi

  prepare:
    name: Prepare sync matrix
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.repos.outputs.repos }}
    
    steps:
      - name: Determine repos to sync
        id: repos
        run: |
          if [ -n "${{ inputs.repos }}" ]; then
            # Use provided repos
            REPOS=$(echo "${{ inputs.repos }}" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            # Use all managed repos
            REPOS=$(cat << 'EOF' | jq -R -s -c 'split("\n") | map(select(length > 0))'
          jbcom/extended-data-types
          jbcom/lifecyclelogging
          jbcom/directed-inputs-class
          jbcom/vendor-connectors
          EOF
          )
          fi
          
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Will sync to: $REPOS"
