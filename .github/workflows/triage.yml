# =============================================================================
# Triage Workflow (this repo)
# =============================================================================
# ARCHITECTURE NOTE:
# - agentic-triage provides CLI + primitives (Vercel AI SDK tools)
# - agentic-control consumes these primitives (see jbcom/agentic-control#22)
# - This workflow uses the agentic-triage CLI for this repo only
# - For cross-repo triage, see agentic-triage.yml (Agentic Triage Hub)
# =============================================================================
name: Triage

on:
  # Trigger on new issues
  issues:
    types: [opened, labeled]

  # Trigger on new PRs for review
  pull_request:
    types: [opened, synchronize, ready_for_review]

  # Manual trigger for different triage commands
  workflow_dispatch:
    inputs:
      command:
        description: 'Triage command to run'
        required: true
        type: choice
        options:
          - sprint
          - roadmap
          - cascade
          - security
        default: sprint

  # Weekly sprint planning
  schedule:
    - cron: '0 9 * * 1'  # Monday 9am UTC

concurrency:
  group: triage-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
  OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}

jobs:
  # ============================================
  # ISSUE TRIAGE: Assess and label new issues
  # ============================================
  assess-issue:
    name: Assess Issue
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-node v6.1.0
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install agentic-triage
        run: npm install -g agentic-triage@latest

      - name: Assess issue
        run: agentic-triage assess ${{ github.event.issue.number }}

  # ============================================
  # PR REVIEW: Review new/updated PRs
  # ============================================
  review-pr:
    name: Review PR
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      # actions/setup-node v6.1.0
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install agentic-triage
        run: npm install -g agentic-triage@latest

      - name: Review PR
        run: agentic-triage review ${{ github.event.pull_request.number }}

  # ============================================
  # SPRINT PLANNING: Weekly automated sprint
  # ============================================
  sprint-planning:
    name: Sprint Planning
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'sprint')
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-node v6.1.0
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install agentic-triage
        run: npm install -g agentic-triage@latest

      - name: Run sprint planning
        run: agentic-triage sprint --trigger

  # ============================================
  # ROADMAP: Quarterly roadmap generation
  # ============================================
  roadmap:
    name: Generate Roadmap
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'roadmap'
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-node v6.1.0
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install agentic-triage
        run: npm install -g agentic-triage@latest

      - name: Generate roadmap
        run: agentic-triage roadmap

  # ============================================
  # SECURITY: Security scanning and alerts
  # ============================================
  security-scan:
    name: Security Scan
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'security'
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-node v6.1.0
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install agentic-triage
        run: npm install -g agentic-triage@latest

      - name: Run security scan
        run: agentic-triage security

  # ============================================
  # CASCADE: Full automation cycle
  # ============================================
  cascade:
    name: Cascade Automation
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'cascade'
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # actions/setup-node v6.1.0
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'

      - name: Install agentic-triage
        run: npm install -g agentic-triage@latest

      - name: Run cascade
        run: agentic-triage cascade
