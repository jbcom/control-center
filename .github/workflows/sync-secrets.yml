name: Sync Secrets

on:
  workflow_dispatch:
    inputs:
      repos:
        description: Comma-separated list of repos to sync (leave empty for all)
        required: false
        default: ""
      dry_run:
        description: Dry run mode
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: read

jobs:
  sync:
    name: Sync Secrets to Public Repos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync secrets
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          INPUT_REPOS: ${{ github.event.inputs.repos }}
          INPUT_DRY_RUN: ${{ github.event.inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail
          
          PUBLIC_REPOS=$(gh repo list jbcom --visibility public --json name --jq ".[].name")
          
          if [[ -n "${INPUT_REPOS:-}" ]]; then
            FILTER="^(${INPUT_REPOS//,/|})$"
            PUBLIC_REPOS=$(echo "$PUBLIC_REPOS" | grep -E "$FILTER" || true)
          fi
          
          echo "Syncing secrets to:"
          echo "$PUBLIC_REPOS"
          echo ""
          
          SECRETS="ANTHROPIC_API_KEY OPENROUTER_API_KEY OPENAI_API_KEY OLLAMA_API_KEY NPM_TOKEN PYPI_TOKEN DOCKERHUB_USERNAME DOCKERHUB_TOKEN"
          
          for repo in $PUBLIC_REPOS; do
            echo "üì¶ $repo"
            for secret in $SECRETS; do
              val="${!secret:-}"
              if [[ -z "$val" ]]; then
                echo "  ‚è≠Ô∏è $secret: skip"
                continue
              fi
              if [[ "${INPUT_DRY_RUN:-false}" == "true" ]]; then
                echo "  üîç $secret: dry-run"
                continue
              fi
              if gh secret set "$secret" --repo "jbcom/$repo" --body "$val" 2>/dev/null; then
                echo "  ‚úÖ $secret"
              else
                echo "  ‚ùå $secret"
              fi
            done
            echo ""
          done
          echo "‚úÖ Done!"
