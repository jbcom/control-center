name: Sync Secrets

# Sync organization secrets to public repositories
# Since org secrets with visibility "all" only work for private repos,
# this workflow runs in control-center (private) and syncs to public repos

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated list of repos to sync (leave empty for all public repos)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run mode'
        required: false
        default: false
        type: boolean
  schedule:
    # Run daily at 4am UTC (after Doppler sync)
    - cron: '0 4 * * *'

permissions:
  contents: read

jobs:
  sync:
    name: Sync Secrets to Public Repos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo-config
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            repo-config.json
            scripts/lib

      - name: Sync secrets
        env:
          GH_TOKEN: \${{ secrets.CI_GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: \${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: \${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: \${{ secrets.OPENAI_API_KEY }}
          OLLAMA_API_KEY: \${{ secrets.OLLAMA_API_KEY }}
          NPM_TOKEN: \${{ secrets.NPM_TOKEN }}
          PYPI_TOKEN: \${{ secrets.PYPI_TOKEN }}
          DOCKERHUB_USERNAME: \${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: \${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Get list of public repos from config
          PUBLIC_REPOS=\$(gh repo list jbcom --visibility public --json name --jq '.[].name')
          
          # If specific repos requested, filter to those
          if [[ -n "\${{ github.event.inputs.repos }}" ]]; then
            REQUESTED="\${{ github.event.inputs.repos }}"
            PUBLIC_REPOS=\$(echo "\$PUBLIC_REPOS" | grep -E "^(\${REQUESTED//,/|})$" || true)
          fi
          
          echo "Syncing secrets to public repos:"
          echo "\$PUBLIC_REPOS"
          echo ""
          
          # Define which secrets to sync
          declare -a SECRETS=(
            "ANTHROPIC_API_KEY"
            "OPENROUTER_API_KEY"
            "OPENAI_API_KEY"
            "OLLAMA_API_KEY"
            "NPM_TOKEN"
            "PYPI_TOKEN"
            "DOCKERHUB_USERNAME"
            "DOCKERHUB_TOKEN"
          )
          
          for repo in \$PUBLIC_REPOS; do
            echo "üì¶ Syncing: jbcom/\$repo"
            
            for secret_name in "\${SECRETS[@]}"; do
              secret_value="\${!secret_name:-}"
              
              if [[ -z "\$secret_value" ]]; then
                echo "  ‚è≠Ô∏è  \$secret_name: skipped (not set)"
                continue
              fi
              
              if [[ "\${{ github.event.inputs.dry_run }}" == "true" ]]; then
                echo "  üîç \$secret_name: would sync (dry run)"
                continue
              fi
              
              if gh secret set "\$secret_name" --repo "jbcom/\$repo" --body "\$secret_value" 2>/dev/null; then
                echo "  ‚úÖ \$secret_name: synced"
              else
                echo "  ‚ùå \$secret_name: failed"
              fi
            done
            
            echo ""
          done
          
          echo "‚úÖ Sync complete!"
