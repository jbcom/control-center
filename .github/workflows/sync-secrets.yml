name: Sync Secrets

on:
  workflow_dispatch:
    inputs:
      repos:
        description: Comma-separated list of repos to sync (leave empty for all)
        required: false
        default: ""
      dry_run:
        description: Dry run mode
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: read

jobs:
  sync:
    name: Sync Secrets to Public Repos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync secrets
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          CI_GITHUB_TOKEN_VALUE: ${{ secrets.CI_GITHUB_TOKEN }}
          INPUT_REPOS: ${{ github.event.inputs.repos }}
          INPUT_DRY_RUN: ${{ github.event.inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Checking GH_TOKEN permissions..."
          gh auth status || echo "Auth check done"
          
          PUBLIC_REPOS=$(gh repo list jbcom --visibility public --json name --jq ".[].name")
          
          if [[ -n "${INPUT_REPOS:-}" ]]; then
            FILTER="^(${INPUT_REPOS//,/|})$"
            PUBLIC_REPOS=$(echo "$PUBLIC_REPOS" | grep -E "$FILTER" || true)
          fi
          
          echo "Syncing secrets to:"
          echo "$PUBLIC_REPOS"
          echo ""
          
          # Include CI_GITHUB_TOKEN in the sync
          SECRETS="ANTHROPIC_API_KEY OPENROUTER_API_KEY OPENAI_API_KEY OLLAMA_API_KEY NPM_TOKEN PYPI_TOKEN DOCKERHUB_USERNAME DOCKERHUB_TOKEN CI_GITHUB_TOKEN_VALUE:CI_GITHUB_TOKEN"
          
          for repo in $PUBLIC_REPOS; do
            echo "üì¶ $repo"
            for secret_spec in $SECRETS; do
              # Handle renamed secrets (ENV_VAR:SECRET_NAME)
              if [[ "$secret_spec" == *":"* ]]; then
                env_var="${secret_spec%%:*}"
                secret_name="${secret_spec##*:}"
              else
                env_var="$secret_spec"
                secret_name="$secret_spec"
              fi
              
              val="${!env_var:-}"
              if [[ -z "$val" ]]; then
                echo "  ‚è≠Ô∏è $secret_name: skip (not set)"
                continue
              fi
              if [[ "${INPUT_DRY_RUN:-false}" == "true" ]]; then
                echo "  üîç $secret_name: dry-run"
                continue
              fi
              # Don't hide errors
              if gh secret set "$secret_name" --repo "jbcom/$repo" --body "$val"; then
                echo "  ‚úÖ $secret_name"
              else
                echo "  ‚ùå $secret_name: FAILED (exit $?)"
              fi
            done
            echo ""
          done
          echo "‚úÖ Done!"
