---
name: Ecosystem Orchestrator

# Unified workflow for PR reviews and issue delegation
# Called by ecosystem-connector.yml in each org's repos

on:
  # Direct triggers (for jbcom/control-center itself)
  pull_request:
    types: [opened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

  # Reusable workflow (called by other repos)
  workflow_call:
    inputs:
      action:
        description: 'Action: review, delegate'
        required: true
        type: string
      pr_number:
        description: 'PR number for review'
        required: false
        type: number
      model_tier:
        description: 'Model tier: ollama, claude, jules'
        required: false
        type: string
        default: 'ollama'
      comment_body:
        description: 'Comment body for delegation'
        required: false
        type: string
      issue_number:
        description: 'Issue number'
        required: false
        type: number
      issue_title:
        description: 'Issue title'
        required: false
        type: string
      issue_body:
        description: 'Issue body'
        required: false
        type: string
      default_branch:
        description: 'Default branch'
        required: false
        type: string
        default: 'main'
      repository:
        description: 'Target repository'
        required: true
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: false
      GOOGLE_JULES_API_KEY:
        required: false
      OLLAMA_API_KEY:
        required: false
      CURSOR_API_KEY:
        required: false

  workflow_dispatch:
    inputs:
      action:
        description: 'Action: review, delegate'
        required: true
        type: string
        default: 'review'
      repository:
        description: 'Target repository'
        required: true
        type: string
      pr_number:
        description: 'PR number'
        required: false
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  # ============================================================================
  # REVIEW: Ollama (Tier 1)
  # ============================================================================
  review_ollama:
    name: Review (Ollama)
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft) ||
      (github.event_name == 'workflow_call' && inputs.action == 'review') ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'review')
    runs-on: ubuntu-latest
    outputs:
      suggestion_count: ${{ steps.review.outputs.suggestion_count }}
      needs_escalation: ${{ steps.check.outputs.needs_escalation }}
    env:
      TARGET_REPO: ${{ inputs.repository || github.repository }}
      PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
      OLLAMA_HOST: ${{ vars.OLLAMA_API_URL || vars.OLLAMA_HOST || 'https://ollama.com' }}
      OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || 'glm-4.6:cloud' }}
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ env.TARGET_REPO }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Review PR with Ollama
        id: review
        uses: jbcom/control-center/.github/actions/agentic-pr-review@main
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          model: ${{ env.OLLAMA_MODEL }}
          ollama_api_key: ${{ secrets.OLLAMA_API_KEY }}
          ollama_host: ${{ env.OLLAMA_HOST }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}

      - name: Check for escalation
        id: check
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          SUGGESTIONS="${{ steps.review.outputs.suggestion_count }}"
          ADDITIONS=$(gh pr view ${{ env.PR_NUMBER }} --repo ${{ env.TARGET_REPO }} --json additions --jq '.additions' 2>/dev/null || echo "0")

          if [[ "$SUGGESTIONS" -gt 5 ]] || [[ "$ADDITIONS" -gt 500 ]] || [[ -z "$SUGGESTIONS" ]]; then
            echo "needs_escalation=true" >> $GITHUB_OUTPUT
          else
            echo "needs_escalation=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # REVIEW: Claude (Tier 2 - escalation)
  # ============================================================================
  review_claude:
    name: Review (Claude)
    needs: review_ollama
    if: |
      always() &&
      needs.review_ollama.outputs.needs_escalation == 'true'
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ inputs.repository || github.repository }}
      PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
    steps:
      - name: Check API Key
        id: check
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v6
        if: steps.check.outputs.skip != 'true'
        with:
          repository: ${{ env.TARGET_REPO }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Claude Code Review
        if: steps.check.outputs.skip != 'true'
        uses: anthropics/claude-code-action@154d0de144ff82240e1c3deedff56280381fd122 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          direct_prompt: |
            Review PR #${{ env.PR_NUMBER }} in ${{ env.TARGET_REPO }}.
            Focus on security, logic, performance, and error handling.
            Approve if no critical issues are found.

  # ============================================================================
  # DELEGATE: Jules/Cursor commands
  # ============================================================================
  delegate_jules_cursor:
    name: Delegate (Jules/Cursor)
    if: |
      (github.event_name == 'issue_comment' &&
       (startsWith(github.event.comment.body, '/jules') || startsWith(github.event.comment.body, '/cursor'))) ||
      (github.event_name == 'workflow_call' && inputs.action == 'delegate' &&
       (startsWith(inputs.comment_body, '/jules') || startsWith(inputs.comment_body, '/cursor'))) ||
      (github.event_name == 'workflow_dispatch' && inputs.action == 'delegate')
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ inputs.repository || github.repository }}
      ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
      COMMENT_BODY: ${{ inputs.comment_body || github.event.comment.body }}
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Delegate Issue Command
        uses: jbcom/control-center/.github/actions/agentic-issue-triage@main
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          cursor_api_key: ${{ secrets.CURSOR_API_KEY }}
          comment_body: ${{ env.COMMENT_BODY }}
          issue_number: ${{ env.ISSUE_NUMBER }}
          repository: ${{ env.TARGET_REPO }}
          default_branch: ${{ inputs.default_branch || github.event.repository.default_branch || 'main' }}

  # ============================================================================
  # DELEGATE: Claude on issues
  # ============================================================================
  delegate_claude_issue:
    name: Delegate (Claude Issue)
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request == null &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'workflow_call' && inputs.action == 'delegate' &&
       contains(inputs.comment_body, '@claude'))
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ inputs.repository || github.repository }}
      ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
      ISSUE_TITLE: ${{ inputs.issue_title || github.event.issue.title }}
      ISSUE_BODY: ${{ inputs.issue_body || github.event.issue.body }}
      COMMENT_BODY: ${{ inputs.comment_body || github.event.comment.body }}
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ env.TARGET_REPO }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Run Claude on Issue
        uses: anthropics/claude-code-action@154d0de144ff82240e1c3deedff56280381fd122 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_tools: "Edit,Write,Read,Glob,Grep,LS,Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Bash(gh pr view),Bash(gh pr create),Bash(gh issue view)"
          direct_prompt: |
            Issue in ${{ env.TARGET_REPO }}: #${{ env.ISSUE_NUMBER }}
            Title: ${{ env.ISSUE_TITLE }}

            Description:
            ${{ env.ISSUE_BODY }}

            Triggering comment: ${{ env.COMMENT_BODY }}

            Analyze and implement a fix or answer. Create a PR with changes.

  # ============================================================================
  # DELEGATE: Claude on PRs
  # ============================================================================
  delegate_claude_pr:
    name: Delegate (Claude PR)
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ inputs.repository || github.repository }}
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ env.TARGET_REPO }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Run Claude on PR
        uses: anthropics/claude-code-action@154d0de144ff82240e1c3deedff56280381fd122 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_tools: "Edit,Write,Read,Glob,Grep,LS,Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Bash(gh pr view),Bash(gh pr list)"
