name: Repository Sync

on:
  workflow_dispatch:
    inputs:
      sync_files:
        description: 'Sync repository files'
        required: false
        default: true
        type: boolean
      configure_repos:
        description: 'Configure repository settings'
        required: false
        default: true
        type: boolean
      target_repo:
        description: 'Target repo (empty for all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        default: false
        type: boolean
      push_changes:
        description: 'Push file changes to repos'
        required: false
        default: false
        type: boolean
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'
  schedule:
    # Daily at 6:00 UTC
    - cron: '0 6 * * *'

permissions:
  contents: write

env:
  GITHUB_ORG: jbdevprimary
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

jobs:
  # =============================================================================
  # Sync repository files via rsync
  # =============================================================================
  sync-files:
    name: Sync Repository Files
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_files != 'false'
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync files to submodules
        run: |
          OPTS=""
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            OPTS="$OPTS --dry-run"
          fi
          
          if [[ "${{ github.event.inputs.push_changes }}" == "true" ]]; then
            OPTS="$OPTS --push"
          fi
          
          TARGET="${{ github.event.inputs.target_repo }}"
          if [[ -n "$TARGET" ]]; then
            ./scripts/sync-files $OPTS "$TARGET"
          else
            ./scripts/sync-files $OPTS --all
          fi
      
      - name: Show sync summary
        run: |
          echo "## File Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for dir in ecosystems/oss/*/; do
            repo=$(basename "$dir")
            changes=$(git -C "$dir" status --porcelain 2>/dev/null | wc -l || echo 0)
            if [[ "$changes" -gt 0 ]]; then
              echo "- **$repo**: $changes files changed" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # =============================================================================
  # Configure repository settings via gh CLI
  # =============================================================================
  configure-repos:
    name: Configure Repository Settings
    runs-on: ubuntu-latest
    if: github.event.inputs.configure_repos != 'false'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure repositories
        run: |
          OPTS=""
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            OPTS="$OPTS --dry-run"
          fi
          
          TARGET="${{ github.event.inputs.target_repo }}"
          if [[ -n "$TARGET" ]]; then
            ./scripts/configure-repos $OPTS "$TARGET"
          else
            ./scripts/configure-repos $OPTS --all
          fi
      
      - name: Show configuration summary
        run: |
          echo "## Repository Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration applied based on \`repo-config.json\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Update submodules to latest
  # =============================================================================
  update-submodules:
    name: Update Submodules
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update submodules to latest
        run: |
          git submodule update --remote --recursive
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi
      
      - name: Create or update PR for submodule updates
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Use stable branch name to avoid stacking PRs
          BRANCH="auto/submodule-update"
          
          # Check for existing open PR
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' || echo "")
          
          if [[ -n "$EXISTING_PR" ]]; then
            echo "Found existing PR #$EXISTING_PR - updating..."
            git fetch origin "$BRANCH" 2>/dev/null || true
            git checkout -B "$BRANCH" origin/"$BRANCH" 2>/dev/null || git checkout -b "$BRANCH"
            git fetch origin main
            git rebase origin/main || git rebase --abort
          else
            git checkout -b "$BRANCH"
          fi
          
          git add -A
          git commit -m "chore: update submodules to latest" || echo "No new changes"
          git push -u origin "$BRANCH" --force-with-lease
          
          if [[ -z "$EXISTING_PR" ]]; then
            gh pr create \
              --title "chore: update submodules to latest" \
              --body "Automated submodule update to latest upstream commits.

          This PR automerges when CI passes." \
              --base main
            
            # Enable automerge
            NEW_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
            if [[ -n "$NEW_PR" ]]; then
              gh pr merge "$NEW_PR" --auto --squash || echo "Could not enable automerge"
            fi
          else
            echo "PR #$EXISTING_PR updated"
            gh pr merge "$EXISTING_PR" --auto --squash || echo "Automerge already enabled"
          fi
