name: Unlock TFC Workspaces

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Specific workspace to unlock (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (list locked workspaces without unlocking)'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  unlock:
    name: Unlock Workspaces
    runs-on: ubuntu-latest
    
    env:
      TF_API_TOKEN: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: List Locked Workspaces
        id: list
        run: |
          chmod +x scripts/unlock-tfc-workspaces.sh
          
          echo "## Locked Workspaces" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run dry-run to check for locks
          set +e
          if [ -n "${{ inputs.workspace }}" ]; then
            ./scripts/unlock-tfc-workspaces.sh --dry-run --workspace "${{ inputs.workspace }}" > list_output.txt 2>&1
          else
            ./scripts/unlock-tfc-workspaces.sh --dry-run > list_output.txt 2>&1
          fi
          exit_code=$?
          set -e
          
          # Add output to step summary
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat list_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Parse exit code (0 = no locks, 1 = locks found, 2+ = error)
          if [ $exit_code -eq 0 ]; then
            echo "locked_count=0" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 1 ]; then
            # Extract count from output as supplementary info
            locked_count=$(grep -oP "Found \K[0-9]+" list_output.txt | head -1 || echo "1")
            echo "locked_count=${locked_count}" >> $GITHUB_OUTPUT
          else
            echo "Error checking workspaces (exit code: $exit_code)"
            exit $exit_code
          fi
      
      - name: Unlock Workspaces
        if: inputs.dry_run == false && steps.list.outputs.locked_count != '0'
        run: |
          echo "## Unlocking Workspaces" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ inputs.workspace }}" ]; then
            ./scripts/unlock-tfc-workspaces.sh --workspace "${{ inputs.workspace }}" | tee unlock_output.txt
          else
            ./scripts/unlock-tfc-workspaces.sh | tee unlock_output.txt
          fi
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat unlock_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "### ðŸ” Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes were made. Re-run with **dry_run: false** to unlock workspaces." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.list.outputs.locked_count }}" == "0" ]; then
            echo "### âœ… No Locked Workspaces" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All workspaces are already unlocked." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Unlock Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Unlocked ${{ steps.list.outputs.locked_count }} workspace(s)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can now run the terraform-sync workflow." >> $GITHUB_STEP_SUMMARY
          fi
