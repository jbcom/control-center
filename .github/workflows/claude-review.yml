name: Claude Pre-Sync Review

# Run on PRs that modify packages/ - this is the GATE before sync
on:
  pull_request:
    paths:
      - 'packages/**'
    types: [opened, synchronize, ready_for_review]

concurrency:
  group: claude-review-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: pip install ruff mypy pytest

      - name: Claude Review & Auto-Heal
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            
            This PR modifies packages that will be synced to public repos and released to PyPI.
            
            ## Your Tasks
            
            1. **Review the changes** - Check for bugs, security issues, breaking changes
            2. **Run lint/format** - Execute `ruff check --fix` and `ruff format` on changed packages
            3. **Fix any issues you find** - Auto-heal code problems
            4. **Update documentation** if needed
            5. **Commit fixes** directly to this PR branch
            
            ## Package Structure
            ```
            packages/
            ├── extended-data-types/    → PyPI: extended-data-types (foundation)
            ├── lifecyclelogging/       → PyPI: lifecyclelogging
            ├── directed-inputs-class/  → PyPI: directed-inputs-class
            └── vendor-connectors/      → PyPI: cloud-connectors
            ```
            
            ## Key Rules
            - ALL packages must support Python 3.9+ (use `from __future__ import annotations` for union syntax)
            - Dependent packages should use utilities from extended-data-types, not duplicate them
            - CalVer versioning (YYYY.MM.BUILD) - don't manually set versions
            
            ## After Review
            - If you made fixes, commit them with message "fix: auto-heal from Claude review"
            - Post a summary comment on the PR
            - If everything is clean, just approve
            
          claude_args: |
            --allowedTools "Read,Write,Edit,Bash(ruff:*),Bash(pytest:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(gh pr comment:*),mcp__github_inline_comment__create_inline_comment"

  # Run tests after Claude review (in case Claude made changes)
  test:
    needs: claude-review
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [extended-data-types, lifecyclelogging, directed-inputs-class, vendor-connectors]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install and test ${{ matrix.package }}
        working-directory: packages/${{ matrix.package }}
        run: |
          pip install -e ".[tests]" 2>/dev/null || pip install -e ".[dev]" 2>/dev/null || pip install -e .
          pytest -x -v --tb=short 2>/dev/null || echo "No tests or tests skipped"
