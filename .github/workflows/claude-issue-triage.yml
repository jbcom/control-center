name: Claude Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    # Skip issues that are already agent tasks or labeled for claude
    if: |
      !contains(github.event.issue.labels.*.name, 'agent-task') &&
      !contains(github.event.issue.labels.*.name, 'claude')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Issue Triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_non_write_users: "*"  # Allow triage for issues from any user
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            ISSUE_TITLE: ${{ github.event.issue.title }}
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            
            Analyze this new issue and perform triage:
            
            ## 1. Classification
            Determine the type:
            - bug: Something is broken
            - enhancement: New feature request  
            - documentation: Docs need updates
            - question: User needs help
            - ci-cd: CI/CD or workflow related
            - security: Security concern
            
            ## 2. Priority Assessment
            - critical: System down, security vulnerability
            - high: Major functionality broken
            - medium: Important but not urgent
            - low: Nice to have
            
            ## 3. Package Detection
            Check if the issue mentions specific packages:
            - extended-data-types
            - lifecyclelogging  
            - vendor-connectors
            - directed-inputs-class
            
            ## 4. Actions to Take
            
            Based on your analysis:
            
            1. Add appropriate labels:
               `gh issue edit ${{ github.event.issue.number }} --add-label "label1,label2"`
            
            2. If it's a duplicate, find the original and comment:
               `gh issue comment ${{ github.event.issue.number }} --body "Looks like a duplicate of #X"`
            
            3. If it's an agent task (has ðŸ¤– in title), ensure it has the agent-task label
            
            4. Add a brief triage comment explaining:
               - What type of issue this is
               - Suggested priority
               - Any related issues found
               - Next steps
            
            ## Available Labels
            - bug, enhancement, documentation, question
            - ci-cd, security, ecosystem, maintenance
            - agent-task, agent-review-requested
            - pkg:extended-data-types, pkg:lifecyclelogging, pkg:vendor-connectors, pkg:directed-inputs-class
            - priority:critical, priority:high, priority:medium, priority:low
            - stale, has-pr, blocked
          
          claude_args: |
            --allowedTools "Bash(gh issue:*),Bash(gh search:*),Read,Glob,Grep"
            --max-turns 10
