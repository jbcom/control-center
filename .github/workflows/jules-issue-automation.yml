name: Jules Automation

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  delegate-to-jules-issue:
    name: Delegate Issue to Jules
    if: "contains(github.event.comment.body, '/jules') && github.event.issue.pull_request == null"
    runs-on: ubuntu-latest
    steps:
      - name: Check for API Key
        id: check
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          if [[ -z "$GOOGLE_JULES_API_KEY" ]]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge
        if: steps.check.outputs.available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ü§ñ Received '/jules' command. Creating Jules session..."

      - name: Create Jules Session
        if: steps.check.outputs.available == 'true'
        id: jules
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          USER_PROMPT=$(echo "$COMMENT_BODY" | sed 's|/jules[[:space:]]*||')
          if [[ -z "$USER_PROMPT" ]]; then
            TASK="Resolve issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}. Issue description: ${ISSUE_BODY}"
          else
            TASK="Resolve issue #${ISSUE_NUMBER} (${ISSUE_TITLE}) with the following instructions: ${USER_PROMPT}"
          fi

          RESPONSE=$(curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "$TASK" \
              --arg repo "${{ github.repository }}" \
              --arg branch "$DEFAULT_BRANCH" \
              '{
                prompt: $task,
                sourceContext: {
                  source: ("sources/github/" + ($repo | split("/")[0]) + "/" + ($repo | split("/")[1])),
                  githubRepoContext: { startingBranch: $branch }
                },
                automationMode: "AUTO_CREATE_PR"
              }')")

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          SESSION_URL="https://jules.google.com/session/$SESSION_ID"

          echo "session_url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

      - name: Post Session Link
        if: steps.check.outputs.available == 'true' && steps.jules.outputs.session_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ü§ñ Jules Session Created

          ‚û°Ô∏è **[Monitor Session](${{ steps.jules.outputs.session_url }})**

          Jules will analyze the issue and create a new PR with the suggested refactoring."

      - name: Post API Key Missing
        if: steps.check.outputs.available == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ö†Ô∏è GOOGLE_JULES_API_KEY not configured. Cannot delegate to Jules."

      - name: Post Session Creation Failed
        if: steps.check.outputs.available == 'true' && steps.jules.outputs.session_id == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ùå Failed to create Jules session. Please check the workflow logs for more details."

  delegate-to-jules-pr:
    name: Delegate PR to Jules
    if: "contains(github.event.comment.body, '/jules') && github.event.issue.pull_request != null"
    runs-on: ubuntu-latest
    steps:
      - name: Check for API Key
        id: check
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          if [[ -z "$GOOGLE_JULES_API_KEY" ]]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Acknowledge
        if: steps.check.outputs.available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "ü§ñ Received '/jules' command. Creating Jules session..."

      - name: Get PR branch
        if: steps.check.outputs.available == 'true'
        id: get_branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH=$(gh pr view ${{ github.event.issue.number }} --json headRefName -q .headRefName)
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create Jules Session
        if: steps.check.outputs.available == 'true'
        id: jules
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          PR_NUMBER: ${{ github.event.issue.number }}
          PR_TITLE: ${{ github.event.issue.title }}
          PR_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_BRANCH: ${{ steps.get_branch.outputs.branch }}
        run: |
          USER_PROMPT=$(echo "$COMMENT_BODY" | sed 's|/jules[[:space:]]*||')
          if [[ -z "$USER_PROMPT" ]]; then
            TASK="Refactor pull request #${PR_NUMBER}: ${PR_TITLE}. PR description: ${PR_BODY}"
          else
            TASK="Refactor pull request #${PR_NUMBER} (${PR_TITLE}) with the following instructions: ${USER_PROMPT}"
          fi

          RESPONSE=$(curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "$TASK" \
              --arg repo "${{ github.repository }}" \
              --arg branch "$PR_BRANCH" \
              '{
                prompt: $task,
                sourceContext: {
                  source: ("sources/github/" + ($repo | split("/")[0]) + "/" + ($repo | split("/")[1])),
                  githubRepoContext: { startingBranch: $branch }
                },
                automationMode: "AUTO_CREATE_PR"
              }')")

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          SESSION_URL="https://jules.google.com/session/$SESSION_ID"

          echo "session_url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

      - name: Post Session Link
        if: steps.check.outputs.available == 'true' && steps.jules.outputs.session_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "## ü§ñ Jules Session Created

          ‚û°Ô∏è **[Monitor Session](${{ steps.jules.outputs.session_url }})**

          Jules will analyze the PR and create a new PR with the suggested refactoring."

      - name: Post API Key Missing
        if: steps.check.outputs.available == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "‚ö†Ô∏è GOOGLE_JULES_API_KEY not configured. Cannot delegate to Jules."

      - name: Post Session Creation Failed
        if: steps.check.outputs.available == 'true' && steps.jules.outputs.session_id == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "‚ùå Failed to create Jules session. Please check the workflow logs for more details."
