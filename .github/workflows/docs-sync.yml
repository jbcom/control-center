---
# Sync generated documentation to jbcom enterprise docs site
# Control Center is the flagship Go release - it gets a special page
name: Sync Docs to Enterprise Site

on:
  workflow_run:
    workflows: ["Deploy Documentation"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout control-center
        uses: actions/checkout@v4
        with:
          path: control-center

      - name: Checkout jbcom/docs
        uses: actions/checkout@v4
        with:
          repository: jbcom/docs
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          path: docs

      - name: Download built docs artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: docs.yml
          name: github-pages
          path: docs-artifact
        continue-on-error: true

      - name: Extract docs artifact
        if: success()
        run: |
          # GitHub Pages artifact is a tarball
          if [ -f docs-artifact/artifact.tar ]; then
            mkdir -p extracted-docs
            tar -xf docs-artifact/artifact.tar -C extracted-docs
            echo "ðŸ“¦ Extracted docs artifact"
          else
            echo "âš ï¸ No artifact found, will sync source docs"
          fi

      - name: Sync to enterprise docs
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          cd docs
          
          # Create control-center section if it doesn't exist
          mkdir -p content/projects/control-center
          
          # Copy main documentation (source markdown for Hugo processing)
          cp -r ../control-center/docs/site/content/* content/projects/control-center/ 2>/dev/null || true
          
          # Create special index for flagship project
          cat > content/projects/control-center/_index.md << 'EOF'
          ---
          title: "Control Center"
          description: "Enterprise AI Orchestration CLI"
          weight: 1
          type: "project"
          flagship: true
          github: "https://github.com/jbcom/control-center"
          godoc: "https://pkg.go.dev/github.com/jbcom/control-center"
          docs: "https://jbcom.github.io/control-center/"
          ---
          
          # Control Center
          
          **The only public Go release from jbcom.**
          
          Control Center is the unified CLI for enterprise AI orchestration, providing
          native integrations with Ollama, Google Jules, and Cursor Cloud for managing
          repositories and automation across the jbcom ecosystem.
          
          ## Quick Links
          
          - [ðŸ“– Full Documentation](https://jbcom.github.io/control-center/)
          - [ðŸ“¦ Go Package](https://pkg.go.dev/github.com/jbcom/control-center)
          - [ðŸ™ GitHub Repository](https://github.com/jbcom/control-center)
          - [ðŸ³ Docker Image](https://ghcr.io/jbcom/control-center)
          
          ## Installation
          
          ```bash
          go install github.com/jbcom/control-center/cmd/control-center@latest
          ```
          
          ## Features
          
          - **Gardener** - Enterprise cascade orchestration
          - **Curator** - AI-powered issue and PR triage
          - **Reviewer** - Ollama-based code review
          - **Fixer** - CI failure analysis and suggestions
          
          See the [full documentation](https://jbcom.github.io/control-center/) for details.
          EOF
          
          echo "âœ… Synced control-center docs to enterprise site"

      - name: Check for changes
        id: changes
        run: |
          cd docs
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR to jbcom/docs
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          cd docs
          
          BRANCH="sync/control-center-docs-$(date +%Y%m%d)"
          
          git config user.name "jbcom-bot"
          git config user.email "bot@jonbogaty.com"
          
          git checkout -b "$BRANCH"
          git add .
          git commit -m "docs(control-center): sync documentation from control-center
          
          Auto-synced from jbcom/control-center docs build.
          
          - Updated API reference
          - Updated command documentation
          - Synced getting started guide"
          
          git push origin "$BRANCH"
          
          gh pr create \
            --repo jbcom/docs \
            --title "docs: sync control-center documentation" \
            --body "## Summary
          
          Automated documentation sync from [control-center](https://github.com/jbcom/control-center).
          
          ## Changes
          
          - Updated project documentation
          - Synced from latest docs build
          
          ## Preview
          
          - [Control Center Docs](https://jbcom.github.io/control-center/)
          - [Go Package](https://pkg.go.dev/github.com/jbcom/control-center)
          
          ---
          <sub>Auto-generated by docs-sync workflow</sub>" \
            --head "$BRANCH" \
            --base main
          
          echo "âœ… Created PR to sync docs"
