name: Terraform Repository Sync

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-sync.yml'
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-sync.yml'
  schedule:
    # Run daily at 2 AM UTC to detect drift
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      apply:
        description: "Apply changes (default: plan only)"
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write  # For security scanning

# Prevent concurrent Terraform runs on the same workspace
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    
    env:
      # GitHub token for Terraform GitHub provider (repository management)
      GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
      # Separate token for PR comments (dflook actions)
      TERRAFORM_ACTIONS_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # HCP Terraform Cloud authentication
      TERRAFORM_CLOUD_TOKENS: app.terraform.io=${{ secrets.TF_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =================================================================
      # FORMAT CHECK - All events
      # =================================================================
      - name: Terraform Format Check
        uses: dflook/terraform-fmt-check@v2
        with:
          path: terraform

      # =================================================================
      # SECURITY SCANNING - All events
      # =================================================================
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'terraform/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'terraform-security'
        continue-on-error: true

      # =================================================================
      # PULL REQUEST - Plan and comment
      # =================================================================
      - name: Terraform Plan
        id: plan
        if: github.event_name == 'pull_request'
        uses: dflook/terraform-plan@v2
        with:
          path: terraform
          label: jbcom-repositories
          add_github_comment: changes-only

      - name: PR Plan Summary
        if: github.event_name == 'pull_request'
        run: |
          echo '## Terraform Plan Summary' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '| Metric | Count |' >> $GITHUB_STEP_SUMMARY
          echo '|--------|-------|' >> $GITHUB_STEP_SUMMARY
          echo '| Resources to add | ${{ steps.plan.outputs.to_add }} |' >> $GITHUB_STEP_SUMMARY
          echo '| Resources to change | ${{ steps.plan.outputs.to_change }} |' >> $GITHUB_STEP_SUMMARY
          echo '| Resources to destroy | ${{ steps.plan.outputs.to_destroy }} |' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.plan.outputs.changes }}" == "true" ]]; then
            echo '**Status:** ðŸ“ Changes detected - review the plan in the PR comment' >> $GITHUB_STEP_SUMMARY
          else
            echo '**Status:** âœ… No changes needed' >> $GITHUB_STEP_SUMMARY
          fi

      # =================================================================
      # PUSH TO MAIN - Apply changes
      # =================================================================
      - name: Terraform Apply (Push to Main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: dflook/terraform-apply@v2
        with:
          path: terraform
          label: jbcom-repositories
          auto_approve: true

      - name: Apply Summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo '## Terraform Apply Complete' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'âœ… Repository configurations have been applied successfully.' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '**Managed:** 18 jbcom repositories' >> $GITHUB_STEP_SUMMARY

      # =================================================================
      # MANUAL DISPATCH - Apply on demand
      # =================================================================
      - name: Terraform Apply (Manual)
        if: github.event_name == 'workflow_dispatch' && inputs.apply
        uses: dflook/terraform-apply@v2
        with:
          path: terraform
          label: jbcom-repositories
          auto_approve: true

      - name: Manual Plan Only
        id: manual-plan
        if: github.event_name == 'workflow_dispatch' && !inputs.apply
        uses: dflook/terraform-plan@v2
        with:
          path: terraform
          label: jbcom-repositories
          add_github_comment: false

      - name: Manual Dispatch Summary
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo '## Manual Terraform Run' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.apply }}" == "true" ]]; then
            echo 'âœ… **Apply completed** - Changes have been applied' >> $GITHUB_STEP_SUMMARY
          else
            echo 'ðŸ“‹ **Plan only** - No changes applied' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo 'To apply changes, re-run with `apply: true`' >> $GITHUB_STEP_SUMMARY
          fi

      # =================================================================
      # SCHEDULED - Drift detection
      # =================================================================
      - name: Check for Drift
        id: drift
        if: github.event_name == 'schedule'
        uses: dflook/terraform-check@v2
        with:
          path: terraform
        continue-on-error: true

      - name: Drift Detection Summary
        if: github.event_name == 'schedule'
        run: |
          echo '## Daily Drift Detection' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.drift.outcome }}" == "success" ]]; then
            echo 'âœ… **No drift detected**' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo 'All 18 jbcom repositories match the Terraform configuration.' >> $GITHUB_STEP_SUMMARY
          else
            echo 'âš ï¸ **Configuration drift detected**' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo 'Repositories have diverged from Terraform state.' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo 'Run `terraform apply` or merge a PR to realign configurations.' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on Drift
        if: github.event_name == 'schedule' && steps.drift.outcome == 'failure'
        run: |
          echo "::error::Configuration drift detected - repositories do not match Terraform state"
          exit 1
