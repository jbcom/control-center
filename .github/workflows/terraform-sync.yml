name: Terragrunt Repository Sync

on:
  push:
    branches: [main]
    paths:
      - 'terragrunt-stacks/**'
      - 'repository-files/**'
      - 'scripts/**'
      - '.github/workflows/terraform-sync.yml'
  pull_request:
    paths:
      - 'terragrunt-stacks/**'
      - 'repository-files/**'
      - 'scripts/**'
      - '.github/workflows/terraform-sync.yml'
  schedule:
    # Run daily at 2 AM UTC to detect drift
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      apply:
        description: "Apply changes (default: plan only)"
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

# Prevent concurrent Terraform runs
concurrency:
  group: terragrunt-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terragrunt:
    name: Terragrunt
    runs-on: ubuntu-latest
    
    env:
      # CI_GITHUB_TOKEN requires these permissions:
      # - repo (full control) - for repository settings management
      # - admin:org (read) - for organization membership checks
      # - workflow (write) - for GitHub Actions workflow modifications
      GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
      # TF_TOKEN_app_terraform_io is the env var Terraform Cloud expects
      # The secret is named TF_TOKEN_APP_TERRAFORM_IO (same token used for backend + TFE provider)
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
      # Alias the same token for legacy providers and CLI-driven workflows
      TF_API_TOKEN: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
      TFE_TOKEN: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
      
      # Secrets to sync to all repositories via Terraform
      # These are passed as TF_VAR_* environment variables
      TF_VAR_ci_github_token: ${{ secrets.CI_GITHUB_TOKEN }}
      TF_VAR_pypi_token: ${{ secrets.PYPI_TOKEN }}
      TF_VAR_npm_token: ${{ secrets.NPM_TOKEN }}
      TF_VAR_anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      TF_VAR_ollama_api_key: ${{ secrets.OLLAMA_API_KEY }}

    steps:
      - name: Checkout
        # actions/checkout v6.0.1
        # Docs: https://github.com/actions/checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Setup Terraform
        # hashicorp/setup-terraform v3.1.2
        # Docs: https://github.com/hashicorp/setup-terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: "1.14.1"
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
          cli_config_credentials_hostname: app.terraform.io

      - name: Setup Terragrunt
        run: |
          curl -sL https://github.com/gruntwork-io/terragrunt/releases/download/v0.77.22/terragrunt_linux_amd64 -o terragrunt
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/
          terragrunt --version

      # =================================================================
      # TFC WORKSPACE MANAGEMENT - Unlock any locked workspaces
      # =================================================================
      - name: Check for Locked Workspaces
        id: check_locks
        run: |
          chmod +x scripts/unlock-tfc-workspaces.sh
          
          echo "## Workspace Lock Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for locked workspaces (exit code 0 = success/no locks, 1 = locks found)
          set +e
          ./scripts/unlock-tfc-workspaces.sh --dry-run > lock_check.txt 2>&1
          exit_code=$?
          set -e
          
          cat lock_check.txt
          
          if [ $exit_code -eq 0 ]; then
            echo "âœ… All workspaces are unlocked" >> $GITHUB_STEP_SUMMARY
            echo "has_locks=false" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 1 ]; then
            echo "âš ï¸ Found locked workspaces - attempting to unlock..." >> $GITHUB_STEP_SUMMARY
            echo "has_locks=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to check workspace locks" >> $GITHUB_STEP_SUMMARY
            cat lock_check.txt >> $GITHUB_STEP_SUMMARY
            exit $exit_code
          fi

      - name: Unlock Workspaces
        if: steps.check_locks.outputs.has_locks == 'true'
        run: |
          echo "Unlocking workspaces..." | tee -a $GITHUB_STEP_SUMMARY
          
          # Run unlock script and capture output
          set +e
          ./scripts/unlock-tfc-workspaces.sh > unlock_output.txt 2>&1
          unlock_exit=$?
          set -e
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat unlock_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check exit code
          if [ $unlock_exit -eq 0 ]; then
            echo "âœ… Workspaces unlocked successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to unlock workspaces (exit code: $unlock_exit)" >> $GITHUB_STEP_SUMMARY
            exit $unlock_exit
          fi

      # =================================================================
      # VALIDATION - Ensure Terraform code is syntactically valid
      # =================================================================
      - name: Validate Generate Blocks
        run: |
          chmod +x scripts/validate-terragrunt-generate-blocks.sh
          ./scripts/validate-terragrunt-generate-blocks.sh
          echo "âœ… No duplicate generate block names found" >> $GITHUB_STEP_SUMMARY

      - name: Terraform Validate
        working-directory: terragrunt-stacks/modules/repository
        run: |
          terraform init -backend=false
          terraform validate
          echo "âœ… Terraform configuration is valid" >> $GITHUB_STEP_SUMMARY

      # =================================================================
      # SECURITY SCANNING
      # =================================================================
      - name: Run Trivy Security Scan
        # aquasecurity/trivy-action v0.33.1
        # Docs: https://github.com/aquasecurity/trivy-action
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: 'config'
          scan-ref: 'terragrunt-stacks/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true

      - name: Upload Trivy Results
        # github/codeql-action v4.31.7
        # Docs: https://github.com/github/codeql-action
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'terraform-security'
        continue-on-error: true

      # =================================================================
      # PULL REQUEST - Plan all repos
      # =================================================================
      - name: Terragrunt Plan
        id: plan
        if: github.event_name == 'pull_request'
        working-directory: terragrunt-stacks
        run: |
          echo "## Terragrunt Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run plan and capture output
          terragrunt run-all plan --non-interactive 2>&1 | tee plan_output.txt
          
          # Count changes
          CHANGES=$(grep -c "Plan:" plan_output.txt || echo "0")
          NO_CHANGES=$(grep -c "No changes" plan_output.txt || echo "0")
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repos with changes | $CHANGES |" >> $GITHUB_STEP_SUMMARY
          echo "| Repos without changes | $NO_CHANGES |" >> $GITHUB_STEP_SUMMARY
          
          if [[ $CHANGES -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Changes detected** - Review the plan output" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **No changes needed**" >> $GITHUB_STEP_SUMMARY
          fi

      # =================================================================
      # PUSH TO MAIN - Apply changes
      # =================================================================
      - name: Terragrunt Apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: terragrunt-stacks
        run: |
          terragrunt run-all apply --non-interactive
          
          echo "## Terragrunt Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Repository configurations applied to all 18 jbcom repositories." >> $GITHUB_STEP_SUMMARY

      # =================================================================
      # MANUAL DISPATCH
      # =================================================================
      - name: Terragrunt Apply (Manual)
        if: github.event_name == 'workflow_dispatch' && inputs.apply
        working-directory: terragrunt-stacks
        run: |
          terragrunt run-all apply --non-interactive
          
          echo "## Manual Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Changes applied successfully." >> $GITHUB_STEP_SUMMARY

      - name: Terragrunt Plan Only (Manual)
        if: github.event_name == 'workflow_dispatch' && !inputs.apply
        working-directory: terragrunt-stacks
        run: |
          terragrunt run-all plan --non-interactive
          
          echo "## Manual Plan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Plan completed - re-run with apply: true to apply changes." >> $GITHUB_STEP_SUMMARY

      # =================================================================
      # SCHEDULED - Drift detection
      # =================================================================
      - name: Check for Drift
        id: drift
        if: github.event_name == 'schedule'
        working-directory: terragrunt-stacks
        run: |
          echo "## Daily Drift Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          terragrunt run-all plan --non-interactive 2>&1 | tee drift_output.txt
          
          CHANGES=$(grep -c "Plan:" drift_output.txt || echo "0")
          
          if [[ $CHANGES -eq 0 ]]; then
            echo "âœ… **No drift detected** - All 18 repos match configuration." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Drift detected** in $CHANGES repositories" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run 'terragrunt run-all apply' to realign configurations." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
