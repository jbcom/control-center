name: Terraform Repository Sync

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-sync.yml'
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-sync.yml'
  schedule:
    # Run daily at 2 AM UTC to detect drift
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      apply:
        description: "Apply changes (default: plan only)"
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write  # For security scanning

# Prevent concurrent Terraform runs on the same workspace
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: terraform
    
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.1"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan -no-color -input=false -out=tfplan -detailed-exitcode
          echo "exitcode=$?" >> $GITHUB_OUTPUT
          exit 0
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Save Plan Output
        if: github.event_name == 'pull_request' && steps.plan.outputs.exitcode != '1'
        run: terraform show -no-color tfplan > plan.txt
      
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'terraform/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
        continue-on-error: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'terraform-security'
        continue-on-error: true

      - name: Generate Step Summary
        if: always()
        run: |
          echo '## Terraform Workflow Summary' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '| Step | Status |' >> $GITHUB_STEP_SUMMARY
          echo '|------|--------|' >> $GITHUB_STEP_SUMMARY
          echo '| Format Check | ${{ steps.fmt.outcome == 'success' && 'âœ…' || 'âŒ' }} |' >> $GITHUB_STEP_SUMMARY
          echo '| Initialize | ${{ steps.init.outcome == 'success' && 'âœ…' || 'âŒ' }} |' >> $GITHUB_STEP_SUMMARY
          echo '| Validate | ${{ steps.validate.outcome == 'success' && 'âœ…' || 'âŒ' }} |' >> $GITHUB_STEP_SUMMARY
          echo '| Plan | ${{ steps.plan.outcome == 'success' && 'âœ…' || 'âŒ' }} |' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          
          # Plan summary
          if [[ "${{ steps.plan.outputs.exitcode }}" == "0" ]]; then
            echo '**Plan Result:** No changes needed' >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.exitcode }}" == "2" ]]; then
            echo '**Plan Result:** Changes detected' >> $GITHUB_STEP_SUMMARY
          else
            echo '**Plan Result:** Error occurred' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request' && steps.plan.outputs.exitcode != '1'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const rawPlan = fs.readFileSync('terraform/plan.txt', 'utf8');
            
            // Sanitize plan output to prevent markdown injection
            // Escape backticks and dollar signs that could break markdown code blocks
            const sanitizePlan = (text) => {
              return text
                .replace(/`/g, '\\`')
                .replace(/\$/g, '\\$')
                .slice(0, 65000); // GitHub comment size limit safety
            };
            const plan = sanitizePlan(rawPlan);
            
            const fmtStatus = '${{ steps.fmt.outcome }}' === 'success' ? 'âœ…' : 'âŒ';
            const initStatus = '${{ steps.init.outcome }}' === 'success' ? 'âœ…' : 'âŒ';
            const validateStatus = '${{ steps.validate.outcome }}' === 'success' ? 'âœ…' : 'âŒ';
            const planExitCode = '${{ steps.plan.outputs.exitcode }}';
            
            let planStatus = 'âœ…';
            let planMessage = 'No changes';
            if (planExitCode === '2') {
              planStatus = 'ğŸ“';
              planMessage = 'Changes detected';
            } else if (planExitCode !== '0') {
              planStatus = 'âŒ';
              planMessage = 'Error';
            }
            
            const output = `## Terraform Plan Results
            
            | Check | Status |
            |-------|--------|
            | Format | ${fmtStatus} \`${{ steps.fmt.outcome }}\` |
            | Initialize | ${initStatus} \`${{ steps.init.outcome }}\` |
            | Validate | ${validateStatus} \`${{ steps.validate.outcome }}\` |
            | Plan | ${planStatus} ${planMessage} |
            
            <details><summary>ğŸ“– Show Terraform Plan</summary>
            
            \`\`\`terraform
            ${plan}
            \`\`\`
            
            </details>
            
            ---
            *Triggered by @${{ github.actor }} via \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Check Plan Status
        if: steps.plan.outputs.exitcode == '1'
        run: |
          echo "Terraform plan failed"
          exit 1

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          (github.event_name == 'workflow_dispatch' && inputs.apply)
        run: terraform apply -auto-approve -input=false tfplan
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Drift Detection
        if: github.event_name == 'schedule'
        run: |
          if [[ "${{ steps.plan.outputs.exitcode }}" == "0" ]]; then
            echo "âœ… No drift detected - repositories are in sync"
            echo "## âœ… Drift Detection: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "All 18 repositories match the Terraform configuration." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Configuration drift detected"
            echo "## âš ï¸ Drift Detection: Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "Repositories have diverged from Terraform state." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`terraform apply\` to realign configurations." >> $GITHUB_STEP_SUMMARY
            terraform show tfplan
            exit 1
          fi

      - name: Cleanup Plan Files
        if: always()
        run: |
          # Remove plan files to avoid leaving sensitive data
          rm -f tfplan plan.txt
          echo "Plan files cleaned up"
