name: Ecosystem Sync

# Sync repository-files to all managed repositories using repo-file-sync-action
# 
# Two separate sync configs for safety:
# - sync-always.yml: Files that ALWAYS overwrite (workflows, cursor rules)
# - sync-initial.yml: Files created ONLY if missing (templates, customizable configs)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      skip_pr:
        description: 'Push directly (skip PR creation)'
        required: false
        default: false
        type: boolean
      sync_type:
        description: 'Which files to sync'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - always-only
          - initial-only
  schedule:
    # Nightly at 3:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'
      - '.github/sync-always.yml'
      - '.github/sync-initial.yml'

permissions:
  contents: read

jobs:
  # =============================================================================
  # Validate sync configuration
  # =============================================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Validate repo-config.json
        run: ./scripts/validate-config

      - name: Check for symlinks in repository-files
        run: ./scripts/check-symlinks

      - name: Validate sync configs
        run: |
          pip install -q pyyaml 2>/dev/null || true
          for config in .github/sync-always.yml .github/sync-initial.yml; do
            python3 -c "import yaml; yaml.safe_load(open('$config'))" 2>/dev/null || \
              (echo "âš ï¸ YAML validation skipped for $config" && continue)
            echo "âœ… $config is valid YAML"
          done

  # =============================================================================
  # Sync ALWAYS files (overwrite existing)
  # =============================================================================
  sync-always:
    name: Sync Always Files
    needs: validate
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.sync_type != 'initial-only'
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # BetaHuhn/repo-file-sync-action v1.21.1 (pinned for security)
      - name: Sync Always Files
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-always.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: ${{ github.event.inputs.skip_pr == 'true' || github.event_name == 'schedule' }}
          PR_LABELS: |
            sync
            automated
          COMMIT_PREFIX: 'chore(sync):'
          COMMIT_BODY: |
            Automated sync of shared configurations.
            
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH_PREFIX: control-center-sync
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]
          OVERWRITE_EXISTING_PR: true

  # =============================================================================
  # Sync INITIAL files (only if missing - safe for customized repos)
  # =============================================================================
  sync-initial:
    name: Sync Initial Files
    needs: validate
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.sync_type != 'always-only'
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # BetaHuhn/repo-file-sync-action v1.21.1 (pinned for security)
      - name: Sync Initial Files
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-initial.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: ${{ github.event.inputs.skip_pr == 'true' || github.event_name == 'schedule' }}
          PR_LABELS: |
            sync
            automated
            initial-setup
          COMMIT_PREFIX: 'chore(init):'
          COMMIT_BODY: |
            Initial file setup (only creates missing files).
            
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH_PREFIX: control-center-init
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]
          OVERWRITE_EXISTING_PR: true

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: Sync Summary
    needs: [sync-always, sync-initial]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Ecosystem Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mode
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ” **Mode:** Dry run (no changes made)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.skip_pr }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "âš¡ **Mode:** Direct push to main" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **Mode:** Pull requests created" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Sync type
          SYNC_TYPE="${{ github.event.inputs.sync_type || 'both' }}"
          echo "### Sync Type: \`$SYNC_TYPE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Always sync
          if [[ "$SYNC_TYPE" != "initial-only" ]]; then
            echo "#### Always-Sync Files (overwrite)" >> $GITHUB_STEP_SUMMARY
            echo "- \`.cursor/\` rules" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/workflows/\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/agents/\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/settings.yml\`" >> $GITHUB_STEP_SUMMARY
            echo "- Language-specific configs" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Initial sync
          if [[ "$SYNC_TYPE" != "always-only" ]]; then
            echo "#### Initial-Only Files (if missing)" >> $GITHUB_STEP_SUMMARY
            echo "- \`CLAUDE.md\`, \`AGENTS.md\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/dependabot.yml\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/ISSUE_TEMPLATE/\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`docs/\` scaffold" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Config files: \`.github/sync-always.yml\`, \`.github/sync-initial.yml\`*" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Update submodules in control center
  # =============================================================================
  update-submodules:
    name: Update Submodules
    needs: [sync-always, sync-initial]
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update submodules
        run: |
          git submodule update --remote --recursive || true

      - name: Push submodule updates
        run: |
          if git diff --quiet; then
            echo "No submodule changes"
            exit 0
          fi

          git add -A
          git commit -m "deps: update submodules to latest"
          git push origin main
          echo "âœ… Submodules updated"

  # =============================================================================
  # Sync issues to GitHub Projects
  # =============================================================================
  sync-projects:
    name: Sync Issues to Projects
    needs: [sync-always, sync-initial, update-submodules]
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Sync all issues to projects
        run: |
          ./scripts/sync-projects --verbose
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
