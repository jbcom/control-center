name: Ecosystem Sync

on:
  workflow_dispatch:
    inputs:
      update_submodules:
        description: 'Update all submodules to latest'
        required: false
        default: true
        type: boolean
      sync_missing:
        description: 'Add missing submodules'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
  schedule:
    # Daily sync at 6:00 UTC
    - cron: '0 6 * * *'
  push:
    branches: [main]
    paths:
      - 'triage-hub.json'
      - 'repo-config.json'

permissions:
  contents: write
  pull-requests: write

env:
  GITHUB_ORG: jbdevprimary
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

jobs:
  # =============================================================================
  # Discover and sync ecosystem repositories
  # =============================================================================
  sync:
    name: Sync Ecosystem Submodules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Discover organization repos
        id: discover
        run: |
          echo "Discovering repos in $GITHUB_ORG..."
          
          # Get all non-archived repos
          REPOS=$(gh repo list "$GITHUB_ORG" \
            --json name,primaryLanguage,isArchived \
            --limit 200 \
            --jq '.[] | select(.isArchived == false) | .name')
          
          echo "Found $(echo "$REPOS" | wc -l) active repos"
          echo "$REPOS"
          
          # Save for later steps
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          echo "$REPOS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Check for missing submodules
        id: missing
        run: |
          source ./scripts/lib/ecosystem.sh
          
          echo "Checking for missing submodules..."
          MISSING=$(list_missing_submodules || echo "")
          
          if [[ -n "$MISSING" ]]; then
            echo "Missing submodules:"
            echo "$MISSING"
            echo "has_missing=true" >> $GITHUB_OUTPUT
            echo "missing<<EOF" >> $GITHUB_OUTPUT
            echo "$MISSING" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "All managed repos have submodules"
            echo "has_missing=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Add missing submodules
        if: steps.missing.outputs.has_missing == 'true' && github.event.inputs.sync_missing != 'false' && github.event.inputs.dry_run != 'true'
        run: |
          source ./scripts/lib/ecosystem.sh
          
          echo "${{ steps.missing.outputs.missing }}" | while read -r repo; do
            if [[ -n "$repo" ]]; then
              echo "Adding submodule: $repo"
              submodule_add "$repo" || echo "Failed to add $repo"
            fi
          done
      
      - name: Update submodules to latest
        if: github.event.inputs.update_submodules != 'false' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Updating all submodules to latest..."
          git submodule update --remote --recursive || true
          
          # Show what changed
          git status --short ecosystems/oss/
      
      - name: Create or update PR for changes
        if: github.event.inputs.dry_run != 'true'
        run: |
          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Use a stable branch name so we update the same PR
          BRANCH="auto/ecosystem-sync"
          
          # Check if branch exists and has an open PR
          EXISTING_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' || echo "")
          
          if [[ -n "$EXISTING_PR" ]]; then
            echo "Found existing PR #$EXISTING_PR - updating..."
            
            # Fetch and checkout existing branch
            git fetch origin "$BRANCH" 2>/dev/null || true
            git checkout -B "$BRANCH" origin/"$BRANCH" 2>/dev/null || git checkout -b "$BRANCH"
            
            # Pull latest main to rebase
            git fetch origin main
            git rebase origin/main || git rebase --abort
          else
            echo "Creating new branch..."
            git checkout -b "$BRANCH"
          fi
          
          # Add and commit
          git add .gitmodules ecosystems/oss/
          
          # Build commit message
          CHANGES=$(git diff --staged --stat | tail -5)
          
          git commit -m "chore(ecosystem): sync submodules

          Automated ecosystem synchronization:
          - Updated submodules to latest commits
          - Added missing submodules for managed repos

          Changes:
          $CHANGES" || echo "No new changes to commit"
          
          # Push (force since we may have rebased)
          git push -u origin "$BRANCH" --force-with-lease
          
          if [[ -z "$EXISTING_PR" ]]; then
            # Create new PR with automerge
            gh pr create \
              --title "chore(ecosystem): sync submodules" \
              --body "## Ecosystem Sync

          Automated synchronization of ecosystem submodules.

          This PR is automatically updated and will automerge when CI passes.

          ### Triggered by
          - Event: ${{ github.event_name }}
          - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          " \
              --base main
            
            # Get the new PR number and enable automerge
            NEW_PR=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number')
            if [[ -n "$NEW_PR" ]]; then
              gh pr merge "$NEW_PR" --auto --squash || echo "Could not enable automerge"
            fi
          else
            echo "PR #$EXISTING_PR updated"
            # Ensure automerge is still enabled
            gh pr merge "$EXISTING_PR" --auto --squash || echo "Automerge already enabled or not available"
          fi

  # =============================================================================
  # Validate ecosystem configuration
  # =============================================================================
  validate:
    name: Validate Ecosystem Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Validate triage-hub.json
        run: |
          if [[ ! -f "triage-hub.json" ]]; then
            echo "ERROR: triage-hub.json not found"
            exit 1
          fi
          
          # Validate JSON syntax
          jq empty triage-hub.json || {
            echo "ERROR: Invalid JSON in triage-hub.json"
            exit 1
          }
          
          echo "✅ triage-hub.json is valid JSON"
      
      - name: Check ecosystem consistency
        run: |
          echo "Checking ecosystem consistency..."
          
          # Get packages from triage-hub.json
          CONFIGURED=$(jq -r '.ecosystems | to_entries[] | .value.packages | keys[]' triage-hub.json | sort)
          
          # Get packages from repo-config.json
          MANAGED=$(jq -r '.repositories | keys[]' repo-config.json | sort)
          
          # Compare
          echo ""
          echo "Packages in triage-hub.json but not in repo-config.json:"
          comm -23 <(echo "$CONFIGURED") <(echo "$MANAGED") | sed 's/^/  - /' || echo "  (none)"
          
          echo ""
          echo "Packages in repo-config.json but not in triage-hub.json:"
          comm -13 <(echo "$CONFIGURED") <(echo "$MANAGED") | sed 's/^/  - /' || echo "  (none)"
          
          echo ""
          echo "✅ Ecosystem consistency check complete"
