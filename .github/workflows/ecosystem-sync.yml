name: Ecosystem Sync

# Sync repository-files to all managed repositories
# 
# Two-phase sync for safety and clean logging:
# PHASE 1: Initial Sync - Creates missing files only (safe for customized repos)  
# PHASE 2: Always Sync - Overwrites with latest shared configs
#
# DIRECT PUSH MODE: Always pushes directly to main (no PRs)
# Branch rulesets allow Dependabot, Renovate, and admins to bypass protections
#
# TROUBLESHOOTING:
# - If you see 'repository not found' errors:
#   1. Verify the repository exists in repo-config.json
#   2. Ensure CI_GITHUB_TOKEN has write access to the repository

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      sync_type:
        description: 'Which sync to run'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - always-only
          - initial-only
  schedule:
    # Nightly at 3:00 UTC - direct push mode
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'
      - 'branch-rulesets/**'
      - '.github/sync-always.yml'
      - '.github/sync-initial.yml'

permissions:
  contents: read

jobs:
  # =============================================================================
  # Validate configuration before any sync
  # =============================================================================
  validate:
    name: ðŸ” Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Validate all configs
        run: |
          echo "Validating repo-config.json..."
          ./scripts/validate-config
          
          echo "Checking for symlinks..."
          ./scripts/check-symlinks
          
          echo "âœ… All validations passed"

  # =============================================================================
  # PHASE 0: Create Repos (Idempotent)
  # Creates any repos that don't exist yet - safe to run every time
  # =============================================================================
  phase-0-create-repos:
    name: ðŸ†• Phase 0 - Create Repos
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Create missing repositories
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            ./scripts/create-repos --dry-run --verbose
          else
            ./scripts/create-repos --verbose
          fi

      - name: Phase 0 Summary
        run: |
          echo "### ðŸ†• Phase 0: Create Repos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Behavior:** Idempotently creates any missing repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repos are created as public with:" >> $GITHUB_STEP_SUMMARY
          echo "- README initialized" >> $GITHUB_STEP_SUMMARY
          echo "- Standard descriptions from repo-config.json" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # PHASE 1: Initial Sync
  # Creates files ONLY if they don't exist - safe for repos with customizations
  # =============================================================================
  phase-1-initial:
    name: ðŸ“¦ Phase 1 - Initial Sync
    needs: phase-0-create-repos
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_type != 'always-only'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Initial file sync (create missing only)
        id: sync
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        env:
          # Skip LFS to avoid issues with repos that have broken LFS objects
          GIT_LFS_SKIP_SMUDGE: "1"
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-initial.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: true
          COMMIT_PREFIX: 'chore(init):'
          COMMIT_BODY: |
            Initial file setup from control center.
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]

      - name: Phase 1 Summary
        run: |
          echo "### ðŸ“¦ Phase 1: Initial Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`.github/sync-initial.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "**Behavior:** Only creates files if they don't exist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files synced:" >> $GITHUB_STEP_SUMMARY
          echo "- \`CLAUDE.md\`, \`AGENTS.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/dependabot.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/SECURITY.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/ISSUE_TEMPLATE/\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.cursor/Dockerfile\`, \`.cursor/environment.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/\` scaffold" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # PHASE 2: Always Sync  
  # Overwrites files with latest from control center - keeps shared configs in sync
  # =============================================================================
  phase-2-always:
    name: ðŸ”„ Phase 2 - Always Sync
    needs: [validate, phase-1-initial]
    runs-on: ubuntu-latest
    # Run even if phase-1 was skipped (when sync_type is always-only)
    if: |
      always() && 
      needs.validate.result == 'success' &&
      github.event.inputs.sync_type != 'initial-only' &&
      (needs.phase-1-initial.result == 'success' || needs.phase-1-initial.result == 'skipped')
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Always file sync (overwrite)
        id: sync
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        env:
          # Skip LFS to avoid issues with repos that have broken LFS objects
          GIT_LFS_SKIP_SMUDGE: "1"
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-always.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: true
          COMMIT_PREFIX: 'chore(sync):'
          COMMIT_BODY: |
            Sync shared configurations from control center.
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]

      - name: Phase 2 Summary
        run: |
          echo "### ðŸ”„ Phase 2: Always Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`.github/sync-always.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "**Behavior:** Overwrites files with latest from control center" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files synced:" >> $GITHUB_STEP_SUMMARY
          echo "- \`.cursor/rules/\` (Cursor AI rules)" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/workflows/\` (shared workflows)" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/agents/\` (AI agent configs)" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/settings.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/CODEOWNERS\`" >> $GITHUB_STEP_SUMMARY
          echo "- Language-specific rules (python/nodejs/go/terraform)" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Final Summary
  # =============================================================================
  summary:
    name: ðŸ“Š Summary
    needs: [phase-1-initial, phase-2-always]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate final summary
        env:
          PHASE1_RESULT: ${{ needs.phase-1-initial.result }}
          PHASE2_RESULT: ${{ needs.phase-2-always.result }}
        run: |
          echo "## ðŸ”„ Ecosystem Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "**Mode:** ðŸ” Dry run (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** âš¡ Direct push to main" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          case "$PHASE1_RESULT" in
            success) echo "| ðŸ“¦ Initial Sync | âœ… Success |" >> $GITHUB_STEP_SUMMARY ;;
            skipped) echo "| ðŸ“¦ Initial Sync | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            failure) echo "| ðŸ“¦ Initial Sync | âŒ Failed |" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "| ðŸ“¦ Initial Sync | âš ï¸ $PHASE1_RESULT |" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          case "$PHASE2_RESULT" in
            success) echo "| ðŸ”„ Always Sync | âœ… Success |" >> $GITHUB_STEP_SUMMARY ;;
            skipped) echo "| ðŸ”„ Always Sync | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            failure) echo "| ðŸ”„ Always Sync | âŒ Failed |" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "| ðŸ”„ Always Sync | âš ï¸ $PHASE2_RESULT |" >> $GITHUB_STEP_SUMMARY ;;
          esac

  # =============================================================================
  # Sync GitHub Projects
  # =============================================================================
  sync-projects:
    name: ðŸ“‹ Sync Projects
    needs: phase-2-always
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Sync issues to projects
        run: ./scripts/sync-projects --verbose
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
