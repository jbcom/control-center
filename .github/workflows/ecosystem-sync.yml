name: Ecosystem Sync

# ONE nightly job that:
# 1. Syncs repository-files directly to each repo (pushes to main)
# 2. Updates submodules to latest

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repo (empty for all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
  schedule:
    # Nightly at 3:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

jobs:
  # =============================================================================
  # Build matrix of repos to sync
  # =============================================================================
  matrix:
    name: Build Repo Matrix
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.repos.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get repos from config
        id: repos
        run: |
          TARGET="${{ github.event.inputs.target_repo }}"
          
          if [[ -n "$TARGET" ]]; then
            REPOS=$(jq -c "[{name: \"$TARGET\", language: .repositories[\"$TARGET\"].language}]" repo-config.json)
          else
            REPOS=$(jq -c '[.repositories | to_entries[] | {name: .key, language: .value.language}]' repo-config.json)
          fi
          
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Will sync $(echo "$REPOS" | jq length) repos"

  # =============================================================================
  # Sync files directly to each repository
  # =============================================================================
  sync-repo:
    name: Sync ${{ matrix.repo.name }}
    needs: matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        repo: ${{ fromJson(needs.matrix.outputs.repos) }}
    
    steps:
      - name: Checkout control center
        uses: actions/checkout@v4
        with:
          path: control-center
      
      - name: Clone target repo
        run: |
          gh repo clone "jbdevprimary/${{ matrix.repo.name }}" target-repo
          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync always-sync files
        run: |
          echo "Syncing always-sync files..."
          if [[ -d "control-center/repository-files/always-sync" ]]; then
            rsync -av --exclude='.git' \
              control-center/repository-files/always-sync/ \
              target-repo/
          fi
      
      - name: Sync language-specific files
        run: |
          LANG="${{ matrix.repo.language }}"
          case "$LANG" in
            python) DIR="python" ;;
            typescript|javascript) DIR="nodejs" ;;
            go) DIR="go" ;;
            terraform|hcl) DIR="terraform" ;;
            *) DIR="" ;;
          esac
          
          if [[ -n "$DIR" && -d "control-center/repository-files/$DIR" ]]; then
            echo "Syncing $DIR files..."
            rsync -av --exclude='.git' \
              "control-center/repository-files/$DIR/" \
              target-repo/
          fi
      
      - name: Sync initial-only files
        run: |
          if [[ -d "control-center/repository-files/initial-only" ]]; then
            cd control-center/repository-files/initial-only
            find . -type f | while read -r file; do
              dest="../../../target-repo/$file"
              if [[ ! -f "$dest" ]]; then
                mkdir -p "$(dirname "$dest")"
                cp "$file" "$dest"
                echo "Added: $file"
              fi
            done
          fi
      
      - name: Push changes
        if: github.event.inputs.dry_run != 'true'
        working-directory: target-repo
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes for ${{ matrix.repo.name }}"
            exit 0
          fi
          
          git add -A
          git commit -m "chore: sync from control center

          Automated sync of shared configurations.
          Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push origin main
          echo "✅ Pushed to ${{ matrix.repo.name }}"

  # =============================================================================
  # Update submodules in control center
  # =============================================================================
  update-submodules:
    name: Update Submodules
    needs: sync-repo
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update submodules
        run: |
          git submodule update --remote --recursive || true
      
      - name: Push submodule updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          if git diff --quiet; then
            echo "No submodule changes"
            exit 0
          fi
          
          git add -A
          git commit -m "deps: update submodules to latest"
          git push origin main
          echo "✅ Submodules updated"
