# Ecosystem Sync - Enterprise Hierarchical Delegation
#
# ARCHITECTURE:
# jbcom/control-center (this repo)
#   â””â”€â”€ syncs to â†’ org/control-center (each org)
#         â””â”€â”€ syncs to â†’ org/repo (each repo in org)
#
# This workflow ONLY syncs to org control-centers.
# Each org control-center handles its own internal sync.
#
# PHASES:
# 0. Ensure org control-centers exist (idempotent)
# 1. Sync enterprise files to org control-centers
# 2. Trigger org control-centers to cascade to their repos

name: Ecosystem Sync

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      target_org:
        description: 'Target specific org (or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arcade-cabinet
          - agentic-dev-library
          - extended-data-library
          - strata-game-library
  schedule:
    # Nightly at 3:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'

permissions:
  contents: read

env:
  MANAGED_ORGS: arcade-cabinet,agentic-dev-library,extended-data-library,strata-game-library

jobs:
  # =============================================================================
  # Phase 0: Ensure Org Control-Centers Exist (Idempotent)
  # =============================================================================
  phase-0-ensure-control-centers:
    name: ðŸ—ï¸ Phase 0 - Ensure Org Control-Centers
    runs-on: ubuntu-latest
    outputs:
      orgs: ${{ steps.list.outputs.orgs }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: List target orgs
        id: list
        run: |
          if [[ "${{ inputs.target_org }}" == "all" || -z "${{ inputs.target_org }}" ]]; then
            echo 'orgs=["arcade-cabinet","agentic-dev-library","extended-data-library","strata-game-library"]' >> $GITHUB_OUTPUT
          else
            echo 'orgs=["${{ inputs.target_org }}"]' >> $GITHUB_OUTPUT
          fi

      - name: Ensure org control-centers exist
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          for org in arcade-cabinet agentic-dev-library extended-data-library strata-game-library; do
            # Skip if targeting specific org
            if [[ "${{ inputs.target_org }}" != "all" && "${{ inputs.target_org }}" != "" && "${{ inputs.target_org }}" != "$org" ]]; then
              continue
            fi
            
            echo "Checking $org/control-center..."
            
            if gh repo view "$org/control-center" >/dev/null 2>&1; then
              echo "  âœ… Already exists"
            else
              echo "  Creating $org/control-center..."
              if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                gh repo create "$org/control-center" \
                  --public \
                  --description "Control center for $org organization - syncs from jbcom/control-center" \
                  --add-readme
                echo "  âœ… Created"
              else
                echo "  [DRY RUN] Would create"
              fi
            fi
          done

      - name: Summary
        run: |
          echo "### ðŸ—ï¸ Phase 0: Org Control-Centers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verified control-center repos exist for all managed orgs." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Phase 1: Sync Enterprise Files to Org Control-Centers
  # =============================================================================
  phase-1-sync-to-org-control-centers:
    name: ðŸ“¤ Phase 1 - Sync to ${{ matrix.org }}/control-center
    needs: phase-0-ensure-control-centers
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        org: ${{ fromJson(needs.phase-0-ensure-control-centers.outputs.orgs) }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Sync enterprise files to ${{ matrix.org }}/control-center
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
          ORG: ${{ matrix.org }}
        run: |
          echo "ðŸ”„ Syncing enterprise files to $ORG/control-center..."
          
          # Clone org control-center
          git clone "https://x-access-token:${GH_TOKEN}@github.com/$ORG/control-center.git" /tmp/org-cc
          cd /tmp/org-cc
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ensure directory structure
          mkdir -p repository-files/always-sync/.github/workflows
          mkdir -p repository-files/always-sync/.cursor/rules
          mkdir -p repository-files/initial-only
          mkdir -p .github/workflows
          
          # Copy enterprise always-sync files (these cascade down)
          echo "  Copying always-sync files..."
          cp -r $GITHUB_WORKSPACE/repository-files/always-sync/.github/workflows/* repository-files/always-sync/.github/workflows/ 2>/dev/null || true
          cp -r $GITHUB_WORKSPACE/repository-files/always-sync/.cursor/rules/* repository-files/always-sync/.cursor/rules/ 2>/dev/null || true
          
          # Copy language-specific rules
          for lang in python nodejs go terraform rust; do
            if [ -d "$GITHUB_WORKSPACE/repository-files/$lang" ]; then
              mkdir -p "repository-files/$lang"
              cp -r "$GITHUB_WORKSPACE/repository-files/$lang/"* "repository-files/$lang/" 2>/dev/null || true
            fi
          done
          
          # Copy initial-only files
          cp -r $GITHUB_WORKSPACE/repository-files/initial-only/* repository-files/initial-only/ 2>/dev/null || true
          
          # Copy the org sync workflow from template
          cp $GITHUB_WORKSPACE/repository-files/org-control-center/.github/workflows/sync.yml .github/workflows/sync.yml
          
          # Commit and push
          git add -A
          if ! git diff --staged --quiet; then
            if [[ "${{ inputs.dry_run }}" != "true" ]]; then
              git commit -m "chore(sync): update from jbcom/control-center

          Enterprise sync from jbcom/control-center
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              git push origin main
              echo "âœ… Pushed to $ORG/control-center"
            else
              echo "[DRY RUN] Would push to $ORG/control-center"
              git diff --staged --stat
            fi
          else
            echo "âœ… No changes needed for $ORG/control-center"
          fi

  # =============================================================================
  # Phase 2: Trigger Org Control-Centers to Cascade
  # =============================================================================
  phase-2-trigger-cascade:
    name: ðŸŒŠ Phase 2 - Trigger Cascade
    needs: phase-1-sync-to-org-control-centers
    runs-on: ubuntu-latest
    if: inputs.dry_run != 'true'
    steps:
      - name: Trigger org sync workflows
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          for org in arcade-cabinet agentic-dev-library extended-data-library strata-game-library; do
            # Skip if targeting specific org
            if [[ "${{ inputs.target_org }}" != "all" && "${{ inputs.target_org }}" != "" && "${{ inputs.target_org }}" != "$org" ]]; then
              continue
            fi
            
            echo "Triggering sync in $org/control-center..."
            gh workflow run sync.yml --repo "$org/control-center" 2>/dev/null || echo "  âš ï¸ Could not trigger (workflow may not exist yet)"
          done

      - name: Summary
        run: |
          echo "### ðŸŒŠ Phase 2: Cascade Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered sync workflows in org control-centers." >> $GITHUB_STEP_SUMMARY
          echo "Each org will now sync to its own repositories." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Final Summary
  # =============================================================================
  summary:
    name: ðŸ“Š Summary
    needs: [phase-0-ensure-control-centers, phase-1-sync-to-org-control-centers, phase-2-trigger-cascade]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”„ Ecosystem Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**Mode:** ðŸ” Dry run" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** âš¡ Live sync" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "jbcom/control-center (enterprise)" >> $GITHUB_STEP_SUMMARY
          echo "  â”œâ”€â”€ arcade-cabinet/control-center" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     â””â”€â”€ (syncs to arcade-cabinet/*)" >> $GITHUB_STEP_SUMMARY
          echo "  â”œâ”€â”€ agentic-dev-library/control-center" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     â””â”€â”€ (syncs to agentic-dev-library/*)" >> $GITHUB_STEP_SUMMARY
          echo "  â”œâ”€â”€ extended-data-library/control-center" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     â””â”€â”€ (syncs to extended-data-library/*)" >> $GITHUB_STEP_SUMMARY
          echo "  â””â”€â”€ strata-game-library/control-center" >> $GITHUB_STEP_SUMMARY
          echo "        â””â”€â”€ (syncs to strata-game-library/*)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
