name: Ecosystem Sync

# ONE nightly job that:
# 1. Syncs repository-files directly to each repo (pushes to main)
# 2. Updates submodules to latest

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repo (empty for all)'
        required: false
        default: ''
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
  schedule:
    # Nightly at 3:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

jobs:
  # =============================================================================
  # Build matrix of repos to sync
  # =============================================================================
  matrix:
    name: Build Repo Matrix
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.repos.outputs.repos }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get repos from config
        id: repos
        run: |
          TARGET="${{ github.event.inputs.target_repo }}"
          
          # Validate JSON using shared script
          ./scripts/validate-config
          
          if [[ -n "$TARGET" ]]; then
            # Find target repo in ecosystems
            REPOS=$(jq -c --arg target "$TARGET" '[
              .ecosystems | to_entries[] | 
              select(.value.repos[]? == $target) |
              {name: $target, ecosystem: .key}
            ]' repo-config.json)
            
            if [[ "$REPOS" == "[]" ]]; then
              echo "ERROR: Repository '$TARGET' not found in any ecosystem"
              exit 1
            fi
          else
            # Get all repos from all ecosystems
            REPOS=$(jq -c '[
              .ecosystems | to_entries[] | 
              .value.repos[]? as $repo |
              {name: $repo, ecosystem: .key}
            ]' repo-config.json)
          fi
          
          if [[ -z "$REPOS" || "$REPOS" == "null" ]]; then
            echo "ERROR: No repositories found in config"
            exit 1
          fi
          
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Will sync $(echo "$REPOS" | jq length) repos"

  # =============================================================================
  # Sync files directly to each repository
  # =============================================================================
  sync-repo:
    name: Sync ${{ matrix.repo.name }}
    needs: matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        repo: ${{ fromJson(needs.matrix.outputs.repos) }}
    
    steps:
      - name: Checkout control center
        uses: actions/checkout@v4
        with:
          path: control-center
      
      - name: Check for symlinks in repository-files
        working-directory: control-center
        run: |
          # Use existing check-symlinks script for consistency
          ./scripts/check-symlinks
      
      - name: Clone target repo
        run: |
          gh repo clone "jbcom/${{ matrix.repo.name }}" target-repo
          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync always-sync files
        run: |
          echo "Syncing always-sync files..."
          if [[ -d "control-center/repository-files/always-sync" ]]; then
            rsync -av --copy-links --exclude='.git' \
              control-center/repository-files/always-sync/ \
              target-repo/
          fi
      
      - name: Sync ecosystem-specific files
        run: |
          ECOSYSTEM="${{ matrix.repo.ecosystem }}"
          
          # Skip control ecosystem (these repos don't sync ecosystem files)
          if [[ "$ECOSYSTEM" == "control" ]]; then
            echo "Skipping ecosystem sync for control center repo"
            exit 0
          fi
          
          # Map ecosystem to directory (use ecosystem name directly for most cases)
          case "$ECOSYSTEM" in
            nodejs) DIR="nodejs" ;;
            python) DIR="python" ;;
            go) DIR="go" ;;
            terraform) DIR="terraform" ;;
            *) DIR="$ECOSYSTEM" ;; # Default: use ecosystem name as-is
          esac
          
          if [[ -d "control-center/repository-files/$DIR" ]]; then
            echo "Syncing $ECOSYSTEM files from $DIR/..."
            rsync -av --copy-links --exclude='.git' \
              "control-center/repository-files/$DIR/" \
              target-repo/
          else
            echo "⚠️  WARNING: No ecosystem directory found for $ECOSYSTEM at repository-files/$DIR/"
          fi
      
      - name: Sync initial-only files
        run: |
          if [[ -d "control-center/repository-files/initial-only" ]]; then
            cd control-center/repository-files/initial-only
            # Use find to avoid symlinks, -L follows symlinks during find
            find -L . -type f | while read -r file; do
              dest="../../../target-repo/$file"
              if [[ ! -f "$dest" ]]; then
                mkdir -p "$(dirname "$dest")"
                # Copy with dereference to ensure no symlinks
                cp -L "$file" "$dest"
                echo "Added: $file"
              fi
            done
          fi
      
      - name: Push changes
        if: github.event.inputs.dry_run != 'true'
        working-directory: target-repo
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes for ${{ matrix.repo.name }}"
            exit 0
          fi
          
          git add -A
          git commit -m "chore: sync from control center

          Automated sync of shared configurations.
          Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push origin main
          echo "✅ Pushed to ${{ matrix.repo.name }}"

  # =============================================================================
  # Sync issues to GitHub Projects
  # =============================================================================
  sync-projects:
    name: Sync Issues to Projects
    needs: [sync-repo, update-submodules]
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Sync all issues to projects
        run: |
          ./scripts/sync-projects --verbose
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

  # =============================================================================
  # Update submodules in control center
  # =============================================================================
  update-submodules:
    name: Update Submodules
    needs: sync-repo
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # submodules disabled until migration complete
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Update submodules
        run: |
          git submodule update --remote --recursive || true
      
      - name: Push submodule updates
        if: github.event.inputs.dry_run != 'true'
        run: |
          if git diff --quiet; then
            echo "No submodule changes"
            exit 0
          fi
          
          git add -A
          git commit -m "deps: update submodules to latest"
          git push origin main
          echo "✅ Submodules updated"
