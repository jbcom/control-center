name: Ecosystem Sync

# Sync repository-files to all managed repositories using repo-file-sync-action
# Creates PRs in target repos for review (or direct push if SKIP_PR is true)
#
# See .github/sync.yml for the sync configuration

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      skip_pr:
        description: 'Push directly (skip PR creation)'
        required: false
        default: false
        type: boolean
  schedule:
    # Nightly at 3:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'
      - '.github/sync.yml'

permissions:
  contents: read

jobs:
  # =============================================================================
  # Validate sync configuration
  # =============================================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Validate repo-config.json
        run: ./scripts/validate-config

      - name: Check for symlinks in repository-files
        run: ./scripts/check-symlinks

      - name: Validate sync.yml syntax
        run: |
          # Install PyYAML if not available, then validate
          pip install -q pyyaml 2>/dev/null || true
          python3 -c "import yaml; yaml.safe_load(open('.github/sync.yml'))" 2>/dev/null || \
            (echo "âš ï¸ YAML validation skipped (pyyaml not available)" && exit 0)
          echo "âœ… sync.yml is valid YAML"

  # =============================================================================
  # Sync files to all repositories
  # =============================================================================
  sync:
    name: Sync Files
    needs: validate
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      # BetaHuhn/repo-file-sync-action v1.21.1 (pinned for security)
      - name: Sync Files to Repositories
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: ${{ github.event.inputs.skip_pr == 'true' || github.event_name == 'schedule' }}
          PR_LABELS: |
            sync
            automated
          COMMIT_PREFIX: 'chore(sync):'
          COMMIT_BODY: |
            Automated sync from control center.
            
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH_PREFIX: control-center-sync
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]
          OVERWRITE_EXISTING_PR: true

      - name: Summary
        run: |
          echo "## Ecosystem Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ” **Dry run mode** - no changes were made" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.skip_pr }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "âš¡ **Direct push mode** - changes pushed directly to main" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **PR mode** - pull requests created in target repositories" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration: \`.github/sync.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced Directories" >> $GITHUB_STEP_SUMMARY
          echo "- \`repository-files/always-sync/\` â†’ All repos (overwrite)" >> $GITHUB_STEP_SUMMARY
          echo "- \`repository-files/python/\` â†’ Python repos" >> $GITHUB_STEP_SUMMARY
          echo "- \`repository-files/nodejs/\` â†’ Node.js repos" >> $GITHUB_STEP_SUMMARY
          echo "- \`repository-files/go/\` â†’ Go repos" >> $GITHUB_STEP_SUMMARY
          echo "- \`repository-files/terraform/\` â†’ Terraform repos" >> $GITHUB_STEP_SUMMARY
          echo "- \`repository-files/initial-only/\` â†’ All repos (if not exists)" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Update submodules in control center
  # =============================================================================
  update-submodules:
    name: Update Submodules
    needs: sync
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update submodules
        run: |
          git submodule update --remote --recursive || true

      - name: Push submodule updates
        run: |
          if git diff --quiet; then
            echo "No submodule changes"
            exit 0
          fi

          git add -A
          git commit -m "deps: update submodules to latest"
          git push origin main
          echo "âœ… Submodules updated"

  # =============================================================================
  # Sync issues to GitHub Projects
  # =============================================================================
  sync-projects:
    name: Sync Issues to Projects
    needs: [sync, update-submodules]
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      # actions/checkout v6.0.1 (pinned for security)
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Sync all issues to projects
        run: |
          ./scripts/sync-projects --verbose
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
