# Ecosystem Sync - Enterprise Hierarchical Delegation
#
# ARCHITECTURE:
# jbcom/control-center (this repo) - THE PROGENITOR
#   â”‚
#   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  â”‚ Phase 0: ENTERPRISE SETTINGS (first, blocking)                 â”‚
#   â”‚  â”‚   enterprise/settings.json â†’ jbcom org API settings            â”‚
#   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#   â”‚                              â”‚
#   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚              â–¼               â–¼               â–¼
#   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  â”‚ ORG .GITHUB    â”‚ â”‚ GLOBAL SYNC    â”‚ â”‚ CASCADE SYNC               â”‚
#   â”‚  â”‚ REPOS (1a)     â”‚ â”‚ (parallel)     â”‚ â”‚ (parallel)                 â”‚
#   â”‚  â”‚                â”‚ â”‚                â”‚ â”‚                            â”‚
#   â”‚  â”‚ Ensure each    â”‚ â”‚ sync-files/always-sync/global/*  â”‚ â”‚ sync-files/always-sync/* â†’       â”‚
#   â”‚  â”‚ org has        â”‚ â”‚ â†’ ALL repo     â”‚ â”‚   org/control-center's     â”‚
#   â”‚  â”‚ .github repo   â”‚ â”‚   roots        â”‚ â”‚   sync-files/always-sync/        â”‚
#   â”‚  â”‚                â”‚ â”‚                â”‚ â”‚                            â”‚
#   â”‚  â”‚ INITIAL sync   â”‚ â”‚ AI workflows,  â”‚ â”‚ Org-specific configs       â”‚
#   â”‚  â”‚ settings.yml   â”‚ â”‚ ecosystem,     â”‚ â”‚ that cascade to repos      â”‚
#   â”‚  â”‚ (org defaults) â”‚ â”‚ agent configs  â”‚ â”‚                            â”‚
#   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#   â”‚
#   â”‚  SETTINGS INHERITANCE (via repository-settings/app):
#   â”‚    org/.github/settings.yml  â†’  ALL repos in org (org defaults)
#   â”‚      â””â”€â”€ repo/.github/settings.yml  â†’  Override for specific repo
#   â”‚
#   â”‚  This allows: otterblade-odyssey to have its own settings.yml with
#   â”‚  custom release environment, merge rules, etc. that OVERRIDE org defaults!
#
# PHASES:
# 0.  Enterprise org settings (BLOCKING - runs first)
# 1a. Ensure org .github repos exist & INITIAL sync settings.yml
# 1b. Global sync to ALL repo roots (PARALLEL)
# 1c. Ensure org control-centers exist (PARALLEL)
# 2.  Sync cascade files to org control-centers' sync-files/always-sync/
# 3.  Trigger org control-centers to cascade to their repos

name: Ecosystem Sync

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      target_org:
        description: 'Target specific org (or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arcade-cabinet
          - agentic-dev-library
          - extended-data-library
          - strata-game-library
      skip_enterprise:
        description: 'Skip enterprise ruleset sync'
        required: false
        default: false
        type: boolean
      skip_global:
        description: 'Skip global direct-to-repo sync'
        required: false
        default: false
        type: boolean
  schedule:
    # Nightly at 3:00 UTC
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'sync-files/always-sync/**'
      - 'enterprise/**'
      - 'sync-files/always-sync/global/**'
      - 'repo-config.json'
      # Note: org-github-repo is inside sync-files/always-sync/ so already covered

permissions:
  contents: read

env:
  MANAGED_ORGS: arcade-cabinet,agentic-dev-library,extended-data-library,strata-game-library
  ENTERPRISE_ORG: jbcom

jobs:
  # =============================================================================
  # Phase 0: Sync Enterprise Org Settings (jbcom org API settings)
  # =============================================================================
  phase-0-enterprise-sync:
    name: ðŸ›ï¸ Phase 0 - Enterprise Org Settings
    runs-on: ubuntu-latest
    if: inputs.skip_enterprise != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Sync enterprise org settings
        if: hashFiles('enterprise/settings.json') != ''
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          echo "ðŸ›ï¸ Syncing enterprise org settings to jbcom..."
          
          if [ -f "enterprise/settings.json" ]; then
            # Remove comments and $schema before sending
            SETTINGS=$(jq 'del(."$schema", ._comment)' enterprise/settings.json)
            
            if [[ "${{ inputs.dry_run }}" == "true" ]]; then
              echo "[DRY RUN] Would apply org settings:"
              echo "$SETTINGS" | jq '.'
            else
              echo "$SETTINGS" | gh api --method PATCH /orgs/jbcom --input - > /dev/null 2>&1 && \
                echo "âœ… Applied org settings" || echo "âš ï¸ Some settings may require admin permissions"
            fi
          fi

      - name: Summary
        run: |
          echo "### ðŸ›ï¸ Phase 0: Enterprise Org Settings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Applied jbcom org-level settings via API." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Phase 1a: Ensure Org .github Repos Exist & INITIAL Sync settings.yml
  # This uses repository-settings/app for repo-level settings inheritance
  # Settings in org/.github/settings.yml apply to ALL repos in org
  # Individual repos can override with their own settings.yml
  # =============================================================================
  phase-1a-org-github-repos:
    name: ðŸ”§ Phase 1a - Org .github Repos
    needs: phase-0-enterprise-sync
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Ensure org .github repos exist & sync settings.yml
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          echo "ðŸ”§ Ensuring org .github repos exist with settings.yml..."
          
          for org in jbcom arcade-cabinet agentic-dev-library extended-data-library strata-game-library; do
            # Skip if targeting specific org
            if [[ "${{ inputs.target_org }}" != "all" && "${{ inputs.target_org }}" != "" && "${{ inputs.target_org }}" != "$org" ]]; then
              continue
            fi
            
            echo "Processing $org/.github..."
            
            # Check if .github repo exists
            if ! gh repo view "$org/.github" >/dev/null 2>&1; then
              echo "  Creating $org/.github repo..."
              if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                gh repo create "$org/.github" \
                  --public \
                  --description "Organization-wide settings and defaults for $org" \
                  --add-readme || echo "  âš ï¸ Could not create (may already exist)"
                sleep 2  # Brief pause after creation
              else
                echo "  [DRY RUN] Would create repo"
              fi
            else
              echo "  âœ… Repo exists"
            fi
            
            # INITIAL sync settings.yml (only if it doesn't exist)
            if [[ "${{ inputs.dry_run }}" != "true" ]]; then
              # Check if settings.yml already exists
              if gh api "repos/$org/.github/contents/settings.yml" >/dev/null 2>&1; then
                echo "  âœ… settings.yml already exists (preserving org customizations)"
              else
                echo "  ðŸ“ Creating initial settings.yml..."
                
                # Clone and add settings.yml
                rm -rf /tmp/org-github
                git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/$org/.github.git" /tmp/org-github 2>/dev/null || {
                  echo "  âš ï¸ Could not clone (may be empty)"
                  continue
                }
                
                cd /tmp/org-github
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                
                # Copy org-level settings template
                cp "$GITHUB_WORKSPACE/sync-files/always-sync/org-github-repo/settings.yml" settings.yml
                
                git add settings.yml
                if ! git diff --staged --quiet; then
                  git commit -m "chore: add organization-wide settings.yml

          Initial settings from jbcom/control-center
          These settings apply to ALL repos in $org via repository-settings/app
          Individual repos can override with their own .github/settings.yml
          
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  
                  git push origin HEAD && echo "  âœ… Created settings.yml" || echo "  âš ï¸ Push failed"
                fi
                cd - > /dev/null
              fi
            else
              echo "  [DRY RUN] Would create settings.yml if missing"
            fi
          done
          
          echo "âœ… Org .github repos sync complete"

      - name: Summary
        run: |
          echo "### ðŸ”§ Phase 1a: Org .github Repos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ensured each org has a \`.github\` repo with \`settings.yml\`." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Settings Inheritance (via repository-settings/app):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "org/.github/settings.yml  â†’  ALL repos in org" >> $GITHUB_STEP_SUMMARY
          echo "  â””â”€â”€ repo/.github/settings.yml  â†’  Repo-specific overrides" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Phase 1b: Global Sync - DIRECT to repo roots of ALL repos
  # Goes to .github/workflows/, .github/agents/, etc. DIRECTLY
  # Control-centers receive these to USE (not distribute)
  # Used for: AI workflows, ecosystem workflows, agent configs
  # =============================================================================
  phase-1b-global-sync:
    name: ðŸŒ Phase 1b - Global Direct Sync
    needs: phase-0-enterprise-sync
    if: always() && !failure() && !cancelled() && inputs.skip_global != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Get all repos across all orgs
        id: repos
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          echo "ðŸ“‹ Discovering all repos across managed orgs..."
          REPOS=""
          for org in jbcom arcade-cabinet agentic-dev-library extended-data-library strata-game-library; do
            echo "  Scanning $org..."
            ORG_REPOS=$(gh repo list "$org" --limit 500 --json nameWithOwner --jq '.[].nameWithOwner' 2>/dev/null || echo "")
            REPOS="$REPOS $ORG_REPOS"
          done
          # Include ALL repos - control-centers are just another repo for global sync
          REPOS=$(echo "$REPOS" | tr ' ' '\n' | grep -v '^$' | sort -u)
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          echo "$REPOS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found $(echo "$REPOS" | wc -w) repos for global sync"

      - name: Sync global files DIRECTLY to repo roots
        if: hashFiles('sync-files/always-sync/global/**') != ''
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          echo "ðŸŒ Syncing global files DIRECTLY to repo roots..."
          echo "   sync-files/always-sync/global/.github/* â†’ repo/.github/* (for USE, not distribution)"
          
          # Check if global-sync directory has content
          if [ ! -d "global-sync" ] || [ -z "$(ls -A global-sync 2>/dev/null)" ]; then
            echo "No global-sync files to sync"
            exit 0
          fi
          
          REPOS="${{ steps.repos.outputs.repos }}"
          TOTAL=$(echo "$REPOS" | wc -w)
          COUNT=0
          UPDATED=0
          FAILED=0
          KILLED=0
          
          for repo in $REPOS; do
            COUNT=$((COUNT + 1))
            echo "[$COUNT/$TOTAL] Processing $repo..."
            
            # Clone repo
            rm -rf /tmp/target-repo
            if ! git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/$repo.git" /tmp/target-repo 2>/dev/null; then
              echo "  âš ï¸ Failed to clone (may be empty or archived)"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            cd /tmp/target-repo
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # STEP 1: Process kill list FIRST (remove old workflows)
            echo "  ðŸ—‘ï¸  Processing kill list..."
            if [[ "${{ inputs.dry_run }}" != "true" ]]; then
              $GITHUB_WORKSPACE/scripts/process-kill-list process . false 2>&1 | sed 's/^/    /'
            else
              $GITHUB_WORKSPACE/scripts/process-kill-list process . true 2>&1 | sed 's/^/    /'
            fi
            
            # Check if files were deleted
            git add -A
            if ! git diff --staged --quiet; then
              if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                COMMIT_MSG="chore(kill-list): remove deprecated workflows

          Automated cleanup via kill list from jbcom/control-center
          - Removed old ecosystem-* and ai-* workflows
          - Consolidated into 4 core workflows (triage, autoheal, review, delegator)
          - Removed Jules remote agent configurations

          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                git commit -m "$COMMIT_MSG"
                
                git push origin HEAD 2>/dev/null || echo "    âš ï¸ Kill list push failed"
                KILLED=$((KILLED + 1))
              fi
            fi
            
            # STEP 2: Copy global files DIRECTLY to repo root (preserving structure)
            # e.g. sync-files/always-sync/global/.github/workflows/ai-*.yml â†’ .github/workflows/ai-*.yml
            echo "  ðŸ“¦ Syncing new workflow files..."
            cp -r $GITHUB_WORKSPACE/sync-files/always-sync/global/. . 2>/dev/null || true
            
            # Commit and push
            git add -A
            if ! git diff --staged --quiet; then
              if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                COMMIT_MSG="chore(global-sync): update AI/ecosystem workflows

          Global sync from jbcom/control-center (direct to repo root)
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                git commit -m "$COMMIT_MSG"
                
                if git push origin HEAD 2>/dev/null; then
                  echo "  âœ… Updated"
                  UPDATED=$((UPDATED + 1))
                else
                  echo "  âš ï¸ Push failed"
                  FAILED=$((FAILED + 1))
                fi
              else
                echo "  [DRY RUN] Would update"
                UPDATED=$((UPDATED + 1))
              fi
            else
              echo "  âœ“ No changes"
            fi
            
            cd - > /dev/null
          done
          
          echo ""
          echo "ðŸ“Š Global sync complete:"
          echo "   ðŸ—‘ï¸  Kill list processed: $KILLED repos"
          echo "   âœ… Updated: $UPDATED repos"
          echo "   âŒ Failed: $FAILED repos"
          echo "   ðŸ“¦ Total: $TOTAL repos"

      - name: Summary
        run: |
          echo "### ðŸŒ Phase 0b: Global Direct Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Synced global files DIRECTLY to all repos (leapfrogging cascade)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "global-sync" ]; then
            echo "**Global files:**" >> $GITHUB_STEP_SUMMARY
            find global-sync -type f -name "*.yml" -o -name "*.md" 2>/dev/null | head -20 | while read -r f; do
              echo "- \`${f#sync-files/always-sync/global/}\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

  # =============================================================================
  # Phase 1c: Ensure Org Control-Centers Exist (Idempotent)
  # Runs in PARALLEL with Phase 1a and 1b (all depend only on Phase 0)
  # =============================================================================
  phase-1c-ensure-control-centers:
    name: ðŸ—ï¸ Phase 1c - Ensure Org Control-Centers
    needs: phase-0-enterprise-sync
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    outputs:
      orgs: ${{ steps.list.outputs.orgs }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: List target orgs
        id: list
        run: |
          if [[ "${{ inputs.target_org }}" == "all" || -z "${{ inputs.target_org }}" ]]; then
            echo 'orgs=["arcade-cabinet","agentic-dev-library","extended-data-library","strata-game-library"]' >> $GITHUB_OUTPUT
          else
            echo 'orgs=["${{ inputs.target_org }}"]' >> $GITHUB_OUTPUT
          fi

      - name: Ensure org control-centers exist
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          for org in arcade-cabinet agentic-dev-library extended-data-library strata-game-library; do
            # Skip if targeting specific org
            if [[ "${{ inputs.target_org }}" != "all" && "${{ inputs.target_org }}" != "" && "${{ inputs.target_org }}" != "$org" ]]; then
              continue
            fi
            
            echo "Checking $org/control-center..."
            
            if gh repo view "$org/control-center" >/dev/null 2>&1; then
              echo "  âœ… Already exists"
            else
              echo "  Creating $org/control-center..."
              if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                gh repo create "$org/control-center" \
                  --public \
                  --description "Control center for $org organization - syncs from jbcom/control-center" \
                  --add-readme
                echo "  âœ… Created"
              else
                echo "  [DRY RUN] Would create"
              fi
            fi
          done

      - name: Summary
        run: |
          echo "### ðŸ—ï¸ Phase 1: Org Control-Centers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verified control-center repos exist for all managed orgs." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Phase 2: Sync CASCADE files to Org Control-Centers' sync-files/always-sync/
  # These go into sync-files/always-sync/ for DISTRIBUTION (not direct use)
  # Org control-centers then cascade these to their repos
  # =============================================================================
  phase-2-sync-to-org-control-centers:
    name: ðŸ“¤ Phase 2 - Cascade to ${{ matrix.org }}/control-center
    needs: phase-1c-ensure-control-centers
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        org: ${{ fromJson(needs.phase-1c-ensure-control-centers.outputs.orgs) }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Sync enterprise files to ${{ matrix.org }}/control-center
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
          ORG: ${{ matrix.org }}
        run: |
          echo "ðŸ”„ Syncing enterprise files to $ORG/control-center..."
          
          # Clone org control-center
          git clone "https://x-access-token:${GH_TOKEN}@github.com/$ORG/control-center.git" /tmp/org-cc
          cd /tmp/org-cc
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Ensure directory structure
          mkdir -p sync-files/always-sync/always-sync/.github/workflows
          mkdir -p sync-files/always-sync/always-sync/.cursor/rules
          mkdir -p sync-files/always-sync/initial-only
          mkdir -p .github/workflows
          
          # Copy enterprise always-sync files (these cascade down)
          echo "  Copying always-sync files..."
          cp -r $GITHUB_WORKSPACE/sync-files/always-sync/always-sync/.github/workflows/* sync-files/always-sync/always-sync/.github/workflows/ 2>/dev/null || true
          cp -r $GITHUB_WORKSPACE/sync-files/always-sync/always-sync/.cursor/rules/* sync-files/always-sync/always-sync/.cursor/rules/ 2>/dev/null || true
          
          # Copy language-specific rules
          for lang in python nodejs go terraform rust; do
            if [ -d "$GITHUB_WORKSPACE/sync-files/always-sync/$lang" ]; then
              mkdir -p "sync-files/always-sync/$lang"
              cp -r "$GITHUB_WORKSPACE/sync-files/always-sync/$lang/"* "sync-files/always-sync/$lang/" 2>/dev/null || true
            fi
          done
          
          # Copy initial-only files
          cp -r $GITHUB_WORKSPACE/sync-files/always-sync/initial-only/* sync-files/always-sync/initial-only/ 2>/dev/null || true
          
          # Copy the org sync workflow from template
          cp $GITHUB_WORKSPACE/sync-files/always-sync/org-control-center/.github/workflows/sync.yml .github/workflows/sync.yml
          
          # Commit and push with retry
          git add -A
          if ! git diff --staged --quiet; then
            if [[ "${{ inputs.dry_run }}" != "true" ]]; then
              git commit -m "chore(sync): update from jbcom/control-center

          Enterprise sync from jbcom/control-center
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              
              # Try to push, pull and retry if rejected
              for i in 1 2 3; do
                if git push origin main 2>/dev/null; then
                  echo "âœ… Pushed to $ORG/control-center"
                  break
                else
                  echo "  Retry $i: pulling latest..."
                  git pull --rebase origin main 2>/dev/null || true
                fi
              done
            else
              echo "[DRY RUN] Would push to $ORG/control-center"
              git diff --staged --stat
            fi
          else
            echo "âœ… No changes needed for $ORG/control-center"
          fi

  # =============================================================================
  # Phase 3: Trigger Org Control-Centers to Cascade
  # =============================================================================
  phase-3-trigger-cascade:
    name: ðŸŒŠ Phase 3 - Trigger Cascade
    needs: phase-2-sync-to-org-control-centers
    runs-on: ubuntu-latest
    if: inputs.dry_run != 'true'
    steps:
      - name: Trigger org sync workflows
        env:
          GH_TOKEN: ${{ secrets.JBCOM_TOKEN }}
        run: |
          for org in arcade-cabinet agentic-dev-library extended-data-library strata-game-library; do
            # Skip if targeting specific org
            if [[ "${{ inputs.target_org }}" != "all" && "${{ inputs.target_org }}" != "" && "${{ inputs.target_org }}" != "$org" ]]; then
              continue
            fi
            
            echo "Triggering sync in $org/control-center..."
            gh workflow run sync.yml --repo "$org/control-center" 2>/dev/null || echo "  âš ï¸ Could not trigger (workflow may not exist yet)"
          done

      - name: Summary
        run: |
          echo "### ðŸŒŠ Phase 3: Cascade Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered sync workflows in org control-centers." >> $GITHUB_STEP_SUMMARY
          echo "Each org will now sync to its own repositories." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Final Summary
  # =============================================================================
  summary:
    name: ðŸ“Š Summary
    needs: [phase-0-enterprise-sync, phase-1a-org-github-repos, phase-1b-global-sync, phase-1c-ensure-control-centers, phase-2-sync-to-org-control-centers, phase-3-trigger-cascade]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”„ Ecosystem Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "**Mode:** ðŸ” Dry run" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** âš¡ Live sync" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "jbcom/control-center (PROGENITOR)" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚" >> $GITHUB_STEP_SUMMARY
          echo "  â”œâ”€â”€ enterprise/settings.json â†’ jbcom org settings (API)" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚" >> $GITHUB_STEP_SUMMARY
          echo "  â”œâ”€â”€ org-github-repo/settings.yml â†’ org/.github repos (INITIAL)" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     â†“ repository-settings/app inheritance" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     ALL repos in org get these defaults" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     Individual repos can OVERRIDE with own settings.yml" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚" >> $GITHUB_STEP_SUMMARY
          echo "  â”œâ”€â”€ sync-files/always-sync/global/* â†’ ALL repo roots (DIRECT)" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚     AI workflows, ecosystem workflows, agent configs" >> $GITHUB_STEP_SUMMARY
          echo "  â”‚" >> $GITHUB_STEP_SUMMARY
          echo "  â””â”€â”€ sync-files/always-sync/* â†’ org control-centers (CASCADE)" >> $GITHUB_STEP_SUMMARY
          echo "        â”œâ”€â”€ arcade-cabinet/control-center â†’ arcade-cabinet/*" >> $GITHUB_STEP_SUMMARY
          echo "        â”œâ”€â”€ agentic-dev-library/control-center â†’ agentic-dev-library/*" >> $GITHUB_STEP_SUMMARY
          echo "        â”œâ”€â”€ extended-data-library/control-center â†’ extended-data-library/*" >> $GITHUB_STEP_SUMMARY
          echo "        â””â”€â”€ strata-game-library/control-center â†’ strata-game-library/*" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Settings Inheritance" >> $GITHUB_STEP_SUMMARY
          echo "Repos inherit settings from \`org/.github/settings.yml\` via repository-settings/app." >> $GITHUB_STEP_SUMMARY
          echo "Override by creating \`repo/.github/settings.yml\` (e.g., for custom release environments)." >> $GITHUB_STEP_SUMMARY
