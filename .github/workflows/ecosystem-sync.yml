name: Ecosystem Sync

# Sync repository-files to all managed repositories
# 
# Two-phase sync for safety and clean logging:
# PHASE 1: Initial Sync - Creates missing files only (safe for customized repos)  
# PHASE 2: Always Sync - Overwrites with latest shared configs
#
# Each phase runs as a separate job with detailed per-repo logging

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      skip_pr:
        description: 'Push directly (skip PR creation)'
        required: false
        default: false
        type: boolean
      sync_type:
        description: 'Which sync to run'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - always-only
          - initial-only
  schedule:
    # Nightly at 3:00 UTC - direct push mode
    - cron: '0 3 * * *'
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'
      - '.github/sync-always.yml'
      - '.github/sync-initial.yml'

permissions:
  contents: read

jobs:
  # =============================================================================
  # Validate configuration before any sync
  # =============================================================================
  validate:
    name: ðŸ” Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Validate all configs
        run: |
          echo "Validating repo-config.json..."
          ./scripts/validate-config
          
          echo "Checking for symlinks..."
          ./scripts/check-symlinks
          
          echo "âœ… All validations passed"

  # =============================================================================
  # PHASE 1: Initial Sync
  # Creates files ONLY if they don't exist - safe for repos with customizations
  # =============================================================================
  phase-1-initial:
    name: ðŸ“¦ Phase 1 - Initial Sync
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.sync_type != 'always-only'
    outputs:
      pr_urls: ${{ steps.sync.outputs.pull_request_urls }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Initial file sync (create missing only)
        id: sync
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-initial.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: ${{ github.event.inputs.skip_pr == 'true' || github.event_name == 'schedule' }}
          PR_LABELS: |
            sync
            initial-setup
          COMMIT_PREFIX: 'chore(init):'
          COMMIT_BODY: |
            Initial file setup - only creates files that don't exist.
            Repos can customize these files after creation.
            
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH_PREFIX: control-center-init
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]
          OVERWRITE_EXISTING_PR: true

      - name: Phase 1 Summary
        run: |
          echo "### ðŸ“¦ Phase 1: Initial Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`.github/sync-initial.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "**Behavior:** Only creates files if they don't exist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files synced:" >> $GITHUB_STEP_SUMMARY
          echo "- \`CLAUDE.md\`, \`AGENTS.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/dependabot.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/SECURITY.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/ISSUE_TEMPLATE/\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.cursor/Dockerfile\`, \`.cursor/environment.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/\` scaffold" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # PHASE 2: Always Sync  
  # Overwrites files with latest from control center - keeps shared configs in sync
  # =============================================================================
  phase-2-always:
    name: ðŸ”„ Phase 2 - Always Sync
    needs: [validate, phase-1-initial]
    runs-on: ubuntu-latest
    # Run even if phase-1 was skipped (when sync_type is always-only)
    if: |
      always() && 
      needs.validate.result == 'success' &&
      github.event.inputs.sync_type != 'initial-only' &&
      (needs.phase-1-initial.result == 'success' || needs.phase-1-initial.result == 'skipped')
    outputs:
      pr_urls: ${{ steps.sync.outputs.pull_request_urls }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Always file sync (overwrite)
        id: sync
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-always.yml
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
          SKIP_PR: ${{ github.event.inputs.skip_pr == 'true' || github.event_name == 'schedule' }}
          PR_LABELS: |
            sync
            automated
          COMMIT_PREFIX: 'chore(sync):'
          COMMIT_BODY: |
            Sync shared configurations from control center.
            These files are managed centrally and should not be modified locally.
            
            Source: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH_PREFIX: control-center-sync
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]
          OVERWRITE_EXISTING_PR: true

      - name: Phase 2 Summary
        run: |
          echo "### ðŸ”„ Phase 2: Always Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** \`.github/sync-always.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "**Behavior:** Overwrites files with latest from control center" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files synced:" >> $GITHUB_STEP_SUMMARY
          echo "- \`.cursor/rules/\` (Cursor AI rules)" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/workflows/\` (shared workflows)" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/agents/\` (AI agent configs)" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/settings.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/CODEOWNERS\`" >> $GITHUB_STEP_SUMMARY
          echo "- Language-specific rules (python/nodejs/go/terraform)" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Final Summary
  # =============================================================================
  summary:
    name: ðŸ“Š Summary
    needs: [phase-1-initial, phase-2-always]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate final summary
        env:
          PHASE1_RESULT: ${{ needs.phase-1-initial.result }}
          PHASE2_RESULT: ${{ needs.phase-2-always.result }}
          PHASE1_PRS: ${{ needs.phase-1-initial.outputs.pr_urls }}
          PHASE2_PRS: ${{ needs.phase-2-always.outputs.pr_urls }}
        run: |
          echo "## ðŸ”„ Ecosystem Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Mode info
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "**Mode:** ðŸ” Dry run (no changes made)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.skip_pr }}" == "true" || "${{ github.event_name }}" == "schedule" ]]; then
            echo "**Mode:** âš¡ Direct push to main" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** ðŸ“ Pull requests" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Results
          echo "### Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          case "$PHASE1_RESULT" in
            success) echo "| ðŸ“¦ Initial Sync | âœ… Success |" >> $GITHUB_STEP_SUMMARY ;;
            skipped) echo "| ðŸ“¦ Initial Sync | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            failure) echo "| ðŸ“¦ Initial Sync | âŒ Failed |" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "| ðŸ“¦ Initial Sync | âš ï¸ $PHASE1_RESULT |" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          case "$PHASE2_RESULT" in
            success) echo "| ðŸ”„ Always Sync | âœ… Success |" >> $GITHUB_STEP_SUMMARY ;;
            skipped) echo "| ðŸ”„ Always Sync | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            failure) echo "| ðŸ”„ Always Sync | âŒ Failed |" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "| ðŸ”„ Always Sync | âš ï¸ $PHASE2_RESULT |" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Configs: \`.github/sync-initial.yml\`, \`.github/sync-always.yml\`*" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Update submodules (after sync completes)
  # =============================================================================
  update-submodules:
    name: ðŸ“š Update Submodules
    needs: phase-2-always
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true' && needs.phase-2-always.result != 'failure'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Update submodules
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git submodule update --remote --recursive || true
          
          if git diff --quiet; then
            echo "No submodule changes"
            exit 0
          fi
          
          git add -A
          git commit -m "deps: update submodules to latest"
          git push origin main
          echo "âœ… Submodules updated"

  # =============================================================================
  # Sync GitHub Projects
  # =============================================================================
  sync-projects:
    name: ðŸ“‹ Sync Projects
    needs: [phase-2-always, update-submodules]
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Sync issues to projects
        run: ./scripts/sync-projects --verbose
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
