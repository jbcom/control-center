name: Hub Validation

# This CI validates the MANAGEMENT HUB ITSELF
# It ensures management tools, workflows, and processes are correct

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  validate-python-scripts:
    name: Validate Python Scripts
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest yamllint
      
      - name: Lint Python scripts with ruff
        run: |
          ruff check .github/scripts/
          ruff format --check .github/scripts/
      
      - name: Type check scripts with mypy
        run: |
          mypy --strict .github/scripts/
      
      - name: Test set_version.py script
        env:
          GITHUB_RUN_NUMBER: 999
        run: |
          # Test the versioning script
          python .github/scripts/set_version.py
          
          # Verify it actually updated the version (matches any valid CalVer format)
          if grep -q '__version__ = "[0-9]\{4\}\.[0-9]\{1,2\}\.[0-9]\+"' src/example_package/__init__.py; then
            echo "✅ Version script works correctly"
            cat src/example_package/__init__.py | grep __version__
          else
            echo "❌ Version was not updated correctly"
            cat src/example_package/__init__.py | grep __version__
            exit 1
          fi

  validate-workflows:
    name: Validate GitHub Actions Workflows
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Validate workflow YAML syntax
        run: |
          sudo snap install yq
          
          for workflow in .github/workflows/*.yml; do
            echo "Validating $workflow"
            yq eval . "$workflow" > /dev/null || exit 1
          done
          
          echo "✅ All workflows have valid YAML syntax"
      
      - name: Check for required workflow components
        run: |
          # Ensure standard-ci.yml exists in workflows/ for distribution
          if [ ! -f workflows/standard-ci.yml ]; then
            echo "❌ Missing workflows/standard-ci.yml"
            exit 1
          fi
          
          # Ensure hub validation exists
          if [ ! -f .github/workflows/template-validation.yml ]; then
            echo "❌ Missing .github/workflows/template-validation.yml"
            exit 1
          fi
          
          echo "✅ Required workflow files present"

  validate-hub-structure:
    name: Validate Hub Structure
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Check required management files
        run: |
          required_files=(
            "pyproject.toml"
            "README.md"
            "AGENTS.md"
            ".cursorrules"
            ".github/copilot-instructions.md"
            ".github/scripts/set_version.py"
            "workflows/standard-ci.yml"
            "src/example_package/__init__.py"
            "tests/test_default.py"
            "ECOSYSTEM_STATE.json"
            ".ruler/AGENTS.md"
            ".ruler/ruler.toml"
            "tools/deploy_workflows.py"
            "docs/MANAGEMENT.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
          done
          
          echo "✅ All required management hub files present"
      
      - name: Verify placeholders are documented
        run: |
          # Check that documentation mentions ${REPO_NAME} placeholder
          if ! grep -q '\${REPO_NAME}' AGENTS.md; then
            echo "❌ AGENTS.md should document \${REPO_NAME} placeholder"
            exit 1
          fi
          
          echo "✅ Placeholders properly documented"
      
      - name: Verify ecosystem documentation
        run: |
          # Check ECOSYSTEM_STATE.json is valid
          python3 -c "import json; json.load(open('ECOSYSTEM_STATE.json'))"
          echo "✅ ECOSYSTEM_STATE.json is valid JSON"
          
          # Check managed repos are documented
          if ! grep -q "extended-data-types" ECOSYSTEM_STATE.json; then
            echo "❌ ECOSYSTEM_STATE.json missing managed repos"
            exit 1
          fi
          
          echo "✅ Ecosystem documentation valid"

  validate-package-structure:
    name: Validate Example Package
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install package in development mode
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[tests,typing]"
      
      - name: Run example tests
        run: |
          pytest tests/ -v
      
      - name: Verify package can be imported
        run: |
          python -c "import example_package; print(f'Version: {example_package.__version__}')"

  lint-template-code:
    name: Lint Template Code Quality
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run ruff linter
        run: |
          ruff check src/ tests/ --output-format=github
      
      - name: Run ruff formatter check
        run: |
          ruff format --check src/ tests/

  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Check README completeness
        run: |
          required_sections=(
            "Management Hub"
            "Managed Repositories"
            "Agent"
          )
          
          for section in "${required_sections[@]}"; do
            if ! grep -qi "$section" README.md; then
              echo "⚠️  Warning: README.md should contain '$section' section"
            fi
          done
      
      - name: Validate AGENTS.md structure
        run: |
          if ! grep -q "CalVer" AGENTS.md; then
            echo "❌ AGENTS.md must document CalVer approach"
            exit 1
          fi
          
          if ! grep -q "semantic-release" AGENTS.md; then
            echo "❌ AGENTS.md must explain why NOT to use semantic-release"
            exit 1
          fi
          
          echo "✅ AGENTS.md has required content"
      
      - name: Check for markdown lint issues
        run: |
          sudo npm install -g markdownlint-cli
          markdownlint *.md --ignore node_modules --ignore .github || echo "⚠️  Markdown lint warnings found"

  validate-ruler-structure:
    name: Validate Ruler Configuration
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Check ruler directory exists
        run: |
          if [ ! -d ".ruler" ]; then
            echo "❌ .ruler directory not found"
            exit 1
          fi
          
          # Validate ruler configuration
          if [ ! -f ".ruler/ruler.toml" ]; then
            echo "❌ Missing .ruler/ruler.toml"
            exit 1
          fi
          
          if [ ! -f ".ruler/AGENTS.md" ]; then
            echo "❌ Missing .ruler/AGENTS.md"
            exit 1
          fi
          
          echo "✅ Ruler structure validated"
  
  validate-management-tools:
    name: Validate Management Tools
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Check management tools
        run: |
          if [ ! -f "tools/deploy_workflows.py" ]; then
            echo "❌ Missing tools/deploy_workflows.py"
            exit 1
          fi
          
          if [ ! -x "tools/deploy_workflows.py" ]; then
            echo "❌ tools/deploy_workflows.py is not executable"
            exit 1
          fi
          
          echo "✅ Management tools present and executable"
      
      - name: Validate ECOSYSTEM_STATE.json
        run: |
          python3 <<'EOF'
          import json
          state = json.load(open('ECOSYSTEM_STATE.json'))
          assert 'repositories' in state
          assert 'standards' in state
          assert len(state['repositories']) >= 4
          print('✅ ECOSYSTEM_STATE.json structure valid')
          EOF
