name: Autoheal
# Consolidated CI failure resolution workflow
# Replaces: ai-fixer, ecosystem-fixer, ecosystem-fixer-local
#
# INTELLIGENT CONFLICT RESOLUTION:
# - Automatically resolves CI failures
# - Resolves merge conflicts triggered by triage workflow
# - Uses AI to analyze and fix issues

on:
  workflow_run:
    workflows: ["CI", "Go"]
    types: [completed]
  workflow_call:
    inputs:
      operation:
        description: 'Operation type (analyze_failure, resolve_conflicts)'
        required: false
        type: string
        default: 'analyze_failure'
      run_id:
        description: 'Workflow run ID to fix'
        required: false
        type: string
      pr_number:
        description: 'PR number (for conflict resolution)'
        required: false
        type: string
      repository:
        description: 'Repository (owner/repo)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - analyze_failure
          - resolve_conflicts
          - apply_fix
      run_id:
        description: 'Workflow run ID to fix (for failures)'
        required: false
        type: string
      pr_number:
        description: 'PR number (for conflicts)'
        required: false
        type: string
      repository:
        description: 'Repository (owner/repo)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # ============================================
  # CI FAILURE RESOLUTION
  # ============================================
  quick-fix:
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'workflow_call' && inputs.operation == 'analyze_failure') ||
      (github.event_name == 'workflow_dispatch' && inputs.operation == 'analyze_failure')
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.3.0
        with:
          repository: ${{ inputs.repository || github.repository }}
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v6.0.0
        with:
          go-version: '1.23'
          cache: true
      
      - name: Setup Control Center
        run: |
          # Build control-center binary
          make build
          # Make it available in PATH
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
      

      - name: Analyze failure with control-center
        id: analyze
        run: |
          RUN_ID="${{ inputs.run_id || github.event.workflow_run.id }}"
          REPO="${{ inputs.repository || github.repository }}"
          
          ./control-center fixer analyze \
            --run-id "$RUN_ID" \
            --repo "$REPO" \
            --output json > fix-suggestion.json
          
          echo "suggestion<<EOF" >> $GITHUB_OUTPUT
          cat fix-suggestion.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply quick fix
        if: steps.analyze.outputs.suggestion != ''
        run: |
          ./control-center fixer apply \
            --suggestion-file fix-suggestion.json \
            --repo ${{ inputs.repository || github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment fix on PR
        if: github.event.workflow_run.pull_requests[0]
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const suggestion = JSON.parse(fs.readFileSync('fix-suggestion.json', 'utf8'));
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.workflow_run.pull_requests[0].number,
              body: `## üîß CI Fix Suggestion\n\n${suggestion.description}\n\n---\n<sub>ü§ñ Generated by Control Center Autoheal</sub>`
            });

  # ============================================
  # MERGE CONFLICT RESOLUTION
  # ============================================
  resolve-conflicts:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_call' && inputs.operation == 'resolve_conflicts') ||
      (github.event_name == 'workflow_dispatch' && inputs.operation == 'resolve_conflicts')
    steps:
      - name: Get PR details
        id: pr-info
        run: |
          PR_NUM="${{ inputs.pr_number }}"
          REPO="${{ inputs.repository || github.repository }}"
          
          # Get PR details
          gh pr view "$PR_NUM" --repo "$REPO" --json headRefName,baseRefName,number,title > pr-details.json
          
          HEAD_REF=$(jq -r '.headRefName' pr-details.json)
          BASE_REF=$(jq -r '.baseRefName' pr-details.json)
          PR_TITLE=$(jq -r '.title' pr-details.json)
          
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v6.3.0
        with:
          repository: ${{ inputs.repository || github.repository }}
          ref: ${{ steps.pr-info.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Control Center Bot"
          git config --global user.email "control-center[bot]@users.noreply.github.com"

      - name: Setup Control Center
        run: |
          # Build control-center binary
          make build
          # Make it available in PATH
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH
      

      - name: Attempt automatic conflict resolution
        id: resolve
        run: |
          echo "üîß Analyzing conflicts for PR #${{ inputs.pr_number }}"
          
          # Fetch latest base branch
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          
          # Attempt rebase
          if git rebase origin/${{ steps.pr-info.outputs.base_ref }}; then
            echo "‚úÖ Rebase successful, no conflicts"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Conflicts detected during rebase"
            echo "status=conflicts" >> $GITHUB_OUTPUT
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            
            # Get list of conflicted files
            git diff --name-only --diff-filter=U > conflicted-files.txt
            echo "conflict_files<<EOF" >> $GITHUB_OUTPUT
            cat conflicted-files.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Abort the rebase for now
            git rebase --abort
          fi

      - name: AI-powered conflict resolution
        if: steps.resolve.outputs.has_conflicts == 'true'
        run: |
          echo "ü§ñ Using AI to resolve conflicts..."
          
          # For each conflicted file, use control-center to resolve
          cat conflicted-files.txt | while read -r FILE; do
            echo "Resolving conflicts in: $FILE"
            
            # Get the conflicted content
            git show :1:"$FILE" > "$FILE.base" 2>/dev/null || echo "" > "$FILE.base"
            git show :2:"$FILE" > "$FILE.ours" 2>/dev/null || echo "" > "$FILE.ours"
            git show :3:"$FILE" > "$FILE.theirs" 2>/dev/null || echo "" > "$FILE.theirs"
            
            # Use control-center to resolve conflict with AI
            ./control-center fixer resolve-conflict \
              --file "$FILE" \
              --base "$FILE.base" \
              --ours "$FILE.ours" \
              --theirs "$FILE.theirs" \
              --output "$FILE.resolved" \
              --strategy ai
            
            if [ -f "$FILE.resolved" ]; then
              mv "$FILE.resolved" "$FILE"
              git add "$FILE"
              echo "‚úÖ Resolved: $FILE"
            else
              echo "‚ùå Failed to resolve: $FILE"
            fi
          done
          
          # Check if all conflicts are resolved
          if git diff --cached --quiet; then
            echo "‚ùå No conflicts were successfully resolved"
            echo "resolution_status=failed" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Some conflicts resolved, attempting to continue rebase"
            echo "resolution_status=partial" >> $GITHUB_OUTPUT
          fi

      - name: Complete rebase and push
        if: steps.resolve.outputs.has_conflicts == 'true' && steps.resolve.outputs.resolution_status != 'failed'
        run: |
          # Start rebase again
          git rebase origin/${{ steps.pr-info.outputs.base_ref }} || true
          
          # Continue rebase with resolved conflicts
          git rebase --continue || true
          
          # Push changes
          git push --force-with-lease origin ${{ steps.pr-info.outputs.head_ref }}
          
          echo "‚úÖ Conflicts resolved and pushed"

      - name: Push successful rebase
        if: steps.resolve.outputs.has_conflicts == 'false'
        run: |
          git push --force-with-lease origin ${{ steps.pr-info.outputs.head_ref }}
          echo "‚úÖ Rebased and pushed successfully"

      - name: Comment on PR - Success
        if: steps.resolve.outputs.status == 'success' || steps.resolve.outputs.resolution_status == 'partial'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const status = '${{ steps.resolve.outputs.status }}';
            const hasConflicts = '${{ steps.resolve.outputs.has_conflicts }}' === 'true';
            const conflictFiles = `${{ steps.resolve.outputs.conflict_files }}`.split('\n').filter(f => f);
            
            let body = '## ü§ñ Automatic Conflict Resolution\n\n';
            
            if (!hasConflicts) {
              body += '‚úÖ Successfully rebased against `${{ steps.pr-info.outputs.base_ref }}`\n\n';
              body += 'No conflicts detected. Your PR is now up-to-date!\n';
            } else {
              body += 'üîß **AI-Powered Conflict Resolution Applied**\n\n';
              body += `Resolved conflicts in ${conflictFiles.length} file(s):\n`;
              conflictFiles.forEach(file => {
                body += `- \`${file}\`\n`;
              });
              body += '\n‚ö†Ô∏è  **Please review the changes** to ensure the conflict resolution is correct.\n';
            }
            
            body += '\n---\n<sub>ü§ñ Performed by Control Center Autoheal</sub>';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body: body
            });

      - name: Comment on PR - Failure
        if: steps.resolve.outputs.resolution_status == 'failed'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const conflictFiles = `${{ steps.resolve.outputs.conflict_files }}`.split('\n').filter(f => f);
            
            let body = '## ü§ñ Automatic Conflict Resolution Failed\n\n';
            body += '‚ùå Unable to automatically resolve all conflicts.\n\n';
            body += `Conflicted files (${conflictFiles.length}):\n`;
            conflictFiles.forEach(file => {
              body += `- \`${file}\`\n`;
            });
            body += '\n**Manual resolution required.** Please resolve conflicts locally:\n\n';
            body += '```bash\n';
            body += 'git fetch origin\n';
            body += 'git rebase origin/${{ steps.pr-info.outputs.base_ref }}\n';
            body += '# Resolve conflicts manually\n';
            body += 'git rebase --continue\n';
            body += 'git push --force-with-lease\n';
            body += '```\n';
            body += '\n---\n<sub>ü§ñ Performed by Control Center Autoheal</sub>';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body: body
            });
