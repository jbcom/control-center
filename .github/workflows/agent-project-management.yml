name: Agent Project Management

on:
  issues:
    types: [opened, closed, reopened, assigned, labeled]
  pull_request:
    types: [opened, closed, merged, review_requested]
  schedule:
    # Run daily at 6 AM UTC for stale issue check
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - sync-project-status
          - cleanup-stale-issues
          - generate-ecosystem-report
          - spawn-maintenance-agents

permissions:
  contents: read
  issues: write
  pull-requests: write
  projects: write

env:
  PROJECT_NUMBER: 2
  STALE_DAYS: 14
  VERY_STALE_DAYS: 30

jobs:
  sync-issue-to-project:
    name: Sync Issue Status to Project
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    
    steps:
      - name: Update Project Item Status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ACTION="${{ github.event.action }}"
          
          echo "Issue #$ISSUE_NUM action: $ACTION"
          
          # Determine new status based on action
          case "$ACTION" in
            opened|reopened)
              STATUS="Todo"
              ;;
            assigned)
              STATUS="In Progress"
              ;;
            closed)
              STATUS="Done"
              ;;
            labeled)
              # Check for specific labels
              LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
              if echo "$LABELS" | grep -qE 'blocked|waiting'; then
                STATUS="Blocked"
              elif echo "$LABELS" | grep -qE 'in-progress|wip'; then
                STATUS="In Progress"
              fi
              ;;
          esac
          
          if [ -n "$STATUS" ]; then
            echo "Setting status to: $STATUS"
            # Note: Actual project field update requires GraphQL API
            # This is a placeholder for the status update logic
          fi

  sync-pr-to-project:
    name: Sync PR Status to Project
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Link PR to Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          ACTION="${{ github.event.action }}"
          
          # Extract issue references from PR body
          ISSUES=$(echo "$PR_BODY" | grep -oE '(fixes|closes|resolves|relates to) #[0-9]+' | grep -oE '#[0-9]+' || echo "")
          
          if [ -n "$ISSUES" ]; then
            echo "Found related issues: $ISSUES"
            
            for issue in $ISSUES; do
              ISSUE_NUM=$(echo "$issue" | tr -d '#')
              
              case "$ACTION" in
                opened)
                  gh issue comment $ISSUE_NUM --body "üîó PR #$PR_NUM opened that references this issue."
                  gh issue edit $ISSUE_NUM --add-label "has-pr"
                  ;;
                closed)
                  if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                    gh issue comment $ISSUE_NUM --body "‚úÖ PR #$PR_NUM merged! This issue may be resolved."
                  fi
                  ;;
              esac
            done
          fi

  stale-issue-management:
    name: Manage Stale Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'cleanup-stale-issues')
    
    steps:
      - name: Find and Process Stale Issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for stale issues..."
          
          # Find issues not updated in STALE_DAYS
          STALE_DATE=$(date -d "-${{ env.STALE_DAYS }} days" +%Y-%m-%d)
          VERY_STALE_DATE=$(date -d "-${{ env.VERY_STALE_DAYS }} days" +%Y-%m-%d)
          
          # Get stale issues
          STALE_ISSUES=$(gh issue list --state open --json number,title,updatedAt \
            --jq ".[] | select(.updatedAt < \"${STALE_DATE}\") | .number")
          
          for issue_num in $STALE_ISSUES; do
            # Check if already labeled stale
            LABELS=$(gh issue view $issue_num --json labels --jq '.labels[].name' | tr '\n' ',')
            
            if echo "$LABELS" | grep -q "stale"; then
              # Already stale, check if very stale
              UPDATED=$(gh issue view $issue_num --json updatedAt --jq '.updatedAt')
              if [[ "$UPDATED" < "$VERY_STALE_DATE" ]]; then
                echo "Issue #$issue_num is very stale, requesting agent review"
                gh issue comment $issue_num --body "$(cat << 'EOF'
          ‚ö†Ô∏è **Very Stale Issue Alert**
          
          This issue has been inactive for over 30 days.
          
          A background agent will review if this should be:
          - Closed as won't fix
          - Reassigned
          - Bumped for attention
          
          Use `/agent review` to request manual agent review.
          EOF
          )"
              fi
            else
              # Mark as stale
              echo "Marking issue #$issue_num as stale"
              gh issue edit $issue_num --add-label "stale"
              gh issue comment $issue_num --body "$(cat << 'EOF'
          ‚è∞ **Stale Issue Notice**
          
          This issue has been inactive for 14+ days.
          
          - If still relevant, please comment with an update
          - If blocked, add the `blocked` label and explain
          - If no longer needed, please close
          
          Issues inactive for 30 days may be auto-closed or reviewed by agents.
          EOF
          )"
            fi
          done

  generate-ecosystem-report:
    name: Generate Ecosystem Status Report
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'generate-ecosystem-report'
    
    steps:
      - name: Gather Ecosystem Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Generating ecosystem status report..."
          
          REPOS="jbcom/jbcom-control-center jbcom/extended-data-types jbcom/lifecyclelogging jbcom/vendor-connectors jbcom/directed-inputs-class"
          
          REPORT="# üìä Ecosystem Status Report\n\n"
          REPORT+="**Generated**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")\n\n"
          
          for repo in $REPOS; do
            echo "Checking $repo..."
            
            # Get repo stats
            OPEN_ISSUES=$(gh issue list --repo $repo --state open --json number --jq 'length')
            OPEN_PRS=$(gh pr list --repo $repo --state open --json number --jq 'length')
            LAST_RELEASE=$(gh release list --repo $repo --limit 1 --json tagName --jq '.[0].tagName // "none"' 2>/dev/null || echo "N/A")
            LAST_CI=$(gh run list --repo $repo --limit 1 --json conclusion --jq '.[0].conclusion // "unknown"' 2>/dev/null || echo "unknown")
            
            REPORT+="## $repo\n"
            REPORT+="| Metric | Value |\n"
            REPORT+="|--------|-------|\n"
            REPORT+="| Open Issues | $OPEN_ISSUES |\n"
            REPORT+="| Open PRs | $OPEN_PRS |\n"
            REPORT+="| Last Release | $LAST_RELEASE |\n"
            REPORT+="| Last CI | $LAST_CI |\n\n"
          done
          
          # Create report issue
          gh issue create \
            --title "üìä Ecosystem Status Report - $(date +%Y-%m-%d)" \
            --body "$(echo -e "$REPORT")" \
            --label "report,ecosystem"

  spawn-maintenance-agents:
    name: Spawn Maintenance Agents
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'spawn-maintenance-agents'
    
    steps:
      - name: Create Maintenance Tasks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          echo "ü§ñ Spawning maintenance agents..."
          
          # Dependency Update Agent
          gh issue create \
            --title "ü§ñ Agent Task: Weekly Dependency Audit" \
            --body "$(cat << 'EOF'
          ## Background Agent Task: Dependency Audit
          
          Perform weekly dependency maintenance:
          
          ### 1. Check for Updates
          ```bash
          cd packages/extended-data-types && uv pip list --outdated
          cd packages/lifecyclelogging && uv pip list --outdated
          cd packages/vendor-connectors && uv pip list --outdated
          ```
          
          ### 2. Security Audit
          ```bash
          uv pip audit
          ```
          
          ### 3. Update Safe Dependencies
          - Patch updates: Auto-update
          - Minor updates: Review changelog first
          - Major updates: Create separate issue
          
          ### 4. Test After Updates
          ```bash
          pytest
          mypy src/
          ruff check .
          ```
          
          ## Deliverables
          - [ ] List of updated packages
          - [ ] Security audit results
          - [ ] PR with updates (if any)
          
          ---
          *Weekly maintenance task*
          EOF
          )" \
            --label "agent-task,maintenance,dependencies"
          
          # Documentation Sync Agent
          gh issue create \
            --title "ü§ñ Agent Task: Documentation Sync Check" \
            --body "$(cat << 'EOF'
          ## Background Agent Task: Documentation Sync
          
          Verify documentation is current:
          
          ### 1. Check README Files
          - [ ] Root README.md
          - [ ] Package READMEs
          - [ ] Docs folder
          
          ### 2. Verify Examples Work
          ```bash
          # Test code examples in docs
          python -c "from extended_data_types import ..."
          ```
          
          ### 3. Check Links
          - [ ] All URLs valid
          - [ ] Internal links work
          - [ ] Badge URLs correct
          
          ### 4. API Documentation
          - [ ] All public functions documented
          - [ ] Type hints complete
          - [ ] Examples provided
          
          ## Deliverables
          - [ ] List of outdated docs
          - [ ] PR with fixes (if any)
          
          ---
          *Weekly maintenance task*
          EOF
          )" \
            --label "agent-task,maintenance,documentation"
          
          echo "‚úÖ Maintenance agents spawned"

  weekly-project-sync:
    name: Weekly Project Board Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Sync Project Board
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÑ Running weekly project board sync..."
          
          # Find issues not in project
          ALL_ISSUES=$(gh issue list --state open --json number --jq '.[].number')
          
          for issue_num in $ALL_ISSUES; do
            # Check if important enough for project
            LABELS=$(gh issue view $issue_num --json labels --jq '.labels[].name' | tr '\n' ',')
            
            # Add to project if has relevant labels
            if echo "$LABELS" | grep -qE 'agent-task|ecosystem|ci-cd|security|bug'; then
              echo "Ensuring issue #$issue_num is in project"
              gh project item-add ${{ env.PROJECT_NUMBER }} \
                --owner "@me" \
                --url "https://github.com/${{ github.repository }}/issues/$issue_num" 2>/dev/null || true
            fi
          done
          
          echo "‚úÖ Project board sync complete"
