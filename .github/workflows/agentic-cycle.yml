name: Agentic Cycle Orchestration

on:
  issues:
    types: [opened, edited, labeled]
  workflow_dispatch:
    inputs:
      cycle_issue:
        description: 'Cycle issue number to process'
        required: true
        type: number
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - decompose
          - aggregate
          - complete

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  MANAGED_REPOS: "jbcom/extended-data-types jbcom/lifecyclelogging jbcom/directed-inputs-class jbcom/vendor-connectors"

jobs:
  detect-cycle:
    name: Detect Agentic Cycle
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && 
       github.event.action == 'labeled' && 
       github.event.label.name == 'agentic-cycle')
    outputs:
      is_cycle: ${{ steps.check.outputs.is_cycle }}
      cycle_number: ${{ steps.check.outputs.cycle_number }}
      phase: ${{ steps.check.outputs.phase }}
    
    steps:
      - name: Check for cycle
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUM="${{ inputs.cycle_issue }}"
            PHASE="${{ inputs.action }}"
          else
            ISSUE_NUM="${{ github.event.issue.number }}"
            PHASE="decompose"
          fi
          
          # Verify it's a cycle issue
          LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '.labels[].name' | tr '\n' ',')
          
          if echo "$LABELS" | grep -q "agentic-cycle"; then
            echo "is_cycle=true" >> $GITHUB_OUTPUT
            echo "cycle_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "phase=$PHASE" >> $GITHUB_OUTPUT
          else
            echo "is_cycle=false" >> $GITHUB_OUTPUT
          fi

  decompose:
    name: Decompose Cycle to Repos
    runs-on: ubuntu-latest
    needs: detect-cycle
    if: needs.detect-cycle.outputs.is_cycle == 'true' && needs.detect-cycle.outputs.phase == 'decompose'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Parse cycle and create repo issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_JBCOM_TOKEN }}
          CYCLE_NUM: ${{ needs.detect-cycle.outputs.cycle_number }}
        run: |
          # Get cycle issue details
          CYCLE_DATA=$(gh issue view "$CYCLE_NUM" --json title,body)
          CYCLE_TITLE=$(echo "$CYCLE_DATA" | jq -r '.title')
          CYCLE_BODY=$(echo "$CYCLE_DATA" | jq -r '.body')
          
          echo "Processing cycle: $CYCLE_TITLE"
          
          # Parse tasks from body (look for repo headers)
          CREATED_ISSUES=""
          
          for repo in $MANAGED_REPOS; do
            REPO_NAME=$(basename "$repo")
            
            # Check if this repo is mentioned in the cycle
            if echo "$CYCLE_BODY" | grep -qi "$REPO_NAME"; then
              echo "Creating task for $repo..."
              
              # Extract tasks for this repo (between ### repo_name and next ###)
              REPO_TASKS=$(echo "$CYCLE_BODY" | sed -n "/### $REPO_NAME/,/### /p" | head -n -1)
              
              if [ -z "$REPO_TASKS" ]; then
                REPO_TASKS="Work on tasks related to $REPO_NAME as part of this cycle."
              fi
              
              # Create issue in target repo
              ISSUE_URL=$(gh issue create \
                --repo "$repo" \
                --title "ü§ñ Agent Task: $CYCLE_TITLE" \
                --label "agent-task" \
                --body "## Agentic Cycle Task

**Control Plane Cycle**: jbcom/jbcom-control-center#${CYCLE_NUM}
**Cycle Title**: $CYCLE_TITLE

## Tasks for This Repo

$REPO_TASKS

## Instructions

1. Complete the tasks listed above
2. Create PRs for any code changes
3. Update this issue with progress
4. When complete, close this issue

The upstream notification workflow will automatically inform the control plane.

---
*Auto-generated by agentic-cycle workflow*")
              
              CREATED_ISSUES="$CREATED_ISSUES\n- $repo: $ISSUE_URL"
              echo "Created: $ISSUE_URL"
            fi
          done
          
          # Update cycle issue with created tasks
          if [ -n "$CREATED_ISSUES" ]; then
            gh issue comment "$CYCLE_NUM" --body "## üöÄ Cycle Decomposed

Tasks created in managed repos:
$(echo -e "$CREATED_ISSUES")

Monitor progress via the links above. Repos will notify back when complete.

---
*Automated by agentic-cycle workflow*"
          fi

  aggregate:
    name: Aggregate Cycle Status
    runs-on: ubuntu-latest
    needs: detect-cycle
    if: needs.detect-cycle.outputs.is_cycle == 'true' && needs.detect-cycle.outputs.phase == 'aggregate'
    
    steps:
      - name: Collect status from repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_JBCOM_TOKEN }}
          CYCLE_NUM: ${{ needs.detect-cycle.outputs.cycle_number }}
        run: |
          echo "Aggregating status for cycle #$CYCLE_NUM..."
          
          STATUS_REPORT="## üìä Cycle Status Update\n\n"
          ALL_COMPLETE=true
          
          for repo in $MANAGED_REPOS; do
            REPO_NAME=$(basename "$repo")
            
            # Find agent-task issues that reference this cycle
            ISSUES=$(gh issue list \
              --repo "$repo" \
              --label "agent-task" \
              --state all \
              --json number,state,title,url \
              --jq ".[] | select(.title | contains(\"#$CYCLE_NUM\") or contains(\"Cycle\")) | \"\(.state) \(.url)\"" 2>/dev/null || echo "")
            
            if [ -n "$ISSUES" ]; then
              STATUS_REPORT+="### $repo\n"
              
              while IFS= read -r line; do
                STATE=$(echo "$line" | cut -d' ' -f1)
                URL=$(echo "$line" | cut -d' ' -f2-)
                
                if [ "$STATE" = "OPEN" ]; then
                  STATUS_REPORT+="- üü° In Progress: $URL\n"
                  ALL_COMPLETE=false
                else
                  STATUS_REPORT+="- ‚úÖ Complete: $URL\n"
                fi
              done <<< "$ISSUES"
              
              STATUS_REPORT+="\n"
            fi
          done
          
          if [ "$ALL_COMPLETE" = "true" ]; then
            STATUS_REPORT+="\n---\n**All tasks complete!** Consider marking cycle as done."
          else
            STATUS_REPORT+="\n---\n**Some tasks still in progress.**"
          fi
          
          # Update cycle issue
          gh issue comment "$CYCLE_NUM" --body "$(echo -e "$STATUS_REPORT")"

  complete:
    name: Complete Cycle
    runs-on: ubuntu-latest
    needs: detect-cycle
    if: needs.detect-cycle.outputs.is_cycle == 'true' && needs.detect-cycle.outputs.phase == 'complete'
    
    steps:
      - name: Verify and close cycle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_JBCOM_TOKEN }}
          CYCLE_NUM: ${{ needs.detect-cycle.outputs.cycle_number }}
        run: |
          echo "Completing cycle #$CYCLE_NUM..."
          
          # Final status check
          OPEN_TASKS=0
          
          for repo in $MANAGED_REPOS; do
            COUNT=$(gh issue list \
              --repo "$repo" \
              --label "agent-task" \
              --state open \
              --json number \
              --jq 'length' 2>/dev/null || echo "0")
            OPEN_TASKS=$((OPEN_TASKS + COUNT))
          done
          
          if [ "$OPEN_TASKS" -gt 0 ]; then
            gh issue comment "$CYCLE_NUM" --body "‚ö†Ô∏è **Cannot complete cycle**

There are still $OPEN_TASKS open agent tasks in managed repos.

Run aggregate to see details, or complete tasks first."
          else
            gh issue comment "$CYCLE_NUM" --body "## ‚úÖ Cycle Complete

All tasks in managed repos have been completed.

**Summary**:
- All repo issues closed
- Changes merged to main branches
- Ecosystem synchronized

This cycle is now complete. Creating the next cycle issue is recommended.

---
*Automated by agentic-cycle workflow*"
            
            gh issue close "$CYCLE_NUM" --comment "Cycle completed successfully."
          fi
