# Efficient testing for monorepo
# - Detects changed packages
# - Tests affected packages + dependents
# - Runs in parallel
# - Caches dependencies

name: Test

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - 'pyproject.toml'
      - 'uv.lock'
  pull_request:
    paths:
      - 'packages/**'
      - 'pyproject.toml'
      - 'uv.lock'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to test (or "all")'
        required: false
        default: 'all'

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which packages changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.detect.outputs.packages }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed packages
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.package }}" != "all" ]; then
            # Manual trigger for specific package
            PACKAGES='["${{ inputs.package }}"]'
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger for all
            PACKAGES='["extended-data-types","lifecyclelogging","directed-inputs-class","vendor-connectors"]'
          else
            # Detect from git diff
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE="${{ github.event.pull_request.base.sha }}"
            else
              BASE="${{ github.event.before }}"
            fi
            
            CHANGED=""
            
            # Check each package
            if git diff --name-only $BASE HEAD | grep -q "^packages/extended-data-types/"; then
              # Foundation changed - test everything
              PACKAGES='["extended-data-types","lifecyclelogging","directed-inputs-class","vendor-connectors"]'
              echo "extended-data-types changed - testing all dependents"
              echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
              echo "matrix={\"package\":$PACKAGES,\"python\":[\"3.9\",\"3.13\"]}" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if git diff --name-only $BASE HEAD | grep -q "^packages/lifecyclelogging/"; then
              CHANGED="$CHANGED lifecyclelogging vendor-connectors"
            fi
            
            if git diff --name-only $BASE HEAD | grep -q "^packages/directed-inputs-class/"; then
              CHANGED="$CHANGED directed-inputs-class"
            fi
            
            if git diff --name-only $BASE HEAD | grep -q "^packages/vendor-connectors/"; then
              CHANGED="$CHANGED vendor-connectors"
            fi
            
            # Dedupe and format
            PACKAGES=$(echo $CHANGED | tr ' ' '\n' | sort -u | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            
            if [ "$PACKAGES" == "[]" ] || [ -z "$PACKAGES" ]; then
              # Root config changed, test all
              PACKAGES='["extended-data-types","lifecyclelogging","directed-inputs-class","vendor-connectors"]'
            fi
          fi
          
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "matrix={\"package\":$PACKAGES,\"python\":[\"3.9\",\"3.13\"]}" >> $GITHUB_OUTPUT
          echo "Testing packages: $PACKAGES"

  # Run tests
  test:
    needs: changes
    if: needs.changes.outputs.packages != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.changes.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.python }}-

      - name: Install dependencies
        run: |
          # Install the package and its test deps
          cd packages/${{ matrix.package }}
          uv pip install -e ".[tests]" --system
          
          # Install internal dependencies
          case "${{ matrix.package }}" in
            lifecyclelogging)
              uv pip install -e ../extended-data-types --system
              ;;
            directed-inputs-class)
              uv pip install -e ../extended-data-types --system
              ;;
            vendor-connectors)
              uv pip install -e ../extended-data-types --system
              uv pip install -e ../lifecyclelogging --system
              ;;
          esac

      - name: Run tests
        run: |
          cd packages/${{ matrix.package }}
          pytest tests -v --tb=short -x

  # Lint (only once, not per Python version)
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4

      - name: Lint
        run: |
          uv pip install ruff --system
          ruff check packages/
          ruff format --check packages/

  # Summary
  test-summary:
    needs: [test, lint]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.test.result }}" == "failure" ] || [ "${{ needs.lint.result }}" == "failure" ]; then
            echo "❌ Tests or lint failed"
            exit 1
          fi
          echo "✅ All checks passed"
