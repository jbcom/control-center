name: Ollama Cloud PR Review (GLM-4.6)

on:
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: write          # Required for git-auto-commit-action
  pull-requests: write
  issues: write

env:
  OLLAMA_HOST: https://ollama.com
  OLLAMA_MODEL: glm-4.6:cloud
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ============================================
  # PR Review - Initial review on open/synchronize
  # ============================================
  pr-review:
    name: Ollama Cloud PR Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      # actions/checkout v6.0.1
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      # Install Ollama CLI
      - name: Install Ollama CLI
        run: curl -fsSL https://ollama.com/install.sh | sh

      # Configure for Cloud
      - name: Configure Ollama for Cloud
        run: |
          echo "OLLAMA_HOST=https://ollama.com" >> $GITHUB_ENV
          echo "OLLAMA_API_KEY=${{ secrets.OLLAMA_API_KEY }}" >> $GITHUB_ENV

      # Register cloud model
      - name: Register cloud model
        run: ollama pull glm-4.6:cloud

      # Get PR diff
      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} --color=never)
          DIFF_ESCAPED=$(echo "$DIFF" | sed 's/"/\\"/g; s/\n/\\n/g')
          echo "diff=$DIFF_ESCAPED" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      # Define JSON Schema (shared across jobs)
      - name: Define JSON Schema
        id: schema
        run: |
          # Use a shared schema definition to avoid duplication
          cat > /tmp/review-schema.json << 'EOF'
          {
            "type": "object",
            "properties": {
              "summary": { "type": "string" },
              "issues": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "line": { "type": "integer", "minimum": 1 },
                    "severity": { "type": "string", "enum": ["low", "medium", "high"] },
                    "description": { "type": "string" },
                    "suggestion": { "type": "string" }
                  },
                  "required": ["file", "severity", "description"],
                  "additionalProperties": false
                }
              },
              "suggested_fixes": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "patch": { "type": "string", "description": "Unified diff patch compatible with 'git apply'" },
                    "description": { "type": "string" }
                  },
                  "required": ["file", "patch", "description"],
                  "additionalProperties": false
                }
              },
              "overall_score": { "type": "integer", "minimum": 1, "maximum": 10 },
              "should_auto_apply": { "type": "boolean" }
            },
            "required": ["summary", "issues", "suggested_fixes", "overall_score", "should_auto_apply"],
            "additionalProperties": false
          }
          EOF
          
          SCHEMA=$(cat /tmp/review-schema.json)
          echo "schema=$SCHEMA" >> $GITHUB_OUTPUT

      # Generate structured review
      - name: Generate structured review with fixes
        id: review
        run: |
          RESPONSE=$(curl -s --fail-with-body --max-time 300  \
            -H "Authorization: Bearer ${{ secrets.OLLAMA_API_KEY }}" \
            -d "{
              \"model\": \"glm-4.6:cloud\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are an expert code reviewer. Analyze the diff carefully. Identify issues and provide precise, safe fixes as unified diff patches. Set should_auto_apply to true only if all fixes are low-risk and improve the code without changing behaviour. Respond EXCLUSIVELY with valid JSON matching the schema.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"Schema (respond exactly this format): ${{ steps.schema.outputs.schema }}\\n\\nDiff to review:\\n${{ steps.diff.outputs.diff }}\"
                }
              ],
              \"format\": ${{ steps.schema.outputs.schema }},
              \"options\": {
                \"temperature\": 0.1,
                \"mirostat\": 2,
                \"mirostat_tau\": 5.0,
                \"mirostat_eta\": 0.1,
                \"top_p\": 0.95,
                \"repeat_penalty\": 1.15,
                \"num_ctx\": 196608,
                \"num_predict\": 4096
              },
              \"stream\": false
            }")

          if [ $? -ne 0 ]; then
            echo "Error: Failed to connect to Ollama API"
            exit 1
          fi

          REVIEW_JSON=$(echo "$RESPONSE" | jq -r '.message.content // empty')

          if [ -z "$REVIEW_JSON" ] || [ "$REVIEW_JSON" = "null" ]; then
            echo "Error: Empty or invalid response from model"
            exit 1
          fi

          REVIEW_FORMATTED=$(echo "$REVIEW_JSON" | jq '.')

          echo "json<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "formatted<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Validate JSON output
      - name: Validate JSON output
        run: |
          REVIEW_JSON="${{ steps.review.outputs.json }}"

          echo "$REVIEW_JSON" | jq empty || (
            echo "Invalid JSON received from model"
            exit 1
          )

          echo "JSON is valid and structured"

      # Apply suggested patches (if approved by model)
      - name: Apply suggested fixes (if approved)
        if: fromJSON(steps.review.outputs.json).should_auto_apply == true
        run: |
          REVIEW_JSON="${{ steps.review.outputs.json }}"

          echo "$REVIEW_JSON" | jq -r '.suggested_fixes[] | select(.patch != null and .patch != "") | @base64' | while read -r encoded_patch; do
            PATCH_JSON=$(echo "$encoded_patch" | base64 -d)
            FILE=$(echo "$PATCH_JSON" | jq -r '.file')
            PATCH=$(echo "$PATCH_JSON" | jq -r '.patch')
            DESC=$(echo "$PATCH_JSON" | jq -r '.description')

            # Validate file path to prevent directory traversal
            if [[ "$FILE" =~ \.\./|^/ ]]; then
              echo "Warning: Skipping unsafe file path: $FILE"
              continue
            fi

            echo "Applying patch to $FILE: $DESC"

            # Write patch to temporary file to avoid shell injection
            PATCH_FILE=$(mktemp)
            echo "$PATCH" > "$PATCH_FILE"
            git apply --whitespace=nowarn --verbose "$PATCH_FILE" || echo "Warning: Patch failed for $FILE (skipping)"
            rm -f "$PATCH_FILE"
          done

      # Commit and push auto-applied fixes
      - name: Commit and push auto-applied fixes
        if: fromJSON(steps.review.outputs.json).should_auto_apply == true
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: Apply AI-suggested improvements (GLM-4.6 review)"
          branch: ${{ github.head_ref }}
          commit_user_name: "GLM-4.6 Bot"
          commit_user_email: "glm-bot@users.noreply.github.com"
          commit_author: "GLM-4.6 Bot <glm-bot@users.noreply.github.com>"
          file_pattern: .
          skip_dirty_check: false

      # Post review comment on PR
      - name: Post review comment on PR
        run: |
          AUTO_APPLIED=$(jq -r 'if .should_auto_apply then "✅ Fixes automatically applied and pushed to this branch!" else "⚠️ Fixes suggested – review and apply manually" end' <<< '${{ steps.review.outputs.json }}')
          SUMMARY=$(jq -r '.summary' <<< '${{ steps.review.outputs.json }}')
          SCORE=$(jq -r '.overall_score' <<< '${{ steps.review.outputs.json }}')

          COMMENT_BODY="## GLM-4.6 Cloud Auto-Fix Review\n\n**Summary**: $SUMMARY\n**Overall Score**: $SCORE / 10\n\n$AUTO_APPLIED\n\n\`\`\`json\n${{ steps.review.outputs.formatted }}\n\`\`\`\n\n> Powered by **glm-4.6:cloud** on Ollama Cloud – structured, validated, and auto-applied where safe."

          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
        env:
          GH_TOKEN: ${{ github.token }}

  # ============================================
  # Multi-turn Follow-up - Handle comments and reviews
  # ============================================
  follow-up-review:
    name: Ollama Cloud Follow-Up Review
    if: (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') && contains(github.event.comment.body, '/ollama-review')
    runs-on: ubuntu-latest
    
    steps:
      # actions/checkout v6.0.1
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          ref: ${{ github.event.pull_request.head.sha || github.event.issue.pull_request.head.sha }}
          fetch-depth: 0

      # Install Ollama CLI
      - name: Install Ollama CLI
        run: curl -fsSL https://ollama.com/install.sh | sh

      # Configure for Cloud
      - name: Configure Ollama for Cloud
        run: |
          echo "OLLAMA_HOST=https://ollama.com" >> $GITHUB_ENV
          echo "OLLAMA_API_KEY=${{ secrets.OLLAMA_API_KEY }}" >> $GITHUB_ENV

      # Register cloud model
      - name: Register cloud model
        run: ollama pull glm-4.6:cloud

      # Get PR diff
      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER=$(echo "${{ github.event }}" | jq -r '.pull_request.number // .issue.pull_request.number')
          DIFF=$(gh pr diff $PR_NUMBER --color=never)
          DIFF_ESCAPED=$(echo "$DIFF" | sed 's/"/\\"/g; s/\n/\\n/g')
          echo "diff=$DIFF_ESCAPED" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      # Define Enhanced JSON Schema
      - name: Define Enhanced JSON Schema
        id: schema
        run: |
          SCHEMA=$(cat <<'EOF'
          {
            "type": "object",
            "properties": {
              "summary": { "type": "string" },
              "issues": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "line": { "type": "integer", "minimum": 1 },
                    "severity": { "type": "string", "enum": ["low", "medium", "high"] },
                    "description": { "type": "string" },
                    "suggestion": { "type": "string" }
                  },
                  "required": ["file", "severity", "description"],
                  "additionalProperties": false
                }
              },
              "suggested_fixes": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "patch": { "type": "string", "description": "Unified diff patch compatible with 'git apply'" },
                    "description": { "type": "string" }
                  },
                  "required": ["file", "patch", "description"],
                  "additionalProperties": false
                }
              },
              "overall_score": { "type": "integer", "minimum": 1, "maximum": 10 },
              "should_auto_apply": { "type": "boolean" }
            },
            "required": ["summary", "issues", "suggested_fixes", "overall_score", "should_auto_apply"],
            "additionalProperties": false
          }
          EOF
          )
          echo "schema=$SCHEMA" >> $GITHUB_OUTPUT

      # Get previous AI comments for context
      - name: Fetch previous AI comments
        id: history
        run: |
          PR_NUMBER=$(echo "${{ github.event }}" | jq -r '.pull_request.number // .issue.pull_request.number')
          
          # Get last 10 comments, extract AI ones (assume bot username is your bot)
          COMMENTS=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments -q '.[] | select(.user.login == "github-actions[bot]") | .body' --jq 'join("\n---\n")')
          echo "prev=$COMMENTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      # Multi-turn structured response
      - name: Multi-turn structured response
        id: response
        run: |
          USER_COMMENT="${{ github.event.comment.body }}"
          PR_NUMBER=$(echo "${{ github.event }}" | jq -r '.pull_request.number // .issue.pull_request.number')

          MESSAGES_JSON=$(cat <<EOF
          [
            {"role": "system", "content": "You are an expert code reviewer. Use previous context."},
            {"role": "user", "content": "Initial diff:\n${{ steps.diff.outputs.diff }}"},
            {"role": "assistant", "content": "${{ steps.history.outputs.prev }}"},
            {"role": "user", "content": "$USER_COMMENT"}
          ]
          EOF
          )

          RESPONSE=$(curl -s https://ollama.com/api/chat \
            -H "Authorization: Bearer ${{ secrets.OLLAMA_API_KEY }}" \
            -d "{
              \"model\": \"glm-4.6:cloud\",
              \"messages\": $MESSAGES_JSON,
              \"format\": ${{ steps.schema.outputs.schema }},
              \"options\": {
                \"temperature\": 0.1,
                \"mirostat\": 2,
                \"mirostat_tau\": 5.0,
                \"mirostat_eta\": 0.1,
                \"top_p\": 0.95,
                \"repeat_penalty\": 1.15,
                \"num_ctx\": 196608,
                \"num_predict\": 4096
              },
              \"stream\": false
            }")

          REVIEW_JSON=$(echo "$RESPONSE" | jq -r '.message.content')

          echo "json=$REVIEW_JSON" >> $GITHUB_OUTPUT

      # Validate JSON
      - name: Validate JSON
        run: |
          REVIEW_JSON="${{ steps.response.outputs.json }}"

          echo "$REVIEW_JSON" | jq empty || (
            echo "Invalid JSON received from model"
            exit 1
          )

          echo "JSON is valid and structured"

      # Apply suggested patches (if approved by model)
      - name: Apply suggested fixes (if approved)
        if: fromJSON(steps.response.outputs.json).should_auto_apply == true
        run: |
          REVIEW_JSON="${{ steps.response.outputs.json }}"

          echo "$REVIEW_JSON" | jq -r '.suggested_fixes[] | select(.patch != null and .patch != "") | @base64' | while read -r encoded_patch; do
            PATCH_JSON=$(echo "$encoded_patch" | base64 -d)
            FILE=$(echo "$PATCH_JSON" | jq -r '.file')
            PATCH=$(echo "$PATCH_JSON" | jq -r '.patch')
            DESC=$(echo "$PATCH_JSON" | jq -r '.description')

            echo "Applying patch to $FILE: $DESC"

            echo "$PATCH" | git apply --whitespace=nowarn --verbose || echo "Warning: Patch failed for $FILE (skipping)"
          done

      # Commit and push auto-applied fixes
      - name: Commit and push auto-applied fixes
        if: fromJSON(steps.response.outputs.json).should_auto_apply == true
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: Apply AI-suggested improvements (GLM-4.6 follow-up)"
          branch: ${{ github.event.pull_request.head.ref || github.event.issue.pull_request.head.ref }}
          commit_user_name: "GLM-4.6 Bot"
          commit_user_email: "glm-bot@users.noreply.github.com"
          commit_author: "GLM-4.6 Bot <glm-bot@users.noreply.github.com>"
          file_pattern: .
          skip_dirty_check: false

      # Post follow-up comment
      - name: Post follow-up comment
        run: |
          PR_NUMBER=$(echo "${{ github.event }}" | jq -r '.pull_request.number // .issue.pull_request.number')
          AUTO_APPLIED=$(jq -r 'if .should_auto_apply then "✅ Fixes automatically applied and pushed to this branch!" else "⚠️ Fixes suggested – review and apply manually" end' <<< '${{ steps.response.outputs.json }}')
          SUMMARY=$(jq -r '.summary' <<< '${{ steps.response.outputs.json }}')
          SCORE=$(jq -r '.overall_score' <<< '${{ steps.response.outputs.json }}')

          COMMENT_BODY="## GLM-4.6 Cloud Follow-Up Review\n\n**Summary**: $SUMMARY\n**Overall Score**: $SCORE / 10\n\n$AUTO_APPLIED\n\n\`\`\`json\n${{ steps.response.outputs.json }}\n\`\`\`\n\n> Powered by **glm-4.6:cloud** on Ollama Cloud – structured, validated, and auto-applied where safe."

          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments --field body="$COMMENT_BODY"
        env:
          GH_TOKEN: ${{ github.token }}

  # ============================================
  # Request AI Reviews - Trigger other AI reviewers
  # ============================================
  request-ai-reviews:
    name: Request AI Reviews
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    
    steps:
      - name: Request AI reviews
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          # Request reviews from various AI tools
          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments --field body="/gemini review"
          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments --field body="/q review"
          
          echo "✅ Requested AI reviews from Gemini and Amazon Q"
        env:
          GH_TOKEN: ${{ github.token }}
