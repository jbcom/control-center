# Reusable docs workflow - builds and deploys docs to gh-pages
name: Deploy Docs

on:
  workflow_call:
    inputs:
      package:
        required: true
        type: string
      target-repo:
        required: true
        type: string
      version:
        required: false
        type: string
        default: "latest"
        description: "Version hint (actual version read from package)"
    secrets:
      token:
        required: true

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout control-center
        uses: actions/checkout@v4
        with:
          ref: main
          path: source

      - uses: astral-sh/setup-uv@v7

      - name: Get package version
        id: version
        run: |
          VERSION=$(grep '^version = ' source/packages/${{ inputs.package }}/pyproject.toml | head -1 | sed 's/version = "\([^"]*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Build docs
        run: |
          PKG_DIR="source/packages/${{ inputs.package }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "=== Building docs for ${{ inputs.package }} v$VERSION ==="
          
          # Sync workspace - try with docs extra, fall back to base if not defined
          cd source
          if ! uv sync --package ${{ inputs.package }} --extra docs 2>/dev/null; then
            echo "Note: docs extra not defined, using base dependencies"
            uv sync --package ${{ inputs.package }}
          fi
          
          # Ensure docs/_build directory exists
          cd ..
          mkdir -p "$PKG_DIR/docs/_build"
          
          # Build if docs source exists
          if [ -d "$PKG_DIR/docs" ] && [ -f "$PKG_DIR/docs/conf.py" ]; then
            echo "Building Sphinx docs..."
            cd "$PKG_DIR/docs"
            uv run sphinx-build -b html . _build || echo "Sphinx build had warnings"
          else
            echo "No Sphinx docs found, generating placeholder..."
            echo "<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>${{ inputs.package }} v$VERSION</title></head><body><h1>${{ inputs.package }}</h1><p>Version: $VERSION</p><p>Documentation coming soon.</p><p><a href=\"https://pypi.org/project/${{ inputs.package }}/\">PyPI</a></p></body></html>" > "$PKG_DIR/docs/_build/index.html"
          fi

      - name: Deploy to gh-pages
        env:
          GH_TOKEN: ${{ secrets.token }}
        run: |
          PKG_DIR="source/packages/${{ inputs.package }}"
          REPO="${{ inputs.target-repo }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Clone gh-pages branch or create it
          if git clone --branch gh-pages --single-branch --depth 1 \
               "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" \
               gh-pages 2>/dev/null; then
            echo "Cloned existing gh-pages branch"
          else
            echo "Creating new gh-pages branch"
            mkdir gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
            cd ..
          fi
          
          # Clear old docs (preserve .git directory)
          find gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} + 2>/dev/null || true
          
          if [ -d "$PKG_DIR/docs/_build" ]; then
            cp -r "$PKG_DIR/docs/_build/"* gh-pages/ 2>/dev/null || true
          fi
          
          # Ensure there's at least an index.html
          if [ ! -f "gh-pages/index.html" ]; then
            echo "<html><body><h1>${{ inputs.package }} v$VERSION</h1></body></html>" > gh-pages/index.html
          fi
          
          # Add .nojekyll to prevent Jekyll processing
          touch gh-pages/.nojekyll
          
          # Push
          cd gh-pages
          git config user.name "jbcom-bot"
          git config user.email "jbcom-bot@users.noreply.github.com"
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to docs"
          else
            git commit -m "ðŸ“š Docs for ${{ inputs.package }} v$VERSION"
            git push -u origin gh-pages --force
            echo "âœ… Docs deployed"
          fi
