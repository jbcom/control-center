# Reusable docs workflow - builds and deploys docs to gh-pages
name: Deploy Docs

on:
  workflow_call:
    inputs:
      package:
        required: true
        type: string
      target-repo:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - uses: astral-sh/setup-uv@v4

      - name: Build docs
        run: |
          uv pip install sphinx sphinx-rtd-theme myst-parser --system

          # Install package for API docs
          uv pip install -e packages/extended-data-types --system
          if [ "${{ inputs.package }}" != "extended-data-types" ]; then
            uv pip install -e packages/${{ inputs.package }} --system
          fi

          # Build if docs exist
          if [ -d "packages/${{ inputs.package }}/docs" ]; then
            cd packages/${{ inputs.package }}/docs
            sphinx-build -b html . _build
          else
            # Generate basic docs from docstrings
            mkdir -p packages/${{ inputs.package }}/docs/_build
            echo "<html><body><h1>${{ inputs.package }}</h1><p>Documentation coming soon.</p></body></html>" \
              > packages/${{ inputs.package }}/docs/_build/index.html
          fi

      - name: Deploy to gh-pages
        env:
          GH_TOKEN: ${{ secrets.token }}
        run: |
          cd packages/${{ inputs.package }}

          # Clone gh-pages branch
          git clone --branch gh-pages --single-branch \
            https://x-access-token:${GH_TOKEN}@github.com/${{ inputs.target-repo }}.git \
            gh-pages 2>/dev/null || {
              # Create gh-pages branch if doesn't exist
              mkdir gh-pages
              cd gh-pages
              git init
              git checkout -b gh-pages
              git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${{ inputs.target-repo }}.git
              cd ..
            }

          # Copy built docs
          rm -rf gh-pages/*
          cp -r docs/_build/* gh-pages/ 2>/dev/null || cp -r docs/_build/index.html gh-pages/

          # Push
          cd gh-pages
          git config user.name "jbcom-bot"
          git config user.email "jbcom-bot@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "ðŸ“š Update docs"
          git push -u origin gh-pages --force
