# Reusable docs workflow - builds and deploys docs to gh-pages
name: Deploy Docs

on:
  workflow_call:
    inputs:
      package:
        required: true
        type: string
      target-repo:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - uses: astral-sh/setup-uv@v4

      - name: Build docs
        id: build
        run: |
          PKG_DIR="packages/${{ inputs.package }}"
          
          # Install dependencies
          uv pip install sphinx sphinx-rtd-theme myst-parser --system
          
          # Install package for API docs
          uv pip install -e packages/extended-data-types --system
          if [ "${{ inputs.package }}" != "extended-data-types" ]; then
            uv pip install -e "$PKG_DIR" --system
          fi
          
          # Ensure docs/_build directory exists
          mkdir -p "$PKG_DIR/docs/_build"
          
          # Build if docs source exists
          if [ -d "$PKG_DIR/docs" ] && [ -f "$PKG_DIR/docs/conf.py" ]; then
            echo "Building Sphinx docs..."
            cd "$PKG_DIR/docs"
            sphinx-build -b html . _build || echo "Sphinx build had warnings"
          else
            echo "No Sphinx docs found, generating placeholder..."
            cat > "$PKG_DIR/docs/_build/index.html" << 'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>${{ inputs.package }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
               max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        p { color: #666; }
        a { color: #0366d6; }
    </style>
</head>
<body>
    <h1>${{ inputs.package }}</h1>
    <p>Documentation coming soon.</p>
    <p>View source: <a href="https://github.com/${{ inputs.target-repo }}">GitHub</a></p>
    <p>Install: <code>pip install ${{ inputs.package }}</code></p>
</body>
</html>
HTMLEOF
          fi

      - name: Deploy to gh-pages
        env:
          GH_TOKEN: ${{ secrets.token }}
        run: |
          PKG_DIR="packages/${{ inputs.package }}"
          REPO="${{ inputs.target-repo }}"
          
          # Clone gh-pages branch or create it
          if git clone --branch gh-pages --single-branch --depth 1 \
               "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" \
               gh-pages 2>/dev/null; then
            echo "Cloned existing gh-pages branch"
          else
            echo "Creating new gh-pages branch"
            mkdir gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
            cd ..
          fi
          
          # Clear and copy new docs
          rm -rf gh-pages/* gh-pages/.* 2>/dev/null || true
          
          if [ -d "$PKG_DIR/docs/_build" ]; then
            cp -r "$PKG_DIR/docs/_build/"* gh-pages/ 2>/dev/null || true
          fi
          
          # Ensure there's at least an index.html
          if [ ! -f "gh-pages/index.html" ]; then
            echo "<html><body><h1>${{ inputs.package }}</h1><p>Docs pending.</p></body></html>" > gh-pages/index.html
          fi
          
          # Add .nojekyll to prevent Jekyll processing
          touch gh-pages/.nojekyll
          
          # Push
          cd gh-pages
          git config user.name "jbcom-bot"
          git config user.email "jbcom-bot@users.noreply.github.com"
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to docs"
          else
            git commit -m "ðŸ“š Update docs for ${{ inputs.package }}"
            git push -u origin gh-pages --force
            echo "âœ… Docs deployed to https://$(echo $REPO | cut -d'/' -f1).github.io/$(echo $REPO | cut -d'/' -f2)/"
          fi
