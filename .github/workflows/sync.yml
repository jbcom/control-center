name: Sync to Public Repos

on:
  push:
    branches: [main]
  schedule:
    # Sync daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      sync_secrets:
        description: "Sync secrets"
        type: boolean
        default: true
      sync_files:
        description: "Sync files"
        type: boolean
        default: true
      sync_rulesets:
        description: "Sync repository rulesets"
        type: boolean
        default: true
      sync_repo_settings:
        description: "Sync repository settings (merge, security)"
        type: boolean
        default: true
      sync_code_scanning:
        description: "Sync code scanning default setup"
        type: boolean
        default: true
      sync_pages:
        description: "Sync GitHub Pages settings"
        type: boolean
        default: true
      dry_run:
        description: "Dry run (don't actually sync)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================
  # SECRETS SYNC
  # ============================================
  sync-secrets:
    name: Sync secrets
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_secrets)

    strategy:
      fail-fast: false
      matrix:
        repo:
          # Python packages
          - jbcom/agentic-crew
          - jbcom/ai_game_dev
          - jbcom/directed-inputs-class
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/python-terraform-bridge
          - jbcom/rivers-of-reckoning
          - jbcom/vendor-connectors
          # Node.js / TypeScript packages
          - jbcom/agentic-control
          - jbcom/otter-river-rush
          - jbcom/otterfall
          - jbcom/pixels-pygame-palace
          - jbcom/rivermarsh
          - jbcom/strata
          # Go packages
          - jbcom/port-api
          - jbcom/vault-secret-sync
          # Terraform modules
          - jbcom/terraform-github-markdown
          - jbcom/terraform-repository-automation

    steps:
      - name: Sync secrets to ${{ matrix.repo }}
        # jpoehnelt/secrets-sync-action v1.10.0
        # Docs: https://github.com/jpoehnelt/secrets-sync-action
        uses: jpoehnelt/secrets-sync-action@7840777f242539d96b60477b66aa1c179e7644ea
        with:
          # Required: PAT with repo scope for target repositories
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          # Required: List of target repositories (not regex - see repositories_list_regex)
          repositories: |
            ${{ matrix.repo }}
          # Set to false to use hardcoded repo list instead of regex matching
          repositories_list_regex: "false"
          # Required: Regex patterns to match secret names from env
          secrets: |
            ^CI_GITHUB_TOKEN$
            ^PYPI_TOKEN$
            ^NPM_TOKEN$
            ^DOCKERHUB_USERNAME$
            ^DOCKERHUB_TOKEN$
            ^ANTHROPIC_API_KEY$
          # Optional: Don't actually sync, just show what would happen
          dry_run: ${{ inputs.dry_run || false }}
        env:
          # Secrets to sync - these are matched against the 'secrets' regex patterns above
          CI_GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================
  # FILE SYNC
  # ============================================
  sync-files:
    name: Sync files
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_files)

    steps:
      # actions/checkout v4.2.2
      # Docs: https://github.com/actions/checkout
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Sync files to public repos
        # BetaHuhn/repo-file-sync-action v1.21.1
        # Docs: https://github.com/BetaHuhn/repo-file-sync-action
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          # Required: PAT with full repo scope
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          # Path to sync configuration file
          CONFIG_PATH: .github/sync.yml
          # Prefix for commit messages
          COMMIT_PREFIX: "üîÑ"
          # Don't actually sync, just show what would happen
          DRY_RUN: ${{ inputs.dry_run || false }}
          # Push directly to main - no PRs for sync
          # Rationale: These are agent-managed repos where direct commits are fine
          SKIP_PR: true

  # ============================================
  # RULESETS SYNC
  # ============================================
  sync-rulesets:
    name: Sync rulesets
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_rulesets)

    strategy:
      fail-fast: false
      matrix:
        include:
          # Python packages
          - repo: jbcom/agentic-crew
            eslint: false
          - repo: jbcom/ai_game_dev
            eslint: false
          - repo: jbcom/directed-inputs-class
            eslint: false
          - repo: jbcom/extended-data-types
            eslint: false
          - repo: jbcom/lifecyclelogging
            eslint: false
          - repo: jbcom/python-terraform-bridge
            eslint: false
          - repo: jbcom/rivers-of-reckoning
            eslint: false
          - repo: jbcom/vendor-connectors
            eslint: false
          # Node.js / TypeScript packages (ESLint enabled)
          - repo: jbcom/agentic-control
            eslint: true
          - repo: jbcom/otter-river-rush
            eslint: true
          - repo: jbcom/otterfall
            eslint: true
          - repo: jbcom/pixels-pygame-palace
            eslint: true
          - repo: jbcom/rivermarsh
            eslint: true
          - repo: jbcom/strata
            eslint: true
          # Go packages
          - repo: jbcom/port-api
            eslint: false
          - repo: jbcom/vault-secret-sync
            eslint: false
          # Terraform modules
          - repo: jbcom/terraform-github-markdown
            eslint: false
          - repo: jbcom/terraform-repository-automation
            eslint: false

    steps:
      - name: Sync ruleset to ${{ matrix.repo }}
        if: inputs.dry_run != true
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ESLINT_ENABLED: ${{ matrix.eslint }}
        run: |
          REPO="${{ matrix.repo }}"

          # Build code_quality tools array based on repo type
          if [ "$ESLINT_ENABLED" = "true" ]; then
            CODE_QUALITY_TOOLS='[{"name": "ESLint"}]'
          else
            CODE_QUALITY_TOOLS='[]'
          fi

          # Standard ruleset matching agentic-crew configuration
          # - Admin bypass (actor_id=5): allows semantic-release to push version bumps
          # - Copilot code review with CodeQL analysis
          # - Code quality enforcement (errors level)
          # - Code scanning with CodeQL
          RULESET_PAYLOAD=$(cat <<EOF
          {
            "name": "default",
            "target": "branch",
            "enforcement": "active",
            "conditions": {
              "ref_name": {
                "include": ["~DEFAULT_BRANCH"],
                "exclude": []
              }
            },
            "bypass_actors": [
              {
          if echo "$RULESET_PAYLOAD" | gh api "repos/${REPO}/rulesets/${EXISTING_RULESET}" -X PUT --input -; then
            echo "‚úÖ Updated ruleset for ${REPO}"
          else
            echo "‚ùå Failed to update ruleset for ${REPO}"
            echo "Error details: $(gh api "repos/${REPO}/rulesets/${EXISTING_RULESET}" -X PUT --input - <<< "$RULESET_PAYLOAD" 2>&1 || true)"
            exit 1
          fi
              {"type": "deletion"},
              {"type": "non_fast_forward"},
          if echo "$RULESET_PAYLOAD" | gh api "repos/${REPO}/rulesets" -X POST --input -; then
            echo "‚úÖ Created ruleset for ${REPO}"
          else
            echo "‚ùå Failed to create ruleset for ${REPO}"
            echo "Error details: $(gh api "repos/${REPO}/rulesets" -X POST --input - <<< "$RULESET_PAYLOAD" 2>&1 || true)"
            exit 1
          fi
                }
              },
              {
                "type": "copilot_code_review_analysis_tools",
                "parameters": {
                  "tools": [{"name": "CodeQL"}]
                }
              },
              {
                "type": "code_quality",
                "parameters": {
                  "severity": "errors",
                  "tools": ${CODE_QUALITY_TOOLS}
                }
              },
              {
                "type": "code_scanning",
                "parameters": {
                  "code_scanning_tools": [
                    {
                      "tool": "CodeQL",
                      "alerts_threshold": "errors",
                      "security_alerts_threshold": "high_or_higher"
                    }
                  ]
                }
              }
            ]
          }
          EOF
          )

          # Check if "default" ruleset already exists
          EXISTING_RULESET=$(gh api "repos/${REPO}/rulesets" --jq '.[] | select(.name == "default") | .id' 2>/dev/null || echo "")

          if [ -n "$EXISTING_RULESET" ] && [ "$EXISTING_RULESET" != "null" ]; then
            if echo "$RULESET_PAYLOAD" | gh api "repos/${REPO}/rulesets/${EXISTING_RULESET}" -X PUT --input -; then
              echo "‚úÖ Updated ruleset for ${REPO}"
            else
              echo "‚ùå Failed to update ruleset for ${REPO}"
              exit 1
            fi
          else
            if echo "$RULESET_PAYLOAD" | gh api "repos/${REPO}/rulesets" -X POST --input -; then
              echo "‚úÖ Created ruleset for ${REPO}"
            else
              echo "‚ùå Failed to create ruleset for ${REPO}"
              exit 1
            fi
          fi

      - name: Dry run - would sync ruleset to ${{ matrix.repo }}
        if: inputs.dry_run == true
        run: |
          echo "üîç DRY RUN: Would sync ruleset to ${{ matrix.repo }}"
          echo "Settings:"
          echo "  - Admin bypass: actor_id=5 (RepositoryRole)"
          echo "  - Copilot code review + CodeQL analysis"
          echo "  - Code quality: errors severity"
          echo "  - Code scanning: CodeQL (errors/high_or_higher)"
          echo "  - ESLint: ${{ matrix.eslint }}"

  # ============================================
  # REPOSITORY SETTINGS SYNC
  # ============================================
  sync-repo-settings:
          # Get current repository settings for validation
          CURRENT_SETTINGS=$(gh api "repos/${REPO}" --jq '{has_issues, has_projects, has_wiki, has_discussions, allow_squash_merge, allow_merge_commit, allow_rebase_merge, delete_branch_on_merge}')
          echo "Current settings for ${REPO}: $CURRENT_SETTINGS"
          
          # Repository settings matching agentic-crew configuration
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_repo_settings)

    strategy:
      fail-fast: false
      matrix:
        repo:
          # Python packages
          - jbcom/agentic-crew
          - jbcom/ai_game_dev
          - jbcom/directed-inputs-class
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/python-terraform-bridge
          - jbcom/rivers-of-reckoning
          - jbcom/vendor-connectors
          # Node.js / TypeScript packages
          - jbcom/agentic-control
          - jbcom/otter-river-rush
          - jbcom/otterfall
          - jbcom/pixels-pygame-palace
          - jbcom/rivermarsh
          - jbcom/strata
          # Go packages
          - jbcom/port-api
          - jbcom/vault-secret-sync
          # Terraform modules
          - jbcom/terraform-github-markdown
          - jbcom/terraform-repository-automation

    steps:
      - name: Sync settings for ${{ matrix.repo }}
        if: inputs.dry_run != true
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          REPO="${{ matrix.repo }}"

          # Repository settings matching agentic-crew configuration
          # - Only squash merge allowed
          # - Delete branch on merge
          # - Disable wiki, projects, discussions
          REPO_SETTINGS='{
            "has_issues": true,
            "has_projects": false,
            "has_wiki": false,
            "has_discussions": false,
            "allow_squash_merge": true,
            "allow_merge_commit": false,
            "allow_rebase_merge": false,
            "delete_branch_on_merge": true,
            "allow_auto_merge": false,
            "security_and_analysis": {
              "secret_scanning": {"status": "enabled"},
              "secret_scanning_push_protection": {"status": "enabled"},
              "dependabot_security_updates": {"status": "enabled"}
            }
          }'

          if echo "$REPO_SETTINGS" | gh api "repos/${REPO}" -X PATCH --input -; then
            echo "‚úÖ Updated settings for ${REPO}"
          else
            echo "‚ùå Failed to update settings for ${REPO}"
            exit 1
          fi

      - name: Dry run - would sync settings for ${{ matrix.repo }}
        if: inputs.dry_run == true
        run: |
          echo "üîç DRY RUN: Would sync settings for ${{ matrix.repo }}"
          echo "Settings:"
          echo "  - Squash merge only"
          echo "  - Delete branch on merge"
          echo "  - Secret scanning + push protection"
          echo "  - Dependabot security updates"

  # ============================================
  # CODE SCANNING DEFAULT SETUP
  # ============================================
  sync-code-scanning:
    name: Sync code scanning
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_code_scanning)

    strategy:
      fail-fast: false
      matrix:
        repo:
          # Python packages
          - jbcom/agentic-crew
          - jbcom/ai_game_dev
          - jbcom/directed-inputs-class
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/python-terraform-bridge
          - jbcom/rivers-of-reckoning
          - jbcom/vendor-connectors
          # Node.js / TypeScript packages
          - jbcom/agentic-control
          - jbcom/otter-river-rush
          - jbcom/otterfall
          - jbcom/pixels-pygame-palace
          - jbcom/rivermarsh
          - jbcom/strata
          # Go packages
          - jbcom/port-api
          - jbcom/vault-secret-sync
          # Terraform modules
          - jbcom/terraform-github-markdown
          - jbcom/terraform-repository-automation

    steps:
      - name: Enable code scanning for ${{ matrix.repo }}
        if: inputs.dry_run != true
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          REPO="${{ matrix.repo }}"

          # Enable CodeQL default setup with weekly schedule
          CODE_SCANNING_SETUP='{
            "state": "configured",
            "query_suite": "default",
            "schedule": "weekly"
          }'

          if echo "$CODE_SCANNING_SETUP" | gh api "repos/${REPO}/code-scanning/default-setup" -X PATCH --input -; then
            echo "‚úÖ Enabled code scanning for ${REPO}"
          else
            echo "‚ö†Ô∏è Could not configure code scanning for ${REPO} (may require Advanced Security)"
          fi

      - name: Dry run - would enable code scanning for ${{ matrix.repo }}
        if: inputs.dry_run == true
        run: |
          echo "üîç DRY RUN: Would enable code scanning for ${{ matrix.repo }}"
          echo "Settings:"
          echo "  - CodeQL default setup"
          echo "  - Query suite: default"
          echo "  - Schedule: weekly"

  # ============================================
  # GITHUB PAGES SYNC
  # ============================================
  sync-pages:
    name: Sync GitHub Pages
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_pages)

    strategy:
      fail-fast: false
      matrix:
        repo:
          # Python packages
          - jbcom/agentic-crew
          - jbcom/ai_game_dev
          - jbcom/directed-inputs-class
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/python-terraform-bridge
          - jbcom/rivers-of-reckoning
          - jbcom/vendor-connectors
          # Node.js / TypeScript packages
          - jbcom/agentic-control
          - jbcom/otter-river-rush
          - jbcom/otterfall
          - jbcom/pixels-pygame-palace
          - jbcom/rivermarsh
          - jbcom/strata
          # Go packages
          - jbcom/port-api
          - jbcom/vault-secret-sync
          # Terraform modules
          - jbcom/terraform-github-markdown
          - jbcom/terraform-repository-automation

    steps:
      - name: Enable GitHub Pages for ${{ matrix.repo }}
        if: inputs.dry_run != true
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Enable GitHub Pages with GitHub Actions as build source
          # Try PUT first (update), fall back to POST (create)
          JSON_PAYLOAD='{"build_type": "workflow"}'
          echo "$JSON_PAYLOAD" | gh api repos/${{ matrix.repo }}/pages -X PUT --input - 2>/dev/null || \
          echo "$JSON_PAYLOAD" | gh api repos/${{ matrix.repo }}/pages -X POST --input -
          echo "‚úÖ Enabled GitHub Pages for ${{ matrix.repo }}"

      - name: Dry run - would enable Pages for ${{ matrix.repo }}
        if: inputs.dry_run == true
        run: |
          echo "üîç DRY RUN: Would enable GitHub Pages for ${{ matrix.repo }}"
          echo "Settings: build_type=workflow (GitHub Actions)"
