---
name: Sync to Public Repos

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to sync (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - extended-data-types
          - lifecyclelogging
          - directed-inputs-class
          - python-terraform-bridge
          - vendor-connectors
      create_pr:
        description: 'Create PR instead of direct push'
        required: false
        default: false
        type: boolean

permissions: {}

concurrency:
  group: sync-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================
  # SYNC PACKAGES TO PUBLIC REPOS
  # ============================================
  sync:
    name: Sync ${{ matrix.package }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          - package: extended-data-types
            repo: jbcom/extended-data-types
          - package: lifecyclelogging
            repo: jbcom/lifecyclelogging
          - package: directed-inputs-class
            repo: jbcom/directed-inputs-class
          - package: python-terraform-bridge
            repo: jbcom/python-terraform-bridge
          - package: vendor-connectors
            repo: jbcom/vendor-connectors

    steps:
      - name: Check if should sync
        id: should-sync
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.package }}" == "all" ] || [ "${{ inputs.package }}" == "${{ matrix.package }}" ]; then
              echo "sync=true" >> $GITHUB_OUTPUT
            else
              echo "sync=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "sync=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.should-sync.outputs.sync == 'true'
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Get package version
        if: steps.should-sync.outputs.sync == 'true'
        id: version
        run: |
          VERSION=$(grep '^version = ' packages/${{ matrix.package }}/pyproject.toml | head -1 | sed 's/version = "\([^"]*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ${{ matrix.package }} version: $VERSION"

      - name: Sync to public repository
        if: steps.should-sync.outputs.sync == 'true'
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          set -e

          REPO="${{ matrix.repo }}"
          PKG="${{ matrix.package }}"
          VERSION="${{ steps.version.outputs.version }}"
          CREATE_PR="${{ inputs.create_pr }}"

          echo "ðŸ”„ Syncing $PKG to $REPO..."

          # Clone target repo
          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" target
          cd target

          # Configure git
          git config user.name "jbcom-bot"
          git config user.email "jbcom-bot@users.noreply.github.com"

          # Determine branch
          if [ "$CREATE_PR" == "true" ]; then
            BRANCH="sync/from-control-center-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
          else
            BRANCH="main"
          fi

          # Clear everything except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy package contents
          cp -r "../packages/${PKG}/." .

          # Remove any workspace-specific files
          rm -f .python-version 2>/dev/null || true

          # Stage changes
          git add -A

          # Check for changes
          if git diff --staged --quiet; then
            echo "â­ï¸  No changes to sync for $PKG"
            exit 0
          fi

          # Show what changed
          echo "ðŸ“ Changes to sync:"
          git diff --staged --stat

          # Commit
          git commit -m "ðŸ”„ Sync from jbcom-control-center

          Package: $PKG
          Version: $VERSION
          Source: https://github.com/jbcom/jbcom-control-center/tree/main/packages/$PKG"

          # Push
          if [ "$CREATE_PR" == "true" ]; then
            git push -u origin "$BRANCH"

            # Create PR using gh CLI
            GH_TOKEN="${GH_TOKEN}" gh pr create \
              --repo "$REPO" \
              --title "ðŸ”„ Sync from jbcom-control-center" \
              --body "Automated sync from [jbcom-control-center](https://github.com/jbcom/jbcom-control-center).

          **Package:** $PKG
          **Version:** $VERSION

          ---
          *This PR was automatically created by the sync workflow.*" \
              --head "$BRANCH" \
              --base main
          else
            git push origin main
          fi

          echo "âœ… Synced $PKG to $REPO"

      - name: Summary
        if: steps.should-sync.outputs.sync == 'true'
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Repository | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ matrix.package }} | ${{ matrix.repo }} | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # AUTO-MERGE SYNC PRS (if created)
  # ============================================
  automerge:
    name: Auto-merge sync PRs
    runs-on: ubuntu-latest
    needs: sync
    if: inputs.create_pr == true

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors

    steps:
      - name: Enable auto-merge on sync PRs
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Find open sync PRs
          PRS=$(gh pr list --repo "${{ matrix.repo }}" --head "sync/" --state open --json number --jq '.[].number')

          for PR in $PRS; do
            echo "Enabling auto-merge for PR #$PR in ${{ matrix.repo }}"
            gh pr merge "$PR" --repo "${{ matrix.repo }}" --auto --squash || true
          done
