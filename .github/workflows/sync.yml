# Ecosystem Sync - Ultra-Simplified with repo-file-sync-action
#
# Replaces 590-line cascade workflow with simple action + 87-line config
#
# Strategy:
# 1. Global profile covers MOST repos (35 files)
# 2. Language profiles for docs tooling (1-13 files each) - add as needed
# 3. See what's left - handle exceptions manually

name: Sync

on:
  push:
    branches: [main]
    paths:
      - 'sync-files/**'
      - '.github/sync.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # CRITICAL: Deletions MUST happen FIRST before sync events
  cleanup-kill-list:
    name: Cleanup Deprecated Workflows
    runs-on: ubuntu-latest
    if: github.repository == 'jbcom/control-center'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run kill list cleanup
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          BRANCH_PREFIX: repo-sync/cleanup-kill-list
          BASE_BRANCH: main
        run: |
          ./scripts/cleanup-sync-repos

  # Sync using repo-file-sync-action
  sync:
    name: Sync Files
    runs-on: ubuntu-latest
    needs: cleanup-kill-list
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      - name: Sync files to repos
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619 # v1.23.1
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync.yml
          PR_LABELS: |
            sync
            automated
            automerge
          COMMIT_PREFIX: "chore(sync):"
          COMMIT_BODY: |
            Synced from jbcom/control-center
            
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            [skip ci]
          ASSIGNEES: jbdevprimary
          OVERWRITE_EXISTING_PR: true
          SKIP_CI: "[skip ci]"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [sync, cleanup-kill-list]
    if: always()
    steps:
      - run: |
          echo "## Ecosystem Sync" >> $GITHUB_STEP_SUMMARY
          echo "Using repo-file-sync-action with simple config" >> $GITHUB_STEP_SUMMARY
          echo "- Global profile: 35 files to ALL repos" >> $GITHUB_STEP_SUMMARY
          echo "- Language profiles: 1-13 files each (as needed)" >> $GITHUB_STEP_SUMMARY
          echo "- PRs created automatically in target repos" >> $GITHUB_STEP_SUMMARY
          echo "- Deletions processed FIRST, then sync" >> $GITHUB_STEP_SUMMARY
