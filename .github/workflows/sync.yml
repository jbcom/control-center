name: Sync to Public Repos

on:
  push:
    branches: [main]
  schedule:
    # Sync daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      sync_secrets:
        description: "Sync secrets"
        type: boolean
        default: true
      sync_files:
        description: "Sync files"
        type: boolean
        default: true
      sync_branch_protection:
        description: "Sync branch protection rules"
        type: boolean
        default: true
      sync_pages:
        description: "Sync GitHub Pages settings"
        type: boolean
        default: true
      dry_run:
        description: "Dry run (don't actually sync)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================
  # SECRETS SYNC
  # ============================================
  sync-secrets:
    name: Sync secrets
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_secrets)

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors
          - jbcom/agentic-control
          - jbcom/vault-secret-sync
          - jbcom/cursor-rules

    steps:
      - name: Sync secrets to ${{ matrix.repo }}
        # jpoehnelt/secrets-sync-action v1.10.0
        # Docs: https://github.com/jpoehnelt/secrets-sync-action
        uses: jpoehnelt/secrets-sync-action@7840777f242539d96b60477b66aa1c179e7644ea
        with:
          # Required: PAT with repo scope for target repositories
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          # Required: List of target repositories (not regex - see repositories_list_regex)
          repositories: |
            ${{ matrix.repo }}
          # Set to false to use hardcoded repo list instead of regex matching
          repositories_list_regex: "false"
          # Required: Regex patterns to match secret names from env
          secrets: |
            ^CI_GITHUB_TOKEN$
            ^PYPI_TOKEN$
            ^NPM_TOKEN$
            ^DOCKERHUB_USERNAME$
            ^DOCKERHUB_TOKEN$
            ^ANTHROPIC_API_KEY$
          # Optional: Don't actually sync, just show what would happen
          dry_run: ${{ inputs.dry_run || false }}
        env:
          # Secrets to sync - these are matched against the 'secrets' regex patterns above
          CI_GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================
  # FILE SYNC
  # ============================================
  sync-files:
    name: Sync files
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_files)

    steps:
      # actions/checkout v4.2.2
      # Docs: https://github.com/actions/checkout
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Sync files to public repos
        # BetaHuhn/repo-file-sync-action v1.21.1
        # Docs: https://github.com/BetaHuhn/repo-file-sync-action
        uses: BetaHuhn/repo-file-sync-action@8b92be3375cf1d1b0cd579af488a9255572e4619
        with:
          # Required: PAT with full repo scope
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          # Path to sync configuration file
          CONFIG_PATH: .github/sync.yml
          # Prefix for commit messages
          COMMIT_PREFIX: "üîÑ"
          # Don't actually sync, just show what would happen
          DRY_RUN: ${{ inputs.dry_run || false }}
          # Push directly to main - no PRs for sync
          # Rationale: These are agent-managed repos where direct commits are fine
          SKIP_PR: true

  # ============================================
  # BRANCH PROTECTION SYNC
  # ============================================
  sync-branch-protection:
    name: Sync branch protection
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_branch_protection)

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors
          - jbcom/agentic-control
          - jbcom/vault-secret-sync
          - jbcom/cursor-rules

    steps:
      - name: Apply branch protection to ${{ matrix.repo }}
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Agent-managed repos: no required reviews, allow force pushes for releases
          gh api repos/${{ matrix.repo }}/branches/main/protection -X PUT --input - <<'EOF'
          {
            "required_status_checks": null,
            "enforce_admins": false,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "required_linear_history": true,
            "allow_force_pushes": true,
            "allow_deletions": false
          }
          EOF
          echo "‚úÖ Applied branch protection to ${{ matrix.repo }}"

      - name: Dry run - would apply to ${{ matrix.repo }}
        if: ${{ inputs.dry_run }}
        run: |
          echo "üîç DRY RUN: Would apply branch protection to ${{ matrix.repo }}"
          echo "Settings: no required reviews, allow force pushes, linear history"

  # ============================================
  # GITHUB PAGES SYNC
  # ============================================
  sync-pages:
    name: Sync GitHub Pages
    runs-on: ubuntu-latest
    # Run on push, schedule, or manual trigger (unless explicitly disabled)
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.sync_pages)

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors
          - jbcom/agentic-control
          - jbcom/cursor-rules

    steps:
      - name: Enable GitHub Pages for ${{ matrix.repo }}
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Enable GitHub Pages with GitHub Actions as build source
          # Try PUT first (update existing), fall back to POST (create new)
          PAYLOAD='{"build_type": "workflow"}'
          
          if gh api repos/${{ matrix.repo }}/pages -X PUT --input - <<< "$PAYLOAD" 2>/dev/null; then
            echo "‚úÖ Updated GitHub Pages for ${{ matrix.repo }}"
          elif gh api repos/${{ matrix.repo }}/pages -X POST --input - <<< "$PAYLOAD" 2>/dev/null; then
            echo "‚úÖ Created GitHub Pages for ${{ matrix.repo }}"
          else
            echo "‚ö†Ô∏è Could not enable GitHub Pages for ${{ matrix.repo }} (may require manual setup)"
            exit 0  # Don't fail the job - Pages might need manual first-time setup
          fi

      - name: Dry run - would enable Pages for ${{ matrix.repo }}
        if: ${{ inputs.dry_run }}
        run: |
          echo "üîç DRY RUN: Would enable GitHub Pages for ${{ matrix.repo }}"
          echo "Settings: build_type=workflow (GitHub Actions)"
