name: Sync to Public Repos

on:
  push:
    branches: [main]
    paths:
      - "cursor-rules/**"
      - ".github/sync.yml"
  schedule:
    # Sync daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      sync_secrets:
        description: "Sync secrets"
        type: boolean
        default: true
      sync_files:
        description: "Sync files"
        type: boolean
        default: true
      sync_branch_protection:
        description: "Sync branch protection rules"
        type: boolean
        default: true
      sync_pages:
        description: "Sync GitHub Pages settings"
        type: boolean
        default: true
      dry_run:
        description: "Dry run (don't actually sync)"
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================
  # SECRETS SYNC
  # ============================================
  sync-secrets:
    name: Sync secrets
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.sync_secrets)

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors
          - jbcom/agentic-control
          - jbcom/vault-secret-sync
          - jbcom/cursor-rules

    steps:
      - name: Sync secrets to ${{ matrix.repo }}
        uses: google/secrets-sync-action@v1
        with:
          secrets: |
            ^CI_GITHUB_TOKEN$
            ^PYPI_TOKEN$
            ^NPM_TOKEN$
            ^DOCKERHUB_USERNAME$
            ^DOCKERHUB_TOKEN$
            ^ANTHROPIC_API_KEY$
          repositories: |
            ${{ matrix.repo }}
          dry_run: ${{ inputs.dry_run || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          CI_GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  # ============================================
  # FILE SYNC
  # ============================================
  sync-files:
    name: Sync files
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.sync_files)

    steps:
      - uses: actions/checkout@v4

      - name: Sync files to public repos
        uses: BetaHuhn/repo-file-sync-action@v1
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync.yml
          PR_LABELS: sync,automated
          COMMIT_PREFIX: "ðŸ”„"
          DRY_RUN: ${{ inputs.dry_run || false }}
          PR_BODY: |
            Syncs centralized configs from jbcom-control-center.

            **Changes**: Cursor rules, Dockerfile, environment configs

            ---
            _Automated by [repo-file-sync-action](https://github.com/BetaHuhn/repo-file-sync-action)_

  # ============================================
  # BRANCH PROTECTION SYNC
  # ============================================
  sync-branch-protection:
    name: Sync branch protection
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.sync_branch_protection)

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors
          - jbcom/agentic-control
          - jbcom/vault-secret-sync
          - jbcom/cursor-rules

    steps:
      - name: Apply branch protection to ${{ matrix.repo }}
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Agent-managed repos: no required reviews, allow force pushes for releases
          gh api repos/${{ matrix.repo }}/branches/main/protection -X PUT --input - <<'EOF'
          {
            "required_status_checks": null,
            "enforce_admins": false,
            "required_pull_request_reviews": null,
            "restrictions": null,
            "required_linear_history": true,
            "allow_force_pushes": true,
            "allow_deletions": false
          }
          EOF
          echo "âœ… Applied branch protection to ${{ matrix.repo }}"

      - name: Dry run - would apply to ${{ matrix.repo }}
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” DRY RUN: Would apply branch protection to ${{ matrix.repo }}"
          echo "Settings: no required reviews, allow force pushes, linear history"

  # ============================================
  # GITHUB PAGES SYNC
  # ============================================
  sync-pages:
    name: Sync GitHub Pages
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.sync_pages)

    strategy:
      fail-fast: false
      matrix:
        repo:
          - jbcom/extended-data-types
          - jbcom/lifecyclelogging
          - jbcom/directed-inputs-class
          - jbcom/python-terraform-bridge
          - jbcom/vendor-connectors
          - jbcom/agentic-control
          - jbcom/cursor-rules

    steps:
      - name: Enable GitHub Pages for ${{ matrix.repo }}
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Enable GitHub Pages with GitHub Actions as build source
          gh api repos/${{ matrix.repo }}/pages -X PUT --input - <<'EOF' || \
          gh api repos/${{ matrix.repo }}/pages -X POST --input - <<'EOF'
          {
            "build_type": "workflow"
          }
          EOF
          echo "âœ… Enabled GitHub Pages for ${{ matrix.repo }}"

      - name: Dry run - would enable Pages for ${{ matrix.repo }}
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” DRY RUN: Would enable GitHub Pages for ${{ matrix.repo }}"
          echo "Settings: build_type=workflow (GitHub Actions)"
