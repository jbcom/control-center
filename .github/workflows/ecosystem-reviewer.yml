name: Ecosystem Reviewer

# Tiered AI Review Pipeline:
# 1. Ollama (fast, cheap) â†’ quick review
# 2. Claude (escalation) â†’ complex PRs or many issues  
# 3. Jules (refactor) â†’ when code changes needed

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  # Also handle @claude mentions in PR comments
  issue_comment:
    types: [created]

env:
  OLLAMA_HOST: ${{ secrets.OLLAMA_API_URL || vars.OLLAMA_HOST || 'https://ollama.com' }}
  OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || 'glm-4.6:cloud' }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ============================================
  # TIER 1: Ollama Quick Review
  # ============================================
  ollama-review:
    name: Ollama Review
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      suggestion_count: ${{ steps.review.outputs.suggestion_count }}
      needs_escalation: ${{ steps.check.outputs.needs_escalation }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Review PR
        id: review
        uses: ./.github/actions/agentic-pr-review
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          model: ${{ env.OLLAMA_MODEL }}
          ollama_api_key: ${{ secrets.OLLAMA_API_KEY }}
          ollama_host: ${{ env.OLLAMA_HOST }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}

      - name: Check if escalation needed
        id: check
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          SUGGESTIONS="${{ steps.review.outputs.suggestion_count }}"
          ADDITIONS=$(gh pr view ${{ github.event.pull_request.number }} --json additions --jq '.additions')
          
          # Escalate if: >5 suggestions OR >500 lines changed OR Ollama failed
          if [[ "$SUGGESTIONS" -gt 5 ]] || [[ "$ADDITIONS" -gt 500 ]] || [[ -z "$SUGGESTIONS" ]]; then
            echo "needs_escalation=true" >> $GITHUB_OUTPUT
          else
            echo "needs_escalation=false" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # TIER 2: Claude Escalation (complex PRs)
  # ============================================
  claude-review:
    name: Claude Review
    needs: ollama-review
    if: |
      needs.ollama-review.outputs.needs_escalation == 'true' && 
      secrets.ANTHROPIC_API_KEY != ''
    runs-on: ubuntu-latest
    outputs:
      critical_issues: ${{ steps.claude.outputs.critical_issues }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          track_progress: true
          prompt: |
            Review this PR thoroughly. Focus on:
            - Security issues (tokens, secrets, injection)
            - Logic errors and bugs
            - Performance problems
            - Missing error handling
            
            If no critical issues, APPROVE the PR.
            Post inline comments for specific issues.
          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(git diff:*),Bash(gh:*)"

  # ============================================
  # TIER 3: Jules Refactor (when code changes needed)
  # ============================================
  jules-refactor:
    name: Jules Refactor
    needs: [ollama-review, claude-review]
    if: |
      always() &&
      needs.ollama-review.outputs.suggestion_count > 10
    runs-on: ubuntu-latest
    steps:
      - name: Check for API Key
        id: check
        run: |
          if [[ -z "${{ secrets.GOOGLE_JULES_API_KEY }}" ]]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Jules Session
        if: steps.check.outputs.available == 'true'
        id: jules
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          RESPONSE=$(curl -sf -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "Refactor PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" \
              --arg repo "${{ github.repository }}" \
              --arg branch "${{ github.event.pull_request.head.ref }}" \
              '{
                prompt: $task,
                sourceContext: {
                  source: ("sources/github/" + ($repo | split("/")[0]) + "/" + ($repo | split("/")[1])),
                  githubRepoContext: { startingBranch: $branch }
                },
                automationMode: "AUTO_CREATE_PR"
              }')" 2>/dev/null) || true
          
          if [ -n "$RESPONSE" ]; then
            SESSION_ID=$(echo "$RESPONSE" | jq -r '.name // empty' | sed 's|sessions/||')
            echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          fi

      - name: Post Jules Link
        if: steps.jules.outputs.session_id != ''
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body \
            "ðŸ”§ **Jules refactoring session started**: https://jules.google.com/session/${{ steps.jules.outputs.session_id }}"

  # ============================================
  # INTERACTIVE: @claude mentions
  # ============================================
  claude-interactive:
    name: Claude Interactive
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh:*),Bash(node:*),Bash(npm:*)"
