name: Ecosystem Reviewer

# Per-PR AI-powered code review using Ollama

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: AI Code Review
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.review.outputs.summary }}
      score: ${{ steps.review.outputs.score }}
      issues_count: ${{ steps.review.outputs.issues_count }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DIFF=$(gh pr diff "$PR_NUMBER" --color=never | head -c 30000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Review
        id: review
        env:
          OLLAMA_HOST: ${{ vars.OLLAMA_HOST || 'https://ollama.com' }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || 'glm-4.6:cloud' }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
        run: |
          if [[ -z "$OLLAMA_API_KEY" ]]; then
            echo "‚ö†Ô∏è OLLAMA_API_KEY not set, skipping review"
            echo "review=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PROMPT="Review this code diff for a pull request. Focus on:
          1. Potential bugs or issues
          2. Security concerns
          3. Code quality and best practices
          4. Suggestions for improvement
          
          Be concise. If the code looks good, say so briefly.
          
          Diff:
          $PR_DIFF"
          
          RESPONSE=$(curl -s -X POST "${OLLAMA_HOST}/api/chat" \
            -H "Authorization: Bearer $OLLAMA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg model "$OLLAMA_MODEL" --arg prompt "$PROMPT" '{
              model: $model,
              messages: [{role: "user", content: $prompt}],
              stream: false
            }')" | jq -r '.message.content // "Review unavailable"')
          
          ISSUES_COUNT=$(echo "$RESPONSE" | grep -c '^-')
          SCORE=$((10 - ISSUES_COUNT))
          if ((SCORE < 0)); then SCORE=0; fi

          SUMMARY=$(echo "$RESPONSE" | head -n 5)

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "issues_count=$ISSUES_COUNT" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        if: steps.review.outputs.review != 'skipped'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEW_RESPONSE: ${{ steps.review.outputs.response }}
          OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL || 'glm-4.6:cloud' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT="## ü§ñ AI Code Review
    
          $REVIEW_RESPONSE
          
          ---
          *Reviewed by Ollama ($OLLAMA_MODEL)*"
          
          gh pr comment "$PR_NUMBER" --body "$COMMENT"

  delegate-to-jules:
    name: Delegate Complex Tasks to Jules
    needs: review
    if: needs.review.outputs.issues_count > 5
    runs-on: ubuntu-latest
    steps:
      - name: Create Jules session
        id: jules
        env:
          JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          SUMMARY: ${{ needs.review.outputs.summary }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          set -eo pipefail
          JSON_PAYLOAD=$(jq -n \
            --arg prompt "Fix issues identified in PR #$PR_NUMBER: $SUMMARY" \
            --arg source "sources/github/$REPOSITORY" \
            --arg branch "$HEAD_REF" \
            --arg title "Jules: Fix PR #$PR_NUMBER issues" \
            '{
              "prompt": $prompt,
              "sourceContext": {
                "source": $source,
                "githubRepoContext": {
                  "startingBranch": $branch
                }
              },
              "automationMode": "AUTO_CREATE_PR",
              "title": $title
            }')

          RESPONSE=$(curl -s -X POST 'https://jules.googleapis.com/v1alpha/sessions' \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$JSON_PAYLOAD")

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          SESSION_URL="https://jules.google.com/session/$SESSION_ID"

          echo "session_url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT

      - name: Post Session Link
        if: steps.jules.outputs.session_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SESSION_URL: ${{ steps.jules.outputs.session_url }}
        run: |
          gh pr comment "$PR_NUMBER" --body "## ü§ñ Task Delegated to Jules
    
          This PR has been automatically delegated to Google Jules for further fixes.
    
          ‚û°Ô∏è **[Monitor Session]($SESSION_URL)**"
