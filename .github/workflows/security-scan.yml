# Security Scanning Across Ecosystem
# Aggregates security findings from all repos

name: Security Scan

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  security-events: read
  issues: write

jobs:
  aggregate-security:
    name: Aggregate Security Findings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install PyGithub requests
      
      - name: Scan ecosystem for vulnerabilities
        env:
          GITHUB_TOKEN: ${{ secrets.JBCOM_DEPLOY_TOKEN }}
        run: |
          python3 tools/monitor/security_scan.py \
            --output ecosystem/SECURITY_FINDINGS.json
      
      - name: Check for critical vulnerabilities
        id: check-vulns
        run: |
          critical_count=$(python3 -c "
          import json
          findings = json.load(open('ecosystem/SECURITY_FINDINGS.json'))
          print(sum(1 for f in findings.get('findings', []) if f.get('severity') == 'critical'))
          ")
          echo "critical_count=$critical_count" >> $GITHUB_OUTPUT
          
          if [ "$critical_count" -gt 0 ]; then
            echo "ðŸ”´ Found $critical_count critical vulnerabilities"
          fi
      
      - name: Commit security findings
        run: |
          git config user.name "jbcom-bot"
          git config user.email "bot@jbcom.dev"
          git add ecosystem/SECURITY_FINDINGS.json
          git diff --staged --quiet || git commit -m "ðŸ”’ Update security findings [skip ci]"
          git push
      
      - name: Create security advisory for critical vulns
        if: steps.check-vulns.outputs.critical_count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ”´ Critical Security Vulnerabilities (${{ steps.check-vulns.outputs.critical_count }} found)" \
            --body "$(python3 tools/monitor/generate_security_report.py)" \
            --label "security,critical,automated"
