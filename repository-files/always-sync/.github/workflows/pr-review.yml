# AI PR Review Workflow - Ollama Cloud (GLM-4.6)
# Uses direct Ollama Cloud API with structured JSON output
#
# Synced from jbcom-control-center (always-sync)
# DO NOT EDIT - changes will be overwritten

name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  auto-review-and-fix:
    name: AI Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' &&
       !github.event.pull_request.draft &&
       github.actor != 'dependabot[bot]') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/review'))

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current diff against base branch
        id: diff
        run: |
          BASE_REF="${{ github.base_ref || github.event.pull_request.base.ref }}"
          git diff origin/${BASE_REF}...HEAD --unified=5 --color=never | head -c 50000 > /tmp/diff.txt

      - name: Generate structured review
        id: review
        run: |
          DIFF_CONTENT=$(cat /tmp/diff.txt | jq -Rs .)
          
          SCHEMA='{"type":"object","properties":{"summary":{"type":"string"},"issues":{"type":"array","items":{"type":"object","properties":{"file":{"type":"string"},"severity":{"type":"string","enum":["low","medium","high"]},"description":{"type":"string"},"suggestion":{"type":"string"}},"required":["file","severity","description"]}},"overall_score":{"type":"integer","minimum":1,"maximum":10},"should_auto_apply":{"type":"boolean"}},"required":["summary","issues","overall_score","should_auto_apply"]}'
          
          PROMPT="You are an expert code reviewer. Analyze this diff and provide a structured review.

          Diff:
          $(cat /tmp/diff.txt | head -c 30000)

          Respond with JSON matching this schema: $SCHEMA"

          RESPONSE=$(curl -s https://ollama.com/api/generate \
            -H "Authorization: Bearer ${{ secrets.OLLAMA_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg model "glm-4.6:cloud" \
              --arg prompt "$PROMPT" \
              '{model: $model, prompt: $prompt, stream: false, options: {temperature: 0.1, num_ctx: 32768}}')")

          echo "Response preview: ${RESPONSE:0:500}"
          
          REVIEW=$(echo "$RESPONSE" | jq -r '.response // .error // "No response"')
          
          # Try to extract JSON from the response
          REVIEW_JSON=$(echo "$REVIEW" | grep -o '{.*}' | head -1 || echo "$REVIEW")

          {
            echo "json<<EOF"
            echo "$REVIEW_JSON"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "raw<<EOF"
            echo "$REVIEW"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const rawReview = `${{ steps.review.outputs.raw }}`;
            const jsonReview = `${{ steps.review.outputs.json }}`;
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            let summary = "See details below";
            let score = "N/A";
            let issues = [];
            let formattedJson = rawReview;
            
            try {
              const review = JSON.parse(jsonReview);
              summary = review.summary || "No summary";
              score = review.overall_score || "N/A";
              issues = review.issues || [];
              formattedJson = JSON.stringify(review, null, 2);
            } catch (e) {
              console.log("Failed to parse as JSON, using raw response");
            }
            
            let issuesList = "";
            if (issues.length > 0) {
              issuesList = "\n\n### Issues Found\n" + issues.map(i => 
                `- **${i.severity?.toUpperCase() || 'INFO'}** (${i.file || 'general'}): ${i.description}`
              ).join("\n");
            }
            
            const body = `## ðŸ¤– GLM-4.6 AI Code Review

            **Summary**: ${summary}
            **Overall Score**: ${score} / 10
            ${issuesList}

            <details>
            <summary>Full Review</summary>

            \`\`\`
            ${formattedJson.substring(0, 5000)}
            \`\`\`

            </details>

            ---
            <sub>Powered by glm-4.6:cloud on Ollama Cloud</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
