name: Ollama Cloud Auto-Fix Code Review (GLM-4.6)

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write          # Required for checkout and push
  pull-requests: write     # Required for commenting

concurrency:
  group: auto-fix-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  auto-review-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Ollama CLI
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Configure Ollama for Cloud
        run: |
          echo "OLLAMA_HOST=https://ollama.com" >> $GITHUB_ENV
          echo "OLLAMA_API_KEY=${{ secrets.OLLAMA_API_KEY }}" >> $GITHUB_ENV

      - name: Register cloud model
        run: ollama pull glm-4.6:cloud

      - name: Get current diff against base branch
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD --unified=5 --color=never)
          DIFF_ESCAPED=$(printf '%s' "$DIFF" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "diff=$DIFF_ESCAPED" >> $GITHUB_OUTPUT

      - name: Define JSON Schema with actionable patches
        id: schema
        run: |
          SCHEMA=$(cat <<'EOF'
          {
            "type": "object",
            "properties": {
              "summary": { "type": "string" },
              "issues": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "line": { "type": "integer", "minimum": 1 },
                    "severity": { "type": "string", "enum": ["low", "medium", "high"] },
                    "description": { "type": "string" },
                    "suggestion": { "type": "string" }
                  },
                  "required": ["file", "severity", "description"],
                  "additionalProperties": false
                }
              },
              "suggested_fixes": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "patch": { "type": "string", "description": "Unified diff patch compatible with 'git apply'" },
                    "description": { "type": "string" }
                  },
                  "required": ["file", "patch", "description"],
                  "additionalProperties": false
                }
              },
              "overall_score": { "type": "integer", "minimum": 1, "maximum": 10 },
              "should_auto_apply": { "type": "boolean" }
            },
            "required": ["summary", "issues", "suggested_fixes", "overall_score", "should_auto_apply"],
            "additionalProperties": false
          }
          EOF
          )
          echo "schema=$SCHEMA" >> $GITHUB_OUTPUT

      - name: Generate structured review with fixes
        id: review
        run: |
          RESPONSE=$(curl -s https://ollama.com/api/chat \
            -H "Authorization: Bearer ${{ secrets.OLLAMA_API_KEY }}" \
            -d "{
              \"model\": \"glm-4.6:cloud\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are an expert code reviewer. Analyze the diff carefully. Identify issues and provide precise, safe fixes as unified diff patches. Set should_auto_apply to true only if all fixes are low-risk and improve the code without changing behaviour. Respond EXCLUSIVELY with valid JSON matching the schema.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"Schema (respond exactly this format): ${{ steps.schema.outputs.schema }}\\n\\nDiff to review:\\n${{ steps.diff.outputs.diff }}\"
                }
              ],
              \"format\": ${{ steps.schema.outputs.schema }},
              \"options\": {
                \"temperature\": 0.1,
                \"mirostat\": 2,
                \"mirostat_tau\": 5.0,
                \"mirostat_eta\": 0.1,
                \"top_p\": 0.95,
                \"repeat_penalty\": 1.15,
                \"num_ctx\": 196608,
                \"num_predict\": 4096
              },
              \"stream\": false
            }")

          REVIEW_JSON=$(echo "$RESPONSE" | jq -r '.message.content // empty')

          if [ -z "$REVIEW_JSON" ] || [ "$REVIEW_JSON" = "null" ]; then
            echo "Error: Empty or invalid response from model"
            exit 1
          fi

          REVIEW_FORMATTED=$(echo "$REVIEW_JSON" | jq '.')

          echo "json<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "formatted<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_FORMATTED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate JSON output
        run: |
          REVIEW_JSON="${{ steps.review.outputs.json }}"

          echo "$REVIEW_JSON" | jq empty || (
            echo "Invalid JSON received from model"
            exit 1
          )

          echo "JSON is valid and structured"

      - name: Apply suggested patches (if approved by model)
        if: fromJSON(steps.review.outputs.json).should_auto_apply == true
        run: |
          REVIEW_JSON="${{ steps.review.outputs.json }}"

          echo "$REVIEW_JSON" | jq -r '.suggested_fixes[] | select(.patch != null and .patch != "") | @base64' | while read -r encoded_patch; do
            PATCH_JSON=$(echo "$encoded_patch" | base64 -d)
            FILE=$(echo "$PATCH_JSON" | jq -r '.file')
            PATCH=$(echo "$PATCH_JSON" | jq -r '.patch')
            DESC=$(echo "$PATCH_JSON" | jq -r '.description')

            echo "Applying patch to $FILE: $DESC"

            echo "$PATCH" | git apply --whitespace=nowarn --verbose || echo "Warning: Patch failed for $FILE (skipping)"
          done

      - name: Commit and push auto-applied fixes
        if: fromJSON(steps.review.outputs.json).should_auto_apply == true
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: Apply AI-suggested improvements (GLM-4.6 review)"
          branch: ${{ github.head_ref }}
          commit_user_name: "GLM-4.6 Bot"
          commit_user_email: "glm-bot@users.noreply.github.com"
          commit_author: "GLM-4.6 Bot <glm-bot@users.noreply.github.com>"
          file_pattern: .
          skip_dirty_check: false

      - name: Post review comment on PR
        run: |
          AUTO_APPLIED=$(jq -r 'if .should_auto_apply then "✅ Fixes automatically applied and pushed to this branch!" else "⚠️ Fixes suggested – review and apply manually" end' <<< '${{ steps.review.outputs.json }}')

          SUMMARY=$(jq -r '.summary' <<< '${{ steps.review.outputs.json }}')
          SCORE=$(jq -r '.overall_score' <<< '${{ steps.review.outputs.json }}')

          gh pr comment ${{ github.event.pull_request.number }} --body "## GLM-4.6 Cloud Auto-Fix Review

**Summary**: $SUMMARY  
**Overall Score**: $SCORE / 10

$AUTO_APPLIED

\`\`\`json
${{ steps.review.outputs.formatted }}
\`\`\`

> Powered by **glm-4.6:cloud** on Ollama Cloud – structured, validated, and auto-applied where safe."
        env:
          GH_TOKEN: ${{ github.token }}
