name: Jules Issue Automation

on:
  issue_comment:
    types: [created]

jobs:
  delegate-to-jules:
    if: contains(github.event.comment.body, '/jules')
    runs-on: ubuntu-latest
    steps:
      - name: Parse command and create session
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          if [[ -z "$JULES_API_KEY" ]]; then
            gh issue comment "$ISSUE_NUMBER" --body "‚ö†Ô∏è GOOGLE_JULES_API_KEY not configured. Cannot delegate to Jules."
            exit 1
          fi

          gh issue comment "$ISSUE_NUMBER" --body "ü§ñ Received '/jules' command. Creating Jules session..."

          TASK=$(echo "$COMMENT_BODY" | sed 's|/jules[[:space:]]*||' | head -c 1000)
          [ -z "$TASK" ] && TASK="Fix issue #$ISSUE_NUMBER"

          RESPONSE=$(curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg task "Fix issue #$ISSUE_NUMBER: $TASK" \
              --arg repo "$REPOSITORY" \
              --arg branch "$DEFAULT_BRANCH" \
              '{
                prompt: $task,
                sourceContext: {
                  source: ("sources/github/" + $repo),
                  githubRepoContext: { startingBranch: $branch }
                },
                automationMode: "AUTO_CREATE_PR"
              }')")

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          SESSION_URL="https://jules.google.com/session/$SESSION_ID"

          if [ -n "$SESSION_ID" ]; then
            gh issue comment "$ISSUE_NUMBER" --body "## ü§ñ Jules Session Created

          ‚û°Ô∏è **[Monitor Session]($SESSION_URL)**

          Jules will analyze the issue and create a PR."
          else
            echo "Failed to create Jules session: $RESPONSE"
            gh issue comment "$ISSUE_NUMBER" --body "‚ùå Failed to create Jules session. Please check logs."
            exit 1
          fi
