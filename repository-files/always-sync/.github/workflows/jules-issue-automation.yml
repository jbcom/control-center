name: Jules Issue Automation

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  delegate-to-jules:
    if: |
      github.event.issue.pull_request == null &&
      github.event.issue.state == 'open' &&
      startsWith(github.event.comment.body, '/jules')
    runs-on: ubuntu-latest
    steps:
      - name: Extract Prompt
        id: prompt
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          PROMPT=$(echo "$COMMENT_BODY" | sed -n 's|^/jules ||p')
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Jules Session
        id: jules
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          JULES_PROMPT: ${{ steps.prompt.outputs.prompt }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          if [[ -z "$GOOGLE_JULES_API_KEY" ]]; then
            echo "⚠️ GOOGLE_JULES_API_KEY not set, skipping Jules session"
            echo "session=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          RESPONSE=$(curl -s -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$JULES_PROMPT" --arg repo "$REPO_FULL_NAME" '{
              prompt: $prompt,
              sourceContext: {
                source: "sources/github/" + $repo,
                githubRepoContext: { startingBranch: "main" }
              },
              automationMode: "AUTO_CREATE_PR"
            }')")

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.name // "unknown"')
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Session Comment
        if: steps.jules.outputs.session_id != 'unknown'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SESSION_ID: ${{ steps.jules.outputs.session_id }}
        run: |
          COMMENT=$(cat <<EOF
          ✅ Jules session \`${SESSION_ID}\` created.

          I will now begin working on this issue. You can track my progress in the session details.
          EOF
          )

          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"

      - name: Handle API Error
        if: steps.jules.outputs.session_id == 'unknown'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_RESPONSE: ${{ steps.jules.outputs.response }}
        run: |
          COMMENT=$(cat <<EOF
          ❌ Failed to create Jules session.

          **API Response:**
          \`\`\`json
          ${JULES_RESPONSE}
          \`\`\`
          EOF
          )

          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"
          exit 1
