name: Jules Issue Automation

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  delegate-to-jules:
    name: Delegate to Jules
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/jules')
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ü§ñ Received '/jules' command. Creating Jules session..."
      - name: Parse Task
        id: task
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          TASK=$(echo "$COMMENT_BODY" | sed 's|/jules[[:space:]]*||' | head -c 1000)
          echo "task=$TASK" >> $GITHUB_OUTPUT
      - name: Create Jules session
        id: jules
        env:
          JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST 'https://jules.googleapis.com/v1alpha/sessions' \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n \
              --arg prompt "Fix issue #${{ github.event.issue.number }}: ${{ steps.task.outputs.task }}" \
              --arg repo "${{ github.repository }}" \
              --arg branch "${{ github.event.repository.default_branch }}" \
              '{
                "prompt": $prompt,
                "sourceContext": {
                  "source": ("sources/github/" + $repo),
                  "githubRepoContext": { "startingBranch": $branch }
                },
                "automationMode": "AUTO_CREATE_PR",
                "title": "Jules: Fix issue #${{ github.event.issue.number }}"
              }')")

          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          SESSION_URL="https://jules.google.com/session/$SESSION_ID"

          echo "session_url=$SESSION_URL" >> $GITHUB_OUTPUT
          echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
      - name: Post Session Link
        if: steps.jules.outputs.session_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ü§ñ Jules Session Created

          ‚û°Ô∏è **[Monitor Session](${{ steps.jules.outputs.session_url }})**

          Jules will analyze the issue and create a PR."
      - name: Post Error
        if: steps.jules.outputs.session_id == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚ùå Failed to create Jules session."
