name: Ecosystem Fixer

# CI Failure Resolution Pipeline:
# 1. Try agentic-ci-resolution action (Jules/Cursor)
# 2. Fallback to Claude if that fails

on:
  workflow_run:
    workflows: ["CI", "Build", "Test", "Lint"]
    types: [completed]
    branches-ignore: [main]
  
  # Enterprise Reusable Workflow
  workflow_call:
    inputs:
      run_id:
        description: 'Workflow run ID that failed'
        required: true
        type: string
      repository:
        description: 'Repository owner/name'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
    secrets:
      CI_GITHUB_TOKEN:
        required: true
      GOOGLE_JULES_API_KEY:
        required: false
      ANTHROPIC_API_KEY:
        required: false

  # Manual/On-call trigger
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID'
        required: true
        type: string
      repository:
        description: 'Repository'
        required: true
        type: string
      branch:
        description: 'Branch'
        required: true
        type: string

env:
  TARGET_REPO: ${{ inputs.repository || github.repository }}
  TARGET_RUN_ID: ${{ inputs.run_id || github.event.workflow_run.id }}
  TARGET_BRANCH: ${{ inputs.branch || github.event.workflow_run.head_branch }}

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # Security gate: Skip fork PRs to prevent untrusted code execution
  security-check:
    name: Security Check
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
      safe_to_proceed: ${{ steps.check.outputs.safe }}
    steps:
      - name: Check if fork PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TARGET_REPO: ${{ env.TARGET_REPO }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
        run: |
          # For workflow_run, check if the triggering PR is from a fork
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            HEAD_REPO="${{ github.event.workflow_run.head_repository.full_name }}"
            BASE_REPO="${{ github.event.workflow_run.repository.full_name }}"
            
            if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
              echo "⚠️ Fork PR detected: $HEAD_REPO → $BASE_REPO"
              echo "is_fork=true" >> $GITHUB_OUTPUT
              echo "safe=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "is_fork=false" >> $GITHUB_OUTPUT
          echo "safe=true" >> $GITHUB_OUTPUT

  fix:
    name: Auto-resolve CI Failures
    needs: security-check
    if: needs.security-check.outputs.safe_to_proceed == 'true'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.agentic.outcome }}
    steps:
      # Use persist-credentials: false for security - we'll auth separately for push
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          persist-credentials: false
          
      - name: Agentic CI Resolution
        id: agentic
        continue-on-error: true
        uses: jbcom/control-center/.github/actions/agentic-ci-resolution@main
        with:
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          workflow_run_id: ${{ env.TARGET_RUN_ID }}
          branch: ${{ env.TARGET_BRANCH }}
          repository: ${{ env.TARGET_REPO }}

  claude-fallback:
    name: Claude CI Fix
    needs: [security-check, fix]
    # Only run if security passed, fix job actually ran (not skipped), and didn't succeed
    if: |
      always() && 
      needs.security-check.outputs.safe_to_proceed == 'true' &&
      needs.fix.result != 'skipped' && 
      needs.fix.result != 'success'
    runs-on: ubuntu-latest
    steps:
      # Use persist-credentials: false for security
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          persist-credentials: false

      - name: Get failure logs
        id: logs
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          gh run view ${{ env.TARGET_RUN_ID }} --repo ${{ env.TARGET_REPO }} --log-failed > /tmp/ci_failure.log 2>&1 || true
          echo "log_file=/tmp/ci_failure.log" >> $GITHUB_OUTPUT

      - name: Claude Fix
        uses: anthropics/claude-code-action@154d0de144ff82240e1c3deedff56280381fd122 # main
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          allowed_tools: "Edit,Write,Read,Glob,Grep,LS,Bash(git status),Bash(git diff),Bash(git add),Bash(git commit),Bash(git push),Bash(gh pr view),Bash(gh run view),Bash(node:*),Bash(npm:*)"
          direct_prompt: |
            Fix the CI failure in ${{ env.TARGET_REPO }}. The failure log is at /tmp/ci_failure.log
            
            1. Read the failure log
            2. Identify the root cause
            3. Fix the code
            4. Commit and push
            
            Branch: ${{ env.TARGET_BRANCH }}
