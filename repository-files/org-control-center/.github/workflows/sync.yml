# Org Internal Sync - Cascades from enterprise control-center
# 
# MERGE STRATEGY:
# 1. Apply enterprise files from repository-files/always-sync (from jbcom/control-center)
# 2. Apply org-specific overrides from repository-files/org-overrides (org can customize)
# 3. Apply language-specific rules based on detected stack
# 4. Initial-only files only created if missing
#
# PR-BASED SYNC:
# - Creates PRs instead of pushing directly to main
# - Ecosystem connector workflow auto-triages and merges sync PRs
# - Labels: sync, auto-merge

name: Sync

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - '.github/workflows/sync.yml'

permissions:
  contents: read

jobs:
  sync:
    name: Sync to Org Repos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Sync to all org repos
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ORG: ${{ github.repository_owner }}
        run: |
          echo "üîÑ Syncing to all repos in $ORG..."
          echo "Strategy: Enterprise base + Org overrides ‚Üí PR"
          echo ""
          
          # Get all non-archived, non-control-center repos
          repos=$(gh repo list "$ORG" --no-archived --json name --jq '.[].name' | grep -v "^control-center$" | grep -v "^\.github$")
          
          for repo in $repos; do
            echo ""
            echo "=== $ORG/$repo ==="
            
            # Clone target repo
            rm -rf /tmp/target
            if ! git clone "https://x-access-token:${GH_TOKEN}@github.com/$ORG/$repo.git" /tmp/target 2>/dev/null; then
              echo "  ‚ö†Ô∏è Could not clone - skipping"
              continue
            fi
            cd /tmp/target
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Create sync branch
            BRANCH="sync/control-center-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
            
            # Ensure directories exist
            mkdir -p .github/workflows .cursor/rules
            
            # LAYER 1: Enterprise always-sync (base)
            echo "  Layer 1: Enterprise files..."
            if [ -d "$GITHUB_WORKSPACE/repository-files/always-sync" ]; then
              cp -r $GITHUB_WORKSPACE/repository-files/always-sync/.github/workflows/* .github/workflows/ 2>/dev/null || true
              cp -r $GITHUB_WORKSPACE/repository-files/always-sync/.cursor/rules/* .cursor/rules/ 2>/dev/null || true
              # Copy root files
              for file in $GITHUB_WORKSPACE/repository-files/always-sync/*; do
                [ -f "$file" ] && cp "$file" . 2>/dev/null || true
              done
            fi
            
            # LAYER 2: Language-specific rules
            echo "  Layer 2: Language-specific..."
            if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
              echo "    - Python detected"
              cp -r $GITHUB_WORKSPACE/repository-files/python/.cursor/rules/* .cursor/rules/ 2>/dev/null || true
            fi
            if [ -f "package.json" ]; then
              echo "    - Node.js detected"
              cp -r $GITHUB_WORKSPACE/repository-files/nodejs/.cursor/rules/* .cursor/rules/ 2>/dev/null || true
            fi
            if [ -f "go.mod" ]; then
              echo "    - Go detected"
              cp -r $GITHUB_WORKSPACE/repository-files/go/.cursor/rules/* .cursor/rules/ 2>/dev/null || true
            fi
            if [ -f "Cargo.toml" ]; then
              echo "    - Rust detected"
              cp -r $GITHUB_WORKSPACE/repository-files/rust/.cursor/rules/* .cursor/rules/ 2>/dev/null || true
            fi
            if ls *.tf >/dev/null 2>&1; then
              echo "    - Terraform detected"
              cp -r $GITHUB_WORKSPACE/repository-files/terraform/.cursor/rules/* .cursor/rules/ 2>/dev/null || true
            fi
            
            # LAYER 3: Org-specific overrides (wins)
            echo "  Layer 3: Org overrides..."
            if [ -d "$GITHUB_WORKSPACE/repository-files/org-overrides" ]; then
              cp -r $GITHUB_WORKSPACE/repository-files/org-overrides/.github/workflows/* .github/workflows/ 2>/dev/null && echo "    - Workflows overridden" || true
              cp -r $GITHUB_WORKSPACE/repository-files/org-overrides/.cursor/rules/* .cursor/rules/ 2>/dev/null && echo "    - Cursor rules overridden" || true
              for item in $GITHUB_WORKSPACE/repository-files/org-overrides/*; do
                if [ -f "$item" ]; then
                  cp "$item" . 2>/dev/null && echo "    - $(basename $item) overridden" || true
                fi
              done
            else
              echo "    - No org overrides defined"
            fi
            
            # LAYER 4: Initial-only (only if missing)
            echo "  Layer 4: Initial-only..."
            for file in CLAUDE.md AGENTS.md; do
              if [ ! -f "$file" ]; then
                if [ -f "$GITHUB_WORKSPACE/repository-files/org-overrides/$file" ]; then
                  cp "$GITHUB_WORKSPACE/repository-files/org-overrides/$file" "$file"
                  echo "    - $file created (org version)"
                elif [ -f "$GITHUB_WORKSPACE/repository-files/initial-only/$file" ]; then
                  cp "$GITHUB_WORKSPACE/repository-files/initial-only/$file" "$file"
                  echo "    - $file created (enterprise version)"
                fi
              fi
            done
            
            # Check for changes
            if git diff --quiet && [ -z "$(git status --porcelain)" ]; then
              echo "  ‚úÖ Already up to date"
              cd $GITHUB_WORKSPACE
              continue
            fi
            
            # Commit changes
            git add -A
            git commit -m "chore(sync): update from $ORG/control-center

Synced files:
- Enterprise base (always-sync)
- Language-specific rules
- Org overrides (if any)

This PR will be auto-triaged and merged by ecosystem-connector."
            
            # Push branch
            if ! git push origin "$BRANCH" 2>/dev/null; then
              echo "  ‚ö†Ô∏è Push failed"
              cd $GITHUB_WORKSPACE
              continue
            fi
            
            # Create PR
            PR_URL=$(gh pr create \
              --repo "$ORG/$repo" \
              --base main \
              --head "$BRANCH" \
              --title "chore(sync): update from control-center" \
              --body "## üîÑ Sync from $ORG/control-center

### Changes
- Enterprise base files (workflows, cursor rules)
- Language-specific rules (auto-detected)
- Org-specific overrides

### Auto-merge
This PR has the \`sync\` and \`auto-merge\` labels.
The ecosystem-connector workflow will:
1. ‚úÖ Auto-approve (from trusted source)
2. ‚úÖ Add labels
3. ‚úÖ Merge when CI passes

---
*Automated sync from $ORG/control-center*" \
              --label "sync,auto-merge" 2>/dev/null || echo "")
            
            if [ -n "$PR_URL" ]; then
              echo "  ‚úÖ PR created: $PR_URL"
            else
              # PR might already exist, try to find it
              EXISTING=$(gh pr list --repo "$ORG/$repo" --head "$BRANCH" --json url --jq '.[0].url' 2>/dev/null || echo "")
              if [ -n "$EXISTING" ]; then
                echo "  ‚úÖ PR already exists: $EXISTING"
              else
                echo "  ‚ö†Ô∏è Could not create PR"
              fi
            fi
            
            cd $GITHUB_WORKSPACE
          done
          
          echo ""
          echo "üéâ Sync complete - PRs created for all repos"
