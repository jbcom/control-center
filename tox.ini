# Tox configuration for jbcom control center
# Uses tox-uv for uv workspace integration and tox-gh for GitHub Actions
#
# Usage:
#   tox -e extended-data-types     # Test single package
#   tox -e lint                    # Lint all packages
#   tox                            # Run all tests (py39-py313)
#
# With pre-built wheels (CI pattern):
#   # All package wheels must be in dist/ for inter-package dependency resolution.
#   # UV_FIND_LINKS tells uv to resolve dependencies from local wheels, not PyPI.
#   UV_FIND_LINKS=./dist tox run --installpkg dist/extended_data_types-*.whl -e extended-data-types
#   UV_FIND_LINKS=./dist tox run --installpkg dist/lifecyclelogging-*.whl -e lifecyclelogging
#
# IMPORTANT: Inter-package dependencies (e.g., lifecyclelogging depends on extended-data-types)
# are declared in each package's pyproject.toml, NOT in the tox deps section. This ensures:
# 1. Dependencies resolve from local wheels when UV_FIND_LINKS is set (CI)
# 2. Dependencies resolve from PyPI when running locally without pre-built wheels
# The pass_env setting ensures UV_FIND_LINKS is available during dependency resolution.

[tox]
min_version = 4
requires =
    tox>=4.11
    tox-uv>=1.11
    tox-gh>=1.3
env_list =
    py{39,310,311,312,313}
    lint
    typecheck
    coverage-{combine,report}
skip_missing_interpreters = true

[gh]
python =
    3.9 = py39
    3.10 = py310
    3.11 = py311
    3.12 = py312
    3.13 = py313


# ============================================
# BASE TEST ENVIRONMENT
# ============================================
[testenv]
package = wheel
wheel_build_env = .pkg
changedir = {toxinidir}
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    pytest-xdist>=3.5.0
    coverage[toml]>=7.0.0
setenv =
    PYTHONDONTWRITEBYTECODE = 1
    COVERAGE_FILE = {toxinidir}/.coverage.{envname}
commands =
    pytest packages/extended-data-types/tests {posargs}
    pytest packages/lifecyclelogging/tests {posargs}
    pytest packages/directed-inputs-class/tests {posargs}
    pytest packages/python-terraform-bridge/tests {posargs}
    pytest packages/vendor-connectors/tests {posargs}


# ============================================
# INDIVIDUAL PACKAGE ENVIRONMENTS
# ============================================
[testenv:extended-data-types]
description = Test extended-data-types package
package = wheel
package_root = packages/extended-data-types
changedir = {toxinidir}/packages/extended-data-types
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    coverage[toml]>=7.0.0
pass_env =
    UV_FIND_LINKS
setenv =
    COVERAGE_FILE = {toxinidir}/.coverage.extended-data-types
commands =
    coverage run -m pytest tests {posargs}

[testenv:lifecyclelogging]
description = Test lifecyclelogging package
package = wheel
package_root = packages/lifecyclelogging
changedir = {toxinidir}/packages/lifecyclelogging
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    coverage[toml]>=7.0.0
    # Note: extended-data-types is a runtime dep declared in the wheel itself.
    # UV_FIND_LINKS ensures it resolves from local wheels, not PyPI.
pass_env =
    UV_FIND_LINKS
setenv =
    COVERAGE_FILE = {toxinidir}/.coverage.lifecyclelogging
commands =
    coverage run -m pytest tests {posargs}

[testenv:directed-inputs-class]
description = Test directed-inputs-class package
package = wheel
package_root = packages/directed-inputs-class
changedir = {toxinidir}/packages/directed-inputs-class
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    coverage[toml]>=7.0.0
    # Note: extended-data-types is a runtime dep declared in the wheel itself.
    # UV_FIND_LINKS ensures it resolves from local wheels, not PyPI.
pass_env =
    UV_FIND_LINKS
setenv =
    COVERAGE_FILE = {toxinidir}/.coverage.directed-inputs-class
commands =
    coverage run -m pytest tests {posargs}

[testenv:python-terraform-bridge]
description = Test python-terraform-bridge package
package = wheel
package_root = packages/python-terraform-bridge
changedir = {toxinidir}/packages/python-terraform-bridge
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    coverage[toml]>=7.0.0
    # Note: extended-data-types is a runtime dep declared in the wheel itself.
    # UV_FIND_LINKS ensures it resolves from local wheels, not PyPI.
pass_env =
    UV_FIND_LINKS
setenv =
    COVERAGE_FILE = {toxinidir}/.coverage.python-terraform-bridge
commands =
    coverage run -m pytest tests {posargs}

[testenv:vendor-connectors]
description = Test vendor-connectors package
package = wheel
package_root = packages/vendor-connectors
changedir = {toxinidir}/packages/vendor-connectors
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    pytest-asyncio>=0.23.0
    coverage[toml]>=7.0.0
    # Note: extended-data-types, lifecyclelogging, directed-inputs-class are runtime deps
    # declared in the wheel itself. UV_FIND_LINKS ensures they resolve from local wheels.
pass_env =
    UV_FIND_LINKS
setenv =
    COVERAGE_FILE = {toxinidir}/.coverage.vendor-connectors
commands =
    coverage run -m pytest tests {posargs}


# ============================================
# LINT
# ============================================
[testenv:lint]
description = Lint all packages with ruff
skip_install = true
deps = ruff>=0.8.0
commands =
    ruff check packages/
    ruff format --check packages/


# ============================================
# TYPE CHECK
# ============================================
[testenv:typecheck]
description = Type check all packages
base_python = py313
skip_install = true
deps =
    mypy>=1.8.0
    types-PyYAML>=6.0.12
    types-requests>=2.31.0
    {toxinidir}/packages/extended-data-types
    {toxinidir}/packages/lifecyclelogging
    {toxinidir}/packages/directed-inputs-class
    {toxinidir}/packages/python-terraform-bridge
    {toxinidir}/packages/vendor-connectors
commands =
    mypy packages/extended-data-types/src --ignore-missing-imports
    mypy packages/lifecyclelogging/src --ignore-missing-imports
    mypy packages/directed-inputs-class/src --ignore-missing-imports
    mypy packages/python-terraform-bridge/src --ignore-missing-imports
    mypy packages/vendor-connectors/src --ignore-missing-imports


# ============================================
# COVERAGE
# ============================================
[testenv:coverage-combine]
description = Combine coverage data from all test runs
base_python = py313
depends =
    extended-data-types
    lifecyclelogging
    directed-inputs-class
    python-terraform-bridge
    vendor-connectors
skip_install = true
deps = coverage[toml]>=7.0.0
commands = coverage combine

[testenv:coverage-report]
description = Generate coverage report
base_python = py313
depends = coverage-combine
skip_install = true
deps = coverage[toml]>=7.0.0
parallel_show_output = true
commands =
    coverage report --show-missing
    coverage html --skip-covered --skip-empty


# ============================================
# DOCUMENTATION
# ============================================
[testenv:docs-{build,doctests,linkcheck}]
description = Build documentation
base_python = py313
changedir = {toxinidir}/packages/extended-data-types
deps =
    sphinx>=7.0
    sphinxawesome-theme>=5.0.0
    sphinx-autodoc2>=0.5.0
    myst-parser>=3.0.0
    docutils>=0.17
    {toxinidir}/packages/extended-data-types
commands =
    build: sphinx-build -n -T -W -b html -d docs/_build/doctrees docs docs/_build/html {posargs}
    doctests: sphinx-build -n -T -W -b doctest -d docs/_build/doctrees docs docs/_build/html {posargs}
    linkcheck: sphinx-build -W -b linkcheck -d docs/_build/doctrees docs docs/_build/html {posargs}


# ============================================
# DEVELOPMENT
# ============================================
[testenv:dev]
description = Development environment with all packages
package = editable
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    pytest-xdist>=3.5.0
    mypy>=1.8.0
    ruff>=0.8.0
    pre-commit>=3.6.0
    {toxinidir}/packages/extended-data-types[tests]
    {toxinidir}/packages/lifecyclelogging[tests]
    {toxinidir}/packages/directed-inputs-class[tests]
    {toxinidir}/packages/python-terraform-bridge[tests]
    {toxinidir}/packages/vendor-connectors[tests]
commands =
    python -c "print('Development environment ready!')"
