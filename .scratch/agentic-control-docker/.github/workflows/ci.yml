name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  NODE_VERSION: "22"
  PYTHON_VERSION: "3.13"
  REGISTRY: docker.io
  IMAGE_NAME: jbcom/agentic-control

jobs:
  # ============================================
  # BUILD & TEST - Node.js
  # ============================================
  build-node:
    name: Build (Node.js)
    runs-on: ubuntu-latest
    steps:
      # actions/checkout v4.2.2
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      # actions/setup-node v4.4.0
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}

      # pnpm/action-setup v4.1.0
      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build

      # actions/upload-artifact v4.6.0
      - name: Upload build artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
        with:
          name: dist
          path: dist

  test-node:
    name: Test (Node.js)
    runs-on: ubuntu-latest
    needs: build-node
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm run test

  lint-node:
    name: Lint (Node.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm run lint

  # ============================================
  # BUILD & TEST - Python
  # ============================================
  build-python:
    name: Build (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      # actions/setup-python v5.6.0
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # hynek/setup-cached-uv v2.3.0
      - uses: hynek/setup-cached-uv@757bedb77f0636b47f5a5eebaa4ccb59b42bc128

      - name: Build Python package
        working-directory: python
        run: uv build

      - name: Upload Python artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
        with:
          name: python-dist
          path: python/dist

  test-python:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: build-python
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}

      - uses: hynek/setup-cached-uv@757bedb77f0636b47f5a5eebaa4ccb59b42bc128

      - name: Install dependencies
        working-directory: python
        run: uv sync --dev

      - name: Run tests
        working-directory: python
        run: uv run pytest

  # ============================================
  # DOCKER BUILD (PR validation)
  # ============================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build-node, build-python]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Download Node.js build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: dist
          path: dist

      # docker/setup-buildx-action v3.11.1
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      # docker/build-push-action v6.18.0
      - name: Build Docker image (no push)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}

      - name: Run smoke tests
        run: |
          docker run --rm ${{ env.IMAGE_NAME }}:test --version
          docker run --rm ${{ env.IMAGE_NAME }}:test sh -c "node --version && python --version && gh --version"

  # ============================================
  # RELEASE (tags only)
  # ============================================
  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test-node, test-python, lint-node, docker-build]
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda
        with:
          version: 9

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: hynek/setup-cached-uv@757bedb77f0636b47f5a5eebaa4ccb59b42bc128

      - name: Download Node.js build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: dist
          path: dist

      - name: Download Python build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: python-dist
          path: python/dist

      # --- NPM Publish ---
      - name: Publish to npm
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # --- PyPI Publish ---
      - name: Publish to PyPI
        working-directory: python
        run: uv publish
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}

      # --- Docker Publish ---
      # docker/setup-qemu-action v3.7.0
      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130

      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      # docker/login-action v3.6.0
      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # docker/metadata-action v5.10.0
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=
            type=raw,value=latest
            type=raw,value=python${{ env.PYTHON_VERSION }}-node${{ env.NODE_VERSION }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.ref_name }}
            NODE_VERSION=${{ env.NODE_VERSION }}
            PYTHON_VERSION=${{ env.PYTHON_VERSION }}

      # --- GitHub Release ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda
        with:
          generate_release_notes: true
          files: |
            python/dist/*

  # ============================================
  # AUTO-RELEASE (main branch - semantic versioning)
  # ============================================
  auto-release:
    name: Create Release Tag
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [test-node, test-python, lint-node, docker-build]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Get latest tag
        id: latest_tag
        run: |
          LATEST=$(git describe --tags --match "v*" --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST"

      - name: Determine version bump
        id: bump
        run: |
          COMMITS=$(git log ${{ steps.latest_tag.outputs.tag }}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")
          
          if echo "$COMMITS" | grep -qE "^(feat|fix|refactor|perf)(\(.+\))?!:|BREAKING CHANGE"; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          elif echo "$COMMITS" | grep -qE "^(fix|perf|refactor)(\(.+\))?:"; then
            echo "bump=patch" >> $GITHUB_OUTPUT
          else
            echo "bump=none" >> $GITHUB_OUTPUT
          fi

      - name: Calculate new version
        id: version
        if: steps.bump.outputs.bump != 'none'
        run: |
          CURRENT="${{ steps.latest_tag.outputs.tag }}"
          CURRENT="${CURRENT#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          case "${{ steps.bump.outputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          
          echo "version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: steps.bump.outputs.bump != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
