# =============================================================================
# jbcom/agentic-control - Sandbox Edition
# =============================================================================
# Extended image with sandbox execution capabilities for running AI agents
# in complete isolation. Supports multiple runtimes: Claude, Cursor, Custom.
#
# Usage:
#   # As CLI
#   docker run jbcom/agentic-control:sandbox --help
#
#   # As sandbox runtime
#   docker run -v $(pwd):/workspace jbcom/agentic-control:sandbox \
#     sandbox run --runtime claude --prompt "Your task"
# =============================================================================

ARG NODE_VERSION=22
ARG PYTHON_VERSION=3.13
ARG DISTRO=bookworm

# -----------------------------------------------------------------------------
# Stage 1: Base with Python + UV
# -----------------------------------------------------------------------------
FROM python:${PYTHON_VERSION}-${DISTRO} AS base

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

RUN groupadd --gid 1000 agent && \
    useradd --uid 1000 --gid agent --shell /bin/bash --create-home agent

# -----------------------------------------------------------------------------
# Stage 2: Node.js installation
# -----------------------------------------------------------------------------
FROM base AS node-install

ARG NODE_VERSION
ARG TARGETARCH

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg xz-utils && \
    rm -rf /var/lib/apt/lists/*

RUN ARCH= && case "${TARGETARCH}" in \
        amd64) ARCH='x64';; \
        arm64) ARCH='arm64';; \
        *) echo "Unsupported: ${TARGETARCH}"; exit 1;; \
    esac && \
    NODE_FULL=$(curl -fsSL "https://nodejs.org/dist/latest-v${NODE_VERSION}.x/SHASUMS256.txt" | head -n1 | awk '{print $2}' | sed 's/node-\(.*\)-linux.*/\1/') && \
    curl -fsSLO "https://nodejs.org/dist/${NODE_FULL}/node-${NODE_FULL}-linux-${ARCH}.tar.xz" && \
    tar -xJf "node-${NODE_FULL}-linux-${ARCH}.tar.xz" -C /usr/local --strip-components=1 --no-same-owner && \
    rm "node-${NODE_FULL}-linux-${ARCH}.tar.xz" && \
    corepack enable && corepack prepare pnpm@latest --activate

# -----------------------------------------------------------------------------
# Stage 3: Sandbox runtime with all tools
# -----------------------------------------------------------------------------
FROM node-install AS sandbox

LABEL org.opencontainers.image.title="agentic-control-sandbox"
LABEL org.opencontainers.image.description="Sandboxed AI agent execution for Cursor, Claude, and custom runtimes"

ARG VERSION=dev

# Install comprehensive tooling for agentic workloads
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core tools
    git curl wget jq \
    # Build essentials
    build-essential \
    # Process management
    procps \
    # Networking
    openssh-client \
    # For Cursor/Claude agent execution
    bash \
    && rm -rf /var/lib/apt/lists/*

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt-get update && apt-get install -y gh && \
    rm -rf /var/lib/apt/lists/*

# Install Claude Agent SDK globally (for Claude runtime)
RUN npm install -g @anthropic-ai/claude-agent-sdk

# Environment setup
ENV NODE_ENV=production
ENV UV_SYSTEM_PYTHON=1
ENV PNPM_HOME=/usr/local/share/pnpm
ENV PATH="${PNPM_HOME}:${PATH}"
ENV VERSION=${VERSION}

# Sandbox-specific directories
ENV AGENTIC_WORKSPACE=/workspace
ENV AGENTIC_OUTPUT=/output
RUN mkdir -p ${AGENTIC_WORKSPACE} ${AGENTIC_OUTPUT} && \
    chown agent:agent ${AGENTIC_WORKSPACE} ${AGENTIC_OUTPUT}

WORKDIR /app

# Copy agentic-control package
COPY package.json pnpm-lock.yaml ./
COPY python/pyproject.toml python/uv.lock ./python/

RUN pnpm install --frozen-lockfile --prod

RUN cd python && uv sync --frozen --no-dev

COPY dist/ ./dist/
COPY python/src/ ./python/src/

# Sandbox execution scripts
COPY sandbox/ ./sandbox/

# Create entrypoint that supports both CLI and sandbox modes
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Symlinks for CLI access
RUN ln -sf /app/node_modules/.bin/agentic /usr/local/bin/agentic && \
    ln -sf /app/node_modules/.bin/agentic-control /usr/local/bin/agentic-control

# Default to non-root
USER agent

# Volumes for workspace and output
VOLUME ["/workspace", "/output"]

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD node --version && python --version

ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["--help"]
