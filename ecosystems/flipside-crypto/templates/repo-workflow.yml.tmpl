# Auto-generated by FSC Control Center
# This workflow enables self-generation using terraform-modules composite actions
name: {{ workflow_name | default: "Terraform Pipeline" }}

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'workspaces/**'
      - 'config/**'
      - '.github/workflows/terraform*.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'workspaces/**'
      - 'config/**'
  workflow_dispatch:

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  TF_VERSION: "{{ terraform_version | default: '1.13.1' }}"
  PYTHON_VERSION: "{{ python_version | default: '3.12' }}"

jobs:
  # Self-generation: regenerate terraform modules if source changed
  generate:
    name: Generate Terraform Modules
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run tm_cli terraform_modules
        uses: FlipsideCrypto/terraform-modules/.github/actions/tm-cli@main
        with:
          command: terraform_modules

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
          else
            echo "any_changed=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git diff --staged --name-only
          fi

      - name: Commit changes
        if: steps.changes.outputs.any_changed == 'true' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: regenerate terraform modules [skip ci]"
          git push

  # Pipeline: run terraform workspaces
  pipeline:
    name: Terraform Pipeline
    needs: generate
    if: always() && needs.generate.result != 'failure'
    uses: FlipsideCrypto/terraform-modules/.github/workflows/terraform-pipeline.yml@main
    with:
      workspace-dir: "{{ workspace_dir | default: 'workspaces' }}"
      root-dir: "{{ root_dir | default: '.' }}"
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      FLIPSIDE_GITHUB_TOKEN: ${{ secrets.FLIPSIDE_GITHUB_TOKEN }}
