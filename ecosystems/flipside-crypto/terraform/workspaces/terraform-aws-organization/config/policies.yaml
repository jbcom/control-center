# AWS Organization Policies Configuration
# Defines all policy types and templates for the organization

# Enabled policy types
enabled_policy_types:
  - "AISERVICES_OPT_OUT_POLICY"
  - "BACKUP_POLICY"
  - "SERVICE_CONTROL_POLICY"
  - "TAG_POLICY"

# AWS Control Tower Configuration
control_tower:
  # Landing Zone Configuration
  landing_zone:
    version: "3.3"
    governed_regions:
      - "us-east-1"
    centralized_logging:
      enabled: true
      configurations:
        logging_bucket:
          retention_days: 365
        access_logging_bucket:
          retention_days: 3650
        kms_key_arn: "${local.kms_key_arn}"
    access_management:
      enabled: true
  
  # Control Tower Controls
  controls:
    audit_bucket_retention:
      control_id: "AWS-GR_AUDIT_BUCKET_RETENTION_POLICY"
      description: "Ensures that the audit bucket has appropriate retention policies"
      target_ous:
        - "sandbox"
    
    cloudtrail_enabled:
      control_id: "AWS-GR_CLOUDTRAIL_ENABLED"
      description: "Ensures that CloudTrail is enabled in all accounts"
      target_ous:
        - "security"
        - "sandbox"
    
    cloudwatch_events_enabled:
      control_id: "AWS-GR_CLOUDWATCH_EVENTS_ENABLED"
      description: "Ensures that CloudWatch Events is enabled in all accounts"
      target_ous:
        - "security"

# Policy templates by type
policies:
  # Service Control Policies
  service_control:
    FullAWSAccess:
      name: "FullAWSAccess"
      description: "Allows access to every operation"
      content: |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": "*",
              "Resource": "*"
            }
          ]
        }
    
    deny_root_user:
      name: "DenyRootUserActions"
      description: "Prevents the use of the root user for most operations"
      content: |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "DenyRootUserOperations",
              "Effect": "Deny",
              "Action": "*",
              "Resource": "*",
              "Condition": {
                "StringLike": {
                  "aws:PrincipalArn": "arn:aws:iam::*:root"
                }
              }
            }
          ]
        }
    
    deny_leave_organization:
      name: "DenyLeaveOrganization"
      description: "Prevents accounts from leaving the organization"
      content: |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "DenyLeaveOrganization",
              "Effect": "Deny",
              "Action": "organizations:LeaveOrganization",
              "Resource": "*"
            }
          ]
        }
  
  # Tag Policies
  tag:
    required_tags:
      name: "RequiredTags"
      description: "Enforces required tags on resources"
      content: |
        {
          "tags": {
            "Environment": {
              "tag_key": {
                "@@assign": "Environment"
              },
              "tag_value": {
                "@@assign": [
                  "prod",
                  "staging",
                  "dev",
                  "sandbox"
                ]
              },
              "enforced_for": {
                "@@assign": [
                  "ec2:instance",
                  "s3:bucket"
                ]
              }
            },
            "Owner": {
              "tag_key": {
                "@@assign": "Owner"
              },
              "enforced_for": {
                "@@assign": [
                  "ec2:instance",
                  "s3:bucket"
                ]
              }
            }
          }
        }
  
  # AI Services Opt-Out Policies
  ai_services:
    opt_out:
      name: "AIServicesOptOut"
      description: "Opts out of AI services data usage"
      content: |
        {
          "services": {
            "default": {
              "opt_out_policy": {
                "@@assign": "optOut"
              }
            }
          }
        }
  
  # Backup Policies
  backup:
    daily_backup:
      name: "DailyBackup"
      description: "Daily backup policy for critical resources"
      content: |
        {
          "plans": {
            "daily_backup": {
              "regions": {
                "@@assign": [
                  "us-east-1"
                ]
              },
              "rules": {
                "daily": {
                  "schedule_expression": {
                    "@@assign": "cron(0 5 ? * * *)"
                  },
                  "target_backup_vault_name": {
                    "@@assign": "Default"
                  },
                  "lifecycle": {
                    "delete_after_days": {
                      "@@assign": "30"
                    }
                  }
                }
              },
              "selections": {
                "tags": {
                  "datatype": {
                    "iam_role_arn": {
                      "@@assign": "$account:role/aws-service-role/backup.amazonaws.com/AWSServiceRoleForBackup"
                    },
                    "tag_key": {
                      "@@assign": "Backup"
                    },
                    "tag_value": {
                      "@@assign": [
                        "daily"
                      ]
                    }
                  }
                }
              }
            }
          }
        }

  # Policy attachments to the organization root
  root_attachments:
    service_control:
      - "FullAWSAccess"
    # Uncomment and add other policies as needed
    # tag:
    #   - "required_tags"
    # ai_services:
    #   - "opt_out"
    # backup:
    #   - "daily_backup"

  # Policy attachments to organizational units
  ou_attachments:
    service_control:
      deny_leave_organization:
        - "sandbox"
        - "security"
      deny_root_user:
        - "sandbox"
        - "security"
