# IAM User Cleanup Guard Configuration
# This guard manages inactive IAM users in the management account

# Build configuration
build:
  artifacts_dir: "builds/guards"
  attach_tracing_policy: false
  # kms_key_arn will use context.kms.arn by default

# Deploy configuration
deploy:
  config_name: "CodeDeployDefault.Lambda10PercentEvery5Minutes"
  force_deploy: false
  save_deploy_script: true
  wait_deployment_completion: true
  
  # Auto-rollback configuration
  auto_rollback_enabled: true
  auto_rollback_events:
    - "DEPLOYMENT_FAILURE"
    - "DEPLOYMENT_STOP_ON_ALARM"
  
  # Alarm integration
  alarm_enabled: false
  alarms: []

# Monitoring configuration
monitoring:
  cloudwatch_logs_retention_days: 30
  cloudwatch_logs_log_group_class: "STANDARD"
  
  # Async event configuration
  maximum_retry_attempts: 2
  maximum_event_age_in_seconds: 3600
  
  # Dead letter queue
  dlq_message_retention_seconds: 1209600  # 14 days

# Performance configuration
performance:
  reserved_concurrent_executions: 1

# Lambda configuration
lambda:
  description: "Guard lambda to manage inactive IAM users in the management account"
  handler: "bootstrap"
  runtime: "provided.al2023"
  architectures:
    - "arm64"
  timeout: 300
  memory_size: 512

# Schedule configuration
schedule:
  expression: "rate(1 day)"
  description: "Trigger IAM user cleanup guard lambda daily"

# Environment variables
environment:
  LOG_LEVEL: "INFO"
  DRY_RUN: "false"
  DAYS_TO_DISABLE_KEYS: "90"
  DAYS_TO_DISABLE_USER: "180"
  DAYS_TO_DELETE_USER: "270"

# IAM policy statements
policy_statements:
  iam_read:
    effect: "Allow"
    actions:
      - "iam:ListUsers"
      - "iam:GetUser"
      - "iam:ListAccessKeys"
      - "iam:GetAccessKeyLastUsed"
      - "iam:ListUserPolicies"
      - "iam:ListAttachedUserPolicies"
      - "iam:GetLoginProfile"
    resources:
      - "*"
  
  iam_write:
    effect: "Allow"
    actions:
      - "iam:UpdateAccessKey"
      - "iam:DeleteAccessKey"
      - "iam:DeleteUser"
      - "iam:DetachUserPolicy"
      - "iam:DeleteUserPolicy"
      - "iam:DeleteLoginProfile"
    resources:
      - "arn:aws:iam::*:user/*"
    condition:
      StringNotEquals:
        test: "StringNotEquals"
        variable: "aws:PrincipalArn"
        # values will be populated from local.context.admin_bot_users

# Guard-specific tags
tags:
  GuardType: "IAM-Cleanup"
  Schedule: "Daily"
