#!/usr/bin/env bash
# =============================================================================
# configure-repos - Configure GitHub repositories using gh CLI
# =============================================================================
# Replaces Terraform repository configuration with gh CLI operations.
# Uses repo-config.json as the source of truth.
#
# Usage:
#   ./scripts/configure-repos [options] [repo...]
#
# Options:
#   --dry-run       Show what would be configured without making changes
#   --all           Configure all repos (default if no repo specified)
#   --diff          Show differences between current and desired state
#
# Examples:
#   ./scripts/configure-repos                    # Configure all repos
#   ./scripts/configure-repos strata             # Configure specific repo
#   ./scripts/configure-repos --diff --all       # Show drift for all repos
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}/.."
CONFIG_FILE="${REPO_ROOT}/repo-config.json"
GITHUB_ORG="${GITHUB_ORG:-jbdevprimary}"

# Options
DRY_RUN=false
SHOW_DIFF=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
log_diff()  { echo -e "${CYAN}[DIFF]${NC} $*"; }

# =============================================================================
# Functions
# =============================================================================

get_all_repos() {
  jq -r '.ecosystems | to_entries[] | .value.repos[]' "$CONFIG_FILE"
}

get_repo_override() {
  local repo="$1"
  local field="$2"
  jq -r --arg repo "$repo" --arg field "$field" \
    '.overrides[$repo][$field] // empty' "$CONFIG_FILE"
}

get_default() {
  local field="$1"
  jq -r ".defaults.${field}" "$CONFIG_FILE"
}

get_current_config() {
  local repo="$1"
  gh api "repos/${GITHUB_ORG}/${repo}" 2>/dev/null || echo "{}"
}

configure_repo() {
  local repo="$1"
  local full_repo="${GITHUB_ORG}/${repo}"
  
  log_info "Configuring: $repo"
  
  # Get current state
  local current
  current=$(get_current_config "$repo")
  
  if [[ "$current" == "{}" ]]; then
    log_warn "  Could not fetch current config"
    return 1
  fi
  
  # Build desired state from defaults + overrides
  local description
  description=$(get_repo_override "$repo" "description")
  [[ -z "$description" ]] && description=$(echo "$current" | jq -r '.description // ""')
  
  # Build the update payload
  local payload
  payload=$(jq -n \
    --arg desc "$description" \
    --argjson has_issues "$(get_default 'has_issues')" \
    --argjson has_projects "$(get_default 'has_projects')" \
    --argjson has_wiki "$(get_default 'has_wiki')" \
    --argjson has_discussions "$(get_default 'has_discussions')" \
    --argjson allow_squash_merge "$(get_default 'allow_squash_merge')" \
    --argjson allow_merge_commit "$(get_default 'allow_merge_commit')" \
    --argjson allow_rebase_merge "$(get_default 'allow_rebase_merge')" \
    --argjson allow_auto_merge "$(get_default 'allow_auto_merge')" \
    --argjson delete_branch_on_merge "$(get_default 'delete_branch_on_merge')" \
    --arg squash_title "$(get_default 'squash_merge_commit_title')" \
    --arg squash_message "$(get_default 'squash_merge_commit_message')" \
    '{
      description: $desc,
      has_issues: $has_issues,
      has_projects: $has_projects,
      has_wiki: $has_wiki,
      has_discussions: $has_discussions,
      allow_squash_merge: $allow_squash_merge,
      allow_merge_commit: $allow_merge_commit,
      allow_rebase_merge: $allow_rebase_merge,
      allow_auto_merge: $allow_auto_merge,
      delete_branch_on_merge: $delete_branch_on_merge,
      squash_merge_commit_title: $squash_title,
      squash_merge_commit_message: $squash_message
    }')
  
  # Show diff if requested
  if [[ "$SHOW_DIFF" == "true" ]]; then
    echo "  Current vs Desired:"
    
    # Compare key fields
    local fields=("has_wiki" "has_discussions" "allow_squash_merge" "allow_merge_commit" "allow_rebase_merge" "delete_branch_on_merge")
    local has_diff=false
    
    for field in "${fields[@]}"; do
      local current_val desired_val
      current_val=$(echo "$current" | jq -r ".${field}")
      desired_val=$(echo "$payload" | jq -r ".${field}")
      
      if [[ "$current_val" != "$desired_val" ]]; then
        log_diff "    $field: $current_val → $desired_val"
        has_diff=true
      fi
    done
    
    if [[ "$has_diff" != "true" ]]; then
      log_ok "  No differences"
    fi
    
    return 0
  fi
  
  # Apply configuration
  if [[ "$DRY_RUN" == "true" ]]; then
    log_info "  [DRY RUN] Would apply:"
    echo "$payload" | jq -c '.'
  else
    if gh api "repos/${full_repo}" -X PATCH --input - <<< "$payload" >/dev/null 2>&1; then
      log_ok "  Configuration applied"
    else
      log_error "  Failed to apply configuration"
      return 1
    fi
    
    # Configure security settings
    configure_security "$repo"
  fi
}

configure_security() {
  local repo="$1"
  local full_repo="${GITHUB_ORG}/${repo}"
  
  # Enable Dependabot security updates
  if [[ "$(get_default 'security.dependabot_security_updates')" == "true" ]]; then
    gh api "repos/${full_repo}/automated-security-fixes" -X PUT >/dev/null 2>&1 || true
  fi
  
  # Secret scanning is usually enabled at org level, but we can try
  # These may fail if not available for the repo type
  if [[ "$(get_default 'security.secret_scanning')" == "true" ]]; then
    gh api "repos/${full_repo}" -X PATCH \
      -f security_and_analysis='{"secret_scanning":{"status":"enabled"}}' >/dev/null 2>&1 || true
  fi
}

show_help() {
  echo ""
  echo "Usage: configure-repos [options] [repo...]"
  echo ""
  echo "Configure GitHub repositories using gh CLI."
  echo "Uses repo-config.json as the source of truth."
  echo ""
  echo "Options:"
  echo "  --dry-run     Show what would be configured without making changes"
  echo "  --diff        Show differences between current and desired state"
  echo "  --all         Configure all repos (default if no repo specified)"
  echo "  --help        Show this help"
  echo ""
  echo "Examples:"
  echo "  ./scripts/configure-repos                    # Configure all repos"
  echo "  ./scripts/configure-repos strata             # Configure specific repo"
  echo "  ./scripts/configure-repos --diff --all       # Show config drift"
  echo ""
}

# =============================================================================
# Main
# =============================================================================

main() {
  local repos=()
  local configure_all=false
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        shift
        ;;
      --diff)
        SHOW_DIFF=true
        shift
        ;;
      --all)
        configure_all=true
        shift
        ;;
      --help|-h)
        show_help
        exit 0
        ;;
      -*)
        log_error "Unknown option: $1"
        show_help
        exit 1
        ;;
      *)
        repos+=("$1")
        shift
        ;;
    esac
  done
  
  # If no repos specified, configure all
  if [[ ${#repos[@]} -eq 0 ]] || [[ "$configure_all" == "true" ]]; then
    mapfile -t repos < <(get_all_repos)
  fi
  
  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "  REPOSITORY CONFIGURATION (gh CLI)"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""
  
  if [[ "$DRY_RUN" == "true" ]]; then
    log_warn "DRY RUN - no changes will be made"
    echo ""
  fi
  
  if [[ "$SHOW_DIFF" == "true" ]]; then
    log_info "Showing configuration drift..."
    echo ""
  fi
  
  local count=0
  local errors=0
  
  for repo in "${repos[@]}"; do
    if configure_repo "$repo"; then
      ((count++))
    else
      ((errors++))
    fi
  done
  
  echo ""
  log_ok "Processed $count repositories"
  if [[ $errors -gt 0 ]]; then
    log_warn "$errors repositories had errors"
  fi
}

main "$@"
