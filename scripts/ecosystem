#!/usr/bin/env bash
# =============================================================================
# ecosystem - Main CLI for jbcom ecosystem management
# =============================================================================
# This is the primary entry point for all ecosystem operations.
#
# Usage:
#   ./scripts/ecosystem <command> [options]
#
# Commands:
#   discover     - Discover all repos in the organization
#   health       - Check ecosystem health
#   matrix       - Generate GitHub Actions matrix JSON
#   deps         - Show package dependencies
#   triage       - Run triage operations
#   release      - Coordinate releases
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/ecosystem.sh"

# =============================================================================
# Commands
# =============================================================================

cmd_discover() {
  local format="${1:-table}"
  local org="${GITHUB_ORG:-jbcom}"
  
  log_info "Discovering repositories in $org..."
  
  local repos
  repos=$(gh repo list "$org" \
    --json name,description,primaryLanguage,pushedAt,isArchived \
    --limit 200 \
    --jq '.[] | select(.isArchived == false)')
  
  if [[ "$format" == "json" ]]; then
    echo "$repos" | jq -s '.'
  else
    echo ""
    echo "═══════════════════════════════════════════════════════════════════════════════"
    echo "  JBCOM ECOSYSTEM REPOSITORIES"
    echo "═══════════════════════════════════════════════════════════════════════════════"
    echo ""
    
    for lang in "Python" "TypeScript" "Go" "HCL" "Rust" "GDScript"; do
      local lang_repos
      lang_repos=$(echo "$repos" | jq -r "select(.primaryLanguage.name == \"$lang\") | .name" | sort)
      
      if [[ -n "$lang_repos" ]]; then
        echo "  [$lang]"
        echo "$lang_repos" | while read -r repo; do
          local has_terragrunt=" "
          [[ -d "${TERRAGRUNT_ROOT}/python/${repo}" ]] || \
          [[ -d "${TERRAGRUNT_ROOT}/nodejs/${repo}" ]] || \
          [[ -d "${TERRAGRUNT_ROOT}/go/${repo}" ]] || \
          [[ -d "${TERRAGRUNT_ROOT}/terraform/${repo}" ]] && has_terragrunt="✓"
          echo "    [$has_terragrunt] $repo"
        done
        echo ""
      fi
    done
    
    echo "  Legend: [managed] repo-name"
    echo ""
  fi
}

cmd_sync() {
  log_info "Submodules have been removed from this repository."
  log_info "Use the ecosystem-sync workflow to sync files to managed repos."
  log_info "Run './scripts/ecosystem discover' to see managed repositories."
}

cmd_health() {
  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "  ECOSYSTEM HEALTH CHECK"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""
  
  # Check gh authentication
  echo -n "  GitHub CLI authentication: "
  if gh auth status >/dev/null 2>&1; then
    echo "✓ OK"
  else
    echo "✗ FAILED"
  fi
  
  # Check managed repos
  local total_managed
  total_managed=$(list_managed_repos | wc -l)
  
  echo ""
  echo "  Terragrunt-managed repos:  $total_managed"
  
  # List managed repos by ecosystem
  echo ""
  echo "  Managed repositories:"
  for eco in python nodejs go terraform; do
    local count
    count=$(list_managed_repos "$eco" | wc -l)
    if [[ "$count" -gt 0 ]]; then
      echo "    $eco: $count repos"
    fi
  done
  
  echo ""
  ecosystem_health
}

cmd_matrix() {
  # Build matrix dynamically from terragrunt stacks using jq for proper JSON
  local matrix_items=()
  
  # Python repos
  for repo_dir in "${TERRAGRUNT_ROOT}"/python/*/; do
    [[ -d "$repo_dir" ]] || continue
    local repo_name=$(basename "$repo_dir")
    matrix_items+=("$(jq -n \
      --arg ecosystem "python" \
      --arg repo "${GITHUB_ORG}/${repo_name}" \
      '{ecosystem: $ecosystem, repo: $repo}')")
  done
  
  # Node.js repos
  for repo_dir in "${TERRAGRUNT_ROOT}"/nodejs/*/; do
    [[ -d "$repo_dir" ]] || continue
    local repo_name=$(basename "$repo_dir")
    matrix_items+=("$(jq -n \
      --arg ecosystem "typescript" \
      --arg repo "${GITHUB_ORG}/${repo_name}" \
      '{ecosystem: $ecosystem, repo: $repo}')")
  done
  
  # Go repos
  for repo_dir in "${TERRAGRUNT_ROOT}"/go/*/; do
    [[ -d "$repo_dir" ]] || continue
    local repo_name=$(basename "$repo_dir")
    matrix_items+=("$(jq -n \
      --arg ecosystem "go" \
      --arg repo "${GITHUB_ORG}/${repo_name}" \
      '{ecosystem: $ecosystem, repo: $repo}')")
  done
  
  # Terraform repos
  for repo_dir in "${TERRAGRUNT_ROOT}"/terraform/*/; do
    [[ -d "$repo_dir" ]] || continue
    local repo_name=$(basename "$repo_dir")
    matrix_items+=("$(jq -n \
      --arg ecosystem "terraform" \
      --arg repo "${GITHUB_ORG}/${repo_name}" \
      '{ecosystem: $ecosystem, repo: $repo}')")
  done
  
  # Combine all items into a JSON array with jq
  printf '%s\n' "${matrix_items[@]}" | jq -s '{include: .}'
}

cmd_triage() {
  local subcommand="${1:-help}"
  shift || true
  
  case "$subcommand" in
    issues)
      cmd_triage_issues "$@"
      ;;
    prs)
      cmd_triage_prs "$@"
      ;;
    roadmap)
      cmd_triage_roadmap "$@"
      ;;
    cascade)
      cmd_triage_cascade "$@"
      ;;
    help|*)
      echo "Usage: ecosystem triage <subcommand>"
      echo ""
      echo "Subcommands:"
      echo "  issues    - Triage open issues across all repos"
      echo "  prs       - Manage PRs from control center"
      echo "  roadmap   - Update roadmap project"
      echo "  cascade   - Run full cascade across ecosystem"
      ;;
  esac
}

cmd_triage_issues() {
  local repo="${1:-}"
  
  log_info "Triaging issues..."
  
  if [[ -n "$repo" ]]; then
    # Triage specific repo
    npx agentic-triage sprint --repo "${GITHUB_ORG}/${repo}"
  else
    # Triage all managed repos
    list_managed_repos | while read -r entry; do
      local eco=$(dirname "$entry")
      local repo_name=$(basename "$entry")
      log_info "Triaging: $repo_name"
      npx agentic-triage assess --repo "${GITHUB_ORG}/${repo_name}" || true
    done
  fi
}

cmd_triage_prs() {
  local action="${1:-list}"
  
  log_info "Managing PRs from control center..."
  
  case "$action" in
    list)
      # List all open PRs across ecosystem
      list_managed_repos | while read -r entry; do
        local repo_name=$(basename "$entry")
        local prs
        prs=$(gh pr list --repo "${GITHUB_ORG}/${repo_name}" --json number,title,author,createdAt 2>/dev/null || echo "[]")
        local count=$(echo "$prs" | jq length)
        if [[ "$count" -gt 0 ]]; then
          echo ""
          echo "[$repo_name] ($count open PRs)"
          echo "$prs" | jq -r '.[] | "  #\(.number): \(.title) (@\(.author.login))"'
        fi
      done
      ;;
    review)
      local repo="${2:-}"
      local pr="${3:-}"
      if [[ -z "$repo" ]] || [[ -z "$pr" ]]; then
        echo "Usage: ecosystem triage prs review <repo> <pr-number>"
        return 1
      fi
      npx agentic-triage review "$pr" --repo "${GITHUB_ORG}/${repo}"
      ;;
  esac
}

cmd_triage_roadmap() {
  log_info "Updating roadmap..."
  
  # Run roadmap command for each managed repo
  list_managed_repos | while read -r entry; do
    local repo_name=$(basename "$entry")
    log_info "Generating roadmap for: $repo_name"
    npx agentic-triage roadmap --repo "${GITHUB_ORG}/${repo_name}" --update-project || true
  done
}

cmd_triage_cascade() {
  log_info "Running full cascade across ecosystem..."
  
  # This is the main automation command
  list_managed_repos | while read -r entry; do
    local repo_name=$(basename "$entry")
    log_info "Cascading: $repo_name"
    npx agentic-triage cascade --repo "${GITHUB_ORG}/${repo_name}" || true
  done
}

cmd_deps() {
  local repo="${1:-}"
  
  if [[ -z "$repo" ]]; then
    echo "Usage: ecosystem deps <repo-name>"
    echo ""
    echo "Shows dependency information from triage-hub.json"
    return 1
  fi
  
  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "  DEPENDENCY ANALYSIS: $repo"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""
  
  # Check triage-hub.json for dependency info
  if [[ -f "${REPO_ROOT}/triage-hub.json" ]]; then
    for eco in python typescript go terraform; do
      local pkg_info
      pkg_info=$(jq -r ".ecosystems.${eco}.packages[\"${repo}\"] // empty" "${REPO_ROOT}/triage-hub.json" 2>/dev/null)
      if [[ -n "$pkg_info" ]]; then
        echo "  Ecosystem: $eco"
        echo ""
        echo "  Dependencies:"
        echo "$pkg_info" | jq -r '.dependencies // [] | .[]' 2>/dev/null | sed 's/^/    → /' || echo "    (none)"
        echo ""
        echo "  Consumers:"
        echo "$pkg_info" | jq -r '.consumers // [] | .[]' 2>/dev/null | sed 's/^/    ← /' || echo "    (none)"
        echo ""
        return 0
      fi
    done
    log_warn "Repository not found in triage-hub.json: $repo"
  else
    log_error "triage-hub.json not found"
  fi
}

cmd_release() {
  local repo="${1:-}"
  local version="${2:-}"
  
  if [[ -z "$repo" ]]; then
    echo "Usage: ecosystem release <repo-name> [version]"
    echo ""
    echo "Coordinates a release for a package and updates dependents."
    return 1
  fi
  
  log_info "Coordinating release for: $repo"
  
  # Run the agentic-triage release command
  if [[ -n "$version" ]]; then
    npx agentic-triage release --repo "${GITHUB_ORG}/${repo}" --version "$version"
  else
    npx agentic-triage release --repo "${GITHUB_ORG}/${repo}"
  fi
}

cmd_help() {
  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "  JBCOM ECOSYSTEM MANAGEMENT CLI"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""
  echo "  Usage: ecosystem <command> [options]"
  echo ""
  echo "  Discovery:"
  echo "    discover [--json]     List all repos in the organization"
  echo "    health                Check ecosystem health"
  echo ""
  echo "  Workflows:"
  echo "    matrix                Generate GitHub Actions matrix JSON"
  echo "    deps <repo>           Show package dependencies"
  echo ""
  echo "  Triage (centralized management):"
  echo "    triage issues [repo]  Triage open issues"
  echo "    triage prs list       List all open PRs"
  echo "    triage prs review     Review a PR from control center"
  echo "    triage roadmap        Update roadmap project"
  echo "    triage cascade        Full automation cascade"
  echo ""
  echo "  Releases:"
  echo "    release <repo> [ver]  Coordinate package release"
  echo ""
  echo "  Environment Variables:"
  echo "    GITHUB_ORG            GitHub organization (default: jbcom)"
  echo "    GH_TOKEN              GitHub token for API access"
  echo "    OLLAMA_API_KEY        Ollama API key for AI operations"
  echo ""
}

# =============================================================================
# Main
# =============================================================================

main() {
  local command="${1:-help}"
  shift || true
  
  case "$command" in
    discover)
      cmd_discover "$@"
      ;;
    sync)
      cmd_sync "$@"
      ;;
    health)
      cmd_health "$@"
      ;;
    matrix)
      cmd_matrix "$@"
      ;;
    deps)
      cmd_deps "$@"
      ;;
    triage)
      cmd_triage "$@"
      ;;
    release)
      cmd_release "$@"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      log_error "Unknown command: $command"
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
