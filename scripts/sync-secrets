#!/usr/bin/env bash
# =============================================================================
# sync-secrets - Sync GitHub Actions secrets to all managed repositories
# =============================================================================
# Syncs secrets from environment variables to all repos in repo-config.json.
# Uses gh CLI for GitHub API access.
#
# Usage:
#   ./scripts/sync-secrets [options] [repo...]
#
# Required Environment Variables:
#   - CI_GITHUB_TOKEN     - GitHub token for workflows
#   - PYPI_TOKEN          - PyPI publishing token
#   - NPM_TOKEN           - npm publishing token
#   - ANTHROPIC_API_KEY   - Anthropic Claude API key
#   - OPENROUTER_API_KEY  - OpenRouter API key (meta model routing)
#   - OPENAI_API_KEY      - OpenAI API key (Codex)
#   - OLLAMA_API_KEY      - Ollama Cloud API key
#   - OLLAMA_API_URL      - Ollama Cloud API URL
#   - CURSOR_API_KEY      - Cursor Cloud Agent API key
#   - GOOGLE_JULES_API_KEY - Google Jules API key
#   - JULES_GITHUB_TOKEN  - GitHub token for Jules
#   - CURSOR_SESSION_TOKEN - Cursor session token
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}/.."
CONFIG_FILE="${REPO_ROOT}/repo-config.json"
GITHUB_ORG="${GITHUB_ORG:-jbcom}"

# Options
DRY_RUN=false
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }
log_verbose() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[VERBOSE]${NC} $*" || true; }

# =============================================================================
# Secret Definitions
# =============================================================================

# Map of secret names to environment variable names
declare -A SECRETS=(
  ["CI_GITHUB_TOKEN"]="CI_GITHUB_TOKEN"
  ["PYPI_TOKEN"]="PYPI_TOKEN"
  ["NPM_TOKEN"]="NPM_TOKEN"
  ["ANTHROPIC_API_KEY"]="ANTHROPIC_API_KEY"
  ["OPENROUTER_API_KEY"]="OPENROUTER_API_KEY"
  ["OPENAI_API_KEY"]="OPENAI_API_KEY"
  ["OLLAMA_API_KEY"]="OLLAMA_API_KEY"
  ["OLLAMA_API_URL"]="OLLAMA_API_URL"
  ["CURSOR_API_KEY"]="CURSOR_API_KEY"
  ["GOOGLE_JULES_API_KEY"]="GOOGLE_JULES_API_KEY"
  ["JULES_GITHUB_TOKEN"]="JULES_GITHUB_TOKEN"
  ["DOCKERHUB_USERNAME"]="DOCKERHUB_USERNAME"
  ["DOCKERHUB_TOKEN"]="DOCKERHUB_TOKEN"
  ["CURSOR_SESSION_TOKEN"]="CURSOR_SESSION_TOKEN"
)

# =============================================================================
# Functions
# =============================================================================

get_all_repos() {
  jq -r '.ecosystems | to_entries[] | .value.repos[]' "$CONFIG_FILE"
}

sync_secret() {
  local repo="$1"
  local secret_name="$2"
  local env_var="$3"
  local full_repo="${GITHUB_ORG}/${repo}"

  local secret_value="${!env_var:-}"

  if [[ -z "$secret_value" ]]; then
    log_verbose "  $secret_name: SKIPPED (not set)"
    return 0
  fi

  if [[ "$DRY_RUN" == "true" ]]; then
    log_info "  [DRY RUN] Would set: $secret_name"
    return 0
  fi

  if gh secret set "$secret_name" --repo "$full_repo" --body "$secret_value" 2>/dev/null; then
    log_verbose "  $secret_name: ✓"
    return 0
  else
    log_warn "  $secret_name: FAILED"
    return 1
  fi
}

sync_repo_secrets() {
  local repo="$1"
  local full_repo="${GITHUB_ORG}/${repo}"

  log_info "Syncing secrets: $repo"

  local success=0
  local failed=0

  for secret_name in "${!SECRETS[@]}"; do
    local env_var="${SECRETS[$secret_name]}"
    if sync_secret "$repo" "$secret_name" "$env_var"; then
      ((success++))
    else
      ((failed++))
    fi
  done

  if [[ $failed -eq 0 ]]; then
    log_ok "  Synced $success secrets"
  else
    log_warn "  Synced $success, failed $failed"
  fi
}

show_status() {
  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "  SECRET STATUS"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""

  for secret_name in "${!SECRETS[@]}"; do
    local env_var="${SECRETS[$secret_name]}"
    local value="${!env_var:-}"

    if [[ -n "$value" ]]; then
      # Show first/last 4 chars for verification
      local masked
      if [[ ${#value} -gt 8 ]]; then
        masked="${value:0:4}...${value: -4}"
      else
        masked="****"
      fi
      echo -e "  ${GREEN}✓${NC} $secret_name ($masked)"
    else
      echo -e "  ${RED}✗${NC} $secret_name (not set)"
    fi
  done

  echo ""
}

show_help() {
  echo ""
  echo "Usage: sync-secrets [options] [repo...]"
  echo ""
  echo "Sync GitHub Actions secrets to managed repositories."
  echo ""
  echo "Options:"
  echo "  --dry-run     Show what would be synced without making changes"
  echo "  --status      Show which secrets are available"
  echo "  --verbose     Show detailed output"
  echo "  --all         Sync all repos (default if no repo specified)"
  echo "  --help        Show this help"
  echo ""
  echo "Required Environment Variables:"
  echo "  CI_GITHUB_TOKEN, PYPI_TOKEN, NPM_TOKEN, ANTHROPIC_API_KEY,"
  echo "  OPENROUTER_API_KEY, OPENAI_API_KEY, OLLAMA_API_KEY, OLLAMA_API_URL,"
  echo "  CURSOR_API_KEY, GOOGLE_JULES_API_KEY, JULES_GITHUB_TOKEN, CURSOR_SESSION_TOKEN"
  echo ""
  echo "Examples:"
  echo "  ./scripts/sync-secrets --status           # Check secret availability"
  echo "  ./scripts/sync-secrets --dry-run --all    # Preview sync"
  echo "  ./scripts/sync-secrets strata             # Sync specific repo"
  echo ""
}

# =============================================================================
# Main
# =============================================================================

main() {
  local repos=()
  local sync_all=false
  local show_status_only=false

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        shift
        ;;
      --status)
        show_status_only=true
        shift
        ;;
      --verbose|-v)
        VERBOSE=true
        shift
        ;;
      --all)
        sync_all=true
        shift
        ;;
      --help|-h)
        show_help
        exit 0
        ;;
      -*)
        log_error "Unknown option: $1"
        show_help
        exit 1
        ;;
      *)
        repos+=("$1")
        shift
        ;;
    esac
  done

  if [[ "$show_status_only" == "true" ]]; then
    show_status
    exit 0
  fi

  if [[ ${#repos[@]} -eq 0 ]] || [[ "$sync_all" == "true" ]]; then
    mapfile -t repos < <(get_all_repos)
  fi

  echo ""
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo "  SECRETS SYNC"
  echo "═══════════════════════════════════════════════════════════════════════════════"
  echo ""

  if [[ "$DRY_RUN" == "true" ]]; then
    log_warn "DRY RUN - no changes will be made"
    echo ""
  fi

  # Show status first
  show_status

  local count=0
  for repo in "${repos[@]}"; do
    sync_repo_secrets "$repo"
    ((count++))
  done

  echo ""
  log_ok "Processed $count repositories"
}

main "$@"
