# Jules Supervisor Pattern

This document outlines the pattern for a Cursor Cloud Agent to act as a "supervisor" for a Google Jules AI session. The supervisor's role is to manage the entire lifecycle of a pull request generated by Jules, from creation to merging.

## Environment Variables

Cursor Cloud Agents designated as supervisors will have access to the following environment variables:

| Variable              | Purpose                                       |
|-----------------------|-----------------------------------------------|
| `JULES_API_KEY`       | API key for accessing the Google Jules API.   |
| `CURSOR_API_KEY`      | API key for the Cursor Cloud Agent API, used for spawning other agents. |
| `CURSOR_GITHUB_TOKEN` | GitHub token for repository actions. Falls back to `GITHUB_TOKEN` if not set. |

## Orchestration Pattern

The supervisor agent follows a clear orchestration pattern to manage Jules-created pull requests effectively.

```
┌─────────────────────────────────────────────────────────────┐
│                  CURSOR CLOUD AGENT                         │
│                    (Supervisor)                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. List active Jules sessions                              │
│     GET /v1alpha/sessions                                   │
│                                                             │
│  2. Check session status                                    │
│     GET /v1alpha/sessions/{id}                              │
│                                                             │
│  3. When COMPLETED with PR:                                 │
│     - Check PR CI status                                    │
│     - Review AI feedback                                    │
│     - Handle any failing checks                             │
│     - Merge when ready                                      │
│                                                             │
│  4. For complex work, spawn additional:                     │
│     - Jules sessions (async refactoring)                    │
│     - Cursor Cloud Agents (long-running tasks)              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Orchestrator Script

An orchestrator script is available to implement this pattern:

**Location:** `/workspace/scripts/cursor-jules-orchestrator.mjs`

**Usage:**
```bash
# Executed by a Cursor Cloud Agent
node scripts/cursor-jules-orchestrator.mjs
```

## Spawning Additional Agents

For complex tasks that require parallel work, the supervisor can spawn additional Cursor Cloud Agents.

**Example cURL Request:**
```bash
# Spawn a new agent to fix CI failures in a specific PR
curl -X POST 'https://api.cursor.com/agents/launch' \
  -u "$CURSOR_API_KEY:" \
  -d '{
    "prompt": {
      "text": "Fix CI failures in PR #123: Update dependencies"
    },
    "source": {
      "repository": "jbcom/nodejs-strata",
      "ref": "feature-branch-name"
    },
    "target": {
      "autoCreatePr": true
    }
  }'
```

## Workflow Steps

1.  **Jules Creates PR**: A Jules session completes and generates a pull request.
2.  **Supervisor Detection**: The Cursor supervisor agent detects the new PR by monitoring Jules sessions.
3.  **CI/CD Monitoring**: The supervisor monitors the CI/CD pipeline for the PR.
    - If checks fail, the supervisor spawns a new Cursor Cloud Agent specifically tasked with fixing the failure.
4.  **Review Monitoring**: The supervisor checks the PR's review status. It does not actively address comments but waits for the PR to be formally approved without any outstanding change requests.
5.  **Merge**: The supervisor merges the PR once a specific set of conditions are met:
    - All CI/CD checks are passing.
    - The PR is in a mergeable state (e.g., no conflicts).
    - The PR has been approved by at least one reviewer.
    - There are no outstanding change requests.
6.  **Task Delegation**: The primary form of delegation is spawning new agents to handle CI/CD failures.

## Security and Robustness

The orchestrator script includes several features to ensure safe and reliable operation:

-   **Secret Scanning**: Before merging, the script performs a basic scan of the PR's diff to detect common patterns for secrets (e.g., `api_key`, `password`, `token`). If a potential secret is found, the merge is aborted.
-   **Input Validation**: Session IDs and components of the pull request URL (`owner`, `repo`, `prNum`) are validated to prevent path traversal or injection attacks.

## Implementation Status

- [x] Created orchestrator script
- [ ] Add to agentic-control as proper module
- [ ] Create GitHub Action wrapper
- [ ] Add to control-center sync

## Related

- #422 (Unified Orchestrator EPIC)
- #427 (@agentic packages EPIC)
- #428 (Bulk delegation tracking)
